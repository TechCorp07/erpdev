<!-- inventory/pricing/margin_analysis.html -->
{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Margin Analysis{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block dashboard_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Margin Analysis Dashboard
                </h5>
            </div>
            <div class="card-body">
                <!-- Filter Controls -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Category:</label>
                        <select class="form-select" id="category-filter">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Supplier:</label>
                        <select class="form-select" id="supplier-filter">
                            <option value="">All Suppliers</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Margin Range:</label>
                        <select class="form-select" id="margin-filter">
                            <option value="">All Margins</option>
                            <option value="negative">Negative Margin</option>
                            <option value="0-10">0% - 10%</option>
                            <option value="10-25">10% - 25%</option>
                            <option value="25-50">25% - 50%</option>
                            <option value="50+">50%+</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary d-block" onclick="applyFilters()">
                            <i class="bi bi-funnel"></i> Apply Filters
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>Average Margin</h6>
                                        <h4>{{ avg_margin|floatformat:1 }}%</h4>
                                    </div>
                                    <i class="bi bi-percent fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>High Margin Products</h6>
                                        <h4>{{ high_margin_count }}</h4>
                                    </div>
                                    <i class="bi bi-arrow-up fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>Low Margin Products</h6>
                                        <h4>{{ low_margin_count }}</h4>
                                    </div>
                                    <i class="bi bi-arrow-down fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>Negative Margins</h6>
                                        <h4>{{ negative_margin_count }}</h4>
                                    </div>
                                    <i class="bi bi-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Margin Distribution Chart -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <canvas id="marginChart" height="100"></canvas>
                    </div>
                    <div class="col-md-4">
                        <canvas id="marginDistributionChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Product Margin Analysis Table -->
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Cost Price</th>
                                <th>Sell Price</th>
                                <th>Margin $</th>
                                <th>Margin %</th>
                                <th>Stock Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td>
                                    <strong>{{ product.name }}</strong><br>
                                    <small class="text-muted">{{ product.sku }}</small>
                                </td>
                                <td>{{ product.category.name }}</td>
                                <td>${{ product.cost_price|floatformat:2 }}</td>
                                <td>${{ product.sell_price|floatformat:2 }}</td>
                                <td>
                                    {% if product.margin_amount >= 0 %}
                                        <span class="text-success">${{ product.margin_amount|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-danger">${{ product.margin_amount|floatformat:2 }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if product.margin_percentage >= 50 %}
                                            <span class="badge bg-success">{{ product.margin_percentage|floatformat:1 }}%</span>
                                        {% elif product.margin_percentage >= 25 %}
                                            <span class="badge bg-primary">{{ product.margin_percentage|floatformat:1 }}%</span>
                                        {% elif product.margin_percentage >= 0 %}
                                            <span class="badge bg-warning">{{ product.margin_percentage|floatformat:1 }}%</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ product.margin_percentage|floatformat:1 }}%</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>${{ product.stock_value|floatformat:0 }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'inventory:product_detail' product.pk %}" class="btn btn-outline-primary" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-success" onclick="adjustPrice({{ product.pk }})" title="Adjust Price">
                                            <i class="bi bi-currency-dollar"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="viewTrend({{ product.pk }})" title="View Trend">
                                            <i class="bi bi-graph-up"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted">No products found matching the criteria</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Export Options -->
                <div class="row mt-4">
                    <div class="col-12 text-end">
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="exportData('csv')">
                                <i class="bi bi-filetype-csv"></i> Export CSV
                            </button>
                            <button class="btn btn-primary" onclick="exportData('excel')">
                                <i class="bi bi-file-earmark-excel"></i> Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Price Adjustment Modal -->
<div class="modal fade" id="priceAdjustmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust Product Price</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="price-adjustment-form">
                    <div class="mb-3">
                        <label class="form-label">New Selling Price:</label>
                        <input type="number" class="form-control" id="new-price" step="0.01" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Margin %:</label>
                        <input type="number" class="form-control" id="target-margin" step="0.1">
                    </div>
                    <div class="alert alert-info">
                        <strong>Current Cost:</strong> $<span id="current-cost">0.00</span><br>
                        <strong>Calculated Margin:</strong> <span id="calculated-margin">0.0%</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePrice()">Save Price</button>
            </div>
        </div>
    </div>
</div>

<script>
// Margin Distribution Chart
const ctx1 = document.getElementById('marginChart').getContext('2d');
const marginChart = new Chart(ctx1, {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'Product Margins',
            data: [
                {% for product in products %}
                {x: {{ product.cost_price }}, y: {{ product.margin_percentage }}},
                {% endfor %}
            ],
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            borderColor: 'rgba(75, 192, 192, 1)'
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Cost Price ($)'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Margin (%)'
                }
            }
        }
    }
});

// Margin Distribution Pie Chart
const ctx2 = document.getElementById('marginDistributionChart').getContext('2d');
const distributionChart = new Chart(ctx2, {
    type: 'doughnut',
    data: {
        labels: ['High (50%+)', 'Good (25-50%)', 'Low (0-25%)', 'Negative'],
        datasets: [{
            data: [
                {{ high_margin_count }},
                {{ good_margin_count }},
                {{ low_margin_count }},
                {{ negative_margin_count }}
            ],
            backgroundColor: ['#28a745', '#007bff', '#ffc107', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

function applyFilters() {
    const category = document.getElementById('category-filter').value;
    const supplier = document.getElementById('supplier-filter').value;
    const margin = document.getElementById('margin-filter').value;
    
    let url = window.location.pathname + '?';
    if (category) url += 'category=' + category + '&';
    if (supplier) url += 'supplier=' + supplier + '&';
    if (margin) url += 'margin=' + margin + '&';
    
    window.location.href = url;
}

function adjustPrice(productId) {
    // Load product data and show modal
    document.getElementById('priceAdjustmentModal').querySelector('.modal-title').textContent = 'Adjust Price - Product ID: ' + productId;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('priceAdjustmentModal')).show();
}

function viewTrend(productId) {
    // Redirect to product trend view
    window.location.href = `/inventory/products/${productId}/margin-trend/`;
}

function exportData(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('export', format);
    window.location.href = window.location.pathname + '?' + params.toString();
}

function savePrice() {
    // Implement price saving logic
    console.log('Save price adjustment');
}

// Calculate margin when price changes
document.getElementById('new-price').addEventListener('input', function() {
    const newPrice = parseFloat(this.value) || 0;
    const cost = parseFloat(document.getElementById('current-cost').textContent) || 0;
    
    if (cost > 0) {
        const margin = ((newPrice - cost) / newPrice) * 100;
        document.getElementById('calculated-margin').textContent = margin.toFixed(1) + '%';
    }
});

// Calculate price when target margin changes
document.getElementById('target-margin').addEventListener('input', function() {
    const targetMargin = parseFloat(this.value) || 0;
    const cost = parseFloat(document.getElementById('current-cost').textContent) || 0;
    
    if (cost > 0 && targetMargin < 100) {
        const newPrice = cost / (1 - (targetMargin / 100));
        document.getElementById('new-price').value = newPrice.toFixed(2);
    }
});
</script>
{% endblock %}