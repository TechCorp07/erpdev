{% extends "inventory_base.html" %}
{% load static %}

{% block inventory_title %}Inventory Dashboard{% endblock %}

{% block extra_head %}
{{ block.super }}
<!-- Chart.js for dashboard visualizations -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  .dashboard-metric {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 1rem;
    color: white;
    transition: all 0.3s ease;
  }
  
  .dashboard-metric:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  
  .dashboard-metric.critical { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
  .dashboard-metric.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
  .dashboard-metric.success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
  .dashboard-metric.info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
  
  .chart-container {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .activity-item {
    border-left: 4px solid #e3e6f0;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-radius: 0 0.5rem 0.5rem 0;
    background: #f8f9fc;
    transition: all 0.2s ease;
  }
  
  .activity-item:hover {
    border-left-color: #5a5c69;
    background: #eaecf4;
  }
  
  .activity-item.stock-in { border-left-color: #28a745; }
  .activity-item.stock-out { border-left-color: #dc3545; }
  .activity-item.adjustment { border-left-color: #ffc107; }
  .activity-item.transfer { border-left-color: #17a2b8; }
  
  .alert-priority-critical { 
    border-left: 4px solid #dc3545; 
    background: linear-gradient(to right, rgba(220, 53, 69, 0.1), transparent);
  }
  .alert-priority-high { 
    border-left: 4px solid #fd7e14; 
    background: linear-gradient(to right, rgba(253, 126, 20, 0.1), transparent);
  }
  .alert-priority-medium { 
    border-left: 4px solid #ffc107; 
    background: linear-gradient(to right, rgba(255, 193, 7, 0.1), transparent);
  }
  .alert-priority-low { 
    border-left: 4px solid #6c757d; 
    background: linear-gradient(to right, rgba(108, 117, 125, 0.1), transparent);
  }
  
  .quick-action-card {
    border: 2px dashed #d1d3e2;
    border-radius: 1rem;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    background: #f8f9fc;
  }
  
  .quick-action-card:hover {
    border-color: #5a5c69;
    background: #eaecf4;
    transform: translateY(-2px);
  }
  
  .category-progress {
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  }
  
  @media (max-width: 768px) {
    .chart-container {
      padding: 1rem;
    }
    
    .dashboard-metric {
      margin-bottom: 1rem;
    }
  }
</style>
{% endblock %}

{% block inventory_actions %}
<div class="btn-group me-2" role="group">
  {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
    <a href="{% url 'inventory:product_create' %}" class="btn btn-success btn-sm">
      <i class="bi bi-plus-circle me-1"></i>Add Product
    </a>
    <a href="{% url 'inventory:product_list' %}" class="btn btn-warning btn-sm">
      <i class="bi bi-arrows-move me-1"></i>Adjust Stock
    </a>
    <a href="{% url 'inventory:stock_transfer' %}" class="btn btn-info btn-sm">
      <i class="bi bi-arrow-left-right me-1"></i>Transfer
    </a>
  {% endif %}
</div>

<div class="btn-group" role="group">
  <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#quickSearchModal">
    <i class="bi bi-search me-1"></i>Search
  </button>
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
      <i class="bi bi-download me-1"></i>Export
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="{% url 'inventory:product_export' %}?format=csv">
        <i class="bi bi-filetype-csv me-2"></i>Products (CSV)
      </a></li>
      <li><a class="dropdown-item" href="{% url 'inventory:stock_movements_export' %}?format=csv">
        <i class="bi bi-arrow-repeat me-2"></i>Stock Movements
      </a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="{% url 'inventory:reports_dashboard' %}">
        <i class="bi bi-graph-up me-2"></i>All Reports
      </a></li>
    </ul>
  </div>
</div>
{% endblock %}

{% block inventory_content %}
<!-- Key Metrics Dashboard -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card dashboard-metric info">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-uppercase mb-1">Total Products</div>
            <div class="h5 mb-0 font-weight-bold" data-metric="total_products">{{ total_products|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-box-seam fa-2x"></i>
          </div>
        </div>
        <div class="mt-2 text-xs">
          <span class="mr-2">
            <i class="bi bi-check-circle"></i> {{ active_products|default:0 }} Active
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card dashboard-metric success">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-uppercase mb-1">Stock Value</div>
            <div class="h5 mb-0 font-weight-bold" data-metric="total_stock_value">${{ total_stock_value|floatformat:0|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-currency-dollar fa-2x"></i>
          </div>
        </div>
        <div class="mt-2 text-xs">
          <span class="mr-2">
            <i class="bi bi-trending-up"></i> Total inventory value
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card dashboard-metric {% if low_stock_count > 10 %}critical{% elif low_stock_count > 5 %}warning{% else %}info{% endif %}">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-uppercase mb-1">Low Stock</div>
            <div class="h5 mb-0 font-weight-bold" data-metric="low_stock_count">{{ low_stock_count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-exclamation-triangle fa-2x"></i>
          </div>
        </div>
        <div class="mt-2 text-xs">
          <a href="{% url 'inventory:low_stock' %}" class="text-white text-decoration-none">
            <i class="bi bi-arrow-right-circle"></i> View Details
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card dashboard-metric {% if active_alerts_count > 20 %}critical{% elif active_alerts_count > 10 %}warning{% else %}info{% endif %}">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-uppercase mb-1">Active Alerts</div>
            <div class="h5 mb-0 font-weight-bold" data-metric="active_alerts_count">{{ active_alerts_count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-bell fa-2x"></i>
          </div>
        </div>
        <div class="mt-2 text-xs">
          <a href="{% url 'inventory:reorder_alert_list' %}" class="text-white text-decoration-none">
            <i class="bi bi-arrow-right-circle"></i> Manage Alerts
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts and Analytics Row -->
<div class="row">
  <!-- Stock Movement Trends -->
  <div class="col-xl-8 col-lg-7">
    <div class="chart-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="bi bi-graph-up me-2"></i>Stock Movement Trends (Last 30 Days)
        </h6>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-three-dots"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="updateChart('7')">Last 7 Days</a></li>
            <li><a class="dropdown-item" href="#" onclick="updateChart('30')">Last 30 Days</a></li>
            <li><a class="dropdown-item" href="#" onclick="updateChart('90')">Last 90 Days</a></li>
          </ul>
        </div>
      </div>
      <canvas id="stockMovementChart" height="300"></canvas>
    </div>
  </div>

  <!-- Category Distribution -->
  <div class="col-xl-4 col-lg-5">
    <div class="chart-container">
      <h6 class="m-0 font-weight-bold text-primary mb-3">
        <i class="bi bi-pie-chart me-2"></i>Stock Value by Category
      </h6>
      <canvas id="categoryChart" height="300"></canvas>
    </div>
  </div>
</div>

<!-- Activity and Alerts Row -->
<div class="row">
  <!-- Recent Activity -->
  <div class="col-xl-6 col-lg-6">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="bi bi-clock-history me-2"></i>Recent Stock Movements
        </h6>
        <a href="{% url 'inventory:stock_movements' %}" class="btn btn-sm btn-outline-primary">View All</a>
      </div>
      <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% for movement in recent_movements %}
          <div class="activity-item {{ movement.movement_type }}">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">
                  {% if movement.movement_type == 'sale' %}
                    <i class="bi bi-arrow-down-circle text-danger me-1"></i>Sale
                  {% elif movement.movement_type == 'purchase' %}
                    <i class="bi bi-arrow-up-circle text-success me-1"></i>Purchase
                  {% elif movement.movement_type == 'adjustment' %}
                    <i class="bi bi-gear text-warning me-1"></i>Adjustment
                  {% elif movement.movement_type == 'transfer' %}
                    <i class="bi bi-arrow-left-right text-info me-1"></i>Transfer
                  {% else %}
                    <i class="bi bi-circle text-secondary me-1"></i>{{ movement.get_movement_type_display }}
                  {% endif %}
                  {{ movement.product.name }}
                </h6>
                <p class="mb-1 text-sm">
                  SKU: {{ movement.product.sku }} | 
                  Quantity: {{ movement.quantity|floatformat:0 }} |
                  {% if movement.reference %}Reference: {{ movement.reference }}{% endif %}
                </p>
                <small class="text-muted">
                  <i class="bi bi-person me-1"></i>{{ movement.created_by.get_full_name|default:movement.created_by.username }}
                  <span class="mx-2">•</span>
                  <i class="bi bi-clock me-1"></i>{{ movement.created_at|timesince }} ago
                </small>
              </div>
              <span class="badge bg-{% if movement.quantity > 0 %}success{% else %}danger{% endif %}">
                {{ movement.quantity|floatformat:0 }}
              </span>
            </div>
          </div>
        {% empty %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-inbox fs-1 mb-3"></i>
            <p>No recent stock movements</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Reorder Alerts -->
  <div class="col-xl-6 col-lg-6">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="bi bi-exclamation-triangle me-2"></i>Reorder Alerts
        </h6>
        <a href="{% url 'inventory:reorder_alert_list' %}" class="btn btn-sm btn-outline-primary">Manage All</a>
      </div>
      <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% for alert in recent_alerts %}
          <div class="alert-item alert-priority-{{ alert.priority }} p-3 mb-3 rounded">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">
                  {% if alert.priority == 'critical' %}
                    <i class="bi bi-exclamation-triangle-fill text-danger me-1"></i>
                  {% elif alert.priority == 'high' %}
                    <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                  {% else %}
                    <i class="bi bi-info-circle text-info me-1"></i>
                  {% endif %}
                  {{ alert.product.name }}
                </h6>
                <p class="mb-1 text-sm">
                  Current Stock: <strong>{{ alert.current_stock }}</strong> | 
                  Reorder Level: <strong>{{ alert.reorder_level }}</strong>
                </p>
                <small class="text-muted">
                  Suggested Order: {{ alert.suggested_order_quantity }} units
                  {% if alert.estimated_cost %}
                    (Est. ${{ alert.estimated_cost|floatformat:2 }})
                  {% endif %}
                </small>
              </div>
              <div class="text-end">
                <span class="badge bg-{{ alert.priority }} text-uppercase">{{ alert.priority }}</span>
                {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
                  <div class="mt-2">
                    <a href="{% url 'inventory:create_po_from_alert' alert.id %}" 
                       class="btn btn-sm btn-outline-success" 
                       data-bs-toggle="tooltip" 
                       title="Create Purchase Order">
                      <i class="bi bi-plus-square"></i>
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% empty %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-check-circle fs-1 mb-3 text-success"></i>
            <p>No active reorder alerts</p>
            <small>All products are adequately stocked</small>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions Row -->
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="bi bi-lightning me-2"></i>Quick Actions
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
            <div class="col-md-3 mb-3">
              <a href="{% url 'inventory:product_create' %}" class="text-decoration-none">
                <div class="quick-action-card">
                  <i class="bi bi-plus-circle fs-1 text-success mb-2"></i>
                  <h6>Add Product</h6>
                  <small class="text-muted">Create new inventory item</small>
                </div>
              </a>
            </div>
            
            <div class="col-md-3 mb-3">
              <a href="{% url 'inventory:product_import' %}" class="text-decoration-none">
                <div class="quick-action-card">
                  <i class="bi bi-upload fs-1 text-info mb-2"></i>
                  <h6>Bulk Import</h6>
                  <small class="text-muted">Import from CSV/Excel</small>
                </div>
              </a>
            </div>
            
            <div class="col-md-3 mb-3">
              <a href="{% url 'inventory:stock_take_create' %}" class="text-decoration-none">
                <div class="quick-action-card">
                  <i class="bi bi-clipboard-check fs-1 text-warning mb-2"></i>
                  <h6>Stock Take</h6>
                  <small class="text-muted">Physical inventory count</small>
                </div>
              </a>
            </div>
          {% endif %}
          
          <div class="col-md-3 mb-3">
            <a href="{% url 'inventory:reports_dashboard' %}" class="text-decoration-none">
              <div class="quick-action-card">
                <i class="bi bi-graph-up fs-1 text-primary mb-2"></i>
                <h6>Reports</h6>
                <small class="text-muted">Analytics & insights</small>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Top Categories by Value -->
{% if category_stats %}
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="bi bi-grid-3x3-gap me-2"></i>Top Categories by Stock Value
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          {% for category in category_stats %}
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="border rounded p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">{{ category.name }}</h6>
                  <span class="badge bg-primary">{{ category.product_count }} items</span>
                </div>
                <div class="mb-2">
                  <small class="text-muted">Stock Value:</small>
                  <strong>${{ category.total_value|floatformat:0|default:0 }}</strong>
                </div>
                <div class="progress" style="height: 6px;">
                  <div class="category-progress" 
                       style="width: {% widthratio category.total_value total_stock_value 100 %}%"></div>
                </div>
                <div class="mt-2">
                  <a href="{% url 'inventory:category_products' category.id %}" class="btn btn-sm btn-outline-primary">
                    View Products
                  </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Example: Fetch metrics for the last 30 days and update charts
      fetch("{% url 'inventory:dashboard_metrics_api' %}?period=30")
        .then(response => response.json())
        .then(data => {
          // Use the returned data to update your dashboard
          // For example, update a Chart.js chart:
          if (data.movement_chart) {
              // Assuming you have a Chart.js chart initialized...
              movementChart.data.labels = data.movement_chart.labels;
              movementChart.data.datasets[0].data = data.movement_chart.stock_in;
              movementChart.data.datasets[1].data = data.movement_chart.stock_out;
              movementChart.update();
          }
          if (data.category_chart) {
              categoryChart.data.labels = data.category_chart.labels;
              categoryChart.data.datasets[0].data = data.category_chart.values;
              categoryChart.update();
          }
        });
  // Initialize stock movement chart
  initStockMovementChart();
  
  // Initialize category distribution chart
  initCategoryChart();
  
  // Set up real-time updates
  setInterval(updateDashboardData, 300000); // Every 5 minutes
});

function initStockMovementChart() {
  const ctx = document.getElementById('stockMovementChart').getContext('2d');
  
  // Sample data - in production, this would come from the backend
  const chartData = {
    labels: {{ movement_chart_labels|safe }},
    datasets: [{
      label: 'Stock In',
      data: {{ movement_chart_in|safe }},
      backgroundColor: 'rgba(75, 192, 192, 0.2)',
      borderColor: 'rgba(75, 192, 192, 1)',
      borderWidth: 2,
      fill: true
    }, {
      label: 'Stock Out',
      data: {{ movement_chart_out|safe }},
      backgroundColor: 'rgba(255, 99, 132, 0.2)',
      borderColor: 'rgba(255, 99, 132, 1)',
      borderWidth: 2,
      fill: true
    }]
  };

  window.stockMovementChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString();
            }
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
}

function initCategoryChart() {
  const ctx = document.getElementById('categoryChart').getContext('2d');
  
  const chartData = {
    labels: {{ category_chart_labels|safe }},
    datasets: [{
      data: {{ category_chart_values|safe }},
      backgroundColor: [
        '#FF6384',
        '#36A2EB',
        '#FFCE56',
        '#4BC0C0',
        '#9966FF',
        '#FF9F40',
        '#FF6384',
        '#C9CBCF'
      ],
      hoverBackgroundColor: [
        '#FF6384',
        '#36A2EB',
        '#FFCE56',
        '#4BC0C0',
        '#9966FF',
        '#FF9F40',
        '#FF6384',
        '#C9CBCF'
      ]
    }]
  };

  window.categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${label}: $${value.toLocaleString()} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

function updateChart(period) {
  // Update chart data based on selected period
  fetch(`{% url 'inventory:dashboard_metrics_api' %}?period=${period}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update stock movement chart
        window.stockMovementChart.data.labels = data.movement_chart.labels;
        window.stockMovementChart.data.datasets[0].data = data.movement_chart.stock_in;
        window.stockMovementChart.data.datasets[1].data = data.movement_chart.stock_out;
        window.stockMovementChart.update();
      }
    })
    .catch(error => console.error('Chart update error:', error));
}

function updateDashboardData() {
  // Update key metrics
  updateInventoryStats();
  
  // Update recent activities (simplified)
  fetch('{% url "inventory:recent_activities_api" %}')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update activity feed if needed
        console.log('Activities updated');
      }
    })
    .catch(error => console.log('Activity update error:', error));
}

// Add keyboard shortcuts for dashboard
document.addEventListener('keydown', function(e) {
  if (e.altKey) {
    switch(e.key) {
      case '1':
        e.preventDefault();
        window.location.href = '{% url "inventory:product_list" %}';
        break;
      case '2':
        e.preventDefault();
        window.location.href = '{% url "inventory:stock_movements" %}';
        break;
      case '3':
        e.preventDefault();
        window.location.href = '{% url "inventory:reorder_alert_list" %}';
        break;
      case 'r':
        e.preventDefault();
        window.location.href = '{% url "inventory:reports_dashboard" %}';
        break;
    }
  }
});

// Auto-refresh alerts for critical stock levels
function checkCriticalAlerts() {
  fetch('{% url "inventory:critical_alerts_api" %}')
    .then(response => response.json())
    .then(data => {
      if (data.success && data.alerts.length > 0) {
        data.alerts.forEach(alert => {
          showStockStatusUpdate(
            `Critical: ${alert.product_name} is out of stock!`,
            'danger'
          );
        });
      }
    })
    .catch(error => console.log('Alert check error:', error));
}

// Check for critical alerts every 10 minutes
setInterval(checkCriticalAlerts, 600000);

// Smooth scrolling for dashboard sections
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
  });
});
</script>
{% endblock %}
