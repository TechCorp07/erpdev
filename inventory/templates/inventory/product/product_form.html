<!-- inventory/templates/inventory/product/product_form.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if product.pk %}Edit{% else %}Add{% endif %} Product - BlitzTech Electronics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-section {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .cost-calculator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
        }
        .dynamic-attribute {
            border: 1px dashed #dee2e6;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .attribute-required {
            border-color: #dc3545;
        }
        .cost-breakdown {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">
                            <i class="fas fa-{{ product.pk and 'edit' or 'plus' }} text-primary me-2"></i>
                            {% if product.pk %}Edit Product: {{ product.name }}{% else %}Add New Product{% endif %}
                        </h1>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Dashboard</a></li>
                                <li class="breadcrumb-item"><a href="{% url 'inventory:product_list' %}">Products</a></li>
                                <li class="breadcrumb-item active">{% if product.pk %}Edit{% else %}Add{% endif %} Product</li>
                            </ol>
                        </nav>
                    </div>
                    <div>
                        <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        {% if product.pk %}
                        <a href="{% url 'inventory:product_detail' product.pk %}" class="btn btn-info me-2">
                            <i class="fas fa-eye"></i> View Product
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <form id="productForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="row">
                <!-- Main Form -->
                <div class="col-lg-8">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Basic Information
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Product Name <span class="text-danger">*</span></label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="text-danger">{{ form.name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">SKU <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        {{ form.sku }}
                                        <button type="button" class="btn btn-outline-secondary" onclick="generateSKU()">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                    </div>
                                    {% if form.sku.errors %}
                                        <div class="text-danger">{{ form.sku.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Barcode</label>
                                    <div class="input-group">
                                        {{ form.barcode }}
                                        <button type="button" class="btn btn-outline-secondary" onclick="generateBarcode()">
                                            <i class="fas fa-barcode"></i> Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Product Type</label>
                                    {{ form.product_type }}
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Short Description</label>
                                    {{ form.short_description }}
                                    <small class="form-text text-muted">Brief description for listings</small>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Full Description</label>
                                    {{ form.description }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categorization -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-tags text-success me-2"></i>
                            Categorization
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Category <span class="text-danger">*</span></label>
                                    {{ form.category }}
                                    {% if form.category.errors %}
                                        <div class="text-danger">{{ form.category.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Brand <span class="text-danger">*</span></label>
                                    {{ form.brand }}
                                    {% if form.brand.errors %}
                                        <div class="text-danger">{{ form.brand.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Supplier <span class="text-danger">*</span></label>
                                    {{ form.supplier }}
                                    {% if form.supplier.errors %}
                                        <div class="text-danger">{{ form.supplier.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Model Number</label>
                                    {{ form.model_number }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Manufacturer Part Number</label>
                                    {{ form.manufacturer_part_number }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Supplier SKU</label>
                                    {{ form.supplier_sku }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Attributes -->
                    <div class="form-section" id="dynamicAttributesSection">
                        <h5 class="mb-3">
                            <i class="fas fa-cogs text-warning me-2"></i>
                            Component Specifications
                        </h5>
                        <div id="dynamicAttributesContainer">
                            <!-- Dynamic attributes will be loaded here based on component family -->
                        </div>
                    </div>

                    <!-- External Resources -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-link text-info me-2"></i>
                            External Resources
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Datasheet URL</label>
                                    {{ form.datasheet_url }}
                                    <small class="form-text text-muted">Google Drive or Mega link</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Package Type</label>
                                    {{ form.package_type }}
                                    <small class="form-text text-muted">DIP, SMD, TO-220, etc.</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Product Images (JSON)</label>
                                    {{ form.product_images }}
                                    <small class="form-text text-muted">["image1.jpg", "image2.jpg"]</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Quality Grade</label>
                                    {{ form.quality_grade }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Physical Attributes -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-cube text-secondary me-2"></i>
                            Physical Attributes
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Weight (grams)</label>
                                    {{ form.weight_grams }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Dimensions (L x W x H mm)</label>
                                    {{ form.dimensions }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Volume (cm³)</label>
                                    {{ form.volume_cubic_cm }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.is_hazardous }}
                                    <label class="form-check-label">Hazardous Material</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.requires_esd_protection }}
                                    <label class="form-check-label">Requires ESD Protection</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.is_temperature_sensitive }}
                                    <label class="form-check-label">Temperature Sensitive</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Cost Calculator -->
                    <div class="cost-calculator mb-4">
                        <h5 class="mb-3">
                            <i class="fas fa-calculator me-2"></i>
                            Advanced Cost Calculator
                        </h5>
                        <div class="mb-3">
                            <label class="form-label text-white">Cost Price <span class="text-warning">*</span></label>
                            <div class="input-group">
                                {{ form.cost_price }}
                                {{ form.supplier_currency }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label text-white">Shipping/Unit</label>
                                    {{ form.shipping_cost_per_unit }}
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label text-white">Insurance/Unit</label>
                                    {{ form.insurance_cost_per_unit }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label text-white">Duty %</label>
                                    {{ form.customs_duty_percentage }}
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label text-white">VAT %</label>
                                    {{ form.vat_percentage }}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-white">Other Fees/Unit</label>
                            {{ form.other_fees_per_unit }}
                        </div>
                        <button type="button" class="btn btn-light w-100" onclick="calculateCosts()">
                            <i class="fas fa-calculator"></i> Calculate Total Cost
                        </button>
                        
                        <div id="costBreakdown" class="mt-3" style="display:none;">
                            <div class="cost-breakdown">
                                <h6 class="text-dark">Cost Breakdown (USD)</h6>
                                <div id="costDetails"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-dollar-sign text-success me-2"></i>
                                Pricing & Markup
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Selling Price <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    {{ form.selling_price }}
                                    {{ form.selling_currency }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target Markup %</label>
                                {{ form.target_markup_percentage }}
                                <small class="form-text text-muted">Auto-calculate selling price</small>
                            </div>
                            <div class="form-check">
                                {{ form.calculate_costs }}
                                <label class="form-check-label">Auto-calculate costs</label>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Management -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-boxes text-primary me-2"></i>
                                Stock Management
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Reorder Level</label>
                                        {{ form.reorder_level }}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Reorder Qty</label>
                                        {{ form.reorder_quantity }}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Max Stock</label>
                                        {{ form.max_stock_level }}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Lead Time (Days)</label>
                                        {{ form.supplier_lead_time_days }}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Supplier MOQ</label>
                                {{ form.supplier_minimum_order_quantity }}
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-toggle-on text-info me-2"></i>
                                Status & Flags
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-2">
                                {{ form.is_active }}
                                <label class="form-check-label">Active Product</label>
                            </div>
                            <div class="form-check mb-2">
                                {{ form.is_featured }}
                                <label class="form-check-label">Featured Product</label>
                            </div>
                            <button type="submit" class="btn btn-success w-100 mt-3">
                                <i class="fas fa-save"></i> {% if product.pk %}Update{% else %}Save{% endif %} Product
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load dynamic attributes when category changes
        document.querySelector('select[name="category"]').addEventListener('change', function() {
            const categoryId = this.value;
            if (categoryId) {
                loadDynamicAttributes(categoryId);
            }
        });

        function loadDynamicAttributes(categoryId) {
            // Get component family for category and load attributes
            fetch(`/inventory/api/component-families/${categoryId}/attributes/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('dynamicAttributesContainer');
                        container.innerHTML = '';
                        
                        data.attributes.forEach(attr => {
                            const div = document.createElement('div');
                            div.className = `dynamic-attribute ${attr.is_required ? 'attribute-required' : ''}`;
                            
                            let input = createAttributeInput(attr);
                            
                            div.innerHTML = `
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            ${attr.name}
                                            ${attr.is_required ? '<span class="text-danger">*</span>' : ''}
                                        </label>
                                        ${input}
                                        ${attr.help_text ? `<small class="form-text text-muted">${attr.help_text}</small>` : ''}
                                    </div>
                                </div>
                            `;
                            
                            container.appendChild(div);
                        });
                        
                        document.getElementById('dynamicAttributesSection').style.display = data.attributes.length > 0 ? 'block' : 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading dynamic attributes:', error);
                });
        }

        function createAttributeInput(attr) {
            if (attr.field_type === 'choice') {
                let options = '<option value="">-- Select --</option>';
                attr.choice_options.forEach(opt => {
                    options += `<option value="${opt}">${opt}</option>`;
                });
                return `<select class="form-control" name="attr_${attr.id}" ${attr.is_required ? 'required' : ''}>${options}</select>`;
            } else if (attr.field_type === 'boolean') {
                return `<input type="checkbox" class="form-check-input" name="attr_${attr.id}">`;
            } else if (attr.field_type === 'decimal') {
                return `<input type="number" class="form-control" name="attr_${attr.id}" 
                         step="0.000001" ${attr.is_required ? 'required' : ''}
                         ${attr.min_value ? `min="${attr.min_value}"` : ''}
                         ${attr.max_value ? `max="${attr.max_value}"` : ''}
                         placeholder="${attr.default_value || ''}">`;
            } else if (attr.field_type === 'url') {
                return `<input type="url" class="form-control" name="attr_${attr.id}" 
                         ${attr.is_required ? 'required' : ''} placeholder="${attr.default_value || ''}">`;
            } else {
                return `<input type="text" class="form-control" name="attr_${attr.id}" 
                         ${attr.is_required ? 'required' : ''} placeholder="${attr.default_value || ''}">`;
            }
        }

        function calculateCosts() {
            const formData = new FormData(document.getElementById('productForm'));
            const data = {
                cost_price: formData.get('cost_price'),
                currency_id: formData.get('supplier_currency'),
                shipping_cost_per_unit: formData.get('shipping_cost_per_unit'),
                insurance_cost_per_unit: formData.get('insurance_cost_per_unit'),
                customs_duty_percentage: formData.get('customs_duty_percentage'),
                vat_percentage: formData.get('vat_percentage'),
                other_fees_per_unit: formData.get('other_fees_per_unit'),
                category_id: formData.get('category'),
                supplier_id: formData.get('supplier'),
                weight_grams: formData.get('weight_grams')
            };

            fetch('/inventory/api/pricing/calculate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCostBreakdown(data.calculation);
                } else {
                    alert('Error calculating costs: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error calculating costs');
            });
        }

        function displayCostBreakdown(calc) {
            const breakdown = document.getElementById('costBreakdown');
            const details = document.getElementById('costDetails');
            
            details.innerHTML = `
                <div class="row text-dark">
                    <div class="col-8">Base Cost (${calc.currency_code}):</div>
                    <div class="col-4 text-end">$${calc.base_cost_usd.toFixed(4)}</div>
                    <div class="col-8">Shipping:</div>
                    <div class="col-4 text-end">$${calc.shipping_cost.toFixed(4)}</div>
                    <div class="col-8">Insurance:</div>
                    <div class="col-4 text-end">$${calc.insurance_cost.toFixed(4)}</div>
                    <div class="col-8">Customs Duty:</div>
                    <div class="col-4 text-end">$${calc.customs_duty.toFixed(4)}</div>
                    <div class="col-8">VAT:</div>
                    <div class="col-4 text-end">$${calc.vat_cost.toFixed(4)}</div>
                    <div class="col-8">Other Fees:</div>
                    <div class="col-4 text-end">$${calc.other_fees.toFixed(4)}</div>
                    <div class="col-8">Overhead:</div>
                    <div class="col-4 text-end">$${calc.overhead_cost.toFixed(4)}</div>
                    <hr>
                    <div class="col-8"><strong>Total Cost:</strong></div>
                    <div class="col-4 text-end"><strong>$${calc.total_cost_usd.toFixed(4)}</strong></div>
                </div>
                <div class="mt-2">
                    <h6 class="text-dark">Suggested Markups:</h6>
                    ${calc.markup_options.map(option => `
                        <div class="row">
                            <div class="col-4">${option.markup_percentage}%:</div>
                            <div class="col-4">$${option.selling_price.toFixed(2)}</div>
                            <div class="col-4 text-success">+$${option.profit_per_unit.toFixed(2)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            breakdown.style.display = 'block';
        }

        function generateSKU() {
            const category = document.querySelector('select[name="category"]').selectedOptions[0]?.text || '';
            const brand = document.querySelector('select[name="brand"]').selectedOptions[0]?.text || '';
            const date = new Date();
            const year = date.getFullYear();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            let sku = 'BT';
            if (category) sku += '-' + category.substring(0, 3).toUpperCase();
            if (brand) sku += '-' + brand.substring(0, 3).toUpperCase();
            sku += '-' + year + '-' + random;
            
            document.querySelector('input[name="sku"]').value = sku;
        }

        function generateBarcode() {
            const sku = document.querySelector('input[name="sku"]').value;
            if (sku) {
                // Simple barcode generation based on SKU
                const barcode = sku.replace(/[^0-9A-Z]/g, '').substring(0, 12);
                document.querySelector('input[name="barcode"]').value = barcode;
            }
        }

        // Load existing dynamic attributes if editing
        {% if product.pk and product.component_family %}
        document.addEventListener('DOMContentLoaded', function() {
            loadDynamicAttributes({{ product.category.id }});
        });
        {% endif %}

        // Real-time cost calculation on input change
        ['cost_price', 'shipping_cost_per_unit', 'customs_duty_percentage', 'vat_percentage'].forEach(field => {
            const input = document.querySelector(`input[name="${field}"]`);
            if (input) {
                input.addEventListener('change', calculateCosts);
            }
        });
    </script>
</body>
</html>