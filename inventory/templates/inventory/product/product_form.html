{% extends "dashboard_base.html" %}
{% load static crispy_forms_tags %}

{% block page_title %}
  {% if form.instance.pk %}Edit Product - {{ form.instance.name }}{% else %}Add New Product{% endif %}
{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:product_list' %}">Products</a></li>
        <li class="breadcrumb-item active">
          {% if form.instance.pk %}Edit Product{% else %}Add Product{% endif %}
        </li>
      </ol>
    </nav>
    <h1 class="h3 mb-0">
      {% if form.instance.pk %}Edit Product{% else %}Add New Product{% endif %}
    </h1>
  </div>
  
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Back to Products
    </a>
    {% if form.instance.pk %}
    <a href="{% url 'inventory:product_detail' form.instance.pk %}" class="btn btn-outline-info">
      <i class="bi bi-eye me-2"></i>View Product
    </a>
    {% endif %}
  </div>
</div>

<form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
  {% csrf_token %}
  
  <div class="row">
    <!-- Main Product Information -->
    <div class="col-lg-8 mb-4">
      <!-- Basic Information Card -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-info-circle me-2"></i>Basic Information
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              {% if form.name %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Product Name *</label>
                  {{ form.name|as_crispy_field }}
                </div>
              {% endif %}
              
              {% if form.sku %}
                <div class="mb-3">
                  <label class="form-label fw-bold">SKU *</label>
                  {{ form.sku|as_crispy_field }}
                  <div class="form-text">Unique product identifier</div>
                </div>
              {% endif %}
              
              {% if form.category %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Category</label>
                  {{ form.category|as_crispy_field }}
                </div>
              {% endif %}
              
              {% if form.brand %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Brand</label>
                  {{ form.brand|as_crispy_field }}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              {% if form.supplier %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Supplier</label>
                  {{ form.supplier|as_crispy_field }}
                </div>
              {% endif %}
              
              {% if form.component_family %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Component Family</label>
                  {{ form.component_family|as_crispy_field }}
                  <div class="form-text">Determines available specifications</div>
                </div>
              {% endif %}
              
              {% if form.barcode %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Barcode</label>
                  {{ form.barcode|as_crispy_field }}
                </div>
              {% endif %}
              
              {% if form.manufacturer_part_number %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Manufacturer Part #</label>
                  {{ form.manufacturer_part_number|as_crispy_field }}
                </div>
              {% endif %}
            </div>
          </div>
          
          {% if form.description %}
            <div class="mb-3">
              <label class="form-label fw-bold">Description</label>
              {{ form.description|as_crispy_field }}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Pricing Information Card -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-success">
            <i class="bi bi-currency-dollar me-2"></i>Pricing Information
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              {% if form.cost_price %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Cost Price *</label>
                  {{ form.cost_price|as_crispy_field }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-4">
              {% if form.selling_price %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Selling Price *</label>
                  {{ form.selling_price|as_crispy_field }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-4">
              {% if form.markup_percentage %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Markup %</label>
                  {{ form.markup_percentage|as_crispy_field }}
                  <div class="form-text">Auto-calculated</div>
                </div>
              {% endif %}
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              {% if form.supplier_currency %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Supplier Currency</label>
                  {{ form.supplier_currency|as_crispy_field }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              {% if form.selling_currency %}
                <div class="mb-3">
                  <label class="form-label fw-bold">Selling Currency</label>
                  {{ form.selling_currency|as_crispy_field }}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Pricing Card -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-info">
            <i class="bi bi-calculator me-2"></i>Cost Breakdown
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              {% if form.shipping_cost_per_unit %}
                <div class="mb-3">
                  <label class="form-label">Shipping Cost</label>
                  {{ form.shipping_cost_per_unit|as_crispy_field }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-3">
              {% if form.insurance_cost_per_unit %}
                <div class="mb-3">
                  <label class="form-label">Insurance</label>
                  {{ form.insurance_cost_per_unit|as_crispy_field }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-3">
              {% if form.customs_duty_percentage %}
                <div class="mb-3">
                  <label class="form-label">Customs Duty %</label>
                  {{ form.customs_duty_percentage|as_crispy_field }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-3">
              {% if form.vat_percentage %}
                <div class="mb-3">
                  <label class="form-label">VAT %</label>
                  {{ form.vat_percentage|as_crispy_field }}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4 mb-4">
      <!-- Stock Information Card -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-warning">
            <i class="bi bi-box-seam me-2"></i>Stock Information
          </h6>
        </div>
        <div class="card-body">
          {% if form.current_stock %}
            <div class="mb-3">
              <label class="form-label fw-bold">Current Stock</label>
              {{ form.current_stock|as_crispy_field }}
            </div>
          {% endif %}
          
          {% if form.reorder_level %}
            <div class="mb-3">
              <label class="form-label fw-bold">Reorder Level</label>
              {{ form.reorder_level|as_crispy_field }}
            </div>
          {% endif %}
          
          {% if form.reorder_quantity %}
            <div class="mb-3">
              <label class="form-label fw-bold">Reorder Quantity</label>
              {{ form.reorder_quantity|as_crispy_field }}
            </div>
          {% endif %}
          
          {% if form.max_stock_level %}
            <div class="mb-3">
              <label class="form-label fw-bold">Max Stock Level</label>
              {{ form.max_stock_level|as_crispy_field }}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Supplier Information Card -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-secondary">
            <i class="bi bi-truck me-2"></i>Supplier Details
          </h6>
        </div>
        <div class="card-body">
          {% if form.supplier_sku %}
            <div class="mb-3">
              <label class="form-label">Supplier SKU</label>
              {{ form.supplier_sku|as_crispy_field }}
            </div>
          {% endif %}
          
          {% if form.supplier_lead_time_days %}
            <div class="mb-3">
              <label class="form-label">Lead Time (Days)</label>
              {{ form.supplier_lead_time_days|as_crispy_field }}
            </div>
          {% endif %}
          
          {% if form.supplier_minimum_order_quantity %}
            <div class="mb-3">
              <label class="form-label">Min Order Qty</label>
              {{ form.supplier_minimum_order_quantity|as_crispy_field }}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Additional Information Card -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-dark">
            <i class="bi bi-gear me-2"></i>Additional Settings
          </h6>
        </div>
        <div class="card-body">
          {% if form.is_active %}
            <div class="form-check mb-3">
              {{ form.is_active }}
              <label class="form-check-label fw-bold" for="{{ form.is_active.id_for_label }}">
                Active Product
              </label>
              <div class="form-text">Inactive products won't appear in quotes</div>
            </div>
          {% endif %}
          
          {% if form.track_stock %}
            <div class="form-check mb-3">
              {{ form.track_stock }}
              <label class="form-check-label fw-bold" for="{{ form.track_stock.id_for_label }}">
                Track Stock Levels
              </label>
            </div>
          {% endif %}
          
          {% if form.datasheet_url %}
            <div class="mb-3">
              <label class="form-label">Datasheet URL</label>
              {{ form.datasheet_url|as_crispy_field }}
            </div>
          {% endif %}
          
          {% if form.product_images %}
            <div class="mb-3">
              <label class="form-label">Product Image</label>
              {{ form.product_images|as_crispy_field }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="card shadow">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <small class="text-muted">* Required fields</small>
        </div>
        <div class="btn-group" role="group">
          <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-lg me-2"></i>Cancel
          </a>
          <button type="submit" name="save" class="btn btn-primary">
            <i class="bi bi-check-lg me-2"></i>
            {% if form.instance.pk %}Update Product{% else %}Create Product{% endif %}
          </button>
          {% if not form.instance.pk %}
          <button type="submit" name="save_and_add" class="btn btn-success">
            <i class="bi bi-plus-lg me-2"></i>Save & Add Another
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</form>

<script>
// Auto-calculate markup percentage
document.addEventListener('DOMContentLoaded', function() {
    const costField = document.getElementById('id_cost_price');
    const sellingField = document.getElementById('id_selling_price');
    const markupField = document.getElementById('id_markup_percentage');
    
    function calculateMarkup() {
        if (costField && sellingField && markupField) {
            const cost = parseFloat(costField.value) || 0;
            const selling = parseFloat(sellingField.value) || 0;
            
            if (cost > 0) {
                const markup = ((selling - cost) / cost) * 100;
                markupField.value = markup.toFixed(2);
            }
        }
    }
    
    if (costField && sellingField) {
        costField.addEventListener('input', calculateMarkup);
        sellingField.addEventListener('input', calculateMarkup);
    }
});

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();
</script>
{% endblock %}