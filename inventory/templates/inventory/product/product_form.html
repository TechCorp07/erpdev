{% extends "inventory_base.html" %}
{% load static %}

{% block inventory_title %}
  {% if object %}Edit {{ object.name }}{% else %}Add New Product{% endif %}
{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
  .form-card {
    background: white;
    border: 1px solid #e3e6f0;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
  }
  
  .form-section-header {
    color: #5a5c69;
    font-weight: 600;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e3e6f0;
    display: flex;
    align-items: center;
  }
  
  .form-section-header i {
    font-size: 1.25rem;
    margin-right: 0.75rem;
    color: #667eea;
  }
  
  .form-control:focus,
  .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  .required-field {
    color: #dc3545;
  }
  
  .field-help {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }
  
  .pricing-calculator {
    background: #f8f9fc;
    border: 1px solid #e3e6f0;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
  }
  
  .calculated-field {
    background: #e8f5e8;
    border-color: #28a745;
  }
  
  .image-upload-area {
    border: 2px dashed #d1d3e2;
    border-radius: 0.75rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .image-upload-area:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
  }
  
  .image-upload-area.dragover {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.05);
  }
  
  .preview-image {
    max-width: 200px;
    max-height: 200px;
    border-radius: 0.5rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
  }
  
  .validation-error {
    border-color: #dc3545 !important;
    background: rgba(220, 53, 69, 0.05);
  }
  
  .validation-success {
    border-color: #28a745 !important;
    background: rgba(40, 167, 69, 0.05);
  }
  
  .barcode-generator {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 0.5rem;
  }
  
  .supplier-info {
    background: #f8f9fc;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 0.5rem;
  }
  
  @media (max-width: 768px) {
    .form-card {
      padding: 1.5rem;
    }
    
    .form-section-header {
      font-size: 1rem;
    }
  }
</style>
{% endblock %}

{% block inventory_breadcrumbs %}
  {% with inventory_breadcrumbs=breadcrumbs %}
    {{ block.super }}
  {% endwith %}
{% endblock %}

{% block inventory_actions %}
<div class="btn-group" role="group">
  <a href="{% if object %}{% url 'inventory:product_detail' object.pk %}{% else %}{% url 'inventory:product_list' %}{% endif %}" 
     class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left me-1"></i>Cancel
  </a>
  <button type="submit" form="productForm" class="btn btn-primary btn-sm">
    <i class="bi bi-check me-1"></i>
    {% if object %}Update Product{% else %}Create Product{% endif %}
  </button>
  {% if object %}
    <a href="{% url 'inventory:product_duplicate' object.pk %}" 
       class="btn btn-info btn-sm">
      <i class="bi bi-files me-1"></i>Duplicate
    </a>
  {% endif %}
</div>
{% endblock %}

{% block inventory_content %}
<form method="post" enctype="multipart/form-data" id="productForm" novalidate>
  {% csrf_token %}
  
  <!-- Progress Indicator -->
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="text-muted mb-0">Form Progress</h6>
      <span class="badge bg-primary" id="completionBadge">0% Complete</span>
    </div>
    <div class="progress mt-2" style="height: 6px;">
      <div class="progress-bar" id="completionProgress" 
           role="progressbar" style="width: 0%"></div>
    </div>
  </div>
  
  <!-- Basic Information Section -->
  <div class="form-card">
    <h5 class="form-section-header">
      <i class="bi bi-info-circle"></i>
      Basic Information
    </h5>
    
    <div class="row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-8 mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">
              Product Name <span class="required-field">*</span>
            </label>
            {{ form.name }}
            {% if form.name.errors %}
              <div class="text-danger small mt-1">{{ form.name.errors.0 }}</div>
            {% endif %}
            <div class="field-help">Enter a descriptive name for the product</div>
          </div>
          
          <div class="col-md-4 mb-3">
            <label for="{{ form.sku.id_for_label }}" class="form-label">
              SKU <span class="required-field">*</span>
              <button type="button" class="btn btn-sm btn-outline-secondary ms-1" 
                      onclick="generateSKU()" data-bs-toggle="tooltip" title="Generate SKU">
                <i class="bi bi-gear"></i>
              </button>
            </label>
            {{ form.sku }}
            {% if form.sku.errors %}
              <div class="text-danger small mt-1">{{ form.sku.errors.0 }}</div>
            {% endif %}
            <div class="field-help">Unique product identifier</div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.category.id_for_label }}" class="form-label">
              Category <span class="required-field">*</span>
            </label>
            {{ form.category }}
            {% if form.category.errors %}
              <div class="text-danger small mt-1">{{ form.category.errors.0 }}</div>
            {% endif %}
          </div>
          
          <div class="col-md-6 mb-3">
            <label for="{{ form.supplier.id_for_label }}" class="form-label">
              Supplier <span class="required-field">*</span>
            </label>
            {{ form.supplier }}
            {% if form.supplier.errors %}
              <div class="text-danger small mt-1">{{ form.supplier.errors.0 }}</div>
            {% endif %}
            <div id="supplierInfo" class="supplier-info d-none">
              <!-- Supplier details will be populated here -->
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="{{ form.product_type.id_for_label }}" class="form-label">Product Type</label>
            {{ form.product_type }}
          </div>
          
          <div class="col-md-4 mb-3">
            <label for="{{ form.brand.id_for_label }}" class="form-label">Brand</label>
            {{ form.brand }}
          </div>
          
          <div class="col-md-4 mb-3">
            <label for="{{ form.model_number.id_for_label }}" class="form-label">Model Number</label>
            {{ form.model_number }}
          </div>
        </div>
        
        <div class="mb-3">
          <label for="{{ form.short_description.id_for_label }}" class="form-label">Short Description</label>
          {{ form.short_description }}
          <div class="field-help">Brief description for listings and quotes</div>
        </div>
        
        <div class="mb-3">
          <label for="{{ form.description.id_for_label }}" class="form-label">
            Full Description <span class="required-field">*</span>
          </label>
          {{ form.description }}
          {% if form.description.errors %}
            <div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>
          {% endif %}
          <div class="field-help">Detailed product description</div>
        </div>
      </div>
      
      <div class="col-md-4">
        <!-- Product Image Upload -->
        <div class="mb-3">
          <label class="form-label">Product Image</label>
          <div class="image-upload-area" onclick="document.getElementById('id_image').click()">
            <div id="imagePreview">
              {% if object and object.image %}
                <img src="{{ object.image.url }}" alt="Product Image" class="preview-image mb-2">
                <br>
              {% else %}
                <i class="bi bi-cloud-upload fs-1 text-muted mb-2"></i>
                <br>
              {% endif %}
              <p class="mb-1">Click to upload or drag image here</p>
              <small class="text-muted">PNG, JPG up to 5MB</small>
            </div>
            <input type="file" id="id_image" name="image" accept="image/*" class="d-none">
          </div>
        </div>
        
        <!-- Barcode Section -->
        <div class="mb-3">
          <label for="{{ form.barcode.id_for_label }}" class="form-label">
            Barcode
            <button type="button" class="btn btn-sm btn-outline-warning ms-1" 
                    onclick="generateBarcode()" data-bs-toggle="tooltip" title="Generate Barcode">
              <i class="bi bi-upc-scan"></i>
            </button>
          </label>
          {{ form.barcode }}
          {% if form.barcode.errors %}
            <div class="text-danger small mt-1">{{ form.barcode.errors.0 }}</div>
          {% endif %}
          <div class="field-help">Barcode for scanning</div>
          
          <div id="barcodeGenerator" class="barcode-generator d-none">
            <small><strong>Auto-generate barcode?</strong></small>
            <div class="mt-2">
              <button type="button" class="btn btn-sm btn-warning me-2" onclick="generateEAN13()">EAN-13</button>
              <button type="button" class="btn btn-sm btn-info" onclick="generateUPC()">UPC</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Pricing Information Section -->
  <div class="form-card">
    <h5 class="form-section-header">
      <i class="bi bi-currency-dollar"></i>
      Pricing Information
    </h5>
    
    <div class="row">
      <div class="col-md-4 mb-3">
        <label for="{{ form.cost_price.id_for_label }}" class="form-label">
          Cost Price <span class="required-field">*</span>
        </label>
        <div class="input-group">
          <span class="input-group-text">$</span>
          {{ form.cost_price }}
        </div>
        {% if form.cost_price.errors %}
          <div class="text-danger small mt-1">{{ form.cost_price.errors.0 }}</div>
        {% endif %}
        <div class="field-help">Your cost from supplier</div>
      </div>
      
      <div class="col-md-4 mb-3">
        <label for="{{ form.selling_price.id_for_label }}" class="form-label">
          Selling Price <span class="required-field">*</span>
        </label>
        <div class="input-group">
          <span class="input-group-text">$</span>
          {{ form.selling_price }}
        </div>
        {% if form.selling_price.errors %}
          <div class="text-danger small mt-1">{{ form.selling_price.errors.0 }}</div>
        {% endif %}
        <div class="field-help">Customer selling price</div>
      </div>
      
      <div class="col-md-4 mb-3">
        <label for="{{ form.currency.id_for_label }}" class="form-label">Currency</label>
        {{ form.currency }}
      </div>
    </div>
    
    <!-- Pricing Calculator -->
    <div class="pricing-calculator">
      <h6 class="mb-3">
        <i class="bi bi-calculator me-2"></i>Pricing Calculator
      </h6>
      
      <div class="row">
        <div class="col-md-3">
          <label class="form-label">Markup %</label>
          <div class="input-group">
            <input type="number" class="form-control" id="markupPercent" 
                   placeholder="30" step="0.1" min="0">
            <span class="input-group-text">%</span>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Profit Margin %</label>
          <input type="text" class="form-control calculated-field" id="profitMargin" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Profit Amount</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="text" class="form-control calculated-field" id="profitAmount" readonly>
          </div>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="button" class="btn btn-primary btn-sm w-100" onclick="applyMarkup()">
            Apply Markup
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Stock Management Section -->
  <div class="form-card">
    <h5 class="form-section-header">
      <i class="bi bi-box-seam"></i>
      Stock Management
    </h5>
    
    <div class="row">
      <div class="col-md-3 mb-3">
        <label for="{{ form.reorder_level.id_for_label }}" class="form-label">
          Reorder Level <span class="required-field">*</span>
        </label>
        {{ form.reorder_level }}
        {% if form.reorder_level.errors %}
          <div class="text-danger small mt-1">{{ form.reorder_level.errors.0 }}</div>
        {% endif %}
        <div class="field-help">Minimum stock before reordering</div>
      </div>
      
      <div class="col-md-3 mb-3">
        <label for="{{ form.reorder_quantity.id_for_label }}" class="form-label">
          Reorder Quantity <span class="required-field">*</span>
        </label>
        {{ form.reorder_quantity }}
        {% if form.reorder_quantity.errors %}
          <div class="text-danger small mt-1">{{ form.reorder_quantity.errors.0 }}</div>
        {% endif %}
        <div class="field-help">Quantity to order when restocking</div>
      </div>
      
      <div class="col-md-3 mb-3">
        <label for="{{ form.max_stock_level.id_for_label }}" class="form-label">Max Stock Level</label>
        {{ form.max_stock_level }}
        <div class="field-help">Maximum inventory to maintain</div>
      </div>
      
      {% if object %}
        <div class="col-md-3 mb-3">
          <label class="form-label">Current Stock</label>
          <input type="text" class="form-control" value="{{ object.current_stock }}" readonly>
          <div class="field-help">Current inventory level</div>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Supplier Information Section -->
  <div class="form-card">
    <h5 class="form-section-header">
      <i class="bi bi-building"></i>
      Supplier Information
    </h5>
    
    <div class="row">
      <div class="col-md-4 mb-3">
        <label for="{{ form.supplier_sku.id_for_label }}" class="form-label">Supplier SKU</label>
        {{ form.supplier_sku }}
        <div class="field-help">Supplier's product code</div>
      </div>
      
      <div class="col-md-4 mb-3">
        <label for="{{ form.supplier_lead_time_days.id_for_label }}" class="form-label">Lead Time (Days)</label>
        {{ form.supplier_lead_time_days }}
        <div class="field-help">Delivery time from supplier</div>
      </div>
      
      <div class="col-md-4 mb-3">
        <label for="{{ form.minimum_order_quantity.id_for_label }}" class="form-label">Minimum Order Qty</label>
        {{ form.minimum_order_quantity }}
        <div class="field-help">Minimum order from supplier</div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="{{ form.manufacturer_part_number.id_for_label }}" class="form-label">Manufacturer Part Number</label>
        {{ form.manufacturer_part_number }}
      </div>
    </div>
  </div>
  
  <!-- Physical Attributes Section -->
  <div class="form-card">
    <h5 class="form-section-header">
      <i class="bi bi-rulers"></i>
      Physical Attributes
    </h5>
    
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="{{ form.weight.id_for_label }}" class="form-label">Weight (kg)</label>
        <div class="input-group">
          {{ form.weight }}
          <span class="input-group-text">kg</span>
        </div>
        <div class="field-help">Product weight in kilograms</div>
      </div>
      
      <div class="col-md-6 mb-3">
        <label for="{{ form.dimensions.id_for_label }}" class="form-label">Dimensions</label>
        {{ form.dimensions }}
        <div class="field-help">Length × Width × Height in cm</div>
      </div>
    </div>
  </div>
  
  <!-- Product Flags Section -->
  <div class="form-card">
    <h5 class="form-section-header">
      <i class="bi bi-flag"></i>
      Product Settings
    </h5>
    
    <div class="row">
      <div class="col-md-6">
        <div class="form-check mb-3">
          {{ form.is_active }}
          <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
            Active Product
          </label>
          <div class="field-help">Available for sale and ordering</div>
        </div>
        
        <div class="form-check mb-3">
          {{ form.is_serialized }}
          <label class="form-check-label" for="{{ form.is_serialized.id_for_label }}">
            Serialized Product
          </label>
          <div class="field-help">Track individual serial numbers</div>
        </div>
        
        <div class="form-check mb-3">
          {{ form.is_perishable }}
          <label class="form-check-label" for="{{ form.is_perishable.id_for_label }}">
            Perishable Product
          </label>
          <div class="field-help">Has expiration date</div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="form-check mb-3">
          {{ form.requires_quality_check }}
          <label class="form-check-label" for="{{ form.requires_quality_check.id_for_label }}">
            Requires Quality Check
          </label>
          <div class="field-help">QC before sale</div>
        </div>
        
        <div class="form-check mb-3">
          {{ form.is_quotable }}
          <label class="form-check-label" for="{{ form.is_quotable.id_for_label }}">
            Quotable Product
          </label>
          <div class="field-help">Can be included in quotes</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Quote Settings Section -->
  <div class="form-card">
    <h5 class="form-section-header">
      <i class="bi bi-file-earmark-text"></i>
      Quote Settings
    </h5>
    
    <div class="row">
      <div class="col-md-12 mb-3">
        <label for="{{ form.quote_description.id_for_label }}" class="form-label">Quote Description</label>
        {{ form.quote_description }}
        <div class="field-help">Description to use in quotes (if different from main description)</div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-md-4 mb-3">
        <label for="{{ form.minimum_quote_quantity.id_for_label }}" class="form-label">Minimum Quote Quantity</label>
        {{ form.minimum_quote_quantity }}
        <div class="field-help">Minimum quantity for quotes</div>
      </div>
      
      <div class="col-md-4 mb-3">
        <label for="{{ form.bulk_discount_threshold.id_for_label }}" class="form-label">Bulk Discount Threshold</label>
        {{ form.bulk_discount_threshold }}
        <div class="field-help">Quantity threshold for bulk pricing</div>
      </div>
      
      <div class="col-md-4 mb-3">
        <label for="{{ form.bulk_discount_percentage.id_for_label }}" class="form-label">Bulk Discount %</label>
        <div class="input-group">
          {{ form.bulk_discount_percentage }}
          <span class="input-group-text">%</span>
        </div>
        <div class="field-help">Discount percentage for bulk orders</div>
      </div>
    </div>
  </div>
  
  <!-- SEO & Marketing Section -->
  <div class="form-card">
    <h5 class="form-section-header">
      <i class="bi bi-search"></i>
      SEO & Marketing
    </h5>
    
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="{{ form.meta_title.id_for_label }}" class="form-label">Meta Title</label>
        {{ form.meta_title }}
        <div class="field-help">SEO title for web listings</div>
      </div>
      
      <div class="col-md-6 mb-3">
        <label for="{{ form.meta_description.id_for_label }}" class="form-label">Meta Description</label>
        {{ form.meta_description }}
        <div class="field-help">SEO description for search engines</div>
      </div>
    </div>
  </div>
  
  <!-- Form Actions -->
  <div class="form-card">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <button type="button" class="btn btn-outline-secondary" onclick="validateForm()">
          <i class="bi bi-check-circle me-1"></i>Validate Form
        </button>
        <button type="button" class="btn btn-outline-info ms-2" onclick="previewProduct()">
          <i class="bi bi-eye me-1"></i>Preview
        </button>
      </div>
      
      <div>
        <a href="{% if object %}{% url 'inventory:product_detail' object.pk %}{% else %}{% url 'inventory:product_list' %}{% endif %}" 
           class="btn btn-secondary me-2">
          Cancel
        </a>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check me-1"></i>
          {% if object %}Update Product{% else %}Create Product{% endif %}
        </button>
      </div>
    </div>
  </div>
</form>

<!-- Product Preview Modal -->
<div class="modal fade" id="productPreviewModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Product Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="previewContent">
        <!-- Preview content will be populated here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" form="productForm" class="btn btn-primary">Save Product</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize form functionality
  setupFormValidation();
  setupImageUpload();
  setupSupplierInfo();
  setupPricingCalculator();
  updateFormProgress();
  
  // Real-time validation
  document.querySelectorAll('input, select, textarea').forEach(field => {
    field.addEventListener('input', updateFormProgress);
    field.addEventListener('blur', validateField);
  });
  
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

function setupFormValidation() {
  const form = document.getElementById('productForm');
  
  form.addEventListener('submit', function(e) {
    if (!validateForm()) {
      e.preventDefault();
      e.stopPropagation();
    }
  });
}

function validateForm() {
  let isValid = true;
  const requiredFields = document.querySelectorAll('input[required], select[required], textarea[required]');
  
  requiredFields.forEach(field => {
    if (!field.value.trim()) {
      field.classList.add('validation-error');
      isValid = false;
    } else {
      field.classList.remove('validation-error');
      field.classList.add('validation-success');
    }
  });
  
  // Custom validations
  const costPrice = parseFloat(document.getElementById('{{ form.cost_price.id_for_label }}').value) || 0;
  const sellingPrice = parseFloat(document.getElementById('{{ form.selling_price.id_for_label }}').value) || 0;
  
  if (sellingPrice < costPrice) {
    showAlert('Selling price cannot be less than cost price', 'warning');
    isValid = false;
  }
  
  // SKU uniqueness check
  const skuField = document.getElementById('{{ form.sku.id_for_label }}');
  if (skuField.value) {
    checkSKUAvailability(skuField.value);
  }
  
  if (isValid) {
    showAlert('Form validation passed!', 'success');
  } else {
    showAlert('Please fix the highlighted errors', 'danger');
  }
  
  return isValid;
}

function validateField(event) {
  const field = event.target;
  
  if (field.required && !field.value.trim()) {
    field.classList.add('validation-error');
    field.classList.remove('validation-success');
  } else if (field.value.trim()) {
    field.classList.remove('validation-error');
    field.classList.add('validation-success');
  }
}

function updateFormProgress() {
  const allFields = document.querySelectorAll('input, select, textarea');
  const filledFields = Array.from(allFields).filter(field => {
    if (field.type === 'checkbox') return field.checked;
    return field.value.trim() !== '';
  });
  
  const progress = Math.round((filledFields.length / allFields.length) * 100);
  
  document.getElementById('completionProgress').style.width = progress + '%';
  document.getElementById('completionBadge').textContent = progress + '% Complete';
  
  if (progress >= 80) {
    document.getElementById('completionProgress').classList.add('bg-success');
  } else if (progress >= 50) {
    document.getElementById('completionProgress').classList.add('bg-warning');
  }
}

function setupImageUpload() {
  const uploadArea = document.querySelector('.image-upload-area');
  const fileInput = document.getElementById('id_image');
  
  // Drag and drop functionality
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  
  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
  });
  
  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      handleImagePreview(files[0]);
    }
  });
  
  fileInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      handleImagePreview(e.target.files[0]);
    }
  });
}

function handleImagePreview(file) {
  if (file && file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('imagePreview').innerHTML = `
        <img src="${e.target.result}" alt="Preview" class="preview-image mb-2">
        <br>
        <p class="mb-1">${file.name}</p>
        <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
      `;
    };
    reader.readAsDataURL(file);
  }
}

function setupSupplierInfo() {
  const supplierSelect = document.getElementById('{{ form.supplier.id_for_label }}');
  
  supplierSelect.addEventListener('change', function() {
    if (this.value) {
      fetchSupplierInfo(this.value);
    } else {
      document.getElementById('supplierInfo').classList.add('d-none');
    }
  });
}

function fetchSupplierInfo(supplierId) {
  fetch(`{% url 'inventory:supplier_details_api' 0 %}`.replace('0', supplierId))
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('supplierInfo').innerHTML = `
          <small><strong>${data.supplier.name}</strong></small>
          <br><small>Lead Time: ${data.supplier.average_lead_time_days} days</small>
          <br><small>Currency: ${data.supplier.currency}</small>
          <br><small>Country: ${data.supplier.country}</small>
        `;
        document.getElementById('supplierInfo').classList.remove('d-none');
        
        // Auto-populate lead time
        document.getElementById('{{ form.supplier_lead_time_days.id_for_label }}').value = data.supplier.average_lead_time_days;
      }
    })
    .catch(error => console.error('Error fetching supplier info:', error));
}

function setupPricingCalculator() {
  const costPriceField = document.getElementById('{{ form.cost_price.id_for_label }}');
  const sellingPriceField = document.getElementById('{{ form.selling_price.id_for_label }}');
  
  [costPriceField, sellingPriceField].forEach(field => {
    field.addEventListener('input', calculateProfitMetrics);
  });
}

function calculateProfitMetrics() {
  const costPrice = parseFloat(document.getElementById('{{ form.cost_price.id_for_label }}').value) || 0;
  const sellingPrice = parseFloat(document.getElementById('{{ form.selling_price.id_for_label }}').value) || 0;
  
  if (costPrice > 0) {
    const profitAmount = sellingPrice - costPrice;
    const profitMargin = (profitAmount / costPrice) * 100;
    
    document.getElementById('profitAmount').value = profitAmount.toFixed(2);
    document.getElementById('profitMargin').value = profitMargin.toFixed(1) + '%';
    
    // Update markup percentage
    const markup = (profitAmount / costPrice) * 100;
    document.getElementById('markupPercent').value = markup.toFixed(1);
  }
}

function applyMarkup() {
  const costPrice = parseFloat(document.getElementById('{{ form.cost_price.id_for_label }}').value) || 0;
  const markupPercent = parseFloat(document.getElementById('markupPercent').value) || 0;
  
  if (costPrice > 0 && markupPercent > 0) {
    const sellingPrice = costPrice * (1 + markupPercent / 100);
    document.getElementById('{{ form.selling_price.id_for_label }}').value = sellingPrice.toFixed(2);
    calculateProfitMetrics();
    
    showAlert(`Selling price updated with ${markupPercent}% markup`, 'success');
  } else {
    showAlert('Please enter valid cost price and markup percentage', 'warning');
  }
}

function generateSKU() {
  const categorySelect = document.getElementById('{{ form.category.id_for_label }}');
  const nameField = document.getElementById('{{ form.name.id_for_label }}');
  
  if (!categorySelect.value) {
    showAlert('Please select a category first', 'warning');
    return;
  }
  
  // Get category name
  const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
  const categoryPrefix = categoryName.substring(0, 3).toUpperCase();
  
  // Get current year
  const year = new Date().getFullYear();
  
  // Generate random number
  const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  
  const generatedSKU = `${categoryPrefix}-${year}-${randomNum}`;
  
  document.getElementById('{{ form.sku.id_for_label }}').value = generatedSKU;
  
  // Check availability
  checkSKUAvailability(generatedSKU);
}

function checkSKUAvailability(sku) {
  const productId = {% if object %}{{ object.pk }}{% else %}null{% endif %};
  
  fetch(`{% url 'inventory:check_sku_availability' %}?sku=${encodeURIComponent(sku)}${productId ? '&product_id=' + productId : ''}`)
    .then(response => response.json())
    .then(data => {
      const skuField = document.getElementById('{{ form.sku.id_for_label }}');
      
      if (data.available) {
        skuField.classList.remove('validation-error');
        skuField.classList.add('validation-success');
      } else {
        skuField.classList.add('validation-error');
        skuField.classList.remove('validation-success');
        showAlert('SKU already exists. Please choose a different SKU.', 'danger');
      }
    })
    .catch(error => console.error('SKU check error:', error));
}

function generateBarcode() {
  document.getElementById('barcodeGenerator').classList.toggle('d-none');
}

function generateEAN13() {
  // Generate a random EAN-13 barcode
  const countryCode = '123'; // Placeholder country code
  const manufacturerCode = Math.floor(Math.random() * 100000).toString().padStart(5, '0');
  const productCode = Math.floor(Math.random() * 100000).toString().padStart(5, '0');
  
  // Calculate check digit (simplified)
  const digits = (countryCode + manufacturerCode + productCode).split('').map(Number);
  let checkSum = 0;
  for (let i = 0; i < digits.length; i++) {
    checkSum += digits[i] * (i % 2 === 0 ? 1 : 3);
  }
  const checkDigit = (10 - (checkSum % 10)) % 10;
  
  const ean13 = countryCode + manufacturerCode + productCode + checkDigit;
  document.getElementById('{{ form.barcode.id_for_label }}').value = ean13;
  
  showAlert('EAN-13 barcode generated', 'success');
}

function generateUPC() {
  // Generate a random UPC barcode
  const manufacturerCode = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
  const productCode = Math.floor(Math.random() * 100000).toString().padStart(5, '0');
  
  // Calculate check digit (simplified)
  const digits = (manufacturerCode + productCode).split('').map(Number);
  let checkSum = 0;
  for (let i = 0; i < digits.length; i++) {
    checkSum += digits[i] * (i % 2 === 0 ? 3 : 1);
  }
  const checkDigit = (10 - (checkSum % 10)) % 10;
  
  const upc = manufacturerCode + productCode + checkDigit;
  document.getElementById('{{ form.barcode.id_for_label }}').value = upc;
  
  showAlert('UPC barcode generated', 'success');
}

function previewProduct() {
  const formData = new FormData(document.getElementById('productForm'));
  const previewData = {};
  
  for (let [key, value] of formData.entries()) {
    previewData[key] = value;
  }
  
  // Create preview content
  const previewContent = `
    <div class="row">
      <div class="col-md-4 text-center">
        ${document.getElementById('imagePreview').innerHTML}
      </div>
      <div class="col-md-8">
        <h4>${previewData.name || 'Product Name'}</h4>
        <p class="text-muted">${previewData.short_description || previewData.description || 'No description'}</p>
        <table class="table table-sm">
          <tr><td><strong>SKU:</strong></td><td>${previewData.sku || 'Not set'}</td></tr>
          <tr><td><strong>Category:</strong></td><td>${document.getElementById('{{ form.category.id_for_label }}').selectedOptions[0]?.text || 'Not selected'}</td></tr>
          <tr><td><strong>Supplier:</strong></td><td>${document.getElementById('{{ form.supplier.id_for_label }}').selectedOptions[0]?.text || 'Not selected'}</td></tr>
          <tr><td><strong>Cost Price:</strong></td><td>$${previewData.cost_price || '0.00'}</td></tr>
          <tr><td><strong>Selling Price:</strong></td><td>$${previewData.selling_price || '0.00'}</td></tr>
          <tr><td><strong>Reorder Level:</strong></td><td>${previewData.reorder_level || '0'}</td></tr>
        </table>
      </div>
    </div>
  `;
  
  document.getElementById('previewContent').innerHTML = previewContent;
  
  const modal = new bootstrap.Modal(document.getElementById('productPreviewModal'));
  modal.show();
}

function showAlert(message, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 1060; min-width: 300px;';
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alertDiv);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 5000);
}

// Auto-save functionality (optional)
function setupAutoSave() {
  let autoSaveTimeout;
  
  document.querySelectorAll('input, select, textarea').forEach(field => {
    field.addEventListener('input', function() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        // Save draft to localStorage
        const formData = new FormData(document.getElementById('productForm'));
        const draftData = {};
        for (let [key, value] of formData.entries()) {
          draftData[key] = value;
        }
        localStorage.setItem('productFormDraft', JSON.stringify(draftData));
      }, 2000);
    });
  });
}

// setupAutoSave(); // Uncomment to enable auto-save
</script>
{% endblock %}
