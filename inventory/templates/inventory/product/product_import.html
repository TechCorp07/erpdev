{% extends "inventory_base.html" %}
{% load static %}

{% block inventory_title %}Bulk Product Import{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
  .import-wizard {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }
  
  .wizard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
  }
  
  .wizard-steps {
    display: flex;
    justify-content: center;
    padding: 1.5rem;
    background: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
  }
  
  .wizard-step {
    display: flex;
    align-items: center;
    margin: 0 1rem;
    color: #6c757d;
    font-weight: 500;
  }
  
  .wizard-step.active {
    color: #5a5c69;
  }
  
  .wizard-step.completed {
    color: #28a745;
  }
  
  .step-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.5rem;
    border: 2px solid currentColor;
    font-weight: bold;
    font-size: 0.875rem;
  }
  
  .wizard-step.active .step-number {
    background: #5a5c69;
    color: white;
  }
  
  .wizard-step.completed .step-number {
    background: #28a745;
    color: white;
    border-color: #28a745;
  }
  
  .file-drop-zone {
    border: 3px dashed #d1d3e2;
    border-radius: 1rem;
    padding: 3rem;
    text-align: center;
    transition: all 0.3s ease;
    background: #f8f9fc;
  }
  
  .file-drop-zone:hover,
  .file-drop-zone.dragover {
    border-color: #5a5c69;
    background: #eaecf4;
  }
  
  .file-drop-zone.has-file {
    border-color: #28a745;
    background: #d4edda;
  }
  
  .progress-container {
    background: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin: 1rem 0;
    border: 1px solid #e3e6f0;
  }
  
  .import-results {
    background: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin: 1rem 0;
  }
  
  .result-metric {
    text-align: center;
    padding: 1rem;
    border-radius: 0.5rem;
    margin: 0.5rem;
  }
  
  .result-metric.success { background: #d4edda; color: #155724; }
  .result-metric.warning { background: #fff3cd; color: #856404; }
  .result-metric.danger { background: #f8d7da; color: #721c24; }
  .result-metric.info { background: #d1ecf1; color: #0c5460; }
  
  .error-list {
    max-height: 300px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
  }
  
  .mapping-section {
    background: #f8f9fc;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin: 1rem 0;
  }
  
  .field-mapping {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: white;
    border-radius: 0.5rem;
    border: 1px solid #e3e6f0;
  }
  
  .field-mapping label {
    min-width: 150px;
    font-weight: 500;
    margin-bottom: 0;
  }
  
  @media (max-width: 768px) {
    .wizard-steps {
      flex-direction: column;
      gap: 1rem;
    }
    
    .wizard-step {
      margin: 0;
    }
    
    .file-drop-zone {
      padding: 2rem 1rem;
    }
    
    .field-mapping {
      flex-direction: column;
      align-items: stretch;
    }
    
    .field-mapping label {
      min-width: auto;
      margin-bottom: 0.5rem;
    }
  }
</style>
{% endblock %}

{% block inventory_breadcrumbs %}
  <li class="breadcrumb-item"><a href="{% url 'inventory:product_list' %}">Products</a></li>
  <li class="breadcrumb-item active">Bulk Import</li>
{% endblock %}

{% block inventory_actions %}
<div class="btn-group" role="group">
  <a href="{% url 'inventory:product_import_template' %}" class="btn btn-outline-success btn-sm">
    <i class="bi bi-download me-1"></i>Download Template
  </a>
  <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left me-1"></i>Back to Products
  </a>
</div>
{% endblock %}

{% block inventory_content %}
<div class="import-wizard">
  <!-- Wizard Header -->
  <div class="wizard-header">
    <h2 class="mb-2">
      <i class="bi bi-upload me-2"></i>Bulk Product Import
    </h2>
    <p class="mb-0">Import multiple products from CSV or Excel files with intelligent validation and mapping</p>
  </div>

  <!-- Wizard Steps -->
  <div class="wizard-steps">
    <div class="wizard-step" id="step1" data-step="1">
      <div class="step-number">1</div>
      <span>Upload File</span>
    </div>
    <div class="wizard-step" id="step2" data-step="2">
      <div class="step-number">2</div>
      <span>Map Fields</span>
    </div>
    <div class="wizard-step" id="step3" data-step="3">
      <div class="step-number">3</div>
      <span>Validate</span>
    </div>
    <div class="wizard-step" id="step4" data-step="4">
      <div class="step-number">4</div>
      <span>Import</span>
    </div>
  </div>

  <!-- Wizard Content -->
  <div class="wizard-content p-4">
    <!-- Step 1: File Upload -->
    <div class="wizard-panel" id="panel1">
      <div class="row">
        <div class="col-lg-8">
          <h4 class="mb-3">
            <i class="bi bi-file-earmark-arrow-up me-2"></i>Select Import File
          </h4>
          
          <form id="uploadForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="file-drop-zone" id="dropZone">
              <i class="bi bi-cloud-upload display-1 text-muted mb-3"></i>
              <h5>Drag and drop your file here</h5>
              <p class="text-muted mb-3">or click to browse</p>
              <input type="file" 
                     id="fileInput" 
                     name="import_file" 
                     accept=".csv,.xlsx,.xls" 
                     style="display: none;">
              <button type="button" 
                      class="btn btn-primary" 
                      onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-folder-open me-2"></i>Choose File
              </button>
              <div class="mt-3">
                <small class="text-muted">
                  Supported formats: CSV, Excel (.xlsx, .xls) | Max size: 10MB
                </small>
              </div>
            </div>
            
            <div id="fileInfo" class="mt-3" style="display: none;">
              <div class="alert alert-info">
                <div class="d-flex align-items-center">
                  <i class="bi bi-file-earmark-check fs-3 me-3"></i>
                  <div>
                    <strong id="fileName"></strong>
                    <div class="small text-muted">
                      Size: <span id="fileSize"></span> | 
                      Type: <span id="fileType"></span>
                    </div>
                  </div>
                  <button type="button" class="btn btn-outline-danger btn-sm ms-auto" onclick="removeFile()">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
              </div>
            </div>
          </form>

          <!-- Import Options -->
          <div class="mt-4">
            <h5>Import Options</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateExisting" checked>
                  <label class="form-check-label" for="updateExisting">
                    Update existing products
                  </label>
                  <small class="form-text text-muted d-block">
                    Update products with matching SKUs instead of skipping them
                  </small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="createCategories">
                  <label class="form-check-label" for="createCategories">
                    Auto-create categories
                  </label>
                  <small class="form-text text-muted d-block">
                    Automatically create missing categories
                  </small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="createSuppliers">
                  <label class="form-check-label" for="createSuppliers">
                    Auto-create suppliers
                  </label>
                  <small class="form-text text-muted d-block">
                    Automatically create missing suppliers
                  </small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="validateOnly">
                  <label class="form-check-label" for="validateOnly">
                    Validation only (dry run)
                  </label>
                  <small class="form-text text-muted d-block">
                    Check for errors without importing
                  </small>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 d-flex justify-content-between">
            <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i>Cancel
            </a>
            <button type="button" class="btn btn-primary" id="nextStep1" onclick="nextStep(2)" disabled>
              <i class="bi bi-arrow-right me-2"></i>Next: Map Fields
            </button>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>Import Requirements
              </h6>
            </div>
            <div class="card-body">
              <h6>Required Fields:</h6>
              <ul class="list-unstyled mb-3">
                <li><i class="bi bi-check text-success me-2"></i>Name</li>
                <li><i class="bi bi-check text-success me-2"></i>SKU</li>
                <li><i class="bi bi-check text-success me-2"></i>Category</li>
                <li><i class="bi bi-check text-success me-2"></i>Supplier</li>
              </ul>
              
              <h6>Optional Fields:</h6>
              <ul class="list-unstyled mb-3">
                <li><i class="bi bi-dash text-muted me-2"></i>Description</li>
                <li><i class="bi bi-dash text-muted me-2"></i>Cost Price</li>
                <li><i class="bi bi-dash text-muted me-2"></i>Selling Price</li>
                <li><i class="bi bi-dash text-muted me-2"></i>Current Stock</li>
                <li><i class="bi bi-dash text-muted me-2"></i>Reorder Level</li>
                <li><i class="bi bi-dash text-muted me-2"></i>Barcode</li>
                <li><i class="bi bi-dash text-muted me-2"></i>Brand</li>
              </ul>
              
              <div class="text-center">
                <a href="{% url 'inventory:product_import_template_excel' %}" class="btn btn-outline-success btn-sm">
                  <i class="bi bi-download me-2"></i>Download Template
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Field Mapping -->
    <div class="wizard-panel" id="panel2" style="display: none;">
      <h4 class="mb-3">
        <i class="bi bi-arrow-left-right me-2"></i>Map Your Fields
      </h4>
      <p class="text-muted mb-4">
        Map the columns in your file to the corresponding product fields
      </p>

      <div class="mapping-section">
        <div id="fieldMappings">
          <!-- Dynamic field mappings will be inserted here -->
        </div>
      </div>

      <div class="mt-4 d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" onclick="previousStep(1)">
          <i class="bi bi-arrow-left me-2"></i>Previous
        </button>
        <button type="button" class="btn btn-primary" onclick="nextStep(3)">
          <i class="bi bi-arrow-right me-2"></i>Next: Validate Data
        </button>
      </div>
    </div>

    <!-- Step 3: Validation -->
    <div class="wizard-panel" id="panel3" style="display: none;">
      <h4 class="mb-3">
        <i class="bi bi-shield-check me-2"></i>Validate Import Data
      </h4>
      <p class="text-muted mb-4">
        Review any validation errors before proceeding with the import
      </p>

      <div class="progress-container" id="validationProgress">
        <div class="d-flex align-items-center mb-3">
          <div class="spinner-border spinner-border-sm me-3" role="status"></div>
          <span>Validating import data...</span>
        </div>
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
        </div>
      </div>

      <div id="validationResults" style="display: none;">
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="result-metric info">
              <div class="fs-4 fw-bold" id="totalRows">0</div>
              <div class="small">Total Rows</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="result-metric success">
              <div class="fs-4 fw-bold" id="validRows">0</div>
              <div class="small">Valid Rows</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="result-metric warning">
              <div class="fs-4 fw-bold" id="warningRows">0</div>
              <div class="small">Warnings</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="result-metric danger">
              <div class="fs-4 fw-bold" id="errorRows">0</div>
              <div class="small">Errors</div>
            </div>
          </div>
        </div>

        <div id="validationErrors" style="display: none;">
          <h5 class="text-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>Validation Errors
          </h5>
          <div class="error-list" id="errorsList">
            <!-- Errors will be populated here -->
          </div>
        </div>

        <div id="validationWarnings" style="display: none;">
          <h5 class="text-warning">
            <i class="bi bi-exclamation-circle me-2"></i>Warnings
          </h5>
          <div class="error-list" id="warningsList">
            <!-- Warnings will be populated here -->
          </div>
        </div>
      </div>

      <div class="mt-4 d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" onclick="previousStep(2)">
          <i class="bi bi-arrow-left me-2"></i>Previous
        </button>
        <button type="button" class="btn btn-primary" id="nextStep3" onclick="nextStep(4)" disabled>
          <i class="bi bi-arrow-right me-2"></i>Next: Import Data
        </button>
      </div>
    </div>

    <!-- Step 4: Import -->
    <div class="wizard-panel" id="panel4" style="display: none;">
      <h4 class="mb-3">
        <i class="bi bi-cloud-upload me-2"></i>Import Products
      </h4>
      <p class="text-muted mb-4">
        Ready to import your products. This process may take a few minutes for large files.
      </p>

      <div class="progress-container" id="importProgress">
        <div class="d-flex align-items-center mb-3">
          <div class="spinner-border spinner-border-sm me-3" role="status"></div>
          <span id="importStatus">Starting import...</span>
        </div>
        <div class="progress">
          <div class="progress-bar" id="importProgressBar" style="width: 0%"></div>
        </div>
        <div class="mt-2 text-center">
          <small class="text-muted" id="importDetails">Preparing import...</small>
        </div>
      </div>

      <div class="import-results" id="importResults" style="display: none;">
        <h5 class="text-success mb-3">
          <i class="bi bi-check-circle me-2"></i>Import Complete!
        </h5>
        
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="result-metric info">
              <div class="fs-4 fw-bold" id="importTotal">0</div>
              <div class="small">Total Processed</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="result-metric success">
              <div class="fs-4 fw-bold" id="importCreated">0</div>
              <div class="small">Created</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="result-metric warning">
              <div class="fs-4 fw-bold" id="importUpdated">0</div>
              <div class="small">Updated</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="result-metric danger">
              <div class="fs-4 fw-bold" id="importFailed">0</div>
              <div class="small">Failed</div>
            </div>
          </div>
        </div>

        <div class="text-center">
          <a href="{% url 'inventory:product_list' %}" class="btn btn-success me-2">
            <i class="bi bi-list me-2"></i>View Products
          </a>
          <button type="button" class="btn btn-outline-primary" onclick="startNewImport()">
            <i class="bi bi-upload me-2"></i>Import Another File
          </button>
        </div>
      </div>

      <div class="mt-4 d-flex justify-content-between" id="importActions">
        <button type="button" class="btn btn-outline-secondary" onclick="previousStep(3)">
          <i class="bi bi-arrow-left me-2"></i>Previous
        </button>
        <button type="button" class="btn btn-success" id="startImport" onclick="startImport()">
          <i class="bi bi-play-fill me-2"></i>Start Import
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
let currentStep = 1;
let uploadedFile = null;
let fieldMappings = {};
let validationResults = null;

document.addEventListener('DOMContentLoaded', function() {
  initializeFileUpload();
  updateStepIndicators();
});

function initializeFileUpload() {
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  // Drag and drop functionality
  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFileSelection(files[0]);
    }
  });

  // File input change
  fileInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      handleFileSelection(e.target.files[0]);
    }
  });

  // Click to upload
  dropZone.addEventListener('click', function() {
    fileInput.click();
  });
}

function handleFileSelection(file) {
  // Validate file type
  const allowedTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(csv|xls|xlsx)$/i)) {
    alert('Please select a CSV or Excel file.');
    return;
  }

  // Validate file size (10MB limit)
  if (file.size > 10 * 1024 * 1024) {
    alert('File size must be less than 10MB.');
    return;
  }

  uploadedFile = file;
  
  // Update UI
  document.getElementById('fileName').textContent = file.name;
  document.getElementById('fileSize').textContent = formatFileSize(file.size);
  document.getElementById('fileType').textContent = file.type || 'Unknown';
  
  document.getElementById('fileInfo').style.display = 'block';
  document.getElementById('dropZone').classList.add('has-file');
  document.getElementById('nextStep1').disabled = false;

  // Auto-analyze file headers
  analyzeFileHeaders(file);
}

function removeFile() {
  uploadedFile = null;
  document.getElementById('fileInfo').style.display = 'none';
  document.getElementById('dropZone').classList.remove('has-file');
  document.getElementById('nextStep1').disabled = true;
  document.getElementById('fileInput').value = '';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function analyzeFileHeaders(file) {
  // This would analyze the file headers to prepare field mapping
  // For demo purposes, we'll simulate this
  setTimeout(() => {
    console.log('File headers analyzed');
  }, 1000);
}

function nextStep(step) {
  if (step === 2) {
    // Moving to field mapping
    showFieldMapping();
  } else if (step === 3) {
    // Moving to validation
    startValidation();
  } else if (step === 4) {
    // Moving to import
    prepareImport();
  }
  
  currentStep = step;
  showStep(step);
  updateStepIndicators();
}

function previousStep(step) {
  currentStep = step;
  showStep(step);
  updateStepIndicators();
}

function showStep(step) {
  // Hide all panels
  document.querySelectorAll('.wizard-panel').forEach(panel => {
    panel.style.display = 'none';
  });
  
  // Show current panel
  document.getElementById('panel' + step).style.display = 'block';
}

function updateStepIndicators() {
  document.querySelectorAll('.wizard-step').forEach((step, index) => {
    const stepNumber = index + 1;
    step.classList.remove('active', 'completed');
    
    if (stepNumber < currentStep) {
      step.classList.add('completed');
    } else if (stepNumber === currentStep) {
      step.classList.add('active');
    }
  });
}

function showFieldMapping() {
  // Simulate field detection and mapping
  const detectedFields = ['name', 'sku', 'category', 'supplier', 'cost_price', 'selling_price', 'description'];
  const requiredFields = ['name', 'sku', 'category', 'supplier'];
  const optionalFields = ['cost_price', 'selling_price', 'description', 'barcode', 'brand', 'current_stock', 'reorder_level'];
  
  const mappingsContainer = document.getElementById('fieldMappings');
  mappingsContainer.innerHTML = '';
  
  [...requiredFields, ...optionalFields].forEach(field => {
    const isRequired = requiredFields.includes(field);
    const mappingDiv = document.createElement('div');
    mappingDiv.className = 'field-mapping';
    
    mappingDiv.innerHTML = `
      <label class="form-label ${isRequired ? 'text-danger' : ''}">
        ${isRequired ? '<i class="bi bi-asterisk text-danger me-1" style="font-size: 0.5rem;"></i>' : ''}
        ${field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
      </label>
      <select class="form-select" name="mapping_${field}" ${isRequired ? 'required' : ''}>
        <option value="">-- Select Column --</option>
        ${detectedFields.map(f => `<option value="${f}" ${f === field ? 'selected' : ''}>${f}</option>`).join('')}
      </select>
    `;
    
    mappingsContainer.appendChild(mappingDiv);
  });
}

function startValidation() {
  const progressContainer = document.getElementById('validationProgress');
  const resultsContainer = document.getElementById('validationResults');
  
  progressContainer.style.display = 'block';
  resultsContainer.style.display = 'none';
  
  // Simulate validation process
  let progress = 0;
  const progressBar = progressContainer.querySelector('.progress-bar');
  
  const interval = setInterval(() => {
    progress += Math.random() * 15;
    if (progress > 100) progress = 100;
    
    progressBar.style.width = progress + '%';
    
    if (progress >= 100) {
      clearInterval(interval);
      showValidationResults();
    }
  }, 200);
}

function showValidationResults() {
  document.getElementById('validationProgress').style.display = 'none';
  
  // Simulate validation results
  const results = {
    total: 150,
    valid: 145,
    warnings: 3,
    errors: 2
  };
  
  document.getElementById('totalRows').textContent = results.total;
  document.getElementById('validRows').textContent = results.valid;
  document.getElementById('warningRows').textContent = results.warnings;
  document.getElementById('errorRows').textContent = results.errors;
  
  if (results.errors > 0) {
    document.getElementById('validationErrors').style.display = 'block';
    document.getElementById('errorsList').innerHTML = `
      <div class="alert alert-danger">Row 15: Missing required field 'SKU'</div>
      <div class="alert alert-danger">Row 23: Invalid category 'NonExistent'</div>
    `;
  }
  
  if (results.warnings > 0) {
    document.getElementById('validationWarnings').style.display = 'block';
    document.getElementById('warningsList').innerHTML = `
      <div class="alert alert-warning">Row 45: Cost price is 0, consider updating</div>
      <div class="alert alert-warning">Row 67: Duplicate SKU found in row 89</div>
      <div class="alert alert-warning">Row 92: Supplier 'NewSupplier' will be created</div>
    `;
  }
  
  document.getElementById('validationResults').style.display = 'block';
  document.getElementById('nextStep3').disabled = results.errors > 0;
  
  validationResults = results;
}

function prepareImport() {
  // Show import readiness
  const importOptions = {
    updateExisting: document.getElementById('updateExisting').checked,
    createCategories: document.getElementById('createCategories').checked,
    createSuppliers: document.getElementById('createSuppliers').checked,
    validateOnly: document.getElementById('validateOnly').checked
  };
  
  console.log('Import options:', importOptions);
}

function startImport() {
  const progressContainer = document.getElementById('importProgress');
  const resultsContainer = document.getElementById('importResults');
  const actionsContainer = document.getElementById('importActions');
  
  progressContainer.style.display = 'block';
  resultsContainer.style.display = 'none';
  actionsContainer.style.display = 'none';
  
  // Simulate import process
  let progress = 0;
  let processed = 0;
  const total = validationResults ? validationResults.valid : 145;
  
  const progressBar = document.getElementById('importProgressBar');
  const statusText = document.getElementById('importStatus');
  const detailsText = document.getElementById('importDetails');
  
  const interval = setInterval(() => {
    progress += Math.random() * 10;
    processed = Math.floor((progress / 100) * total);
    
    if (progress > 100) {
      progress = 100;
      processed = total;
    }
    
    progressBar.style.width = progress + '%';
    statusText.textContent = `Importing products... ${processed}/${total}`;
    detailsText.textContent = `Processing row ${processed}`;
    
    if (progress >= 100) {
      clearInterval(interval);
      showImportResults();
    }
  }, 300);
}

function showImportResults() {
  document.getElementById('importProgress').style.display = 'none';
  
  // Simulate import results
  const results = {
    total: 145,
    created: 142,
    updated: 2,
    failed: 1
  };
  
  document.getElementById('importTotal').textContent = results.total;
  document.getElementById('importCreated').textContent = results.created;
  document.getElementById('importUpdated').textContent = results.updated;
  document.getElementById('importFailed').textContent = results.failed;
  
  document.getElementById('importResults').style.display = 'block';
  
  // Show success notification
  InventoryApp.showStockStatusUpdate(
    `Successfully imported ${results.created + results.updated} products!`,
    'success'
  );
}

function startNewImport() {
  // Reset the wizard
  currentStep = 1;
  uploadedFile = null;
  fieldMappings = {};
  validationResults = null;
  
  // Reset UI
  removeFile();
  showStep(1);
  updateStepIndicators();
  
  // Reset form inputs
  document.getElementById('updateExisting').checked = true;
  document.getElementById('createCategories').checked = false;
  document.getElementById('createSuppliers').checked = false;
  document.getElementById('validateOnly').checked = false;
}
</script>
{% endblock %}
