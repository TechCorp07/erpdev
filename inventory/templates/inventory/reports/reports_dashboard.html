{% extends "inventory_base.html" %}
{% load static %}

{% block inventory_title %}
  Reports Dashboard
{% endblock %}

{% block inventory_content %}
<div class="container-fluid mt-3">
  <h1 class="h3 mb-4 text-gray-800">Inventory Reports Dashboard</h1>

  <!-- KPI Cards -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card dashboard-metric info">
        <div class="card-body text-center">
          <div class="h4 mb-1">{{ total_products }}</div>
          <div class="text-xs">Total Products</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card dashboard-metric success">
        <div class="card-body text-center">
          <div class="h4 mb-1">${{ total_stock_value|floatformat:0 }}</div>
          <div class="text-xs">Stock Value</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card dashboard-metric warning">
        <div class="card-body text-center">
          <div class="h4 mb-1">{{ low_stock_count }}</div>
          <div class="text-xs">Low Stock</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card dashboard-metric critical">
        <div class="card-body text-center">
          <div class="h4 mb-1">{{ out_of_stock_count }}</div>
          <div class="text-xs">Out of Stock</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Analytics Section -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-clipboard-data"></i> Reports & Actions
          </h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li><a href="{% url 'inventory:valuation_report' %}"><i class="bi bi-bar-chart me-1"></i> Stock Valuation Report</a></li>
            <li><a href="{% url 'inventory:low_stock_report' %}"><i class="bi bi-exclamation-triangle me-1"></i> Low Stock Report</a></li>
            <li><a href="{% url 'inventory:stock_movements_export' %}"><i class="bi bi-download me-1"></i> Export Stock Movements (CSV)</a></li>
            <li><a href="{% url 'inventory:reorder_alert_list' %}"><i class="bi bi-bell me-1"></i> Reorder Alerts</a></li>
            <li><a href="{% url 'inventory:stock_overview' %}"><i class="bi bi-graph-up me-1"></i> Stock Overview</a></li>
            <!-- Add more report/analytics URLs as you implement them -->
          </ul>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-graph-up"></i> Last 30 Days Activity
          </h6>
        </div>
        <div class="card-body">
          <div>
            <span class="fw-bold">{{ movements_last_30_days }}</span> stock movements recorded.<br>
            Value moved: <span class="fw-bold">${{ total_value_last_30_days|floatformat:0 }}</span>
          </div>
          <hr>
          <div class="small text-muted">
            For full analytics, see <a href="{% url 'inventory:stock_movements' %}">Stock Movement History</a>.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Categories and Top Suppliers -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-tags"></i> Top Categories by Value</h6>
        </div>
        <div class="card-body p-0">
          <table class="table table-striped table-sm mb-0">
            <thead>
              <tr>
                <th>Category</th>
                <th>Products</th>
                <th>Stock Value</th>
              </tr>
            </thead>
            <tbody>
              {% for category in top_categories %}
                <tr>
                  <td>
                    <a href="{{ category.get_absolute_url }}">{{ category.name }}</a>
                  </td>
                  <td>{{ category.product_count }}</td>
                  <td>${{ category.stock_value|floatformat:0|default:"0" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="text-muted text-center">No category data available.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-truck"></i> Top Suppliers by Value</h6>
        </div>
        <div class="card-body p-0">
          <table class="table table-striped table-sm mb-0">
            <thead>
              <tr>
                <th>Supplier</th>
                <th>Products</th>
                <th>Stock Value</th>
              </tr>
            </thead>
            <tbody>
              {% for supplier in top_suppliers %}
                <tr>
                  <td>
                    <a href="{{ supplier.get_absolute_url }}">{{ supplier.name }}</a>
                  </td>
                  <td>{{ supplier.product_count }}</td>
                  <td>${{ supplier.stock_value|floatformat:0|default:"0" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="text-muted text-center">No supplier data available.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts & Recent Movements -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-exclamation-triangle"></i> Active Alerts
          </h6>
          <a href="{% url 'inventory:reorder_alert_list' %}" class="btn btn-outline-secondary btn-sm">All Alerts</a>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for alert in active_alerts %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ alert.product.name }}</strong>
                  <small class="text-muted">- {{ alert.get_priority_display }}</small>
                  <br>
                  <span class="text-xs">Current: {{ alert.current_stock }} | Reorder at: {{ alert.reorder_level }}</span>
                </div>
                <span class="badge bg-danger">{{ alert.priority|title }}</span>
              </li>
            {% empty %}
              <li class="list-group-item text-muted text-center">No active alerts.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-clock-history"></i> Recent Stock Movements
          </h6>
          <a href="{% url 'inventory:stock_movements' %}" class="btn btn-outline-secondary btn-sm">View All</a>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for movement in recent_movements %}
              <li class="list-group-item">
                <strong>{{ movement.product.name }}</strong>
                <span class="ms-2">{{ movement.get_movement_type_display }}</span>
                <span class="badge bg-{% if movement.quantity > 0 %}success{% else %}danger{% endif %} ms-2">
                  {% if movement.quantity > 0 %}+{% endif %}{{ movement.quantity }}
                </span>
                <span class="ms-2 text-muted">{{ movement.created_at|date:"M d, H:i" }}</span>
                <br>
                <small>By {{ movement.created_by.get_full_name|default:movement.created_by.username }}</small>
              </li>
            {% empty %}
              <li class="list-group-item text-muted text-center">No recent stock movements.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Stock Takes & Overdue Purchase Orders -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-list-check"></i> Pending Stock Takes</h6>
        </div>
        <div class="card-body">
          {% for st in pending_stock_takes %}
            <div>
              <strong>{{ st.reference }}</strong> ({{ st.get_status_display }})<br>
              Scheduled: {{ st.scheduled_date|date:"M d, Y H:i" }}
              <hr>
            </div>
          {% empty %}
            <span class="text-muted">No pending stock takes.</span>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-exclamation-circle"></i> Overdue Purchase Orders</h6>
        </div>
        <div class="card-body">
          {% for po in overdue_pos %}
            <div>
              <strong>{{ po.supplier.name }}</strong> - PO#{{ po.id }}<br>
              Expected: {{ po.expected_delivery_date|date:"M d, Y" }}
              <hr>
            </div>
          {% empty %}
            <span class="text-muted">No overdue purchase orders.</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
