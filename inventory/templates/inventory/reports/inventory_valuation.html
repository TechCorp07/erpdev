{% extends "inventory_base.html" %}
{% load static %}

{% block inventory_title %}Inventory Valuation Report{% endblock %}

{% block inventory_actions %}
  <div class="btn-group me-2" role="group">
    <a href="{% url 'inventory:reports_dashboard' %}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left me-1"></i>Back to Reports
    </a>
    <button type="button" class="btn btn-success btn-sm" onclick="exportReport('pdf')">
      <i class="bi bi-file-pdf me-1"></i>Export PDF
    </button>
    <button type="button" class="btn btn-info btn-sm" onclick="exportReport('excel')">
      <i class="bi bi-file-excel me-1"></i>Export Excel
    </button>
  </div>
  <button type="button" class="btn btn-primary btn-sm" onclick="refreshReport()">
    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
  </button>
{% endblock %}

{% block inventory_content %}
<!-- Report Filters -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card inventory-card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="bi bi-funnel me-2"></i>Report Filters
        </h6>
      </div>
      <div class="card-body">
        <form method="get" id="filterForm" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">As of Date</label>
            <input type="date" class="form-control" name="as_of_date" value="{{ request.GET.as_of_date|default:today }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Category</label>
            <select class="form-select" name="category">
              <option value="">All Categories</option>
              {% for category in categories %}
                <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                  {{ category.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Location</label>
            <select class="form-select" name="location">
              <option value="">All Locations</option>
              {% for location in locations %}
                <option value="{{ location.id }}" {% if request.GET.location == location.id|stringformat:"s" %}selected{% endif %}>
                  {{ location.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search me-1"></i>Apply Filters
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Valuation Summary -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="metric-card success">
      <div class="d-flex align-items-center">
        <i class="bi bi-boxes fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">{{ report_data.total_products|default:0 }}</div>
          <div class="small">Total Products</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="metric-card info">
      <div class="d-flex align-items-center">
        <i class="bi bi-stack fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">{{ report_data.total_quantity|default:0 }}</div>
          <div class="small">Total Quantity</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="metric-card warning">
      <div class="d-flex align-items-center">
        <i class="bi bi-currency-dollar fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">${{ report_data.total_value|floatformat:0|default:0 }}</div>
          <div class="small">Total Value</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="metric-card">
      <div class="d-flex align-items-center">
        <i class="bi bi-percent fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">{{ report_data.avg_margin|floatformat:1|default:0 }}%</div>
          <div class="small">Avg Margin</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Category Breakdown -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card inventory-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
          <i class="bi bi-pie-chart me-2"></i>Valuation by Category
        </h6>
        <div class="btn-group btn-group-sm" role="group">
          <input type="radio" class="btn-check" name="chartType" id="pieChart" autocomplete="off" checked>
          <label class="btn btn-outline-primary" for="pieChart">Pie</label>
          
          <input type="radio" class="btn-check" name="chartType" id="barChart" autocomplete="off">
          <label class="btn btn-outline-primary" for="barChart">Bar</label>
        </div>
      </div>
      <div class="card-body">
        <canvas id="categoryChart" height="300"></canvas>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card inventory-card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="bi bi-list-ol me-2"></i>Top Categories
        </h6>
      </div>
      <div class="card-body">
        {% for category in report_data.categories %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="fw-bold">{{ category.name }}</div>
              <small class="text-muted">{{ category.product_count }} products</small>
            </div>
            <div class="text-end">
              <div class="fw-bold">${{ category.total_value|floatformat:0 }}</div>
              <small class="text-muted">{{ category.percentage|floatformat:1 }}%</small>
            </div>
          </div>
          <div class="progress mb-3" style="height: 4px;">
            <div class="progress-bar" style="width: {{ category.percentage }}%"></div>
          </div>
        {% empty %}
          <div class="text-muted">No data available</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Detailed Product List -->
<div class="row">
  <div class="col-12">
    <div class="card inventory-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
          <i class="bi bi-table me-2"></i>Detailed Valuation
        </h6>
        <div class="input-group" style="width: 300px;">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
        </div>
      </div>
      <div class="card-body p-0">
        <div class="inventory-table-container">
          <table class="table table-hover mb-0" id="valuationTable">
            <thead class="table-light sticky-top">
              <tr>
                <th>SKU</th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Supplier</th>
                <th class="text-end">Quantity</th>
                <th class="text-end">Cost Price</th>
                <th class="text-end">Selling Price</th>
                <th class="text-end">Total Value</th>
                <th class="text-end">Margin %</th>
                <th class="text-center">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for product in report_data.products %}
                <tr>
                  <td>
                    <a href="{% url 'inventory:product_detail' product.id %}" class="text-decoration-none">
                      {{ product.sku }}
                    </a>
                  </td>
                  <td>{{ product.name }}</td>
                  <td>{{ product.category }}</td>
                  <td>{{ product.supplier }}</td>
                  <td class="text-end">{{ product.quantity }}</td>
                  <td class="text-end">${{ product.cost_price|floatformat:2 }}</td>
                  <td class="text-end">${{ product.selling_price|floatformat:2 }}</td>
                  <td class="text-end fw-bold">${{ product.total_value|floatformat:2 }}</td>
                  <td class="text-end">
                    <span class="badge bg-{% if product.margin_percentage < 20 %}danger{% elif product.margin_percentage < 30 %}warning{% else %}success{% endif %}">
                      {{ product.margin_percentage|floatformat:1 }}%
                    </span>
                  </td>
                  <td class="text-center">
                    <span class="stock-status-badge {{ product.stock_status|lower }}">
                      {{ product.stock_status|title }}
                    </span>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="10" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No products found matching your criteria
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      {% if is_paginated %}
        <div class="card-footer">
          <nav>
            <ul class="pagination pagination-sm mb-0 justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1">First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
              {% endif %}
              
              <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
              </li>
              
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Report Metadata -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-0 bg-light">
      <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted small">
            <i class="bi bi-info-circle me-1"></i>
            Report generated on {{ report_data.as_of_date }} for {{ report_data.location|default:"All Locations" }}
          </div>
          <div class="text-muted small">
            <i class="bi bi-clock me-1"></i>
            Last updated: {{ last_updated|date:"Y-m-d H:i" }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize chart
  initializeCategoryChart();
  
  // Initialize product search
  initializeProductSearch();
  
  // Chart type toggle
  document.querySelectorAll('input[name="chartType"]').forEach(radio => {
    radio.addEventListener('change', function() {
      updateChartType(this.id);
    });
  });
});

function initializeCategoryChart() {
  const ctx = document.getElementById('categoryChart').getContext('2d');
  const chartData = {
    labels: [{% for category in report_data.categories %}'{{ category.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      data: [{% for category in report_data.categories %}{{ category.total_value }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  };
  
  window.categoryChart = new Chart(ctx, {
    type: 'pie',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${label}: $${value.toLocaleString()} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

function updateChartType(type) {
  if (window.categoryChart) {
    window.categoryChart.destroy();
  }
  
  const ctx = document.getElementById('categoryChart').getContext('2d');
  const chartData = window.categoryChart ? window.categoryChart.data : {
    labels: [{% for category in report_data.categories %}'{{ category.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      data: [{% for category in report_data.categories %}{{ category.total_value }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: type === 'pieChart' ? [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
      ] : '#36A2EB',
      borderWidth: 2,
      borderColor: '#fff'
    }]
  };
  
  window.categoryChart = new Chart(ctx, {
    type: type === 'pieChart' ? 'pie' : 'bar',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: type === 'pieChart',
          position: 'bottom'
        }
      },
      scales: type === 'barChart' ? {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          }
        }
      } : {}
    }
  });
}

function initializeProductSearch() {
  const searchInput = document.getElementById('productSearch');
  const table = document.getElementById('valuationTable');
  const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
  
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    
    Array.from(rows).forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
}

function exportReport(format) {
  const params = new URLSearchParams(window.location.search);
  params.set('export', format);
  
  window.open(`{% url 'inventory:export_report' 'valuation' %}?${params.toString()}`, '_blank');
}

function refreshReport() {
  window.location.reload();
}
</script>
{% endblock %}
