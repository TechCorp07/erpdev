{% extends "inventory_base.html" %}
{% load static %}

{% block inventory_title %}Stock Aging Analysis{% endblock %}

{% block inventory_actions %}
  <div class="btn-group me-2" role="group">
    <a href="{% url 'inventory:reports_dashboard' %}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left me-1"></i>Back to Reports
    </a>
    {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
      <button type="button" class="btn btn-warning btn-sm" onclick="markdownSuggestions()">
        <i class="bi bi-percent me-1"></i>Markdown Suggestions
      </button>
    {% endif %}
  </div>
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-success btn-sm" onclick="exportReport('pdf')">
      <i class="bi bi-file-pdf me-1"></i>Export PDF
    </button>
    <button type="button" class="btn btn-info btn-sm" onclick="exportReport('excel')">
      <i class="bi bi-file-excel me-1"></i>Export Excel
    </button>
    <button type="button" class="btn btn-primary btn-sm" onclick="refreshReport()">
      <i class="bi bi-arrow-clockwise me-1"></i>Refresh
    </button>
  </div>
{% endblock %}

{% block inventory_content %}
<!-- Report Filters -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card inventory-card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="bi bi-funnel me-2"></i>Aging Analysis Filters
        </h6>
      </div>
      <div class="card-body">
        <form method="get" id="filterForm" class="row g-3">
          <div class="col-md-2">
            <label class="form-label">Analysis Date</label>
            <input type="date" class="form-control" name="analysis_date" value="{{ request.GET.analysis_date|default:today }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Age Threshold</label>
            <select class="form-select" name="age_threshold">
              <option value="30" {% if request.GET.age_threshold == '30' %}selected{% endif %}>30+ days</option>
              <option value="60" {% if request.GET.age_threshold == '60' %}selected{% endif %}>60+ days</option>
              <option value="90" {% if request.GET.age_threshold == '90' %}selected{% endif %}>90+ days</option>
              <option value="180" {% if request.GET.age_threshold == '180' %}selected{% endif %}>180+ days</option>
              <option value="365" {% if request.GET.age_threshold == '365' %}selected{% endif %}>365+ days</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Category</label>
            <select class="form-select" name="category">
              <option value="">All Categories</option>
              {% for category in categories %}
                <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                  {{ category.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Supplier</label>
            <select class="form-select" name="supplier">
              <option value="">All Suppliers</option>
              {% for supplier in suppliers %}
                <option value="{{ supplier.id }}" {% if request.GET.supplier == supplier.id|stringformat:"s" %}selected{% endif %}>
                  {{ supplier.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Location</label>
            <select class="form-select" name="location">
              <option value="">All Locations</option>
              {% for location in locations %}
                <option value="{{ location.id }}" {% if request.GET.location == location.id|stringformat:"s" %}selected{% endif %}>
                  {{ location.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-search me-1"></i>Analyze
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Aging Summary -->
<div class="row mb-4">
  <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
    <div class="metric-card success">
      <div class="d-flex align-items-center">
        <i class="bi bi-hourglass-top fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">{{ report_data.fresh_count|default:0 }}</div>
          <div class="small">Fresh (0-30d)</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
    <div class="metric-card info">
      <div class="d-flex align-items-center">
        <i class="bi bi-hourglass-split fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">{{ report_data.aging_count|default:0 }}</div>
          <div class="small">Aging (30-90d)</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
    <div class="metric-card warning">
      <div class="d-flex align-items-center">
        <i class="bi bi-hourglass-bottom fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">{{ report_data.slow_count|default:0 }}</div>
          <div class="small">Slow (90-180d)</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
    <div class="metric-card">
      <div class="d-flex align-items-center">
        <i class="bi bi-exclamation-triangle fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">{{ report_data.dead_count|default:0 }}</div>
          <div class="small">Dead (180d+)</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
    <div class="metric-card">
      <div class="d-flex align-items-center">
        <i class="bi bi-currency-dollar fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">${{ report_data.aged_value|floatformat:0|default:0 }}</div>
          <div class="small">Aged Value</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
    <div class="metric-card">
      <div class="d-flex align-items-center">
        <i class="bi bi-percent fs-1 me-3"></i>
        <div>
          <div class="fs-4 fw-bold">{{ report_data.aged_percentage|floatformat:1|default:0 }}%</div>
          <div class="small">Aged Ratio</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Aging Distribution Charts -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card inventory-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
          <i class="bi bi-graph-down me-2"></i>Aging Distribution
        </h6>
        <div class="btn-group btn-group-sm" role="group">
          <input type="radio" class="btn-check" name="chartView" id="byValue" autocomplete="off" checked>
          <label class="btn btn-outline-primary" for="byValue">By Value</label>
          
          <input type="radio" class="btn-check" name="chartView" id="byQuantity" autocomplete="off">
          <label class="btn btn-outline-primary" for="byQuantity">By Quantity</label>
        </div>
      </div>
      <div class="card-body">
        <canvas id="agingChart" height="300"></canvas>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card inventory-card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="bi bi-speedometer2 me-2"></i>Turnover Velocity
        </h6>
      </div>
      <div class="card-body">
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-2">
            <span>Fast Movers</span>
            <span class="fw-bold text-success">{{ report_data.fast_movers|default:0 }}</span>
          </div>
          <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar bg-success" style="width: {{ report_data.fast_movers_percentage|default:0 }}%"></div>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-2">
            <span>Medium Movers</span>
            <span class="fw-bold text-info">{{ report_data.medium_movers|default:0 }}</span>
          </div>
          <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar bg-info" style="width: {{ report_data.medium_movers_percentage|default:0 }}%"></div>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-2">
            <span>Slow Movers</span>
            <span class="fw-bold text-warning">{{ report_data.slow_movers|default:0 }}</span>
          </div>
          <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar bg-warning" style="width: {{ report_data.slow_movers_percentage|default:0 }}%"></div>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-2">
            <span>Non Movers</span>
            <span class="fw-bold text-danger">{{ report_data.non_movers|default:0 }}</span>
          </div>
          <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar bg-danger" style="width: {{ report_data.non_movers_percentage|default:0 }}%"></div>
          </div>
        </div>
        
        <hr>
        <div class="text-center">
          <div class="fs-5 fw-bold">{{ report_data.avg_age|default:0 }}</div>
          <small class="text-muted">Average Age (Days)</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Category Analysis -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card inventory-card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="bi bi-grid me-2"></i>Aging by Category
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          {% for category in report_data.category_aging %}
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card border">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">{{ category.name|truncatechars:20 }}</h6>
                    <span class="badge bg-{% if category.avg_age <= 30 %}success{% elif category.avg_age <= 90 %}info{% elif category.avg_age <= 180 %}warning{% else %}danger{% endif %}">
                      {{ category.avg_age|floatformat:0 }}d
                    </span>
                  </div>
                  <div class="row g-0 text-center">
                    <div class="col">
                      <div class="fs-6 fw-bold text-success">{{ category.fresh_count }}</div>
                      <small class="text-muted">Fresh</small>
                    </div>
                    <div class="col">
                      <div class="fs-6 fw-bold text-warning">{{ category.aging_count }}</div>
                      <small class="text-muted">Aging</small>
                    </div>
                    <div class="col">
                      <div class="fs-6 fw-bold text-danger">{{ category.dead_count }}</div>
                      <small class="text-muted">Dead</small>
                    </div>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">Value: ${{ category.total_value|floatformat:0 }}</small>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Detailed Aging Table -->
<div class="row">
  <div class="col-12">
    <div class="card inventory-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
          <i class="bi bi-table me-2"></i>Detailed Aging Analysis
        </h6>
        <div class="d-flex gap-2">
          <div class="input-group" style="width: 250px;">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="agingSearch" placeholder="Search products...">
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <input type="radio" class="btn-check" name="sortBy" id="sortAge" autocomplete="off" checked onchange="sortTable('age')">
            <label class="btn btn-outline-secondary" for="sortAge">Age</label>
            
            <input type="radio" class="btn-check" name="sortBy" id="sortValue" autocomplete="off" onchange="sortTable('value')">
            <label class="btn btn-outline-secondary" for="sortValue">Value</label>
            
            <input type="radio" class="btn-check" name="sortBy" id="sortQty" autocomplete="off" onchange="sortTable('quantity')">
            <label class="btn btn-outline-secondary" for="sortQty">Quantity</label>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="inventory-table-container">
          <table class="table table-hover table-sm mb-0" id="agingTable">
            <thead class="table-light sticky-top">
              <tr>
                <th>SKU</th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Supplier</th>
                <th class="text-end">Age (Days)</th>
                <th class="text-end">Quantity</th>
                <th class="text-end">Unit Cost</th>
                <th class="text-end">Total Value</th>
                <th class="text-center">Last Sale</th>
                <th class="text-center">Velocity</th>
                <th class="text-center">Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in aging_items %}
                <tr data-age="{{ item.age_days }}" data-value="{{ item.total_value }}" data-quantity="{{ item.quantity }}">
                  <td>
                    <a href="{% url 'inventory:product_detail' item.product.id %}" class="text-decoration-none">
                      <code>{{ item.product.sku }}</code>
                    </a>
                  </td>
                  <td>{{ item.product.name|truncatechars:40 }}</td>
                  <td>
                    <small class="text-muted">{{ item.product.category.name }}</small>
                  </td>
                  <td>
                    <small class="text-muted">{{ item.product.supplier.name|truncatechars:20 }}</small>
                  </td>
                  <td class="text-end">
                    <span class="badge bg-{% if item.age_days <= 30 %}success{% elif item.age_days <= 90 %}info{% elif item.age_days <= 180 %}warning{% else %}danger{% endif %}">
                      {{ item.age_days }}
                    </span>
                  </td>
                  <td class="text-end">{{ item.quantity }}</td>
                  <td class="text-end">${{ item.unit_cost|floatformat:2 }}</td>
                  <td class="text-end fw-bold">
                    <span class="{% if item.total_value > 1000 %}text-danger{% elif item.total_value > 500 %}text-warning{% endif %}">
                      ${{ item.total_value|floatformat:2 }}
                    </span>
                  </td>
                  <td class="text-center">
                    {% if item.last_sale_date %}
                      <small class="text-muted">{{ item.last_sale_date|date:"M d" }}</small>
                    {% else %}
                      <small class="text-muted">Never</small>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <span class="badge bg-{% if item.velocity == 'fast' %}success{% elif item.velocity == 'medium' %}info{% elif item.velocity == 'slow' %}warning{% else %}danger{% endif %}">
                      {{ item.velocity|title }}
                    </span>
                  </td>
                  <td class="text-center">
                    {% if item.age_days > 180 %}
                      <span class="text-danger fw-bold">DEAD</span>
                    {% elif item.age_days > 90 %}
                      <span class="text-warning fw-bold">SLOW</span>
                    {% elif item.age_days > 30 %}
                      <span class="text-info fw-bold">AGING</span>
                    {% else %}
                      <span class="text-success fw-bold">FRESH</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                      {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
                        {% if item.age_days > 90 %}
                          <button type="button" class="btn btn-outline-warning" 
                                  onclick="suggestMarkdown({{ item.product.id }})" 
                                  title="Suggest Markdown">
                            <i class="bi bi-percent"></i>
                          </button>
                        {% endif %}
                        {% if item.age_days > 180 %}
                          <button type="button" class="btn btn-outline-danger" 
                                  onclick="markAsObsolete({{ item.product.id }})" 
                                  title="Mark as Obsolete">
                            <i class="bi bi-archive"></i>
                          </button>
                        {% endif %}
                      {% endif %}
                      <button type="button" class="btn btn-outline-info" 
                              onclick="viewMovementHistory({{ item.product.id }})" 
                              title="View History">
                        <i class="bi bi-clock-history"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="12" class="text-center text-muted py-5">
                    <i class="bi bi-hourglass fs-1 d-block mb-2"></i>
                    <h6>No aging inventory found</h6>
                    <p class="mb-0">All products are within the fresh inventory threshold.</p>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      {% if is_paginated %}
        <div class="card-footer">
          <nav>
            <ul class="pagination pagination-sm mb-0 justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1">First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
              {% endif %}
              
              <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
              </li>
              
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Report Analysis Summary -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card border-0 bg-light">
      <div class="card-body">
        <h6 class="fw-bold mb-3">
          <i class="bi bi-lightbulb me-2"></i>Key Insights
        </h6>
        <ul class="list-unstyled mb-0">
          {% if report_data.aged_percentage > 20 %}
            <li class="mb-2">
              <i class="bi bi-exclamation-triangle text-warning me-2"></i>
              <strong>{{ report_data.aged_percentage|floatformat:1 }}%</strong> of inventory is aging (90+ days)
            </li>
          {% endif %}
          {% if report_data.dead_count > 0 %}
            <li class="mb-2">
              <i class="bi bi-archive text-danger me-2"></i>
              <strong>{{ report_data.dead_count }}</strong> items are dead stock (180+ days)
            </li>
          {% endif %}
          {% if report_data.slow_movers > report_data.fast_movers %}
            <li class="mb-2">
              <i class="bi bi-speedometer text-info me-2"></i>
              More slow movers than fast movers - consider promotions
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card border-0 bg-light">
      <div class="card-body">
        <h6 class="fw-bold mb-3">
          <i class="bi bi-clipboard-check me-2"></i>Recommended Actions
        </h6>
        <ul class="list-unstyled mb-0">
          <li class="mb-2">
            <i class="bi bi-percent text-warning me-2"></i>
            Consider markdowns for items 90+ days old
          </li>
          <li class="mb-2">
            <i class="bi bi-megaphone text-info me-2"></i>
            Run promotions on slow-moving categories
          </li>
          <li class="mb-2">
            <i class="bi bi-arrow-down text-success me-2"></i>
            Reduce reorder quantities for aging items
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Report Metadata -->
<div class="row mt-3">
  <div class="col-12">
    <div class="card border-0 bg-light">
      <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted small">
            <i class="bi bi-info-circle me-1"></i>
            Aging analysis as of {{ report_data.analysis_date }} showing items {{ request.GET.age_threshold|default:30 }}+ days old
          </div>
          <div class="text-muted small">
            <i class="bi bi-clock me-1"></i>
            Report generated: {{ now|date:"Y-m-d H:i" }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize chart
  initializeAgingChart();
  
  // Initialize search
  initializeAgingSearch();
  
  // Chart view toggle
  document.querySelectorAll('input[name="chartView"]').forEach(radio => {
    radio.addEventListener('change', function() {
      updateChartView(this.id);
    });
  });
});

function initializeAgingChart() {
  const ctx = document.getElementById('agingChart').getContext('2d');
  
  const chartData = {
    labels: ['0-30 days', '30-90 days', '90-180 days', '180+ days'],
    datasets: [{
      label: 'Value ($)',
      data: [
        {{ report_data.fresh_value|default:0 }},
        {{ report_data.aging_value|default:0 }},
        {{ report_data.slow_value|default:0 }},
        {{ report_data.dead_value|default:0 }}
      ],
      backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  };
  
  window.agingChart = new Chart(ctx, {
    type: 'bar',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              return `Value: $${value.toLocaleString()}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          }
        }
      }
    }
  });
}

function updateChartView(viewType) {
  if (window.agingChart) {
    window.agingChart.destroy();
  }
  
  const ctx = document.getElementById('agingChart').getContext('2d');
  
  let chartData;
  if (viewType === 'byQuantity') {
    chartData = {
      labels: ['0-30 days', '30-90 days', '90-180 days', '180+ days'],
      datasets: [{
        label: 'Quantity',
        data: [
          {{ report_data.fresh_count|default:0 }},
          {{ report_data.aging_count|default:0 }},
          {{ report_data.slow_count|default:0 }},
          {{ report_data.dead_count|default:0 }}
        ],
        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    };
  } else {
    chartData = {
      labels: ['0-30 days', '30-90 days', '90-180 days', '180+ days'],
      datasets: [{
        label: 'Value ($)',
        data: [
          {{ report_data.fresh_value|default:0 }},
          {{ report_data.aging_value|default:0 }},
          {{ report_data.slow_value|default:0 }},
          {{ report_data.dead_value|default:0 }}
        ],
        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    };
  }
  
  window.agingChart = new Chart(ctx, {
    type: 'bar',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              if (viewType === 'byQuantity') {
                return `Quantity: ${value.toLocaleString()}`;
              } else {
                return `Value: $${value.toLocaleString()}`;
              }
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              if (viewType === 'byQuantity') {
                return value.toLocaleString();
              } else {
                return '$' + value.toLocaleString();
              }
            }
          }
        }
      }
    }
  });
}

function initializeAgingSearch() {
  const searchInput = document.getElementById('agingSearch');
  const table = document.getElementById('agingTable');
  const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
  
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    
    Array.from(rows).forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
}

function sortTable(criteria) {
  const table = document.getElementById('agingTable');
  const tbody = table.getElementsByTagName('tbody')[0];
  const rows = Array.from(tbody.getElementsByTagName('tr'));
  
  rows.sort((a, b) => {
    let aVal, bVal;
    
    switch(criteria) {
      case 'age':
        aVal = parseInt(a.dataset.age);
        bVal = parseInt(b.dataset.age);
        break;
      case 'value':
        aVal = parseFloat(a.dataset.value);
        bVal = parseFloat(b.dataset.value);
        break;
      case 'quantity':
        aVal = parseInt(a.dataset.quantity);
        bVal = parseInt(b.dataset.quantity);
        break;
    }
    
    return bVal - aVal; // Descending order
  });
  
  // Clear tbody and re-add sorted rows
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));
}

function suggestMarkdown(productId) {
  // This would open a modal with markdown suggestions
  if (confirm('Suggest a markdown for this aging product?')) {
    window.location.href = `/inventory/products/${productId}/markdown-suggestions/`;
  }
}

function markAsObsolete(productId) {
  if (confirm('Mark this product as obsolete? This will deactivate it and create a disposal recommendation.')) {
    fetch(`/inventory/api/mark-obsolete/${productId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    });
  }
}

function viewMovementHistory(productId) {
  window.open(`/inventory/stock/movements/?product=${productId}`, '_blank');
}

function markdownSuggestions() {
  // Get aging items that need markdowns
  const agingItems = Array.from(document.querySelectorAll('tr[data-age]'))
    .filter(row => parseInt(row.dataset.age) > 90)
    .map(row => {
      const productLink = row.querySelector('a[href*="/products/"]');
      return productLink ? productLink.href.split('/').slice(-2, -1)[0] : null;
    })
    .filter(id => id);
  
  if (agingItems.length > 0) {
    window.location.href = `/inventory/pricing/bulk-markdown/?products=${agingItems.join(',')}`;
  } else {
    alert('No items requiring markdowns found.');
  }
}

function exportReport(format) {
  const params = new URLSearchParams(window.location.search);
  params.set('export', format);
  
  window.open(`{% url 'inventory:export_report' 'aging' %}?${params.toString()}`, '_blank');
}

function refreshReport() {
  window.location.reload();
}

// Utility function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
