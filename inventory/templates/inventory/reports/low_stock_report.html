{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Low Stock Report{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-0 text-gray-800">Low Stock Report</h1>
    <p class="text-muted mb-0">Products requiring immediate attention</p>
  </div>
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:low_stock_ordering' %}" class="btn btn-warning">
      <i class="bi bi-cart me-2"></i>Generate Purchase Orders
    </a>
    <div class="btn-group" role="group">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-download"></i> Export
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="?export=csv">
          <i class="bi bi-file-spreadsheet me-2"></i>Download CSV
        </a></li>
        <li><a class="dropdown-item" href="?export=pdf">
          <i class="bi bi-file-pdf me-2"></i>Download PDF
        </a></li>
        <li><a class="dropdown-item" href="javascript:window.print()">
          <i class="bi bi-printer me-2"></i>Print Report
        </a></li>
      </ul>
    </div>
  </div>
</div>

<!-- Alert Summary -->
{% if products %}
<div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
  <i class="bi bi-exclamation-triangle-fill fa-2x me-3"></i>
  <div>
    <h5 class="alert-heading mb-2">⚠️ {{ total_products }} Products Need Attention</h5>
    <p class="mb-0">
      <strong>{{ out_of_stock_count|default:0 }}</strong> products are completely out of stock and 
      <strong>{{ low_stock_count|default:0 }}</strong> products are running low.
    </p>
  </div>
</div>
{% endif %}

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-danger text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Out of Stock
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ out_of_stock_count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-x-circle fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-warning text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Low Stock
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ low_stock_count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-exclamation-triangle fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-info text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Estimated Reorder Value
            </div>
            <div class="h5 mb-0 font-weight-bold">${{ estimated_reorder_value|floatformat:0|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-currency-dollar fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-primary text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Unique Suppliers
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ unique_suppliers_count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-people fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filter Options -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary">Filter Options</h6>
  </div>
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-2">
        <label class="form-label">Priority</label>
        <select class="form-select" name="priority">
          <option value="">All Priorities</option>
          <option value="critical" {% if request.GET.priority == "critical" %}selected{% endif %}>Critical (Out of Stock)</option>
          <option value="high" {% if request.GET.priority == "high" %}selected{% endif %}>High (Very Low)</option>
          <option value="medium" {% if request.GET.priority == "medium" %}selected{% endif %}>Medium (Low Stock)</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Category</label>
        <select class="form-select" name="category">
          <option value="">All Categories</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
              {{ category.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Supplier</label>
        <select class="form-select" name="supplier">
          <option value="">All Suppliers</option>
          {% for supplier in suppliers %}
            <option value="{{ supplier.id }}" {% if request.GET.supplier == supplier.id|stringformat:"s" %}selected{% endif %}>
              {{ supplier.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Value Range</label>
        <select class="form-select" name="value_range">
          <option value="">All Values</option>
          <option value="high" {% if request.GET.value_range == "high" %}selected{% endif %}>High Value (>$500)</option>
          <option value="medium" {% if request.GET.value_range == "medium" %}selected{% endif %}>Medium ($100-$500)</option>
          <option value="low" {% if request.GET.value_range == "low" %}selected{% endif %}>Low Value (<$100)</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Sort By</label>
        <select class="form-select" name="sort">
          <option value="priority" {% if request.GET.sort == "priority" or not request.GET.sort %}selected{% endif %}>Priority</option>
          <option value="stock_level" {% if request.GET.sort == "stock_level" %}selected{% endif %}>Stock Level</option>
          <option value="reorder_value" {% if request.GET.sort == "reorder_value" %}selected{% endif %}>Reorder Value</option>
          <option value="supplier" {% if request.GET.sort == "supplier" %}selected{% endif %}>Supplier</option>
          <option value="category" {% if request.GET.sort == "category" %}selected{% endif %}>Category</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">Filter</button>
        <a href="{% url 'inventory:low_stock_report' %}" class="btn btn-outline-secondary">Clear</a>
      </div>
    </form>
  </div>
</div>

<!-- Low Stock Products Table -->
<div class="card shadow">
  <div class="card-header py-3 d-flex justify-content-between align-items-center">
    <h6 class="m-0 font-weight-bold text-primary">
      Low Stock Products ({{ products.count|default:0 }})
    </h6>
    <div class="btn-group btn-group-sm" role="group">
      <button type="button" class="btn btn-outline-primary" onclick="selectAllCritical()">
        Select Critical
      </button>
      <button type="button" class="btn btn-outline-warning" onclick="selectAllLowStock()">
        Select Low Stock
      </button>
      <button type="button" class="btn btn-outline-success" onclick="generatePOSelected()" id="generatePOBtn" disabled>
        Generate POs
      </button>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>
              <input type="checkbox" class="form-check-input" id="select-all">
            </th>
            <th>Priority</th>
            <th>SKU</th>
            <th>Product Name</th>
            <th>Category</th>
            <th>Supplier</th>
            <th>Current Stock</th>
            <th>Reorder Level</th>
            <th>Suggested Qty</th>
            <th>Unit Cost</th>
            <th>Reorder Value</th>
            <th>Lead Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr data-product-id="{{ product.id }}" data-priority="{{ product.priority|default:'medium' }}">
            <td>
              <input type="checkbox" class="form-check-input product-checkbox" value="{{ product.id }}">
            </td>
            <td>
              {% if product.current_stock <= 0 %}
                <span class="badge bg-danger">Critical</span>
              {% elif product.current_stock <= product.reorder_level|floatformat:0|div:2 %}
                <span class="badge bg-warning">High</span>
              {% else %}
                <span class="badge bg-info">Medium</span>
              {% endif %}
            </td>
            <td>
              <code class="fw-bold">{{ product.sku }}</code>
            </td>
            <td>
              <a href="{% url 'inventory:product_detail' product.pk %}" class="text-decoration-none fw-bold">
                {{ product.name|truncatechars:40 }}
              </a>
              {% if product.brand %}
                <br><small class="text-muted">{{ product.brand.name }}</small>
              {% endif %}
            </td>
            <td>
              {% if product.category %}
                <span class="badge bg-light text-dark">{{ product.category.name }}</span>
              {% endif %}
            </td>
            <td>
              {% if product.supplier %}
                <a href="{% url 'inventory:supplier_detail' product.supplier.pk %}" class="text-decoration-none">
                  {{ product.supplier.name|truncatechars:20 }}
                </a>
              {% else %}
                <span class="text-muted">No supplier</span>
              {% endif %}
            </td>
            <td>
              <span class="fw-bold 
                {% if product.current_stock <= 0 %}text-danger
                {% elif product.current_stock <= product.reorder_level|floatformat:0|div:2 %}text-warning
                {% else %}text-info
                {% endif %}">
                {{ product.current_stock|floatformat:0 }}
              </span>
            </td>
            <td>
              <span class="text-muted">{{ product.reorder_level|floatformat:0 }}</span>
            </td>
            <td>
              <span class="fw-bold text-success">
                {% if product.reorder_quantity %}
                  {{ product.reorder_quantity|floatformat:0 }}
                {% else %}
                  {{ product.reorder_level|add:10|floatformat:0 }}
                {% endif %}
              </span>
            </td>
            <td>
              ${{ product.cost_price|floatformat:2 }}
            </td>
            <td>
              <span class="fw-bold">
                ${% widthratio product.cost_price 1 product.reorder_quantity|default:product.reorder_level|add:10 %}
              </span>
            </td>
            <td>
              {% if product.supplier_lead_time_days %}
                {{ product.supplier_lead_time_days }} days
              {% else %}
                <span class="text-muted">Unknown</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="quickReorder({{ product.pk }})" title="Quick Reorder">
                  <i class="bi bi-cart-plus"></i>
                </button>
                <a href="{% url 'inventory:adjust_stock' product.pk %}" class="btn btn-outline-info" title="Adjust Stock">
                  <i class="bi bi-plus-minus"></i>
                </a>
                <a href="{% url 'inventory:product_detail' product.pk %}" class="btn btn-outline-secondary" title="View Details">
                  <i class="bi bi-eye"></i>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="13" class="text-center py-5">
              <div class="text-success">
                <i class="bi bi-check-circle fa-3x mb-3"></i>
                <h4>Great News!</h4>
                <p class="text-muted">All products are currently well-stocked. No immediate action required.</p>
                <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-primary">
                  <i class="bi bi-box-seam me-2"></i>View All Products
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  {% if products %}
  <div class="card-footer bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <div class="text-muted small">
        <i class="bi bi-info-circle me-1"></i>
        Report generated on {{ report_date|date:"F d, Y at H:i" }}
      </div>
      <div>
        <span id="selectedProductCount">0</span> products selected
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Quick Reorder Modal -->
<div class="modal fade" id="quickReorderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Reorder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">Product</label>
          <p class="form-control-plaintext" id="reorderProductName"></p>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Current Stock</label>
          <p class="form-control-plaintext" id="reorderCurrentStock"></p>
        </div>
        <div class="mb-3">
          <label for="reorderQuantity" class="form-label fw-bold">Order Quantity</label>
          <input type="number" class="form-control" id="reorderQuantity" min="1" step="1">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Estimated Cost</label>
          <p class="form-control-plaintext fw-bold text-success" id="reorderCost">$0.00</p>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="createPO">
          <label class="form-check-label" for="createPO">
            Create Purchase Order immediately
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitQuickReorder()">
          <i class="bi bi-cart-plus me-1"></i>Add to Reorder List
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let selectedProducts = new Set();
let currentReorderProduct = null;

// Selection handling
document.getElementById('select-all').addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.product-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = this.checked;
    updateSelection();
  });
});

document.querySelectorAll('.product-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', updateSelection);
});

function updateSelection() {
  selectedProducts.clear();
  document.querySelectorAll('.product-checkbox:checked').forEach(cb => {
    selectedProducts.add(parseInt(cb.value));
  });
  
  document.getElementById('selectedProductCount').textContent = selectedProducts.size;
  document.getElementById('generatePOBtn').disabled = selectedProducts.size === 0;
}

function selectAllCritical() {
  document.querySelectorAll('tr[data-product-id]').forEach(row => {
    const checkbox = row.querySelector('.product-checkbox');
    const priority = row.dataset.priority;
    checkbox.checked = priority === 'critical';
  });
  updateSelection();
}

function selectAllLowStock() {
  document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = true);
  updateSelection();
}

function quickReorder(productId) {
  // This would fetch product details and show the modal
  currentReorderProduct = productId;
  new bootstrap.Modal(document.getElementById('quickReorderModal')).show();
}

function submitQuickReorder() {
  // Submit the reorder request
  const quantity = document.getElementById('reorderQuantity').value;
  const createPO = document.getElementById('createPO').checked;
  
  if (!quantity || quantity <= 0) {
    alert('Please enter a valid quantity.');
    return;
  }
  
  // Here you would make an AJAX call or redirect
  window.location.href = `/inventory/reorder/add/${currentReorderProduct}/?quantity=${quantity}&create_po=${createPO}`;
}

function generatePOSelected() {
  if (selectedProducts.size === 0) {
    alert('Please select at least one product.');
    return;
  }
  
  const productIds = Array.from(selectedProducts).join(',');
  window.location.href = `/inventory/purchase-orders/create/?products=${productIds}`;
}

// Update reorder cost calculation
document.getElementById('reorderQuantity')?.addEventListener('input', function() {
  // This would calculate the estimated cost based on the product's cost price
  // For now, just show a placeholder calculation
  const quantity = this.value || 0;
  const estimatedCost = quantity * 10; // Placeholder calculation
  document.getElementById('reorderCost').textContent = `$${estimatedCost.toFixed(2)}`;
});

// Print styles
const printStyles = `
  @media print {
    .btn, .card-header .btn-group, .modal { display: none !important; }
    .card { border: 1px solid #dee2e6 !important; box-shadow: none !important; }
    .table th, .table td { border: 1px solid #dee2e6 !important; }
    .badge { border: 1px solid !important; }
  }
`;
const styleSheet = document.createElement("style");
styleSheet.type = "text/css";
styleSheet.innerText = printStyles;
document.head.appendChild(styleSheet);
</script>
{% endblock %}