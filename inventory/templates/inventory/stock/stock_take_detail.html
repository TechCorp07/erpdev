{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Stock Take - {{ object.reference }}{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:stock_overview' %}">Stock Management</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:stock_take_list' %}">Stock Takes</a></li>
        <li class="breadcrumb-item active">{{ object.reference }}</li>
      </ol>
    </nav>
    <h1 class="h3 mb-0 text-gray-800">
      Stock Take - {{ object.reference }}
      {% if object.status == 'draft' %}
        <span class="badge bg-secondary ms-2">Draft</span>
      {% elif object.status == 'scheduled' %}
        <span class="badge bg-primary ms-2">Scheduled</span>
      {% elif object.status == 'in_progress' %}
        <span class="badge bg-warning ms-2">In Progress</span>
      {% elif object.status == 'pending_review' %}
        <span class="badge bg-info ms-2">Pending Review</span>
      {% elif object.status == 'completed' %}
        <span class="badge bg-success ms-2">Completed</span>
      {% elif object.status == 'cancelled' %}
        <span class="badge bg-danger ms-2">Cancelled</span>
      {% endif %}
    </h1>
    <p class="text-muted mb-0">{{ object.description|default:"Physical inventory count" }}</p>
  </div>
  
  <div class="btn-group" role="group">
    {% if object.status == 'draft' or object.status == 'scheduled' %}
      <a href="{% url 'inventory:stock_take_edit' object.pk %}" class="btn btn-outline-primary">
        <i class="bi bi-pencil me-2"></i>Edit
      </a>
    {% endif %}
    
    {% if object.status == 'scheduled' %}
      <button type="button" class="btn btn-warning" onclick="startStockTake({{ object.pk }})">
        <i class="bi bi-play me-2"></i>Start Counting
      </button>
    {% elif object.status == 'in_progress' %}
      <a href="{% url 'inventory:stock_take_count' object.pk %}" class="btn btn-success">
        <i class="bi bi-calculator me-2"></i>Continue Counting
      </a>
    {% elif object.status == 'pending_review' %}
      <button type="button" class="btn btn-primary" onclick="completeStockTake({{ object.pk }})">
        <i class="bi bi-check-circle me-2"></i>Complete
      </button>
    {% endif %}
    
    <div class="btn-group" role="group">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-three-dots"></i>
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{% url 'inventory:stock_take_print' object.pk %}">
          <i class="bi bi-printer me-2"></i>Print Count Sheets
        </a></li>
        <li><a class="dropdown-item" href="{% url 'inventory:stock_take_export' object.pk %}">
          <i class="bi bi-download me-2"></i>Export Data
        </a></li>
        {% if object.status == 'completed' %}
        <li><a class="dropdown-item" href="{% url 'inventory:stock_take_report' object.pk %}">
          <i class="bi bi-file-text me-2"></i>View Report
        </a></li>
        <li><a class="dropdown-item" href="{% url 'inventory:stock_take_audit_trail' object.pk %}">
          <i class="bi bi-clock-history me-2"></i>Audit Trail
        </a></li>
        {% endif %}
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{% url 'inventory:stock_take_duplicate' object.pk %}">
          <i class="bi bi-files me-2"></i>Duplicate
        </a></li>
        {% if object.status == 'draft' %}
        <li><a class="dropdown-item text-danger" href="{% url 'inventory:stock_take_delete' object.pk %}">
          <i class="bi bi-trash me-2"></i>Delete
        </a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<!-- Stock Take Information Cards -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Stock Take Information</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <dl class="row">
              <dt class="col-sm-5">Reference:</dt>
              <dd class="col-sm-7">{{ object.reference }}</dd>
              
              <dt class="col-sm-5">Description:</dt>
              <dd class="col-sm-7">{{ object.description|default:"â€”" }}</dd>
              
              <dt class="col-sm-5">Type:</dt>
              <dd class="col-sm-7">
                {% if object.is_full_count %}
                  <span class="badge bg-info">Full Count</span>
                {% elif object.is_cycle_count %}
                  <span class="badge bg-secondary">Cycle Count</span>
                {% else %}
                  <span class="badge bg-primary">Partial Count</span>
                {% endif %}
              </dd>
              
              <dt class="col-sm-5">Location:</dt>
              <dd class="col-sm-7">
                {% if object.location %}
                  <i class="bi bi-geo-alt text-primary me-1"></i>
                  <a href="{% url 'inventory:location_detail' object.location.pk %}">{{ object.location.name }}</a>
                {% else %}
                  <span class="badge bg-warning">All Locations</span>
                {% endif %}
              </dd>
            </dl>
          </div>
          <div class="col-md-6">
            <dl class="row">
              <dt class="col-sm-5">Created By:</dt>
              <dd class="col-sm-7">
                <div class="d-flex align-items-center">
                  {% if object.created_by.profile.avatar %}
                    <img src="{{ object.created_by.profile.avatar.url }}" alt="{{ object.created_by.get_full_name }}" class="me-2" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
                  {% else %}
                    <i class="bi bi-person-circle me-2"></i>
                  {% endif %}
                  {{ object.created_by.get_full_name|default:object.created_by.username }}
                </div>
              </dd>
              
              <dt class="col-sm-5">Created:</dt>
              <dd class="col-sm-7">{{ object.created_at|date:"M j, Y g:i A" }}</dd>
              
              <dt class="col-sm-5">Started:</dt>
              <dd class="col-sm-7">
                {% if object.started_at %}
                  {{ object.started_at|date:"M j, Y g:i A" }}
                {% else %}
                  <span class="text-muted">Not started</span>
                {% endif %}
              </dd>
              
              <dt class="col-sm-5">Completed:</dt>
              <dd class="col-sm-7">
                {% if object.completed_at %}
                  {{ object.completed_at|date:"M j, Y g:i A" }}
                {% else %}
                  <span class="text-muted">Not completed</span>
                {% endif %}
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <!-- Progress Card -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Progress Overview</h6>
      </div>
      <div class="card-body text-center">
        <div class="progress mb-3" style="height: 10px;">
          <div class="progress-bar bg-success" style="width: {{ completion_percentage|default:0 }}%"></div>
        </div>
        <h4 class="font-weight-bold">{{ completion_percentage|default:0|floatformat:1 }}%</h4>
        <p class="text-muted mb-3">Complete</p>
        
        <div class="row text-center">
          <div class="col-4">
            <h6 class="text-success">{{ completed_items_count|default:0 }}</h6>
            <small class="text-muted">Counted</small>
          </div>
          <div class="col-4">
            <h6 class="text-warning">{{ pending_items_count|default:0 }}</h6>
            <small class="text-muted">Pending</small>
          </div>
          <div class="col-4">
            <h6 class="text-primary">{{ total_items_count|default:0 }}</h6>
            <small class="text-muted">Total</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Discrepancies Summary -->
    {% if object.status == 'pending_review' or object.status == 'completed' %}
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Discrepancies</h6>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-12 mb-2">
            <h5 class="text-danger">{{ discrepancy_count|default:0 }}</h5>
            <small class="text-muted">Items with Variance</small>
          </div>
        </div>
        <hr>
        <div class="row text-center">
          <div class="col-6">
            <h6 class="text-success">${{ positive_variance_value|floatformat:2|default:"0.00" }}</h6>
            <small class="text-muted">Gains</small>
          </div>
          <div class="col-6">
            <h6 class="text-danger">${{ negative_variance_value|floatformat:2|default:"0.00" }}</h6>
            <small class="text-muted">Losses</small>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Stock Take Items -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex justify-content-between align-items-center">
    <h6 class="m-0 font-weight-bold text-primary">Stock Take Items</h6>
    <div class="btn-group btn-group-sm" role="group">
      {% if object.status == 'in_progress' %}
        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#bulkCountModal">
          <i class="bi bi-calculator me-1"></i>Bulk Count
        </button>
      {% endif %}
      <div class="btn-group btn-group-sm" role="group">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          Filter
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="?filter=all">All Items</a></li>
          <li><a class="dropdown-item" href="?filter=counted">Counted</a></li>
          <li><a class="dropdown-item" href="?filter=pending">Pending</a></li>
          <li><a class="dropdown-item" href="?filter=discrepancies">Discrepancies Only</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    {% if items %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="bg-light">
          <tr>
            <th>Product</th>
            <th>Expected</th>
            <th>Counted</th>
            <th>Variance</th>
            <th>Value Impact</th>
            <th>Status</th>
            <th>Last Counted</th>
            {% if object.status == 'in_progress' %}
            <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr {% if item.variance != 0 and item.actual_quantity is not None %}class="table-warning"{% endif %}>
            <td>
              <div class="d-flex align-items-center">
                {% if item.product.image %}
                  <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="me-3" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                {% else %}
                  <div class="me-3 bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 4px;">
                    <i class="bi bi-image text-muted"></i>
                  </div>
                {% endif %}
                <div>
                  <a href="{% url 'inventory:product_detail' item.product.pk %}" class="fw-bold text-decoration-none">
                    {{ item.product.name|truncatechars:40 }}
                  </a>
                  <br><small class="text-muted">{{ item.product.sku }}</small>
                </div>
              </div>
            </td>
            <td>
              <span class="fw-bold">{{ item.expected_quantity|floatformat:0 }}</span>
              {% if item.product.unit %}
                <small class="text-muted">{{ item.product.unit }}</small>
              {% endif %}
            </td>
            <td>
              {% if item.actual_quantity is not None %}
                <span class="fw-bold {% if item.variance > 0 %}text-success{% elif item.variance < 0 %}text-danger{% endif %}">
                  {{ item.actual_quantity|floatformat:0 }}
                </span>
              {% else %}
                <span class="text-muted">Not counted</span>
              {% endif %}
            </td>
            <td>
              {% if item.actual_quantity is not None %}
                {% if item.variance > 0 %}
                  <span class="badge bg-success">+{{ item.variance|floatformat:0 }}</span>
                {% elif item.variance < 0 %}
                  <span class="badge bg-danger">{{ item.variance|floatformat:0 }}</span>
                {% else %}
                  <span class="badge bg-secondary">0</span>
                {% endif %}
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>
            <td>
              {% if item.value_variance and item.actual_quantity is not None %}
                {% if item.value_variance > 0 %}
                  <span class="text-success fw-bold">+${{ item.value_variance|floatformat:2 }}</span>
                {% elif item.value_variance < 0 %}
                  <span class="text-danger fw-bold">${{ item.value_variance|floatformat:2 }}</span>
                {% else %}
                  <span class="text-muted">$0.00</span>
                {% endif %}
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>
            <td>
              {% if item.actual_quantity is not None %}
                {% if item.variance == 0 %}
                  <span class="badge bg-success">Match</span>
                {% else %}
                  <span class="badge bg-warning">Variance</span>
                {% endif %}
              {% else %}
                <span class="badge bg-secondary">Pending</span>
              {% endif %}
            </td>
            <td>
              {% if item.counted_at %}
                <div class="fw-bold">{{ item.counted_at|date:"M j" }}</div>
                <small class="text-muted">{{ item.counted_at|time:"g:i A" }}</small>
                {% if item.counted_by %}
                  <br><small class="text-muted">by {{ item.counted_by.get_full_name|default:item.counted_by.username }}</small>
                {% endif %}
              {% else %}
                <span class="text-muted">Not counted</span>
              {% endif %}
            </td>
            {% if object.status == 'in_progress' %}
            <td>
              <button type="button" class="btn btn-outline-primary btn-sm" 
                      data-bs-toggle="modal" data-bs-target="#countModal"
                      data-item-id="{{ item.pk }}" 
                      data-product-name="{{ item.product.name }}"
                      data-expected="{{ item.expected_quantity }}"
                      data-current="{{ item.actual_quantity|default:'' }}">
                <i class="bi bi-calculator"></i> Count
              </button>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    {% if page_obj and page_obj.has_other_pages %}
    <nav aria-label="Items pagination" class="p-3">
      <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1">First</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
          </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
          {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
          </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <div class="text-center p-5">
      <i class="bi bi-inbox fa-4x text-muted mb-3"></i>
      <h4>No Items to Count</h4>
      <p class="text-muted">This stock take doesn't have any items yet.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Count Item Modal -->
{% if object.status == 'in_progress' %}
<div class="modal fade" id="countModal" tabindex="-1" aria-labelledby="countModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="countModalLabel">Count Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="countForm" method="post" action="{% url 'inventory:stock_take_count_item' %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="count-item-id" name="item_id">
          <div class="mb-3">
            <label class="form-label">Product</label>
            <input type="text" class="form-control" id="count-product-name" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Expected Quantity</label>
            <input type="text" class="form-control" id="count-expected" readonly>
          </div>
          <div class="mb-3">
            <label for="count-actual" class="form-label">Counted Quantity</label>
            <input type="number" class="form-control" id="count-actual" name="actual_quantity" 
                   step="0.01" required autofocus>
          </div>
          <div class="mb-3">
            <label for="count-notes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="count-notes" name="notes" rows="2" 
                      placeholder="Any observations or comments..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Count</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Count Modal -->
<div class="modal fade" id="bulkCountModal" tabindex="-1" aria-labelledby="bulkCountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkCountModalLabel">Bulk Count Entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'inventory:stock_take_bulk_count' %}">
        {% csrf_token %}
        <input type="hidden" name="stock_take_id" value="{{ object.pk }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="bulk-data" class="form-label">Count Data</label>
            <textarea class="form-control" id="bulk-data" name="count_data" rows="10" 
                      placeholder="Enter counts in format: SKU,Quantity&#10;For example:&#10;ABC123,25&#10;XYZ456,0&#10;DEF789,150"></textarea>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Format:</strong> Enter one item per line in the format "SKU,Quantity". 
            You can also scan barcodes directly into this field.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Process Counts</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle count modal
    const countModal = document.getElementById('countModal');
    if (countModal) {
        countModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const itemId = button.getAttribute('data-item-id');
            const productName = button.getAttribute('data-product-name');
            const expected = button.getAttribute('data-expected');
            const current = button.getAttribute('data-current');

            document.getElementById('count-item-id').value = itemId;
            document.getElementById('count-product-name').value = productName;
            document.getElementById('count-expected').value = expected;
            document.getElementById('count-actual').value = current;
        });
    }

    // Stock take actions
    window.startStockTake = function(stockTakeId) {
        if (confirm('Are you sure you want to start this stock take?')) {
            fetch(`{% url 'inventory:stock_take_start' 0 %}`.replace('0', stockTakeId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error starting stock take: ' + data.error);
                }
            });
        }
    };

    window.completeStockTake = function(stockTakeId) {
        if (confirm('Are you sure you want to complete this stock take? This will apply all adjustments to your inventory.')) {
            fetch(`{% url 'inventory:stock_take_complete' stockTakeId %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error completing stock take: ' + data.error);
                }
            });
        }
    };

    // Auto-save count form on submission
    const countForm = document.getElementById('countForm');
    if (countForm) {
        countForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            fetch(this.action, {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error saving count: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving count. Please try again.');
            });
        });
    }
});
</script>

{% csrf_token %}
{% endblock %}