{% extends "inventory_base.html" %}
{% load static %}

<!-- This template handles manual stock adjustments, which are among the most sensitive
     operations in inventory management. The design prioritizes accuracy and accountability
     while maintaining ease of use. Every adjustment creates an audit trail, and we
     provide multiple safeguards to prevent costly mistakes. -->

{% block inventory_title %}Stock Adjustment{% endblock %}

{% block inventory_breadcrumbs %}
  {{ block.super }}
  {% with inventory_breadcrumbs=breadcrumbs %}{% endwith %}
{% endblock %}

{% block inventory_actions %}
  <!-- Action buttons are organized to promote the audit trail and provide context -->
  <div class="btn-group me-2" role="group">
    <a href="{% url 'inventory:stock_movements' %}" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-clock-history me-1"></i>View History
    </a>
    <a href="{% url 'inventory:stock_transfer' %}" class="btn btn-outline-success btn-sm">
      <i class="bi bi-arrow-left-right me-1"></i>Transfer Stock
    </a>
  </div>
  
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:bulk_adjust_stock' %}" class="btn btn-outline-warning btn-sm">
      <i class="bi bi-layers me-1"></i>Bulk Adjust
    </a>
    <a href="{% url 'inventory:stock_overview' %}" class="btn btn-outline-info btn-sm">
      <i class="bi bi-graph-up me-1"></i>Overview
    </a>
  </div>
{% endblock %}

{% block inventory_content %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      
      <!-- Warning card emphasizes the importance of accuracy in stock adjustments.
           This helps prevent casual or accidental adjustments that could impact business operations. -->
      <div class="card border-warning mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle text-warning fs-2 me-3"></i>
            <div>
              <h6 class="card-title mb-1 text-warning">Important: Stock Adjustment Guidelines</h6>
              <p class="card-text mb-0">
                Stock adjustments directly affect inventory value and availability. Please ensure accuracy and provide detailed reasons for all changes.
                All adjustments are logged and require proper authorization based on your role and the adjustment value.
              </p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Main adjustment form card provides a focused workspace for the critical task -->
      <div class="card inventory-card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-plus-minus me-2"></i>Adjust Stock Levels
          </h5>
          <small class="text-muted">
            Make precise adjustments to inventory quantities with full audit trail
          </small>
        </div>
        
        <form method="post" id="stockAdjustmentForm" novalidate class="needs-validation">
          {% csrf_token %}
          
          <div class="card-body">
            <!-- Form errors are prominently displayed to ensure users see and address them -->
            {% if form.errors %}
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Please correct the following errors:</strong>
                <ul class="mb-0 mt-2">
                  {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                      <li>{{ field|title }}: {{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            
            <!-- Product selection is the first step, with real-time stock level display.
                 This pattern provides immediate context for the adjustment decision. -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-box me-2"></i>Product Selection
                </h6>
              </div>
              
              <div class="col-md-8 mb-3">
                <label for="{{ form.product.id_for_label }}" class="form-label">
                  Product <span class="text-danger">*</span>
                </label>
                {{ form.product }}
                {% if form.product.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.product.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">Search by product name or SKU</div>
              </div>
              
              <!-- Current stock display provides essential context for adjustment decisions.
                   This real-time information helps prevent errors and informs the adjustment amount. -->
              <div class="col-md-4 mb-3">
                <label class="form-label">Current Stock Level</label>
                <div class="card border-info">
                  <div class="card-body text-center py-2">
                    <div id="currentStockDisplay" class="fs-4 fw-bold text-primary">
                      {% if form.instance.product %}
                        {{ form.instance.product.current_stock }}
                      {% else %}
                        Select Product
                      {% endif %}
                    </div>
                    <small class="text-muted">Units Available</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Location selection allows for location-specific adjustments.
                 This granularity is essential for multi-location inventory management. -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-geo-alt me-2"></i>Location Details
                </h6>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="{{ form.location.id_for_label }}" class="form-label">
                  Location
                </label>
                {{ form.location }}
                {% if form.location.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.location.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">Leave blank to adjust total stock across all locations</div>
              </div>
              
              <!-- Stock level by location provides specific context when needed -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Stock at Selected Location</label>
                <div class="card border-light">
                  <div class="card-body text-center py-2">
                    <div id="locationStockDisplay" class="fs-5 fw-bold text-secondary">
                      Select Location
                    </div>
                    <small class="text-muted">Units at Location</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Adjustment configuration is the heart of the form. We provide three
                 adjustment types to accommodate different operational scenarios while
                 making the impact crystal clear to the user. -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-calculator me-2"></i>Adjustment Details
                </h6>
              </div>
              
              <!-- Adjustment type selection with clear visual indicators -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Adjustment Type <span class="text-danger">*</span></label>
                <div class="adjustment-type-selector">
                  {% for choice in form.adjustment_type %}
                    <div class="form-check mb-2">
                      {{ choice.tag }}
                      <label class="form-check-label" for="{{ choice.id_for_label }}">
                        <strong>{{ choice.choice_label }}</strong>
                        <br><small class="text-muted">
                          {% if choice.data == 'set' %}Set inventory to a specific amount
                          {% elif choice.data == 'add' %}Increase current inventory by specified amount
                          {% elif choice.data == 'subtract' %}Decrease current inventory by specified amount
                          {% endif %}
                        </small>
                      </label>
                    </div>
                  {% endfor %}
                </div>
                {% if form.adjustment_type.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.adjustment_type.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <!-- Quantity input with real-time calculation display -->
              <div class="col-md-6 mb-3">
                <label for="{{ form.quantity.id_for_label }}" class="form-label">
                  Quantity <span class="text-danger">*</span>
                </label>
                {{ form.quantity }}
                {% if form.quantity.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.quantity.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                
                <!-- Real-time calculation display helps users understand the impact
                     of their adjustment before committing to it. This prevents errors
                     and provides immediate feedback. -->
                <div class="mt-2">
                  <div class="card border-secondary" id="adjustmentPreview" style="display: none;">
                    <div class="card-body py-2">
                      <div class="row text-center">
                        <div class="col-4">
                          <div class="small text-muted">Current</div>
                          <div id="previewCurrent" class="fw-bold">0</div>
                        </div>
                        <div class="col-4">
                          <div class="small text-muted">Change</div>
                          <div id="previewChange" class="fw-bold">0</div>
                        </div>
                        <div class="col-4">
                          <div class="small text-muted">New Total</div>
                          <div id="previewNew" class="fw-bold">0</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Documentation requirements enforce accountability and provide audit trail context.
                 This information is crucial for understanding why adjustments were made. -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="bi bi-file-text me-2"></i>Documentation & Justification
                </h6>
              </div>
              
              <!-- Reason field is required to maintain audit trail integrity -->
              <div class="col-12 mb-3">
                <label for="{{ form.reason.id_for_label }}" class="form-label">
                  Reason for Adjustment <span class="text-danger">*</span>
                </label>
                {{ form.reason }}
                {% if form.reason.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.reason.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  Provide a clear business reason for this adjustment (e.g., "Physical count variance", "Damaged goods", "Theft loss")
                </div>
              </div>
              
              <!-- Notes provide additional context for complex situations -->
              <div class="col-12 mb-3">
                <label for="{{ form.notes.id_for_label }}" class="form-label">
                  Additional Notes
                </label>
                {{ form.notes }}
                {% if form.notes.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.notes.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  Optional detailed explanation or supporting information
                </div>
              </div>
            </div>
            
            <!-- Value impact calculation helps users understand the financial implications
                 of their adjustments. This is particularly important for high-value items. -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-info" id="valueImpactCard" style="display: none;">
                  <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                      <i class="bi bi-calculator me-2"></i>Financial Impact Assessment
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row text-center">
                      <div class="col-md-4">
                        <div class="small text-muted">Unit Cost</div>
                        <div id="unitCost" class="fs-5 fw-bold">$0.00</div>
                      </div>
                      <div class="col-md-4">
                        <div class="small text-muted">Quantity Change</div>
                        <div id="quantityChange" class="fs-5 fw-bold">0</div>
                      </div>
                      <div class="col-md-4">
                        <div class="small text-muted">Value Impact</div>
                        <div id="valueImpact" class="fs-5 fw-bold">$0.00</div>
                      </div>
                    </div>
                    
                    <!-- High-value adjustment warning provides an additional safeguard -->
                    <div id="highValueWarning" class="alert alert-warning mt-3" style="display: none;">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <strong>High Value Adjustment:</strong> This adjustment affects significant inventory value. Please verify accuracy and ensure proper authorization.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Form actions provide clear options and emphasize the importance of the operation -->
          <div class="card-footer bg-light">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted small">
                <i class="bi bi-shield-check me-1"></i>
                All adjustments are logged with full audit trail
              </div>
              
              <div class="btn-group">
                <a href="{% url 'inventory:stock_movements' %}" class="btn btn-outline-secondary">
                  <i class="bi bi-x-circle me-1"></i>Cancel
                </a>
                <button type="submit" class="btn btn-warning" id="submitAdjustment">
                  <i class="bi bi-check-circle me-1"></i>Submit Adjustment
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <!-- Recent adjustments provide context and allow users to see patterns
           in adjustment activity. This can help identify systemic issues. -->
      {% if recent_adjustments %}
        <div class="card inventory-card mt-4">
          <div class="card-header">
            <h6 class="card-title mb-0">
              <i class="bi bi-clock-history me-2"></i>Recent Stock Adjustments
            </h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Product</th>
                    <th>Change</th>
                    <th>Reason</th>
                    <th>User</th>
                  </tr>
                </thead>
                <tbody>
                  {% for adjustment in recent_adjustments %}
                    <tr>
                      <td>{{ adjustment.created_at|date:"M d, H:i" }}</td>
                      <td>
                        <a href="{% url 'inventory:product_detail' adjustment.product.pk %}" class="text-decoration-none">
                          {{ adjustment.product.name|truncatechars:30 }}
                        </a>
                      </td>
                      <td>
                        <span class="fw-bold {% if adjustment.quantity > 0 %}text-success{% else %}text-danger{% endif %}">
                          {% if adjustment.quantity > 0 %}+{% endif %}{{ adjustment.quantity }}
                        </span>
                      </td>
                      <td>{{ adjustment.reference|truncatechars:40 }}</td>
                      <td>{{ adjustment.created_by.get_full_name|default:adjustment.created_by.username }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="text-center mt-3">
              <a href="{% url 'inventory:stock_movements' %}?movement_type=adjustment" class="btn btn-outline-primary btn-sm">
                View All Adjustments
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Enhanced JavaScript functionality for stock adjustment interface
// This script provides real-time feedback and validation to prevent errors
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('stockAdjustmentForm');
  const productField = document.getElementById('{{ form.product.id_for_label }}');
  const locationField = document.getElementById('{{ form.location.id_for_label }}');
  const quantityField = document.getElementById('{{ form.quantity.id_for_label }}');
  const adjustmentTypeFields = document.querySelectorAll('input[name="{{ form.adjustment_type.html_name }}"]');
  
  // Product selection handler provides immediate stock level feedback
  // This helps users make informed adjustment decisions
  productField.addEventListener('change', function() {
    const productId = this.value;
    if (productId) {
      // Fetch current stock levels for the selected product
      fetch(`/inventory/api/products/${productId}/details/`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateStockDisplays(data.product);
            updateValueCalculations(data.product);
          }
        })
        .catch(error => {
          console.error('Error fetching product details:', error);
          showStockStatusUpdate('Error loading product details', 'error');
        });
    } else {
      resetStockDisplays();
    }
  });
  
  // Location selection updates location-specific stock levels
  // This granular information helps with location-based adjustments
  locationField.addEventListener('change', function() {
    const locationId = this.value;
    const productId = productField.value;
    
    if (productId && locationId) {
      fetch(`/inventory/api/locations/${locationId}/availability/?product=${productId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('locationStockDisplay').textContent = data.quantity;
          }
        })
        .catch(error => {
          console.error('Error fetching location stock:', error);
        });
    } else {
      document.getElementById('locationStockDisplay').textContent = 'Select Location';
    }
  });
  
  // Real-time adjustment preview calculation
  // This immediate feedback helps prevent calculation errors
  function updateAdjustmentPreview() {
    const currentStock = parseInt(document.getElementById('currentStockDisplay').textContent) || 0;
    const quantity = parseInt(quantityField.value) || 0;
    const adjustmentType = document.querySelector('input[name="{{ form.adjustment_type.html_name }}"]:checked')?.value;
    
    if (adjustmentType && quantity) {
      let change = 0;
      let newTotal = currentStock;
      
      // Calculate based on adjustment type
      switch (adjustmentType) {
        case 'set':
          change = quantity - currentStock;
          newTotal = quantity;
          break;
        case 'add':
          change = quantity;
          newTotal = currentStock + quantity;
          break;
        case 'subtract':
          change = -quantity;
          newTotal = Math.max(0, currentStock - quantity);
          break;
      }
      
      // Update preview display with visual indicators
      document.getElementById('previewCurrent').textContent = currentStock;
      document.getElementById('previewChange').textContent = (change >= 0 ? '+' : '') + change;
      document.getElementById('previewNew').textContent = newTotal;
      
      // Color coding for change direction
      const changeElement = document.getElementById('previewChange');
      changeElement.className = 'fw-bold ' + (change > 0 ? 'text-success' : change < 0 ? 'text-danger' : 'text-secondary');
      
      // Warning for negative stock
      if (newTotal < 0) {
        document.getElementById('previewNew').className = 'fw-bold text-danger';
        showValidationMessage('warning', 'This adjustment would result in negative stock');
      } else {
        document.getElementById('previewNew').className = 'fw-bold text-primary';
        clearValidationMessages();
      }
      
      document.getElementById('adjustmentPreview').style.display = 'block';
      updateValueImpact(change);
    } else {
      document.getElementById('adjustmentPreview').style.display = 'none';
      document.getElementById('valueImpactCard').style.display = 'none';
    }
  }
  
  // Value impact calculation for financial awareness
  // This helps users understand the monetary implications of adjustments
  function updateValueImpact(quantityChange) {
    const productId = productField.value;
    if (productId && quantityChange !== 0) {
      fetch(`/inventory/api/products/${productId}/details/`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const unitCost = parseFloat(data.product.cost_price) || 0;
            const valueImpact = Math.abs(quantityChange) * unitCost;
            
            document.getElementById('unitCost').textContent = `$${unitCost.toFixed(2)}`;
            document.getElementById('quantityChange').textContent = Math.abs(quantityChange);
            document.getElementById('valueImpact').textContent = `$${valueImpact.toFixed(2)}`;
            
            // Show high-value warning for significant adjustments
            const highValueWarning = document.getElementById('highValueWarning');
            if (valueImpact > 1000) {
              highValueWarning.style.display = 'block';
            } else {
              highValueWarning.style.display = 'none';
            }
            
            document.getElementById('valueImpactCard').style.display = 'block';
          }
        });
    }
  }
  
  // Event listeners for real-time updates
  quantityField.addEventListener('input', updateAdjustmentPreview);
  adjustmentTypeFields.forEach(field => {
    field.addEventListener('change', updateAdjustmentPreview);
  });
  
  // Form validation enhancement with business logic
  // This prevents common errors and enforces business rules
  form.addEventListener('submit', function(e) {
    const currentStock = parseInt(document.getElementById('currentStockDisplay').textContent) || 0;
    const quantity = parseInt(quantityField.value) || 0;
    const adjustmentType = document.querySelector('input[name="{{ form.adjustment_type.html_name }}"]:checked')?.value;
    const reason = document.getElementById('{{ form.reason.id_for_label }}').value.trim();
    
    // Validate required fields
    if (!productField.value) {
      e.preventDefault();
      showValidationMessage('error', 'Please select a product');
      productField.focus();
      return;
    }
    
    if (!adjustmentType) {
      e.preventDefault();
      showValidationMessage('error', 'Please select an adjustment type');
      return;
    }
    
    if (!quantity || quantity <= 0) {
      e.preventDefault();
      showValidationMessage('error', 'Please enter a valid quantity');
      quantityField.focus();
      return;
    }
    
    if (!reason) {
      e.preventDefault();
      showValidationMessage('error', 'Please provide a reason for this adjustment');
      document.getElementById('{{ form.reason.id_for_label }}').focus();
      return;
    }
    
    // Business rule validations
    if (adjustmentType === 'subtract' && quantity > currentStock) {
      e.preventDefault();
      showValidationMessage('error', `Cannot subtract ${quantity} units. Only ${currentStock} units available.`);
      quantityField.focus();
      return;
    }
    
    // High-value adjustment confirmation
    const valueImpactElement = document.getElementById('valueImpact');
    if (valueImpactElement && parseFloat(valueImpactElement.textContent.replace('$', '')) > 5000) {
      if (!confirm('This adjustment has a high financial impact. Are you sure you want to proceed?')) {
        e.preventDefault();
        return;
      }
    }
    
    // Final confirmation for all adjustments
    const confirmMessage = `Are you sure you want to ${adjustmentType} ${quantity} units for ${productField.options[productField.selectedIndex].text}?`;
    if (!confirm(confirmMessage)) {
      e.preventDefault();
      return;
    }
    
    // Show loading state
    const submitButton = document.getElementById('submitAdjustment');
    submitButton.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Processing...';
    submitButton.disabled = true;
  });
  
  // Helper functions for UI updates
  function updateStockDisplays(product) {
    document.getElementById('currentStockDisplay').textContent = product.current_stock;
    updateAdjustmentPreview();
  }
  
  function resetStockDisplays() {
    document.getElementById('currentStockDisplay').textContent = 'Select Product';
    document.getElementById('locationStockDisplay').textContent = 'Select Location';
    document.getElementById('adjustmentPreview').style.display = 'none';
    document.getElementById('valueImpactCard').style.display = 'none';
  }
  
  function updateValueCalculations(product) {
    // Store product data for value calculations
    form.setAttribute('data-product-cost', product.cost_price);
  }
  
  function showValidationMessage(type, message) {
    // Create or update validation message display
    let messageDiv = document.getElementById('validationMessage');
    if (!messageDiv) {
      messageDiv = document.createElement('div');
      messageDiv.id = 'validationMessage';
      form.insertBefore(messageDiv, form.firstChild);
    }
    
    messageDiv.className = `alert alert-${type === 'error' ? 'danger' : 'warning'} alert-dismissible fade show`;
    messageDiv.innerHTML = `
      <i class="bi bi-exclamation-triangle me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
  }
  
  function clearValidationMessages() {
    const messageDiv = document.getElementById('validationMessage');
    if (messageDiv) {
      messageDiv.remove();
    }
  }
  
  // Initialize tooltips for help text
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
{% endblock %}
