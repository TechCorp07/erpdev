{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Stock Take - {{ stock_take.reference }}{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:stock_overview' %}">Stock Management</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:stock_take_list' %}">Stock Takes</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:stock_take_detail' stock_take.pk %}">{{ stock_take.reference }}</a></li>
        <li class="breadcrumb-item active">Counting</li>
      </ol>
    </nav>
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-calculator me-2"></i>Stock Take Counting
      <span class="badge bg-warning ms-2">In Progress</span>
    </h1>
    <p class="text-muted mb-0">{{ stock_take.description|default:"Physical inventory counting interface" }}</p>
  </div>
  
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#scannerModal">
      <i class="bi bi-qr-code-scan me-2"></i>Barcode Scanner
    </button>
    <button type="button" class="btn btn-outline-success" id="bulk-entry-btn">
      <i class="bi bi-list-ul me-2"></i>Bulk Entry
    </button>
    <div class="btn-group" role="group">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-three-dots"></i>
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{% url 'inventory:stock_take_pause' stock_take.pk %}">
          <i class="bi bi-pause me-2"></i>Pause Counting
        </a></li>
        <li><a class="dropdown-item" href="{% url 'inventory:stock_take_print' stock_take.pk %}">
          <i class="bi bi-printer me-2"></i>Print Count Sheets
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{% url 'inventory:stock_take_export' stock_take.pk %}">
          <i class="bi bi-download me-2"></i>Export Progress
        </a></li>
        <li><a class="dropdown-item" href="#" onclick="syncOfflineData()">
          <i class="bi bi-cloud-upload me-2"></i>Sync Offline Data
        </a></li>
      </ul>
    </div>
  </div>
</div>

<!-- Progress Overview -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-primary text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Total Items
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ total_items|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-list fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-success text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Completed
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ completed_items|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-check-circle fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-warning text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Remaining
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ remaining_items|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-hourglass-split fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-info text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Progress
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ completion_percentage|default:0|floatformat:1 }}%</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-speedometer fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Count Interface -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary">
      <i class="bi bi-search me-2"></i>Quick Count Interface
    </h6>
  </div>
  <div class="card-body">
    <form id="quickCountForm" class="row g-3" onsubmit="return false;">
      <div class="col-md-4">
        <label for="product-search" class="form-label">Product Search</label>
        <div class="input-group">
          <input type="text" class="form-control" id="product-search" 
                 placeholder="Scan barcode or search product..." autofocus>
          <button class="btn btn-outline-secondary" type="button" id="search-btn">
            <i class="bi bi-search"></i>
          </button>
        </div>
        <div id="search-results" class="list-group position-absolute" style="z-index: 1000; width: 100%; display: none;"></div>
      </div>
      <div class="col-md-3">
        <label for="count-quantity" class="form-label">Counted Quantity</label>
        <input type="number" class="form-control" id="count-quantity" 
               step="0.01" min="0" placeholder="0">
      </div>
      <div class="col-md-3">
        <label for="count-notes" class="form-label">Notes (Optional)</label>
        <input type="text" class="form-control" id="count-notes" 
               placeholder="Damage, location notes...">
      </div>
      <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <div class="d-grid">
          <button type="button" class="btn btn-success" id="save-count-btn" disabled>
            <i class="bi bi-check me-1"></i>Save Count
          </button>
        </div>
      </div>
    </form>
    
    <!-- Current Item Display -->
    <div id="current-item" class="mt-3 p-3 bg-light rounded" style="display: none;">
      <div class="row align-items-center">
        <div class="col-md-2">
          <img id="current-item-image" src="" alt="" class="img-fluid rounded" style="max-height: 80px;">
        </div>
        <div class="col-md-6">
          <h6 id="current-item-name" class="mb-1"></h6>
          <div class="text-muted">
            <small>SKU: <span id="current-item-sku"></span></small><br>
            <small>Expected: <span id="current-item-expected" class="fw-bold"></span></small>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-info" onclick="showItemDetails()">
              <i class="bi bi-info-circle"></i> Details
            </button>
            <button type="button" class="btn btn-outline-warning" onclick="flagForReview()">
              <i class="bi bi-flag"></i> Flag
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Items List with Filtering -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex justify-content-between align-items-center">
    <h6 class="m-0 font-weight-bold text-primary">Items to Count</h6>
    <div class="btn-group btn-group-sm" role="group">
      <button type="button" class="btn btn-outline-secondary filter-btn active" data-filter="all">
        All ({{ total_items|default:0 }})
      </button>
      <button type="button" class="btn btn-outline-success filter-btn" data-filter="completed">
        Counted ({{ completed_items|default:0 }})
      </button>
      <button type="button" class="btn btn-outline-warning filter-btn" data-filter="pending">
        Pending ({{ remaining_items|default:0 }})
      </button>
      <button type="button" class="btn btn-outline-danger filter-btn" data-filter="discrepancies">
        Variances ({{ discrepancy_count|default:0 }})
      </button>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="items-table">
        <thead class="bg-light">
          <tr>
            <th width="40">#</th>
            <th>Product</th>
            <th>Location</th>
            <th>Expected</th>
            <th>Counted</th>
            <th>Variance</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr class="item-row {% if item.actual_quantity is not None %}counted{% else %}pending{% endif %} 
                    {% if item.variance and item.variance != 0 %}has-variance{% endif %}"
              data-item-id="{{ item.pk }}" data-product-id="{{ item.product.pk }}">
            <td>
              <small class="text-muted">{{ forloop.counter }}</small>
            </td>
            <td>
              <div class="d-flex align-items-center">
                {% if item.product.image %}
                  <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="me-2" 
                       style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px;">
                {% else %}
                  <div class="me-2 bg-light d-flex align-items-center justify-content-center" 
                       style="width: 32px; height: 32px; border-radius: 4px;">
                    <i class="bi bi-image text-muted small"></i>
                  </div>
                {% endif %}
                <div>
                  <div class="fw-bold">{{ item.product.name|truncatechars:30 }}</div>
                  <small class="text-muted">{{ item.product.sku }}</small>
                </div>
              </div>
            </td>
            <td>
              {% if item.location %}
                <small class="badge bg-light text-dark">{{ item.location.name }}</small>
              {% else %}
                <small class="text-muted">All</small>
              {% endif %}
            </td>
            <td>
              <span class="fw-bold">{{ item.expected_quantity|floatformat:0 }}</span>
              {% if item.product.unit %}
                <small class="text-muted">{{ item.product.unit }}</small>
              {% endif %}
            </td>
            <td>
              <input type="number" class="form-control form-control-sm count-input" 
                     data-item-id="{{ item.pk }}" step="0.01" min="0"
                     value="{% if item.actual_quantity is not None %}{{ item.actual_quantity|floatformat:2 }}{% endif %}"
                     placeholder="Enter count...">
            </td>
            <td>
              <span class="variance-display">
                {% if item.actual_quantity is not None %}
                  {% if item.variance > 0 %}
                    <span class="badge bg-success">+{{ item.variance|floatformat:0 }}</span>
                  {% elif item.variance < 0 %}
                    <span class="badge bg-danger">{{ item.variance|floatformat:0 }}</span>
                  {% else %}
                    <span class="badge bg-secondary">0</span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </span>
            </td>
            <td>
              <span class="status-badge">
                {% if item.actual_quantity is not None %}
                  {% if item.variance == 0 %}
                    <span class="badge bg-success">Match</span>
                  {% else %}
                    <span class="badge bg-warning">Variance</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">Pending</span>
                {% endif %}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-success save-item-btn" 
                        data-item-id="{{ item.pk }}" title="Save Count">
                  <i class="bi bi-check"></i>
                </button>
                <button type="button" class="btn btn-outline-info item-details-btn" 
                        data-product-id="{{ item.product.pk }}" title="View Details">
                  <i class="bi bi-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-warning flag-item-btn" 
                        data-item-id="{{ item.pk }}" title="Flag for Review">
                  <i class="bi bi-flag"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if not items %}
    <div class="text-center p-5">
      <i class="bi bi-clipboard-check fa-4x text-muted mb-3"></i>
      <h4>All Items Counted</h4>
      <p class="text-muted">Great job! All items in this stock take have been counted.</p>
      <a href="{% url 'inventory:stock_take_review' stock_take.pk %}" class="btn btn-success">
        <i class="bi bi-clipboard-check me-2"></i>Review & Complete
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scannerModalLabel">Barcode Scanner</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="scanner-container">
          <video id="scanner-video" width="100%" height="300" style="border: 1px solid #ddd; border-radius: 4px;"></video>
        </div>
        <div id="scanner-result" class="mt-3" style="display: none;">
          <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>
            Product found: <span id="scanned-product-name"></span>
          </div>
        </div>
        <div class="mt-3">
          <button type="button" class="btn btn-primary" id="start-scanner">
            <i class="bi bi-camera me-2"></i>Start Scanner
          </button>
          <button type="button" class="btn btn-secondary" id="stop-scanner" style="display: none;">
            <i class="bi bi-stop-circle me-2"></i>Stop Scanner
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Item Details Modal -->
<div class="modal fade" id="itemDetailsModal" tabindex="-1" aria-labelledby="itemDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="itemDetailsModalLabel">Item Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="item-details-content">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<!-- Flag Item Modal -->
<div class="modal fade" id="flagItemModal" tabindex="-1" aria-labelledby="flagItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="flagItemModalLabel">Flag Item for Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="flagItemForm">
        <div class="modal-body">
          <input type="hidden" id="flag-item-id" name="item_id">
          <div class="mb-3">
            <label for="flag-reason" class="form-label">Reason for Flagging</label>
            <select class="form-select" id="flag-reason" name="flag_reason" required>
              <option value="">Select reason...</option>
              <option value="damaged">Damaged Item</option>
              <option value="missing">Item Missing</option>
              <option value="expired">Expired Product</option>
              <option value="location">Wrong Location</option>
              <option value="quality">Quality Issue</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="flag-notes" class="form-label">Additional Notes</label>
            <textarea class="form-control" id="flag-notes" name="notes" rows="3" 
                      placeholder="Provide details about the issue..."></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="flag-photo-required" name="photo_required">
            <label class="form-check-label" for="flag-photo-required">
              Photo required for verification
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Flag Item</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentSelectedItem = null;
    let scannerStream = null;

    // Product search functionality
    const productSearch = document.getElementById('product-search');
    const searchResults = document.getElementById('search-results');
    const currentItem = document.getElementById('current-item');
    const countQuantity = document.getElementById('count-quantity');
    const saveCountBtn = document.getElementById('save-count-btn');

    // Debounced search
    let searchTimeout;
    productSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length > 2) {
            searchTimeout = setTimeout(() => searchProducts(query), 300);
        } else {
            searchResults.style.display = 'none';
        }
    });

    function searchProducts(query) {
        fetch(`{% url 'inventory:product_search_api' %}?q=${encodeURIComponent(query)}&stock_take=${{{ stock_take.pk }}}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data.products);
            })
            .catch(error => console.error('Search error:', error));
    }

    function displaySearchResults(products) {
        searchResults.innerHTML = '';
        
        if (products.length > 0) {
            products.forEach(product => {
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.href = '#';
                item.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px;">` :
                                `<div class="bg-light d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; border-radius: 4px;"><i class="bi bi-image text-muted"></i></div>`
                            }
                        </div>
                        <div>
                            <div class="fw-bold">${product.name}</div>
                            <small class="text-muted">${product.sku} - Expected: ${product.expected_quantity}</small>
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectProduct(product);
                });
                
                searchResults.appendChild(item);
            });
            
            searchResults.style.display = 'block';
        } else {
            searchResults.style.display = 'none';
        }
    }

    function selectProduct(product) {
        currentSelectedItem = product;
        
        // Hide search results
        searchResults.style.display = 'none';
        productSearch.value = product.name;
        
        // Show current item details
        document.getElementById('current-item-image').src = product.image || '/static/placeholder-image.png';
        document.getElementById('current-item-name').textContent = product.name;
        document.getElementById('current-item-sku').textContent = product.sku;
        document.getElementById('current-item-expected').textContent = product.expected_quantity;
        
        currentItem.style.display = 'block';
        
        // Focus on quantity input
        countQuantity.focus();
        countQuantity.value = product.actual_quantity || '';
        
        // Enable save button
        saveCountBtn.disabled = false;
    }

    // Save count functionality
    saveCountBtn.addEventListener('click', function() {
        if (!currentSelectedItem) return;
        
        const quantity = parseFloat(countQuantity.value) || 0;
        const notes = document.getElementById('count-notes').value;
        
        saveItemCount(currentSelectedItem.item_id, quantity, notes);
    });

    // Save individual item counts
    document.querySelectorAll('.save-item-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            const input = document.querySelector(`input[data-item-id="${itemId}"]`);
            const quantity = parseFloat(input.value) || 0;
            
            saveItemCount(itemId, quantity);
        });
    });

    function saveItemCount(itemId, quantity, notes = '') {
        fetch('{% url "inventory:stock_take_save_count" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity: quantity,
                notes: notes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateItemDisplay(itemId, quantity, data.variance);
                updateProgressStats();
                
                // Clear current item
                currentItem.style.display = 'none';
                productSearch.value = '';
                countQuantity.value = '';
                document.getElementById('count-notes').value = '';
                saveCountBtn.disabled = true;
                currentSelectedItem = null;
                
                // Show success message
                showNotification('Count saved successfully!', 'success');
            } else {
                showNotification('Error saving count: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showNotification('Error saving count. Please try again.', 'error');
        });
    }

    function updateItemDisplay(itemId, quantity, variance) {
        const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
        if (row) {
            // Update variance display
            const varianceSpan = row.querySelector('.variance-display');
            if (variance > 0) {
                varianceSpan.innerHTML = `<span class="badge bg-success">+${variance}</span>`;
            } else if (variance < 0) {
                varianceSpan.innerHTML = `<span class="badge bg-danger">${variance}</span>`;
            } else {
                varianceSpan.innerHTML = `<span class="badge bg-secondary">0</span>`;
            }
            
            // Update status
            const statusBadge = row.querySelector('.status-badge');
            if (variance === 0) {
                statusBadge.innerHTML = `<span class="badge bg-success">Match</span>`;
            } else {
                statusBadge.innerHTML = `<span class="badge bg-warning">Variance</span>`;
            }
            
            // Update row classes
            row.classList.remove('pending');
            row.classList.add('counted');
            if (variance !== 0) {
                row.classList.add('has-variance');
            }
        }
    }

    function updateProgressStats() {
        // This would typically refresh the stats from the server
        // For now, we'll update locally
        location.reload(); // Simple approach - could be optimized with AJAX
    }

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Filter rows
            const rows = document.querySelectorAll('.item-row');
            rows.forEach(row => {
                let show = true;
                
                switch(filter) {
                    case 'completed':
                        show = row.classList.contains('counted');
                        break;
                    case 'pending':
                        show = row.classList.contains('pending');
                        break;
                    case 'discrepancies':
                        show = row.classList.contains('has-variance');
                        break;
                    case 'all':
                    default:
                        show = true;
                }
                
                row.style.display = show ? '' : 'none';
            });
        });
    });

    // Item details modal
    document.querySelectorAll('.item-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            loadItemDetails(productId);
        });
    });

    function loadItemDetails(productId) {
        fetch(`{% url 'inventory:product_detail_api' 0 %}`.replace('0', productId))
            .then(response => response.json())
            .then(data => {
                document.getElementById('item-details-content').innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <img src="${data.image || '/static/placeholder-image.png'}" class="img-fluid rounded" alt="${data.name}">
                        </div>
                        <div class="col-md-8">
                            <h5>${data.name}</h5>
                            <p><strong>SKU:</strong> ${data.sku}</p>
                            <p><strong>Category:</strong> ${data.category || 'Uncategorized'}</p>
                            <p><strong>Current Stock:</strong> ${data.current_stock}</p>
                            <p><strong>Unit Price:</strong> $${data.price}</p>
                            <p><strong>Description:</strong> ${data.description || 'No description available'}</p>
                        </div>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('itemDetailsModal')).show();
            });
    }

    // Flag item functionality
    document.querySelectorAll('.flag-item-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            document.getElementById('flag-item-id').value = itemId;
            new bootstrap.Modal(document.getElementById('flagItemModal')).show();
        });
    });

    // Submit flag form
    document.getElementById('flagItemForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('{% url "inventory:stock_take_flag_item" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('flagItemModal')).hide();
                showNotification('Item flagged for review', 'success');
                this.reset();
            } else {
                showNotification('Error flagging item: ' + data.error, 'error');
            }
        });
    });

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Enter key to save current count
        if (e.key === 'Enter' && document.activeElement === countQuantity) {
            e.preventDefault();
            if (!saveCountBtn.disabled) {
                saveCountBtn.click();
            }
        }
        
        // Escape key to clear selection
        if (e.key === 'Escape') {
            currentItem.style.display = 'none';
            productSearch.value = '';
            countQuantity.value = '';
            saveCountBtn.disabled = true;
            currentSelectedItem = null;
            productSearch.focus();
        }
    });

    // Auto-save when typing in count inputs
    document.querySelectorAll('.count-input').forEach(input => {
        let saveTimeout;
        input.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const itemId = this.getAttribute('data-item-id');
                const quantity = parseFloat(this.value) || 0;
                if (this.value !== '') {
                    saveItemCount(itemId, quantity);
                }
            }, 1500); // Save after 1.5 seconds of no typing
        });
    });

    // Initialize focus on product search
    productSearch.focus();
});
</script>

{% csrf_token %}
{% endblock %}