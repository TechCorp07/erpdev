{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Bulk Product Update{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:product_list' %}">Products</a></li>
        <li class="breadcrumb-item active">Bulk Update</li>
      </ol>
    </nav>
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-pencil-square me-2"></i>Bulk Product Update
    </h1>
    <p class="text-muted mb-0">Update multiple products simultaneously with batch operations</p>
  </div>
  
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Back to Products
    </a>
    <a href="{% url 'inventory:product_bulk_create' %}" class="btn btn-outline-primary">
      <i class="bi bi-plus me-2"></i>Bulk Create
    </a>
    <div class="btn-group" role="group">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-three-dots"></i>
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{% url 'inventory:product_export' %}">
          <i class="bi bi-download me-2"></i>Export Products
        </a></li>
        <li><a class="dropdown-item" href="{% url 'inventory:product_import_template' %}">
          <i class="bi bi-file-spreadsheet me-2"></i>Download Template
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{% url 'inventory:product_search' %}">
          <i class="bi bi-search me-2"></i>Advanced Search
        </a></li>
      </ul>
    </div>
  </div>
</div>

<!-- Update Progress -->
<div class="card mb-4" id="progressCard" style="display: none;">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="card-title mb-0">
        <i class="bi bi-hourglass-split me-2"></i>Bulk Update Progress
      </h6>
      <button class="btn btn-sm btn-outline-secondary" onclick="cancelUpdate()">
        <i class="bi bi-x"></i> Cancel
      </button>
    </div>
    
    <div class="progress mb-2">
      <div class="progress-bar" role="progressbar" style="width: 0%" id="updateProgressBar"></div>
    </div>
    
    <div class="row text-center">
      <div class="col-md-3">
        <div class="fw-bold text-primary" id="processedCount">0</div>
        <div class="small text-muted">Processed</div>
      </div>
      <div class="col-md-3">
        <div class="fw-bold text-success" id="successCount">0</div>
        <div class="small text-muted">Updated</div>
      </div>
      <div class="col-md-3">
        <div class="fw-bold text-warning" id="skippedCount">0</div>
        <div class="small text-muted">Skipped</div>
      </div>
      <div class="col-md-3">
        <div class="fw-bold text-danger" id="errorCount">0</div>
        <div class="small text-muted">Errors</div>
      </div>
    </div>
  </div>
</div>

<!-- Product Selection -->
<div class="row">
  <div class="col-md-4">
    <div class="card sticky-top">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="bi bi-funnel me-2"></i>Select Products to Update
        </h6>
      </div>
      <div class="card-body">
        
        <!-- Quick Selection Options -->
        <div class="mb-4">
          <h6 class="text-muted">Quick Selections</h6>
          <div class="d-grid gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="selectByCategory()">
              <i class="bi bi-collection me-2"></i>By Category
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="selectByBrand()">
              <i class="bi bi-award me-2"></i>By Brand
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="selectBySupplier()">
              <i class="bi bi-building me-2"></i>By Supplier
            </button>
            <button class="btn btn-sm btn-outline-warning" onclick="selectLowStock()">
              <i class="bi bi-exclamation-triangle me-2"></i>Low Stock Items
            </button>
          </div>
        </div>
        
        <!-- Search and Filter -->
        <div class="mb-3">
          <label class="form-label">Search Products</label>
          <div class="input-group">
            <input type="text" class="form-control" id="productSearch" 
                   placeholder="Search by name or SKU..." onkeyup="searchProducts()">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
        
        <!-- Category Filter -->
        <div class="mb-3">
          <label class="form-label">Filter by Category</label>
          <select class="form-select" id="categoryFilter" onchange="filterProducts()">
            <option value="">All Categories</option>
            {% for category in categories %}
              <option value="{{ category.pk }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Brand Filter -->
        <div class="mb-3">
          <label class="form-label">Filter by Brand</label>
          <select class="form-select" id="brandFilter" onchange="filterProducts()">
            <option value="">All Brands</option>
            {% for brand in brands %}
              <option value="{{ brand.pk }}">{{ brand.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Status Filter -->
        <div class="mb-4">
          <label class="form-label">Product Status</label>
          <select class="form-select" id="statusFilter" onchange="filterProducts()">
            <option value="">All Products</option>
            <option value="active">Active Only</option>
            <option value="inactive">Inactive Only</option>
          </select>
        </div>
        
        <!-- Selection Summary -->
        <div class="alert alert-info">
          <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-info-circle me-2"></i><strong id="selectedCountDisplay">0</strong> products selected</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Clear All</button>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="d-grid gap-2">
          <button class="btn btn-primary" onclick="proceedToUpdate()" id="proceedBtn" disabled>
            <i class="bi bi-arrow-right me-2"></i>Proceed to Update
          </button>
          <button class="btn btn-outline-secondary" onclick="selectAll()">
            <i class="bi bi-check-square me-2"></i>Select All Visible
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-8">
    <!-- Product List -->
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">
            <i class="bi bi-list me-2"></i>Available Products
            <span class="badge bg-primary" id="productCountBadge">{{ products|length }}</span>
          </h6>
          
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="toggleView('grid')" id="gridViewBtn">
              <i class="bi bi-grid-3x3-gap"></i>
            </button>
            <button class="btn btn-outline-secondary active" onclick="toggleView('list')" id="listViewBtn">
              <i class="bi bi-list"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div class="card-body p-0">
        <!-- List View -->
        <div id="listView">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th width="40">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="selectAllProducts" onchange="toggleSelectAll()">
                    </div>
                  </th>
                  <th>Product</th>
                  <th>SKU</th>
                  <th>Category</th>
                  <th>Cost Price</th>
                  <th>Selling Price</th>
                  <th>Stock</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="productTableBody">
                {% for product in products %}
                <tr class="product-row" data-product-id="{{ product.pk }}" 
                    data-category="{{ product.category.pk }}" 
                    data-brand="{{ product.brand.pk|default:'' }}"
                    data-status="{% if product.is_active %}active{% else %}inactive{% endif %}">
                  <td>
                    <div class="form-check">
                      <input class="form-check-input product-checkbox" type="checkbox" 
                             value="{{ product.pk }}" onchange="updateSelection()">
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div>
                        <div class="fw-bold">{{ product.name }}</div>
                        {% if product.brand %}
                          <div class="small text-muted">{{ product.brand.name }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td><code>{{ product.sku }}</code></td>
                  <td><span class="badge bg-secondary">{{ product.category.name }}</span></td>
                  <td class="text-success">${{ product.cost_price|floatformat:2 }}</td>
                  <td class="text-primary">${{ product.selling_price|floatformat:2 }}</td>
                  <td>
                    <span class="{% if product.current_stock <= product.reorder_level %}text-danger{% else %}text-success{% endif %}">
                      {{ product.current_stock|default:0 }}
                    </span>
                  </td>
                  <td>
                    {% if product.is_active %}
                      <span class="badge bg-success">Active</span>
                    {% else %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox"></i> No products available for bulk update
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Grid View -->
        <div id="gridView" style="display: none;">
          <div class="row g-3 p-3" id="productGrid">
            {% for product in products %}
            <div class="col-md-6 col-lg-4 product-card" data-product-id="{{ product.pk }}"
                 data-category="{{ product.category.pk }}" 
                 data-brand="{{ product.brand.pk|default:'' }}"
                 data-status="{% if product.is_active %}active{% else %}inactive{% endif %}">
              <div class="card h-100">
                <div class="card-body">
                  <div class="form-check position-absolute top-0 end-0 m-2">
                    <input class="form-check-input product-checkbox" type="checkbox" 
                           value="{{ product.pk }}" onchange="updateSelection()">
                  </div>
                  
                  <h6 class="card-title">{{ product.name }}</h6>
                  {% if product.brand %}
                    <p class="card-text small text-muted">{{ product.brand.name }}</p>
                  {% endif %}
                  
                  <div class="small">
                    <div><strong>SKU:</strong> <code>{{ product.sku }}</code></div>
                    <div><strong>Category:</strong> {{ product.category.name }}</div>
                    <div><strong>Price:</strong> <span class="text-primary">${{ product.selling_price|floatformat:2 }}</span></div>
                    <div><strong>Stock:</strong> 
                      <span class="{% if product.current_stock <= product.reorder_level %}text-danger{% else %}text-success{% endif %}">
                        {{ product.current_stock|default:0 }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Update Form Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square me-2"></i>Bulk Update Selected Products
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="bulkUpdateForm">
          {% csrf_token %}
          
          <!-- Update Type Selection -->
          <div class="mb-4">
            <h6><i class="bi bi-sliders me-2"></i>Select Fields to Update</h6>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updatePricing" onchange="toggleUpdateSection('pricing')">
                  <label class="form-check-label fw-bold" for="updatePricing">
                    <i class="bi bi-currency-dollar me-1"></i>Pricing Information
                  </label>
                </div>
                
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateStock" onchange="toggleUpdateSection('stock')">
                  <label class="form-check-label fw-bold" for="updateStock">
                    <i class="bi bi-boxes me-1"></i>Stock Levels
                  </label>
                </div>
                
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateCategories" onchange="toggleUpdateSection('categories')">
                  <label class="form-check-label fw-bold" for="updateCategories">
                    <i class="bi bi-collection me-1"></i>Categories & Classification
                  </label>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateStatus" onchange="toggleUpdateSection('status')">
                  <label class="form-check-label fw-bold" for="updateStatus">
                    <i class="bi bi-toggle-on me-1"></i>Product Status
                  </label>
                </div>
                
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateSupplier" onchange="toggleUpdateSection('supplier')">
                  <label class="form-check-label fw-bold" for="updateSupplier">
                    <i class="bi bi-building me-1"></i>Supplier Information
                  </label>
                </div>
                
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updatePhysical" onchange="toggleUpdateSection('physical')">
                  <label class="form-check-label fw-bold" for="updatePhysical">
                    <i class="bi bi-rulers me-1"></i>Physical Properties
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Pricing Updates -->
          <div class="update-section" id="pricingSection" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>Pricing Updates</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Cost Price Update Method</label>
                      <select class="form-select" name="cost_price_method">
                        <option value="">No Change</option>
                        <option value="set">Set to Fixed Amount</option>
                        <option value="increase_percent">Increase by Percentage</option>
                        <option value="decrease_percent">Decrease by Percentage</option>
                        <option value="increase_amount">Increase by Fixed Amount</option>
                        <option value="decrease_amount">Decrease by Fixed Amount</option>
                      </select>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label">Value</label>
                      <div class="input-group">
                        <input type="number" class="form-control" name="cost_price_value" step="0.01">
                        <span class="input-group-text" id="costPriceUnit">$</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Selling Price Update Method</label>
                      <select class="form-select" name="selling_price_method">
                        <option value="">No Change</option>
                        <option value="set">Set to Fixed Amount</option>
                        <option value="increase_percent">Increase by Percentage</option>
                        <option value="decrease_percent">Decrease by Percentage</option>
                        <option value="increase_amount">Increase by Fixed Amount</option>
                        <option value="decrease_amount">Decrease by Fixed Amount</option>
                        <option value="markup_from_cost">Set Markup from Cost Price</option>
                      </select>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label">Value</label>
                      <div class="input-group">
                        <input type="number" class="form-control" name="selling_price_value" step="0.01">
                        <span class="input-group-text" id="sellingPriceUnit">$</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Stock Updates -->
          <div class="update-section" id="stockSection" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-boxes me-2"></i>Stock Level Updates</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Current Stock Update Method</label>
                      <select class="form-select" name="stock_method">
                        <option value="">No Change</option>
                        <option value="set">Set to Fixed Amount</option>
                        <option value="increase">Increase by Amount</option>
                        <option value="decrease">Decrease by Amount</option>
                        <option value="zero">Set to Zero</option>
                      </select>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label">Quantity</label>
                      <input type="number" class="form-control" name="stock_value" min="0">
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Reorder Level Update</label>
                      <select class="form-select" name="reorder_method">
                        <option value="">No Change</option>
                        <option value="set">Set to Fixed Amount</option>
                        <option value="percent_of_stock">Set as Percentage of Current Stock</option>
                        <option value="increase">Increase by Amount</option>
                        <option value="decrease">Decrease by Amount</option>
                      </select>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label">Value</label>
                      <input type="number" class="form-control" name="reorder_value" min="0">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Category Updates -->
          <div class="update-section" id="categoriesSection" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-collection me-2"></i>Categories & Classification</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Change Category</label>
                      <select class="form-select" name="new_category">
                        <option value="">No Change</option>
                        {% for category in categories %}
                          <option value="{{ category.pk }}">{{ category.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Change Brand</label>
                      <select class="form-select" name="new_brand">
                        <option value="">No Change</option>
                        <option value="remove">Remove Brand</option>
                        {% for brand in brands %}
                          <option value="{{ brand.pk }}">{{ brand.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Status Updates -->
          <div class="update-section" id="statusSection" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-toggle-on me-2"></i>Product Status</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label class="form-label">Set Product Status</label>
                      <select class="form-select" name="new_status">
                        <option value="">No Change</option>
                        <option value="active">Activate All Selected Products</option>
                        <option value="inactive">Deactivate All Selected Products</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Supplier Updates -->
          <div class="update-section" id="supplierSection" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-building me-2"></i>Supplier Information</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label class="form-label">Change Primary Supplier</label>
                      <select class="form-select" name="new_supplier">
                        <option value="">No Change</option>
                        <option value="remove">Remove Supplier</option>
                        {% for supplier in suppliers %}
                          <option value="{{ supplier.pk }}">{{ supplier.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Physical Properties Updates -->
          <div class="update-section" id="physicalSection" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-rulers me-2"></i>Physical Properties</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Weight Update Method</label>
                      <select class="form-select" name="weight_method">
                        <option value="">No Change</option>
                        <option value="set">Set to Fixed Weight (kg)</option>
                        <option value="clear">Clear Weight</option>
                      </select>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label">Weight Value (kg)</label>
                      <input type="number" class="form-control" name="weight_value" step="0.01" min="0">
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Unit of Measure</label>
                      <select class="form-select" name="new_unit_of_measure">
                        <option value="">No Change</option>
                        <option value="pcs">Pieces</option>
                        <option value="kg">Kilograms</option>
                        <option value="m">Meters</option>
                        <option value="liters">Liters</option>
                        <option value="boxes">Boxes</option>
                        <option value="sets">Sets</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Update Summary -->
          <div class="alert alert-info mt-4">
            <h6><i class="bi bi-info-circle me-2"></i>Update Summary</h6>
            <div id="updateSummary">Select fields to update above to see a summary of changes.</div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-warning" onclick="previewChanges()">
          <i class="bi bi-eye me-2"></i>Preview Changes
        </button>
        <button type="button" class="btn btn-success" onclick="executeUpdate()">
          <i class="bi bi-check me-2"></i>Execute Update
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedProducts = new Set();

function updateSelection() {
  selectedProducts.clear();
  
  document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
    selectedProducts.add(parseInt(checkbox.value));
  });
  
  document.getElementById('selectedCountDisplay').textContent = selectedProducts.size;
  document.getElementById('proceedBtn').disabled = selectedProducts.size === 0;
  
  // Update select all checkbox
  const allCheckboxes = document.querySelectorAll('.product-checkbox');
  const selectAllCheckbox = document.getElementById('selectAllProducts');
  
  if (allCheckboxes.length > 0) {
    selectAllCheckbox.checked = selectedProducts.size === allCheckboxes.length;
    selectAllCheckbox.indeterminate = selectedProducts.size > 0 && selectedProducts.size < allCheckboxes.length;
  }
}

function toggleSelectAll() {
  const selectAll = document.getElementById('selectAllProducts').checked;
  
  document.querySelectorAll('.product-checkbox').forEach(checkbox => {
    checkbox.checked = selectAll;
  });
  
  updateSelection();
}

function selectAll() {
  document.querySelectorAll('.product-checkbox:visible').forEach(checkbox => {
    checkbox.checked = true;
  });
  updateSelection();
}

function clearSelection() {
  document.querySelectorAll('.product-checkbox').forEach(checkbox => {
    checkbox.checked = false;
  });
  updateSelection();
}

function searchProducts() {
  const query = document.getElementById('productSearch').value.toLowerCase();
  
  document.querySelectorAll('.product-row').forEach(row => {
    const productName = row.querySelector('td:nth-child(2) .fw-bold').textContent.toLowerCase();
    const productSku = row.querySelector('code').textContent.toLowerCase();
    
    const matches = productName.includes(query) || productSku.includes(query);
    row.style.display = matches ? '' : 'none';
  });
  
  // Update grid view if active
  document.querySelectorAll('.product-card').forEach(card => {
    const productName = card.querySelector('.card-title').textContent.toLowerCase();
    const productSku = card.querySelector('code').textContent.toLowerCase();
    
    const matches = productName.includes(query) || productSku.includes(query);
    card.style.display = matches ? '' : 'none';
  });
}

function clearSearch() {
  document.getElementById('productSearch').value = '';
  searchProducts();
}

function filterProducts() {
  const categoryFilter = document.getElementById('categoryFilter').value;
  const brandFilter = document.getElementById('brandFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;
  
  document.querySelectorAll('.product-row, .product-card').forEach(item => {
    let show = true;
    
    if (categoryFilter && item.dataset.category !== categoryFilter) show = false;
    if (brandFilter && item.dataset.brand !== brandFilter) show = false;
    if (statusFilter && item.dataset.status !== statusFilter) show = false;
    
    item.style.display = show ? '' : 'none';
  });
}

function selectByCategory() {
  const category = prompt('Enter category name or select from dropdown:');
  if (category) {
    // Implementation would filter and select products by category
    alert(`Selection by category "${category}" would be implemented here`);
  }
}

function selectByBrand() {
  const brand = prompt('Enter brand name:');
  if (brand) {
    alert(`Selection by brand "${brand}" would be implemented here`);
  }
}

function selectBySupplier() {
  const supplier = prompt('Enter supplier name:');
  if (supplier) {
    alert(`Selection by supplier "${supplier}" would be implemented here`);
  }
}

function selectLowStock() {
  // Select all products with stock at or below reorder level
  document.querySelectorAll('.product-row').forEach(row => {
    const stockCell = row.querySelector('td:nth-child(7) span');
    if (stockCell && stockCell.classList.contains('text-danger')) {
      row.querySelector('.product-checkbox').checked = true;
    }
  });
  updateSelection();
}

function toggleView(viewType) {
  const listView = document.getElementById('listView');
  const gridView = document.getElementById('gridView');
  const listBtn = document.getElementById('listViewBtn');
  const gridBtn = document.getElementById('gridViewBtn');
  
  if (viewType === 'grid') {
    listView.style.display = 'none';
    gridView.style.display = 'block';
    listBtn.classList.remove('active');
    gridBtn.classList.add('active');
  } else {
    listView.style.display = 'block';
    gridView.style.display = 'none';
    listBtn.classList.add('active');
    gridBtn.classList.remove('active');
  }
}

function proceedToUpdate() {
  if (selectedProducts.size === 0) {
    alert('Please select at least one product to update.');
    return;
  }
  
  // Show the update modal
  const modal = new bootstrap.Modal(document.getElementById('updateModal'));
  modal.show();
}

function toggleUpdateSection(sectionName) {
  const checkbox = document.getElementById(`update${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}`);
  const section = document.getElementById(`${sectionName}Section`);
  
  section.style.display = checkbox.checked ? 'block' : 'none';
  
  updateSummary();
}

function updateSummary() {
  const checkedSections = Array.from(document.querySelectorAll('.form-check-input:checked'))
    .filter(cb => cb.id.startsWith('update'))
    .map(cb => cb.labels[0].textContent.trim());
  
  const summaryDiv = document.getElementById('updateSummary');
  
  if (checkedSections.length === 0) {
    summaryDiv.textContent = 'Select fields to update above to see a summary of changes.';
  } else {
    summaryDiv.innerHTML = `
      <strong>Fields to update:</strong> ${checkedSections.join(', ')}<br>
      <strong>Products affected:</strong> ${selectedProducts.size} products<br>
      <strong>Estimated time:</strong> ${Math.ceil(selectedProducts.size / 10)} seconds
    `;
  }
}

function previewChanges() {
  // This would show a preview of changes
  alert('Preview functionality would show a table of all changes to be made');
}

function executeUpdate() {
  if (!confirm(`Are you sure you want to update ${selectedProducts.size} products? This action cannot be undone.`)) {
    return;
  }
  
  // Hide modal and show progress
  bootstrap.Modal.getInstance(document.getElementById('updateModal')).hide();
  document.getElementById('progressCard').style.display = 'block';
  
  // Simulate bulk update process
  simulateUpdate();
}

function simulateUpdate() {
  const totalProducts = selectedProducts.size;
  let processed = 0;
  let success = 0;
  let errors = 0;
  
  const interval = setInterval(() => {
    processed++;
    
    // Simulate random success/failure
    if (Math.random() > 0.1) {
      success++;
    } else {
      errors++;
    }
    
    // Update progress
    const percentage = (processed / totalProducts) * 100;
    document.getElementById('updateProgressBar').style.width = percentage + '%';
    document.getElementById('processedCount').textContent = processed;
    document.getElementById('successCount').textContent = success;
    document.getElementById('errorCount').textContent = errors;
    
    if (processed >= totalProducts) {
      clearInterval(interval);
      
      setTimeout(() => {
        document.getElementById('progressCard').style.display = 'none';
        
        alert(`Bulk update completed!\n\nUpdated: ${success} products\nErrors: ${errors} products`);
        
        // Refresh page or update product list
        location.reload();
      }, 1000);
    }
  }, 100);
}

function cancelUpdate() {
  if (confirm('Are you sure you want to cancel the update process?')) {
    document.getElementById('progressCard').style.display = 'none';
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  updateSelection();
  
  // Handle price method changes
  document.querySelector('[name="cost_price_method"]')?.addEventListener('change', function() {
    const unit = document.getElementById('costPriceUnit');
    unit.textContent = this.value.includes('percent') ? '%' : '$';
  });
  
  document.querySelector('[name="selling_price_method"]')?.addEventListener('change', function() {
    const unit = document.getElementById('sellingPriceUnit');
    unit.textContent = this.value.includes('percent') ? '%' : '$';
  });
});
</script>
{% endblock %}