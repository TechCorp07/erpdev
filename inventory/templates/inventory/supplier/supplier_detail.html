{% extends "inventory_base.html" %}
{% load static %}

{% block inventory_title %}{{ supplier.name }}{% endblock %}

{% block inventory_breadcrumbs %}
  {{ block.super }}
  {% with inventory_breadcrumbs=breadcrumbs %}{% endwith %}
{% endblock %}

{% block inventory_actions %}
  <div class="btn-group me-2" role="group">
    {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
      <a href="{% url 'inventory:supplier_edit' supplier.pk %}" class="btn btn-primary btn-sm">
        <i class="bi bi-pencil me-1"></i>Edit Supplier
      </a>
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-plus-circle me-1"></i>Create
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="{% url 'inventory:product_create' %}?supplier={{ supplier.pk }}">
            <i class="bi bi-box me-2"></i>New Product
          </a></li>
          <li><a class="dropdown-item" href="{% url 'inventory:purchase_order_create' %}?supplier={{ supplier.pk }}">
            <i class="bi bi-receipt me-2"></i>Purchase Order
          </a></li>
        </ul>
      </div>
    {% endif %}
  </div>
  
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:supplier_contact' supplier.pk %}" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-envelope me-1"></i>Contact
    </a>
    <a href="{% url 'inventory:supplier_performance' supplier.pk %}" class="btn btn-outline-info btn-sm">
      <i class="bi bi-graph-up me-1"></i>Performance
    </a>
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
        <i class="bi bi-download me-1"></i>Export
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{% url 'inventory:supplier_products' supplier.pk %}?export=csv">
          <i class="bi bi-filetype-csv me-2"></i>Product List (CSV)
        </a></li>
        <li><a class="dropdown-item" href="{% url 'inventory:supplier_analytics' supplier.pk %}?export=pdf">
          <i class="bi bi-filetype-pdf me-2"></i>Analytics Report (PDF)
        </a></li>
      </ul>
    </div>
  </div>
{% endblock %}

{% block inventory_content %}
  <div class="row">
    <!-- Supplier Information Card -->
    <div class="col-lg-4 mb-4">
      <div class="card inventory-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="bi bi-building me-2"></i>Supplier Information
          </h5>
          <div class="d-flex gap-1">
            {% if supplier.is_preferred %}
              <span class="badge bg-warning" title="Preferred Supplier">
                <i class="bi bi-star-fill"></i> Preferred
              </span>
            {% endif %}
            {% if supplier.is_active %}
              <span class="badge bg-success">Active</span>
            {% else %}
              <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          </div>
        </div>
        
        <div class="card-body">
          <!-- Basic Information -->
          <div class="row mb-3">
            <div class="col-6">
              <label class="text-muted small">Supplier Code</label>
              <div class="fw-bold">{{ supplier.supplier_code }}</div>
            </div>
            <div class="col-6">
              <label class="text-muted small">Type</label>
              <div>
                <span class="badge bg-light text-dark">{{ supplier.get_supplier_type_display }}</span>
              </div>
            </div>
          </div>
          
          <!-- Contact Information -->
          <h6 class="border-bottom pb-2 mb-3">Contact Details</h6>
          {% if supplier.contact_person %}
            <div class="mb-2">
              <i class="bi bi-person text-muted me-2"></i>
              <strong>{{ supplier.contact_person }}</strong>
            </div>
          {% endif %}
          
          <div class="mb-2">
            <i class="bi bi-envelope text-muted me-2"></i>
            <a href="mailto:{{ supplier.email }}" class="text-decoration-none">{{ supplier.email }}</a>
          </div>
          
          {% if supplier.phone %}
            <div class="mb-2">
              <i class="bi bi-telephone text-muted me-2"></i>
              <a href="tel:{{ supplier.phone }}" class="text-decoration-none">{{ supplier.phone }}</a>
            </div>
          {% endif %}
          
          {% if supplier.website %}
            <div class="mb-3">
              <i class="bi bi-globe text-muted me-2"></i>
              <a href="{{ supplier.website }}" target="_blank" class="text-decoration-none">
                {{ supplier.website }} <i class="bi bi-box-arrow-up-right small"></i>
              </a>
            </div>
          {% endif %}
          
          <!-- Address -->
          <h6 class="border-bottom pb-2 mb-3">Address</h6>
          <div class="mb-2">
            <i class="bi bi-geo-alt text-muted me-2"></i>
            {{ supplier.address_line_1 }}
            {% if supplier.address_line_2 %}<br>{{ supplier.address_line_2 }}{% endif %}
          </div>
          <div class="mb-2">
            {{ supplier.city }}{% if supplier.state_province %}, {{ supplier.state_province }}{% endif %}
            {% if supplier.postal_code %} {{ supplier.postal_code }}{% endif %}
          </div>
          <div class="mb-3">
            <strong>{{ supplier.country }}</strong>
          </div>
          
          <!-- Business Terms -->
          <h6 class="border-bottom pb-2 mb-3">Business Terms</h6>
          <div class="row mb-2">
            <div class="col-6">
              <label class="text-muted small">Payment Terms</label>
              <div>{{ supplier.payment_terms }}</div>
            </div>
            <div class="col-6">
              <label class="text-muted small">Currency</label>
              <div><strong>{{ supplier.currency }}</strong></div>
            </div>
          </div>
          
          {% if supplier.minimum_order_amount %}
            <div class="mb-2">
              <label class="text-muted small">Minimum Order</label>
              <div><strong>{{ supplier.currency }} {{ supplier.minimum_order_amount|floatformat:2 }}</strong></div>
            </div>
          {% endif %}
          
          {% if supplier.tax_number %}
            <div class="mb-2">
              <label class="text-muted small">Tax Number</label>
              <div>{{ supplier.tax_number }}</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Performance Metrics -->
    <div class="col-lg-8 mb-4">
      <div class="row">
        <!-- Key Metrics Cards -->
        <div class="col-md-3 mb-3">
          <div class="card border-primary text-center">
            <div class="card-body">
              <i class="bi bi-box text-primary fs-2 mb-2"></i>
              <h4 class="text-primary">{{ supplier.total_products }}</h4>
              <p class="card-text small text-muted">Products</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-success text-center">
            <div class="card-body">
              <i class="bi bi-clock text-success fs-2 mb-2"></i>
              <h4 class="text-success">{{ supplier.average_lead_time_days }}</h4>
              <p class="card-text small text-muted">Days Lead Time</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-warning text-center">
            <div class="card-body">
              <i class="bi bi-star text-warning fs-2 mb-2"></i>
              <h4 class="text-warning">{{ supplier.reliability_rating }}/10</h4>
              <p class="card-text small text-muted">Reliability</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card border-info text-center">
            <div class="card-body">
              <i class="bi bi-receipt text-info fs-2 mb-2"></i>
              <h4 class="text-info">{{ recent_pos_count }}</h4>
              <p class="card-text small text-muted">Recent POs</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Performance Chart Placeholder -->
      <div class="card inventory-card mb-4">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i class="bi bi-graph-up me-2"></i>Performance Trends
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label class="text-muted small">Delivery Performance</label>
              <div class="progress mb-2">
                <div class="progress-bar bg-success" 
                     style="width: {{ delivery_performance }}%"
                     title="{{ delivery_performance }}% On-time Delivery">
                </div>
              </div>
              <small class="text-muted">{{ delivery_performance }}% on-time delivery</small>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">Quality Rating</label>
              <div class="progress mb-2">
                <div class="progress-bar bg-info" 
                     style="width: {{ supplier.reliability_rating }}0%">
                </div>
              </div>
              <small class="text-muted">{{ supplier.reliability_rating }}/10 quality rating</small>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Recent Activity -->
      <div class="card inventory-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">
            <i class="bi bi-activity me-2"></i>Recent Activity
          </h6>
          <a href="{% url 'inventory:supplier_purchase_orders' supplier.pk %}" class="btn btn-outline-primary btn-sm">
            View All
          </a>
        </div>
        <div class="card-body">
          {% if recent_purchase_orders %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>PO Number</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Amount</th>
                    <th>Items</th>
                  </tr>
                </thead>
                <tbody>
                  {% for po in recent_purchase_orders %}
                    <tr>
                      <td>
                        <a href="{% url 'inventory:purchase_order_detail' po.pk %}" class="text-decoration-none">
                          {{ po.po_number }}
                        </a>
                      </td>
                      <td>{{ po.order_date|date:"M d, Y" }}</td>
                      <td>
                        <span class="badge bg-{{ po.status|default:'secondary' }}">
                          {{ po.get_status_display }}
                        </span>
                      </td>
                      <td>{{ po.currency }} {{ po.total_amount|floatformat:2 }}</td>
                      <td>{{ po.items.count }} items</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-receipt fs-1 mb-2"></i>
              <p>No recent purchase orders</p>
              {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
                <a href="{% url 'inventory:purchase_order_create' %}?supplier={{ supplier.pk }}" 
                   class="btn btn-primary btn-sm">
                  <i class="bi bi-plus-circle me-1"></i>Create Purchase Order
                </a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Products from this supplier -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card inventory-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="bi bi-box me-2"></i>Products from {{ supplier.name }}
          </h5>
          <div class="d-flex gap-2">
            <a href="{% url 'inventory:supplier_products' supplier.pk %}" class="btn btn-outline-primary btn-sm">
              View All ({{ supplier.total_products }})
            </a>
            {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
              <a href="{% url 'inventory:product_create' %}?supplier={{ supplier.pk }}" 
                 class="btn btn-success btn-sm">
                <i class="bi bi-plus-circle me-1"></i>Add Product
              </a>
            {% endif %}
          </div>
        </div>
        
        <div class="card-body">
          {% if recent_products %}
            <div class="row">
              {% for product in recent_products %}
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="card border-light">
                    <div class="card-body">
                      <h6 class="card-title">
                        <a href="{% url 'inventory:product_detail' product.pk %}" class="text-decoration-none">
                          {{ product.name }}
                        </a>
                      </h6>
                      <p class="card-text small text-muted">{{ product.sku }}</p>
                      <div class="row small">
                        <div class="col-6">
                          <strong>Stock:</strong> {{ product.current_stock }}
                        </div>
                        <div class="col-6">
                          <strong>Price:</strong> {{ product.currency }} {{ product.selling_price }}
                        </div>
                      </div>
                      <div class="mt-2">
                        {% if product.current_stock <= product.reorder_level %}
                          <span class="badge bg-warning">Low Stock</span>
                        {% elif product.current_stock == 0 %}
                          <span class="badge bg-danger">Out of Stock</span>
                        {% else %}
                          <span class="badge bg-success">In Stock</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-box fs-1 mb-2"></i>
              <p>No products from this supplier yet</p>
              {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
                <a href="{% url 'inventory:product_create' %}?supplier={{ supplier.pk }}" 
                   class="btn btn-primary btn-sm">
                  <i class="bi bi-plus-circle me-1"></i>Add First Product
                </a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Notes section -->
  {% if supplier.notes %}
    <div class="row mt-4">
      <div class="col-12">
        <div class="card inventory-card">
          <div class="card-header">
            <h6 class="card-title mb-0">
              <i class="bi bi-sticky me-2"></i>Notes
            </h6>
          </div>
          <div class="card-body">
            <p class="mb-0">{{ supplier.notes|linebreaks }}</p>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips for performance metrics
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Add click tracking for supplier actions
  document.querySelectorAll('a[href*="contact"], a[href*="performance"]').forEach(link => {
    link.addEventListener('click', function() {
      // Track supplier interaction analytics
      console.log('Supplier action:', this.href);
    });
  });
});
</script>
{% endblock %}
