{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Storage Bins{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:configuration' %}">Configuration</a></li>
        <li class="breadcrumb-item active">Storage Bins</li>
      </ol>
    </nav>
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-box text-primary me-2"></i>Storage Bins
    </h1>
    <p class="text-muted mb-0">Manage storage bins and their capacity across locations</p>
  </div>
  
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:storage_bin_create' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-2"></i>Add Bin
    </a>
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-gear me-2"></i>Actions
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="#" onclick="printBinLabels()">
        <i class="bi bi-printer me-2"></i>Print Labels
      </a></li>
      <li><a class="dropdown-item" href="#" onclick="generateBarcodes()">
        <i class="bi bi-qr-code me-2"></i>Generate QR Codes
      </a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="#" onclick="exportBins()">
        <i class="bi bi-download me-2"></i>Export List
      </a></li>
    </ul>
  </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-primary text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Total Bins
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ total_bins|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-box fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-success text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Available Capacity
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ available_capacity|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-stack fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-warning text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Nearly Full
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ bins_nearly_full|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-exclamation-triangle fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-danger text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Full Bins
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ bins_full|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-x-circle fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-info">
      <i class="bi bi-funnel me-2"></i>Filters & Search
    </h6>
  </div>
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-3">
        <label for="search" class="form-label">Search</label>
        <input type="text" class="form-control" id="search" name="search" 
               value="{{ request.GET.search }}" placeholder="Search bins...">
      </div>
      <div class="col-md-2">
        <label for="location" class="form-label">Location</label>
        <select class="form-select" id="location" name="location">
          <option value="">All Locations</option>
          {% for location in locations %}
          <option value="{{ location.pk }}" {% if request.GET.location == location.pk|stringformat:"s" %}selected{% endif %}>
            {{ location.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="component_family" class="form-label">Component Family</label>
        <select class="form-select" id="component_family" name="component_family">
          <option value="">All Families</option>
          {% for family in component_families %}
          <option value="{{ family.pk }}" {% if request.GET.component_family == family.pk|stringformat:"s" %}selected{% endif %}>
            {{ family.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" id="status" name="status">
          <option value="">All Status</option>
          <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
          <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
          <option value="full" {% if request.GET.status == 'full' %}selected{% endif %}>Full</option>
          <option value="nearly_full" {% if request.GET.status == 'nearly_full' %}selected{% endif %}>Nearly Full</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search me-2"></i>Filter
        </button>
        <a href="{% url 'inventory:storage_bin_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-clockwise me-2"></i>Reset
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Storage Bins Grid -->
<div class="row">
  {% for bin in storage_bins %}
  <div class="col-lg-4 col-md-6 mb-4">
    <div class="card shadow h-100">
      <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="bi bi-box me-2"></i>{{ bin.bin_code }}
        </h6>
        <span class="badge bg-{{ bin.is_active|yesno:'success,secondary' }}">
          {{ bin.is_active|yesno:'Active,Inactive' }}
        </span>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h6 class="mb-1">{{ bin.name|default:bin.bin_code }}</h6>
            <p class="text-muted small mb-0">
              <i class="bi bi-building me-1"></i>{{ bin.location.name }}
            </p>
          </div>
          <div class="text-end">
            {% if bin.qr_code %}
            <i class="bi bi-qr-code text-success" title="QR Code Available"></i>
            {% endif %}
          </div>
        </div>

        <!-- Position Info -->
        {% if bin.row or bin.column or bin.shelf %}
        <div class="mb-3">
          <small class="text-muted">Position:</small>
          <div class="badge bg-light text-dark">
            {% if bin.row %}R{{ bin.row }}{% endif %}
            {% if bin.column %}-C{{ bin.column }}{% endif %}
            {% if bin.shelf %}-S{{ bin.shelf }}{% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Capacity Bar -->
        {% if bin.max_capacity_items %}
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">Capacity</small>
            <small class="text-muted">{{ bin.current_items|default:0 }}/{{ bin.max_capacity_items }}</small>
          </div>
          {% with capacity_percentage=bin.capacity_percentage %}
          <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-{% if capacity_percentage >= 90 %}danger{% elif capacity_percentage >= 70 %}warning{% else %}success{% endif %}" 
                 style="width: {{ capacity_percentage }}%"></div>
          </div>
          <small class="text-muted">{{ capacity_percentage|floatformat:0 }}% full</small>
          {% endwith %}
        </div>
        {% endif %}

        <!-- Component Families -->
        {% if bin.component_families.exists %}
        <div class="mb-3">
          <small class="text-muted d-block mb-1">Component Families:</small>
          {% for family in bin.component_families.all|slice:":3" %}
            <span class="badge bg-info badge-sm me-1">{{ family.name }}</span>
          {% endfor %}
          {% if bin.component_families.count > 3 %}
            <span class="badge bg-secondary badge-sm">+{{ bin.component_families.count|add:"-3" }} more</span>
          {% endif %}
        </div>
        {% endif %}

        <!-- Special Handling -->
        {% if bin.requires_special_handling %}
        <div class="alert alert-warning py-2 mb-3" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <small>Requires special handling</small>
        </div>
        {% endif %}

        <!-- Notes -->
        {% if bin.notes %}
        <div class="mb-3">
          <small class="text-muted d-block">Notes:</small>
          <p class="small mb-0">{{ bin.notes|truncatechars:100 }}</p>
        </div>
        {% endif %}
      </div>
      <div class="card-footer bg-transparent">
        <div class="btn-group w-100" role="group">
          <a href="{% url 'inventory:storage_bin_detail' bin.pk %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-eye"></i>
          </a>
          <a href="{% url 'inventory:storage_bin_edit' bin.pk %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-pencil"></i>
          </a>
          {% if bin.qr_code %}
          <button type="button" class="btn btn-outline-info btn-sm" onclick="showQRCode('{{ bin.bin_code }}', '{{ bin.qr_code.url }}')">
            <i class="bi bi-qr-code"></i>
          </button>
          {% endif %}
          <a href="{% url 'inventory:storage_bin_delete' bin.pk %}" 
             class="btn btn-outline-danger btn-sm"
             onclick="return confirm('Delete bin {{ bin.bin_code }}?')">
            <i class="bi bi-trash"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <!-- Empty State -->
  <div class="col-12">
    <div class="card shadow">
      <div class="card-body text-center py-5">
        <i class="bi bi-box text-muted" style="font-size: 4rem;"></i>
        <h5 class="mt-3 text-muted">No Storage Bins Found</h5>
        <p class="text-muted mb-4">Create storage bins to organize your inventory efficiently.</p>
        <a href="{% url 'inventory:storage_bin_create' %}" class="btn btn-primary">
          <i class="bi bi-plus-circle me-2"></i>Create First Bin
        </a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="d-flex justify-content-center mt-4">
  <nav>
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.location %}&location={{ request.GET.location }}{% endif %}">First</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.location %}&location={{ request.GET.location }}{% endif %}">Previous</a>
        </li>
      {% endif %}
      
      <li class="page-item active">
        <span class="page-link">{{ page_obj.number }}</span>
      </li>
      
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.location %}&location={{ request.GET.location }}{% endif %}">Next</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.location %}&location={{ request.GET.location }}{% endif %}">Last</a>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>
{% endif %}

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bin QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div id="qrCodeContainer"></div>
        <p class="mt-3 mb-0" id="qrBinCode"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="printQRCode()">
          <i class="bi bi-printer me-2"></i>Print
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
function showQRCode(binCode, qrCodeUrl) {
  document.getElementById('qrBinCode').textContent = binCode;
  document.getElementById('qrCodeContainer').innerHTML = `<img src="${qrCodeUrl}" alt="QR Code for ${binCode}" class="img-fluid">`;
  
  const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
  modal.show();
}

function printQRCode() {
  const qrImage = document.querySelector('#qrCodeContainer img');
  const binCode = document.getElementById('qrBinCode').textContent;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head><title>QR Code - ${binCode}</title></head>
      <body style="text-align: center; font-family: Arial, sans-serif;">
        <h3>${binCode}</h3>
        <img src="${qrImage.src}" style="max-width: 200px;">
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

function printBinLabels() {
  // Implementation for printing multiple bin labels
  alert('Printing bin labels functionality would be implemented here');
}

function generateBarcodes() {
  // Implementation for generating barcodes for bins
  alert('Barcode generation functionality would be implemented here');
}

function exportBins() {
  const params = new URLSearchParams(window.location.search);
  params.set('export', 'xlsx');
  window.location.href = `${window.location.pathname}?${params.toString()}`;
}
</script>
{% endblock %}