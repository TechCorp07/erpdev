{% extends "dashboard_base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block page_title %}
  {% if form.instance.pk %}Edit Currency{% else %}Add Currency{% endif %}
{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:configuration' %}">Configuration</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:currency_list' %}">Currencies</a></li>
        <li class="breadcrumb-item active">
          {% if form.instance.pk %}Edit Currency{% else %}Add Currency{% endif %}
        </li>
      </ol>
    </nav>
    <h1 class="h3 mb-0 text-gray-800">
      {% if form.instance.pk %}
        <i class="bi bi-pencil me-2"></i>Edit Currency: {{ form.instance.name }}
      {% else %}
        <i class="bi bi-plus me-2"></i>Add New Currency
      {% endif %}
    </h1>
    <p class="text-muted mb-0">
      {% if form.instance.pk %}
        Update currency information and exchange rate settings
      {% else %}
        Add a new currency for international supplier transactions
      {% endif %}
    </p>
  </div>
  
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:currency_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Back to List
    </a>
    {% if form.instance.pk %}
    <a href="{% url 'inventory:currency_detail' form.instance.pk %}" class="btn btn-outline-info">
      <i class="bi bi-eye me-2"></i>View Details
    </a>
    {% endif %}
  </div>
</div>

<form method="post" novalidate>
  {% csrf_token %}
  
  <div class="row">
    <!-- Main Form -->
    <div class="col-lg-8">
      <!-- Basic Information -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-currency-exchange me-2"></i>Basic Information
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.name.id_for_label }}" class="form-label">
                Currency Name <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                     id="{{ form.name.id_for_label }}"
                     name="{{ form.name.name }}"
                     value="{{ form.name.value|default:'' }}"
                     placeholder="e.g., US Dollar, Euro, British Pound"
                     required>
              {% if form.name.errors %}
                <div class="invalid-feedback">{{ form.name.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.code.id_for_label }}" class="form-label">
                Currency Code <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     class="form-control {% if form.code.errors %}is-invalid{% endif %}" 
                     id="{{ form.code.id_for_label }}"
                     name="{{ form.code.name }}"
                     value="{{ form.code.value|default:'' }}"
                     placeholder="USD, EUR, GBP"
                     maxlength="3"
                     pattern="[A-Z]{3}"
                     style="text-transform: uppercase;"
                     required>
              {% if form.code.errors %}
                <div class="invalid-feedback">{{ form.code.errors.0 }}</div>
              {% endif %}
              <div class="form-text">3-letter ISO 4217 currency code</div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.symbol.id_for_label }}" class="form-label">
                Currency Symbol
              </label>
              <input type="text" 
                     class="form-control {% if form.symbol.errors %}is-invalid{% endif %}" 
                     id="{{ form.symbol.id_for_label }}"
                     name="{{ form.symbol.name }}"
                     value="{{ form.symbol.value|default:'' }}"
                     placeholder="$, â‚¬, Â£, Â¥"
                     maxlength="5">
              {% if form.symbol.errors %}
                <div class="invalid-feedback">{{ form.symbol.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Currency symbol for display</div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.decimal_places.id_for_label }}" class="form-label">
                Decimal Places
              </label>
              <select class="form-select {% if form.decimal_places.errors %}is-invalid{% endif %}"
                      id="{{ form.decimal_places.id_for_label }}"
                      name="{{ form.decimal_places.name }}">
                <option value="0" {% if form.decimal_places.value == "0" %}selected{% endif %}>0 (Â¥1000)</option>
                <option value="2" {% if form.decimal_places.value == "2" or not form.decimal_places.value %}selected{% endif %}>2 ($10.00)</option>
                <option value="3" {% if form.decimal_places.value == "3" %}selected{% endif %}>3 ($10.000)</option>
                <option value="4" {% if form.decimal_places.value == "4" %}selected{% endif %}>4 ($10.0000)</option>
              </select>
              {% if form.decimal_places.errors %}
                <div class="invalid-feedback">{{ form.decimal_places.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Number of decimal places for this currency</div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">
              Description
            </label>
            <textarea class="form-control {% if form.description.errors %}is-invalid{% endif %}"
                      id="{{ form.description.id_for_label }}"
                      name="{{ form.description.name }}"
                      rows="3"
                      placeholder="Additional information about this currency">{{ form.description.value|default:'' }}</textarea>
            {% if form.description.errors %}
              <div class="invalid-feedback">{{ form.description.errors.0 }}</div>
            {% endif %}
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-check mb-3">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="{{ form.is_active.id_for_label }}"
                       name="{{ form.is_active.name }}"
                       {% if form.is_active.value %}checked{% endif %}>
                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                  <strong>Active Currency</strong>
                </label>
                <div class="form-text">Available for use in transactions</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check mb-3">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="{{ form.is_base_currency.id_for_label }}"
                       name="{{ form.is_base_currency.name }}"
                       {% if form.is_base_currency.value %}checked{% endif %}>
                <label class="form-check-label" for="{{ form.is_base_currency.id_for_label }}">
                  <strong>Base Currency</strong>
                </label>
                <div class="form-text">Primary currency for calculations</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Exchange Rate Settings -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-success">
            <i class="bi bi-graph-up me-2"></i>Exchange Rate Settings
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.exchange_rate_to_usd.id_for_label }}" class="form-label">
                Exchange Rate to USD
                {% if form.instance.is_base_currency %}
                  <span class="text-muted">(Base Currency)</span>
                {% else %}
                  <span class="text-danger">*</span>
                {% endif %}
              </label>
              <div class="input-group">
                <span class="input-group-text">1 {{ form.instance.code|default:"XXX" }} =</span>
                <input type="number" 
                       class="form-control {% if form.exchange_rate_to_usd.errors %}is-invalid{% endif %}" 
                       id="{{ form.exchange_rate_to_usd.id_for_label }}"
                       name="{{ form.exchange_rate_to_usd.name }}"
                       value="{{ form.exchange_rate_to_usd.value|default:'' }}"
                       step="0.0001"
                       min="0.0001"
                       placeholder="1.0000"
                       {% if form.instance.is_base_currency %}readonly{% endif %}>
                <span class="input-group-text">USD</span>
                {% if form.exchange_rate_to_usd.errors %}
                  <div class="invalid-feedback">{{ form.exchange_rate_to_usd.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="form-text">
                {% if form.instance.is_base_currency %}
                  Base currency always has rate 1.0000
                {% else %}
                  Current market exchange rate to US Dollar
                {% endif %}
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.last_updated.id_for_label }}" class="form-label">
                Last Updated
              </label>
              <input type="datetime-local" 
                     class="form-control {% if form.last_updated.errors %}is-invalid{% endif %}" 
                     id="{{ form.last_updated.id_for_label }}"
                     name="{{ form.last_updated.name }}"
                     value="{{ form.last_updated.value|date:'Y-m-d\TH:i'|default:'' }}"
                     readonly>
              {% if form.last_updated.errors %}
                <div class="invalid-feedback">{{ form.last_updated.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Automatically updated when rate changes</div>
            </div>
          </div>
          
          <!-- Exchange Rate Source -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.rate_source.id_for_label }}" class="form-label">
                Rate Source
              </label>
              <select class="form-select {% if form.rate_source.errors %}is-invalid{% endif %}"
                      id="{{ form.rate_source.id_for_label }}"
                      name="{{ form.rate_source.name }}">
                <option value="">Select source...</option>
                {% for value, label in form.rate_source.field.choices %}
                  <option value="{{ value }}" {% if form.rate_source.value == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
              {% if form.rate_source.errors %}
                <div class="invalid-feedback">{{ form.rate_source.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.update_frequency.id_for_label }}" class="form-label">
                Update Frequency
              </label>
              <select class="form-select {% if form.update_frequency.errors %}is-invalid{% endif %}"
                      id="{{ form.update_frequency.id_for_label }}"
                      name="{{ form.update_frequency.name }}">
                <option value="">Select frequency...</option>
                <option value="manual" {% if form.update_frequency.value == "manual" %}selected{% endif %}>Manual Only</option>
                <option value="daily" {% if form.update_frequency.value == "daily" %}selected{% endif %}>Daily</option>
                <option value="weekly" {% if form.update_frequency.value == "weekly" %}selected{% endif %}>Weekly</option>
                <option value="monthly" {% if form.update_frequency.value == "monthly" %}selected{% endif %}>Monthly</option>
              </select>
              {% if form.update_frequency.errors %}
                <div class="invalid-feedback">{{ form.update_frequency.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="form-check">
            <input class="form-check-input" 
                   type="checkbox" 
                   id="{{ form.auto_update.id_for_label }}"
                   name="{{ form.auto_update.name }}"
                   {% if form.auto_update.value %}checked{% endif %}>
            <label class="form-check-label" for="{{ form.auto_update.id_for_label }}">
              <strong>Enable Automatic Updates</strong>
            </label>
            <div class="form-text">Automatically fetch exchange rates based on update frequency</div>
          </div>
        </div>
      </div>

      <!-- Country and Regional Settings -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-info">
            <i class="bi bi-globe me-2"></i>Regional Settings
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.country_code.id_for_label }}" class="form-label">
                Country Code
              </label>
              <input type="text" 
                     class="form-control {% if form.country_code.errors %}is-invalid{% endif %}" 
                     id="{{ form.country_code.id_for_label }}"
                     name="{{ form.country_code.name }}"
                     value="{{ form.country_code.value|default:'' }}"
                     placeholder="US, GB, EU"
                     maxlength="2"
                     style="text-transform: uppercase;">
              {% if form.country_code.errors %}
                <div class="invalid-feedback">{{ form.country_code.errors.0 }}</div>
              {% endif %}
              <div class="form-text">ISO 3166-1 alpha-2 country code</div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.flag_emoji.id_for_label }}" class="form-label">
                Flag Emoji
              </label>
              <input type="text" 
                     class="form-control {% if form.flag_emoji.errors %}is-invalid{% endif %}" 
                     id="{{ form.flag_emoji.id_for_label }}"
                     name="{{ form.flag_emoji.name }}"
                     value="{{ form.flag_emoji.value|default:'' }}"
                     placeholder="ðŸ‡ºðŸ‡¸, ðŸ‡ªðŸ‡º, ðŸ‡¬ðŸ‡§"
                     maxlength="4">
              {% if form.flag_emoji.errors %}
                <div class="invalid-feedback">{{ form.flag_emoji.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Country flag emoji for visual identification</div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.locale.id_for_label }}" class="form-label">
                Locale
              </label>
              <input type="text" 
                     class="form-control {% if form.locale.errors %}is-invalid{% endif %}" 
                     id="{{ form.locale.id_for_label }}"
                     name="{{ form.locale.name }}"
                     value="{{ form.locale.value|default:'' }}"
                     placeholder="en_US, en_GB, de_DE"
                     pattern="[a-z]{2}_[A-Z]{2}">
              {% if form.locale.errors %}
                <div class="invalid-feedback">{{ form.locale.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Locale for number and date formatting</div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.format_pattern.id_for_label }}" class="form-label">
                Display Format
              </label>
              <select class="form-select {% if form.format_pattern.errors %}is-invalid{% endif %}"
                      id="{{ form.format_pattern.id_for_label }}"
                      name="{{ form.format_pattern.name }}">
                <option value="">Default</option>
                <option value="symbol_before" {% if form.format_pattern.value == "symbol_before" %}selected{% endif %}>$100.00</option>
                <option value="symbol_after" {% if form.format_pattern.value == "symbol_after" %}selected{% endif %}>100.00$</option>
                <option value="code_before" {% if form.format_pattern.value == "code_before" %}selected{% endif %}>USD 100.00</option>
                <option value="code_after" {% if form.format_pattern.value == "code_after" %}selected{% endif %}>100.00 USD</option>
              </select>
              {% if form.format_pattern.errors %}
                <div class="invalid-feedback">{{ form.format_pattern.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check me-2"></i>
                {% if form.instance.pk %}Update Currency{% else %}Create Currency{% endif %}
              </button>
              <a href="{% url 'inventory:currency_list' %}" class="btn btn-outline-secondary ms-2">
                <i class="bi bi-x me-2"></i>Cancel
              </a>
              {% if not form.instance.is_base_currency %}
              <button type="button" class="btn btn-outline-info ms-2" onclick="fetchCurrentRate()">
                <i class="bi bi-arrow-repeat me-2"></i>Fetch Current Rate
              </button>
              {% endif %}
            </div>
            
            {% if form.instance.pk and not form.instance.is_base_currency and form.instance.total_usage == 0 %}
            <div>
              <a href="{% url 'inventory:currency_delete' form.instance.pk %}" 
                 class="btn btn-outline-danger"
                 onclick="return confirm('Are you sure you want to delete this currency?')">
                <i class="bi bi-trash me-2"></i>Delete Currency
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      {% if form.instance.pk %}
      <!-- Currency Statistics -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-info">
            <i class="bi bi-bar-chart me-2"></i>Currency Usage
          </h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <div class="h4 mb-0 text-primary">{{ form.instance.products_using|default:0 }}</div>
              <small class="text-muted">Products</small>
            </div>
            <div class="col-6 mb-3">
              <div class="h4 mb-0 text-success">{{ form.instance.suppliers_using|default:0 }}</div>
              <small class="text-muted">Suppliers</small>
            </div>
          </div>
          
          {% if form.instance.last_updated %}
          <hr>
          <div class="small">
            <strong>Last Updated:</strong><br>
            {{ form.instance.last_updated|date:"M d, Y H:i" }}<br>
            <small class="text-muted">{{ form.instance.last_updated|timesince }} ago</small>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Exchange Rate Preview -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-success">
            <i class="bi bi-calculator me-2"></i>Rate Preview
          </h6>
        </div>
        <div class="card-body">
          <div id="ratePreview">
            <div class="text-center">
              <div class="h4 mb-0" id="currentRate">
                {% if form.instance.exchange_rate_to_usd %}
                  {{ form.instance.exchange_rate_to_usd|floatformat:4 }}
                {% else %}
                  1.0000
                {% endif %}
              </div>
              <small class="text-muted">
                1 <span id="currencyCode">{{ form.instance.code|default:"XXX" }}</span> = <span id="usdAmount">1.0000</span> USD
              </small>
            </div>
            
            <hr>
            
            <div class="mb-3">
              <label class="form-label small">Quick Converter</label>
              <div class="input-group input-group-sm">
                <input type="number" class="form-control" id="convertAmount" value="100" step="0.01">
                <span class="input-group-text" id="fromCurrency">{{ form.instance.code|default:"XXX" }}</span>
              </div>
            </div>
            
            <div class="text-center border rounded p-2">
              <div class="h6 mb-0" id="convertedAmount">$100.00</div>
              <small class="text-muted">USD equivalent</small>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Currency Tips -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-secondary">
            <i class="bi bi-lightbulb me-2"></i>Currency Setup Tips
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Use standard ISO 4217 currency codes
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Keep exchange rates up to date
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Enable auto-update for frequently used currencies
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Set appropriate decimal places for precision
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Only one currency can be the base currency
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Base Currency Warning -->
      {% if form.instance.is_base_currency %}
      <div class="card shadow mb-4 border-warning">
        <div class="card-header py-3 bg-warning text-dark">
          <h6 class="m-0 font-weight-bold">
            <i class="bi bi-star me-2"></i>Base Currency
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <p class="mb-2">
              <strong>This is the base currency</strong> for all calculations. 
              Its exchange rate is always 1.0000.
            </p>
            <p class="mb-0">
              Changing the base currency will affect all pricing calculations 
              and should be done carefully.
            </p>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Common Currencies Quick Add -->
      {% if not form.instance.pk %}
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-lightning me-2"></i>Quick Add Common Currencies
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="fillCurrency('USD', 'US Dollar', '$', 'ðŸ‡ºðŸ‡¸')">
              ðŸ‡ºðŸ‡¸ US Dollar (USD)
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="fillCurrency('EUR', 'Euro', 'â‚¬', 'ðŸ‡ªðŸ‡º')">
              ðŸ‡ªðŸ‡º Euro (EUR)
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="fillCurrency('GBP', 'British Pound', 'Â£', 'ðŸ‡¬ðŸ‡§')">
              ðŸ‡¬ðŸ‡§ British Pound (GBP)
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="fillCurrency('JPY', 'Japanese Yen', 'Â¥', 'ðŸ‡¯ðŸ‡µ')">
              ðŸ‡¯ðŸ‡µ Japanese Yen (JPY)
            </button>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus on currency name field
    const nameField = document.getElementById('{{ form.name.id_for_label }}');
    if (nameField && !nameField.value) {
        nameField.focus();
    }
    
    // Auto-uppercase currency code
    const codeField = document.getElementById('{{ form.code.id_for_label }}');
    if (codeField) {
        codeField.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
            updatePreview();
        });
    }
    
    // Update rate preview when rate changes
    const rateField = document.getElementById('{{ form.exchange_rate_to_usd.id_for_label }}');
    if (rateField) {
        rateField.addEventListener('input', updatePreview);
    }
    
    // Base currency checkbox logic
    const baseCurrencyField = document.getElementById('{{ form.is_base_currency.id_for_label }}');
    if (baseCurrencyField) {
        baseCurrencyField.addEventListener('change', function() {
            if (this.checked) {
                // Set rate to 1.0000 for base currency
                if (rateField) {
                    rateField.value = '1.0000';
                    rateField.readOnly = true;
                }
                
                // Warn user about changing base currency
                if ({{ form.instance.pk|default:0 }}) {
                    if (!confirm('Changing the base currency will affect all pricing calculations. Are you sure?')) {
                        this.checked = false;
                        rateField.readOnly = false;
                        return;
                    }
                }
            } else {
                if (rateField) {
                    rateField.readOnly = false;
                }
            }
            updatePreview();
        });
    }
    
    // Quick currency fill function
    window.fillCurrency = function(code, name, symbol, flag) {
        document.getElementById('{{ form.code.id_for_label }}').value = code;
        document.getElementById('{{ form.name.id_for_label }}').value = name;
        document.getElementById('{{ form.symbol.id_for_label }}').value = symbol;
        document.getElementById('{{ form.flag_emoji.id_for_label }}').value = flag;
        
        // Set decimal places based on currency
        const decimalField = document.getElementById('{{ form.decimal_places.id_for_label }}');
        if (code === 'JPY' || code === 'KRW') {
            decimalField.value = '0';
        } else {
            decimalField.value = '2';
        }
        
        updatePreview();
    };
    
    // Fetch current exchange rate
    window.fetchCurrentRate = function() {
        const code = codeField ? codeField.value : '';
        if (!code || code.length !== 3) {
            alert('Please enter a valid 3-letter currency code first.');
            return;
        }
        
        const button = event.target;
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Fetching...';
        
        // Simulate API call - replace with actual implementation
        setTimeout(() => {
            // Mock exchange rate - replace with real API call
            const mockRates = {
                'EUR': 0.85,
                'GBP': 0.73,
                'JPY': 110.0,
                'CAD': 1.25,
                'AUD': 1.35
            };
            
            const rate = mockRates[code] || 1.0;
            if (rateField) {
                rateField.value = rate.toFixed(4);
                updatePreview();
            }
            
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Fetch Current Rate';
            
            if (mockRates[code]) {
                alert(`Exchange rate updated: 1 ${code} = ${rate} USD`);
            } else {
                alert(`Could not fetch rate for ${code}. Please enter manually.`);
            }
        }, 2000);
    };
    
    // Update preview display
    function updatePreview() {
        const code = codeField ? codeField.value : '{{ form.instance.code|default:"XXX" }}';
        const rate = rateField ? parseFloat(rateField.value) || 1.0 : 1.0;
        const convertAmount = document.getElementById('convertAmount');
        
        // Update currency code displays
        document.getElementById('currencyCode').textContent = code;
        document.getElementById('fromCurrency').textContent = code;
        
        // Update rate display
        document.getElementById('currentRate').textContent = rate.toFixed(4);
        document.getElementById('usdAmount').textContent = rate.toFixed(4);
        
        // Update converter
        if (convertAmount) {
            const amount = parseFloat(convertAmount.value) || 100;
            const converted = amount * rate;
            document.getElementById('convertedAmount').textContent = '$' + converted.toFixed(2);
        }
    }
    
    // Converter input handler
    const convertAmount = document.getElementById('convertAmount');
    if (convertAmount) {
        convertAmount.addEventListener('input', updatePreview);
    }
    
    // Auto-update frequency logic
    const autoUpdateField = document.getElementById('{{ form.auto_update.id_for_label }}');
    const frequencyField = document.getElementById('{{ form.update_frequency.id_for_label }}');
    
    if (autoUpdateField && frequencyField) {
        autoUpdateField.addEventListener('change', function() {
            if (this.checked && !frequencyField.value) {
                frequencyField.value = 'daily';
            }
        });
        
        frequencyField.addEventListener('change', function() {
            if (this.value !== 'manual' && this.value !== '') {
                autoUpdateField.checked = true;
            }
        });
    }
    
    // Initial preview update
    updatePreview();
    
    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const code = codeField ? codeField.value : '';
            const name = nameField ? nameField.value : '';
            const rate = rateField ? parseFloat(rateField.value) : 0;
            
            if (!code || code.length !== 3) {
                e.preventDefault();
                alert('Please enter a valid 3-letter currency code.');
                codeField.focus();
                return;
            }
            
            if (!name.trim()) {
                e.preventDefault();
                alert('Please enter a currency name.');
                nameField.focus();
                return;
            }
            
            if (!baseCurrencyField.checked && (!rate || rate <= 0)) {
                e.preventDefault();
                alert('Please enter a valid exchange rate greater than 0.');
                rateField.focus();
                return;
            }
        });
    }
});
</script>
{% endblock %}