{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Products in {{ category.name }}{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:configuration' %}">Configuration</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:category_list' %}">Categories</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:category_detail' category.pk %}">{{ category.name }}</a></li>
        <li class="breadcrumb-item active">Products</li>
      </ol>
    </nav>
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-box-seam me-2"></i>Products in {{ category.name }}
      {% if category.is_active %}
        <span class="badge bg-success ms-2">Active Category</span>
      {% else %}
        <span class="badge bg-secondary ms-2">Inactive Category</span>
      {% endif %}
    </h1>
    <p class="text-muted mb-0">
      {{ products.count }} product{{ products.count|pluralize }} in this category
      {% if category.parent %}
        | Parent: <a href="{% url 'inventory:category_detail' category.parent.pk %}">{{ category.parent.name }}</a>
      {% endif %}
    </p>
  </div>
  
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:category_detail' category.pk %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Back to Category
    </a>
    <a href="{% url 'inventory:product_create' %}?category={{ category.pk }}" class="btn btn-primary">
      <i class="bi bi-plus me-2"></i>Add Product
    </a>
    <div class="btn-group" role="group">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-three-dots"></i>
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{% url 'inventory:product_bulk_create' %}?category={{ category.pk }}">
          <i class="bi bi-upload me-2"></i>Bulk Import Products
        </a></li>
        <li><a class="dropdown-item" href="?export=csv">
          <i class="bi bi-download me-2"></i>Export to CSV
        </a></li>
        <li><a class="dropdown-item" href="?export=pdf">
          <i class="bi bi-file-pdf me-2"></i>Export to PDF
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{% url 'inventory:category_edit' category.pk %}">
          <i class="bi bi-gear me-2"></i>Category Settings
        </a></li>
      </ul>
    </div>
  </div>
</div>

<!-- Category Summary Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-primary text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Total Products
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ products.count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-box-seam fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-success text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              In Stock
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ in_stock_count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-check-circle fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-warning text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Low Stock
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ low_stock_count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-exclamation-triangle fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-info text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Total Value
            </div>
            <div class="h5 mb-0 font-weight-bold">${{ total_stock_value|floatformat:0|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-currency-dollar fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters and Search -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary">Filter Products</h6>
  </div>
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Search</label>
        <input type="text" class="form-control" name="search" value="{{ current_filters.search }}" 
               placeholder="Product name, SKU, description...">
      </div>
      
      <div class="col-md-2">
        <label class="form-label">Brand</label>
        <select class="form-select" name="brand">
          <option value="">All Brands</option>
          {% for brand in brands %}
            <option value="{{ brand.id }}" {% if current_filters.brand == brand.id|stringformat:"s" %}selected{% endif %}>
              {{ brand.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-2">
        <label class="form-label">Supplier</label>
        <select class="form-select" name="supplier">
          <option value="">All Suppliers</option>
          {% for supplier in suppliers %}
            <option value="{{ supplier.id }}" {% if current_filters.supplier == supplier.id|stringformat:"s" %}selected{% endif %}>
              {{ supplier.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-2">
        <label class="form-label">Stock Status</label>
        <select class="form-select" name="stock_status">
          <option value="">All Stock</option>
          <option value="in_stock" {% if current_filters.stock_status == "in_stock" %}selected{% endif %}>In Stock</option>
          <option value="low_stock" {% if current_filters.stock_status == "low_stock" %}selected{% endif %}>Low Stock</option>
          <option value="out_of_stock" {% if current_filters.stock_status == "out_of_stock" %}selected{% endif %}>Out of Stock</option>
        </select>
      </div>
      
      <div class="col-md-2">
        <label class="form-label">Price Range</label>
        <select class="form-select" name="price_range">
          <option value="">All Prices</option>
          <option value="0-10" {% if current_filters.price_range == "0-10" %}selected{% endif %}>$0 - $10</option>
          <option value="10-50" {% if current_filters.price_range == "10-50" %}selected{% endif %}>$10 - $50</option>
          <option value="50-100" {% if current_filters.price_range == "50-100" %}selected{% endif %}>$50 - $100</option>
          <option value="100+" {% if current_filters.price_range == "100+" %}selected{% endif %}>$100+</option>
        </select>
      </div>
      
      <div class="col-md-1 d-flex align-items-end">
        <div class="btn-group w-100" role="group">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-funnel"></i>
          </button>
          <a href="{% url 'inventory:category_products' category.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-x"></i>
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- View Toggle -->
<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex justify-content-between align-items-center">
    <h6 class="m-0 font-weight-bold text-primary">
      Products
      {% if current_filters.search or current_filters.brand or current_filters.supplier or current_filters.stock_status %}
        <small class="text-muted">(filtered)</small>
      {% endif %}
    </h6>
    <div class="btn-group" role="group">
      <input type="radio" class="btn-check" name="view-toggle" id="tableView" autocomplete="off" checked>
      <label class="btn btn-outline-secondary btn-sm" for="tableView">
        <i class="bi bi-table"></i> Table
      </label>
      <input type="radio" class="btn-check" name="view-toggle" id="gridView" autocomplete="off">
      <label class="btn btn-outline-secondary btn-sm" for="gridView">
        <i class="bi bi-grid-3x3"></i> Grid
      </label>
    </div>
  </div>
  
  <!-- Table View -->
  <div id="tableViewContent" class="card-body p-0">
    {% if products %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll">
              </div>
            </th>
            <th>Product</th>
            <th>SKU</th>
            <th>Brand</th>
            <th>Supplier</th>
            <th>Stock</th>
            <th>Cost</th>
            <th>Selling Price</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr class="{% if product.current_stock <= 0 %}table-danger{% elif product.current_stock <= product.reorder_level %}table-warning{% endif %}">
            <td>
              <div class="form-check">
                <input class="form-check-input product-checkbox" type="checkbox" value="{{ product.id }}">
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                {% if product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                       class="rounded me-3" style="width: 40px; height: 40px; object-fit: cover;">
                {% else %}
                  <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" 
                       style="width: 40px; height: 40px;">
                    <i class="bi bi-box text-muted"></i>
                  </div>
                {% endif %}
                <div>
                  <div class="fw-bold">
                    <a href="{% url 'inventory:product_detail' product.pk %}" 
                       class="text-decoration-none">
                      {{ product.name|truncatechars:40 }}
                    </a>
                  </div>
                  {% if product.description %}
                    <small class="text-muted">{{ product.description|truncatechars:60 }}</small>
                  {% endif %}
                </div>
              </div>
            </td>
            <td>
              <code class="small">{{ product.sku }}</code>
            </td>
            <td>
              {% if product.brand %}
                <a href="{% url 'inventory:brand_detail' product.brand.pk %}" 
                   class="badge bg-light text-dark text-decoration-none">
                  {{ product.brand.name }}
                </a>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              {% if product.supplier %}
                <a href="{% url 'inventory:supplier_detail' product.supplier.pk %}" 
                   class="text-decoration-none small">
                  {{ product.supplier.name|truncatechars:20 }}
                </a>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex align-items-center">
                <span class="me-2 fw-bold {% if product.current_stock <= 0 %}text-danger{% elif product.current_stock <= product.reorder_level %}text-warning{% else %}text-success{% endif %}">
                  {{ product.current_stock|default:0 }}
                </span>
                {% if product.current_stock <= 0 %}
                  <i class="bi bi-x-circle text-danger" title="Out of stock"></i>
                {% elif product.current_stock <= product.reorder_level %}
                  <i class="bi bi-exclamation-triangle text-warning" title="Low stock"></i>
                {% else %}
                  <i class="bi bi-check-circle text-success" title="In stock"></i>
                {% endif %}
              </div>
              <small class="text-muted">Reorder at: {{ product.reorder_level }}</small>
            </td>
            <td>
              <div class="small">
                <div class="fw-bold text-muted">${{ product.cost_price|floatformat:2|default:"0.00" }}</div>
                {% if product.supplier_currency and product.supplier_currency != 'USD' %}
                  <small class="text-muted">{{ product.supplier_currency }}</small>
                {% endif %}
              </div>
            </td>
            <td>
              <div class="small">
                <div class="fw-bold text-success">${{ product.selling_price|floatformat:2|default:"0.00" }}</div>
                {% if product.markup_percentage %}
                  <small class="text-muted">{{ product.markup_percentage }}% markup</small>
                {% endif %}
              </div>
            </td>
            <td>
              {% if product.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'inventory:product_detail' product.pk %}" 
                   class="btn btn-outline-info" 
                   title="View Details">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="{% url 'inventory:product_edit' product.pk %}" 
                   class="btn btn-outline-primary" 
                   title="Edit Product">
                  <i class="bi bi-pencil"></i>
                </a>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'inventory:product_duplicate' product.pk %}">
                      <i class="bi bi-files me-2"></i>Duplicate
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="adjustStock({{ product.id }})">
                      <i class="bi bi-plus-minus me-2"></i>Adjust Stock
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'inventory:product_delete' product.pk %}">
                      <i class="bi bi-trash me-2"></i>Delete
                    </a></li>
                  </ul>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" class="d-none border-top p-3 bg-light">
      <div class="row align-items-center">
        <div class="col">
          <span id="selectedCount">0</span> products selected
        </div>
        <div class="col-auto">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="bulkEdit()">
              <i class="bi bi-pencil me-1"></i>Bulk Edit
            </button>
            <button type="button" class="btn btn-outline-warning btn-sm" onclick="bulkStockAdjustment()">
              <i class="bi bi-plus-minus me-1"></i>Stock Adjustment
            </button>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="exportSelected()">
              <i class="bi bi-download me-1"></i>Export
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="bulkDelete()">
              <i class="bi bi-trash me-1"></i>Delete
            </button>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="bi bi-box fa-3x text-muted mb-3"></i>
      <h5>No Products Found</h5>
      {% if current_filters.search or current_filters.brand or current_filters.supplier or current_filters.stock_status %}
        <p class="text-muted mb-4">No products match your current filters.</p>
        <a href="{% url 'inventory:category_products' category.pk %}" class="btn btn-outline-secondary me-2">
          <i class="bi bi-x me-1"></i>Clear Filters
        </a>
      {% else %}
        <p class="text-muted mb-4">This category doesn't have any products yet.</p>
      {% endif %}
      <a href="{% url 'inventory:product_create' %}?category={{ category.pk }}" class="btn btn-primary">
        <i class="bi bi-plus me-2"></i>Add First Product
      </a>
    </div>
    {% endif %}
  </div>
  
  <!-- Grid View (Hidden by default) -->
  <div id="gridViewContent" class="card-body d-none">
    {% if products %}
    <div class="row">
      {% for product in products %}
      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100 product-card {% if product.current_stock <= 0 %}border-danger{% elif product.current_stock <= product.reorder_level %}border-warning{% endif %}">
          <div class="card-header d-flex justify-content-between align-items-center p-2">
            <div class="form-check">
              <input class="form-check-input product-checkbox" type="checkbox" value="{{ product.id }}">
            </div>
            {% if product.is_active %}
              <span class="badge bg-success">Active</span>
            {% else %}
              <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          </div>
          
          <div class="card-img-wrapper" style="height: 120px; overflow: hidden;">
            {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                   class="card-img-top" style="height: 100%; width: 100%; object-fit: cover;">
            {% else %}
              <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                <i class="bi bi-box fa-2x text-muted"></i>
              </div>
            {% endif %}
          </div>
          
          <div class="card-body p-3">
            <h6 class="card-title">
              <a href="{% url 'inventory:product_detail' product.pk %}" 
                 class="text-decoration-none">
                {{ product.name|truncatechars:35 }}
              </a>
            </h6>
            <p class="card-text">
              <small class="text-muted">SKU: {{ product.sku }}</small>
            </p>
            
            <!-- Stock Status -->
            <div class="row text-center mb-2">
              <div class="col-4">
                <div class="small text-muted">Stock</div>
                <div class="fw-bold {% if product.current_stock <= 0 %}text-danger{% elif product.current_stock <= product.reorder_level %}text-warning{% else %}text-success{% endif %}">
                  {{ product.current_stock|default:0 }}
                </div>
              </div>
              <div class="col-4">
                <div class="small text-muted">Cost</div>
                <div class="fw-bold text-muted">${{ product.cost_price|floatformat:2|default:"0.00" }}</div>
              </div>
              <div class="col-4">
                <div class="small text-muted">Price</div>
                <div class="fw-bold text-success">${{ product.selling_price|floatformat:2|default:"0.00" }}</div>
              </div>
            </div>
            
            <!-- Brand and Supplier -->
            <div class="mb-2">
              {% if product.brand %}
                <span class="badge bg-light text-dark me-1">{{ product.brand.name }}</span>
              {% endif %}
              {% if product.supplier %}
                <small class="text-muted">by {{ product.supplier.name|truncatechars:20 }}</small>
              {% endif %}
            </div>
            
            {% if product.description %}
              <p class="card-text small text-muted">{{ product.description|truncatechars:80 }}</p>
            {% endif %}
          </div>
          
          <div class="card-footer p-2">
            <div class="btn-group w-100" role="group">
              <a href="{% url 'inventory:product_detail' product.pk %}" 
                 class="btn btn-outline-info btn-sm">
                <i class="bi bi-eye"></i>
              </a>
              <a href="{% url 'inventory:product_edit' product.pk %}" 
                 class="btn btn-outline-primary btn-sm">
                <i class="bi bi-pencil"></i>
              </a>
              <button class="btn btn-outline-warning btn-sm" onclick="adjustStock({{ product.id }})">
                <i class="bi bi-plus-minus"></i>
              </button>
              <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{% url 'inventory:product_duplicate' product.pk %}">
                    <i class="bi bi-files me-2"></i>Duplicate
                  </a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="{% url 'inventory:product_delete' product.pk %}">
                    <i class="bi bi-trash me-2"></i>Delete
                  </a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="bi bi-grid fa-3x text-muted mb-3"></i>
      <h5>No Products to Display</h5>
      <p class="text-muted mb-4">Switch to table view or add products to this category.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<nav aria-label="Products pagination">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.brand %}&brand={{ request.GET.brand }}{% endif %}{% if request.GET.supplier %}&supplier={{ request.GET.supplier }}{% endif %}{% if request.GET.stock_status %}&stock_status={{ request.GET.stock_status }}{% endif %}">&laquo; First</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.brand %}&brand={{ request.GET.brand }}{% endif %}{% if request.GET.supplier %}&supplier={{ request.GET.supplier }}{% endif %}{% if request.GET.stock_status %}&stock_status={{ request.GET.stock_status }}{% endif %}">Previous</a>
      </li>
    {% endif %}
    
    <li class="page-item active">
      <span class="page-link">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>
    </li>
    
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.brand %}&brand={{ request.GET.brand }}{% endif %}{% if request.GET.supplier %}&supplier={{ request.GET.supplier }}{% endif %}{% if request.GET.stock_status %}&stock_status={{ request.GET.stock_status }}{% endif %}">Next</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.brand %}&brand={{ request.GET.brand }}{% endif %}{% if request.GET.supplier %}&supplier={{ request.GET.supplier }}{% endif %}{% if request.GET.stock_status %}&stock_status={{ request.GET.stock_status }}{% endif %}">Last &raquo;</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- Quick Stock Adjustment Modal -->
<div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Stock Adjustment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="quickStockForm">
          <input type="hidden" id="productId" name="product_id">
          <div class="mb-3">
            <label class="form-label">Product</label>
            <input type="text" class="form-control" id="productName" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Current Stock</label>
            <input type="number" class="form-control" id="currentStock" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Adjustment</label>
            <input type="number" class="form-control" id="adjustment" placeholder="Enter +/- amount">
          </div>
          <div class="mb-3">
            <label class="form-label">Reason</label>
            <select class="form-select" id="reason">
              <option value="">Select reason...</option>
              <option value="received">Stock Received</option>
              <option value="sold">Stock Sold</option>
              <option value="damaged">Damaged/Lost</option>
              <option value="correction">Count Correction</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitStockAdjustment()">
          <i class="bi bi-check me-1"></i>Adjust Stock
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View toggle functionality
    const tableViewRadio = document.getElementById('tableView');
    const gridViewRadio = document.getElementById('gridView');
    const tableViewContent = document.getElementById('tableViewContent');
    const gridViewContent = document.getElementById('gridViewContent');

    tableViewRadio.addEventListener('change', function() {
        if (this.checked) {
            tableViewContent.classList.remove('d-none');
            gridViewContent.classList.add('d-none');
        }
    });

    gridViewRadio.addEventListener('change', function() {
        if (this.checked) {
            tableViewContent.classList.add('d-none');
            gridViewContent.classList.remove('d-none');
        }
    });

    // Bulk selection functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionsVisibility();
        });
    }

    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionsVisibility);
    });

    function updateBulkActionsVisibility() {
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        if (checkedBoxes.length > 0) {
            bulkActionsBar.classList.remove('d-none');
            selectedCount.textContent = checkedBoxes.length;
        } else {
            bulkActionsBar.classList.add('d-none');
        }

        // Update "Select All" checkbox state
        if (selectAllCheckbox) {
            if (checkedBoxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === productCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
    }

    // Stock adjustment modal
    const stockModal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
    
    window.adjustStock = function(productId) {
        // Find the product row to get current data
        const productRow = document.querySelector(`input[value="${productId}"]`).closest('tr');
        const productName = productRow.querySelector('a').textContent.trim();
        const currentStock = productRow.querySelector('.fw-bold').textContent.trim();
        
        document.getElementById('productId').value = productId;
        document.getElementById('productName').value = productName;
        document.getElementById('currentStock').value = parseInt(currentStock);
        document.getElementById('adjustment').value = '';
        document.getElementById('reason').value = '';
        
        stockModal.show();
    };

    window.submitStockAdjustment = function() {
        const form = document.getElementById('quickStockForm');
        const formData = new FormData(form);
        
        // Here you would typically send an AJAX request to update the stock
        console.log('Stock adjustment:', Object.fromEntries(formData));
        
        // Close modal and refresh page for now
        stockModal.hide();
        location.reload();
    };

    // Bulk actions
    window.bulkEdit = function() {
        const selected = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
        if (selected.length > 0) {
            window.location.href = `{% url 'inventory:product_bulk_update' %}?products=${selected.join(',')}`;
        }
    };

    window.bulkStockAdjustment = function() {
        const selected = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
        if (selected.length > 0) {
            window.location.href = `{% url 'inventory:bulk_stock_adjustment' %}?products=${selected.join(',')}`;
        }
    };

    window.exportSelected = function() {
        const selected = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
        if (selected.length > 0) {
            window.location.href = `?export=csv&products=${selected.join(',')}`;
        }
    };

    window.bulkDelete = function() {
        const selected = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
        if (selected.length > 0) {
            if (confirm(`Are you sure you want to delete ${selected.length} selected products? This action cannot be undone.`)) {
                // Implement bulk delete functionality
                console.log('Bulk delete:', selected);
            }
        }
    };

    // Add tooltips to stock status icons
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}