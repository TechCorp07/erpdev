{% extends "dashboard_base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block page_title %}
  {% if form.instance.pk %}Edit Location{% else %}Add Location{% endif %}
{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:configuration' %}">Configuration</a></li>
        <li class="breadcrumb-item"><a href="{% url 'inventory:location_list' %}">Locations</a></li>
        <li class="breadcrumb-item active">
          {% if form.instance.pk %}Edit Location{% else %}Add Location{% endif %}
        </li>
      </ol>
    </nav>
    <h1 class="h3 mb-0 text-gray-800">
      {% if form.instance.pk %}
        <i class="bi bi-pencil me-2"></i>Edit Location: {{ form.instance.name }}
      {% else %}
        <i class="bi bi-plus me-2"></i>Add New Storage Location
      {% endif %}
    </h1>
    <p class="text-muted mb-0">
      {% if form.instance.pk %}
        Update storage location information and settings
      {% else %}
        Create a new storage location for inventory management
      {% endif %}
    </p>
  </div>
  
  <div class="btn-group" role="group">
    <a href="{% url 'inventory:location_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Back to List
    </a>
    {% if form.instance.pk %}
    <a href="{% url 'inventory:location_detail' form.instance.pk %}" class="btn btn-outline-info">
      <i class="bi bi-eye me-2"></i>View Details
    </a>
    {% endif %}
  </div>
</div>

<form method="post" novalidate>
  {% csrf_token %}
  
  <div class="row">
    <!-- Main Form -->
    <div class="col-lg-8">
      <!-- Basic Information -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-geo-alt me-2"></i>Basic Information
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.name.id_for_label }}" class="form-label">
                Location Name <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                     id="{{ form.name.id_for_label }}"
                     name="{{ form.name.name }}"
                     value="{{ form.name.value|default:'' }}"
                     placeholder="e.g., Main Warehouse, Store A, Distribution Center"
                     required>
              {% if form.name.errors %}
                <div class="invalid-feedback">{{ form.name.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.location_code.id_for_label }}" class="form-label">
                Location Code
              </label>
              <input type="text" 
                     class="form-control {% if form.location_code.errors %}is-invalid{% endif %}" 
                     id="{{ form.location_code.id_for_label }}"
                     name="{{ form.location_code.name }}"
                     value="{{ form.location_code.value|default:'' }}"
                     placeholder="WH001, STORE-A, DC-MAIN"
                     style="text-transform: uppercase;">
              {% if form.location_code.errors %}
                <div class="invalid-feedback">{{ form.location_code.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Unique code for quick identification</div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.location_type.id_for_label }}" class="form-label">
                Location Type <span class="text-danger">*</span>
              </label>
              <select class="form-select {% if form.location_type.errors %}is-invalid{% endif %}"
                      id="{{ form.location_type.id_for_label }}"
                      name="{{ form.location_type.name }}"
                      required>
                <option value="">Select location type...</option>
                {% for value, label in form.location_type.field.choices %}
                  <option value="{{ value }}" {% if form.location_type.value == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
              {% if form.location_type.errors %}
                <div class="invalid-feedback">{{ form.location_type.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="row">
                <div class="col-6">
                  <div class="form-check mt-4">
                    <input class="form-check-input" 
                           type="checkbox" 
                           id="{{ form.is_active.id_for_label }}"
                           name="{{ form.is_active.name }}"
                           {% if form.is_active.value %}checked{% endif %}>
                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                      <strong>Active</strong>
                    </label>
                    <div class="form-text">Available for stock operations</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="form-check mt-4">
                    <input class="form-check-input" 
                           type="checkbox" 
                           id="{{ form.under_maintenance.id_for_label }}"
                           name="{{ form.under_maintenance.name }}"
                           {% if form.under_maintenance.value %}checked{% endif %}>
                    <label class="form-check-label" for="{{ form.under_maintenance.id_for_label }}">
                      <strong>Under Maintenance</strong>
                    </label>
                    <div class="form-text">Temporarily unavailable</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">
              Description
            </label>
            <textarea class="form-control {% if form.description.errors %}is-invalid{% endif %}"
                      id="{{ form.description.id_for_label }}"
                      name="{{ form.description.name }}"
                      rows="3"
                      placeholder="Detailed description of the storage location and its purpose">{{ form.description.value|default:'' }}</textarea>
            {% if form.description.errors %}
              <div class="invalid-feedback">{{ form.description.errors.0 }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Address Information -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-success">
            <i class="bi bi-house me-2"></i>Address Information
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="{{ form.address.id_for_label }}" class="form-label">
              Street Address
            </label>
            <textarea class="form-control {% if form.address.errors %}is-invalid{% endif %}"
                      id="{{ form.address.id_for_label }}"
                      name="{{ form.address.name }}"
                      rows="2"
                      placeholder="Full street address including building number and street name">{{ form.address.value|default:'' }}</textarea>
            {% if form.address.errors %}
              <div class="invalid-feedback">{{ form.address.errors.0 }}</div>
            {% endif %}
          </div>
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="{{ form.city.id_for_label }}" class="form-label">
                City
              </label>
              <input type="text" 
                     class="form-control {% if form.city.errors %}is-invalid{% endif %}" 
                     id="{{ form.city.id_for_label }}"
                     name="{{ form.city.name }}"
                     value="{{ form.city.value|default:'' }}"
                     placeholder="City name">
              {% if form.city.errors %}
                <div class="invalid-feedback">{{ form.city.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
              <label for="{{ form.state_province.id_for_label }}" class="form-label">
                State/Province
              </label>
              <input type="text" 
                     class="form-control {% if form.state_province.errors %}is-invalid{% endif %}" 
                     id="{{ form.state_province.id_for_label }}"
                     name="{{ form.state_province.name }}"
                     value="{{ form.state_province.value|default:'' }}"
                     placeholder="State or Province">
              {% if form.state_province.errors %}
                <div class="invalid-feedback">{{ form.state_province.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
              <label for="{{ form.postal_code.id_for_label }}" class="form-label">
                Postal Code
              </label>
              <input type="text" 
                     class="form-control {% if form.postal_code.errors %}is-invalid{% endif %}" 
                     id="{{ form.postal_code.id_for_label }}"
                     name="{{ form.postal_code.name }}"
                     value="{{ form.postal_code.value|default:'' }}"
                     placeholder="Postal/ZIP code">
              {% if form.postal_code.errors %}
                <div class="invalid-feedback">{{ form.postal_code.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.country.id_for_label }}" class="form-label">
                Country
              </label>
              <input type="text" 
                     class="form-control {% if form.country.errors %}is-invalid{% endif %}" 
                     id="{{ form.country.id_for_label }}"
                     name="{{ form.country.name }}"
                     value="{{ form.country.value|default:'' }}"
                     placeholder="Country name">
              {% if form.country.errors %}
                <div class="invalid-feedback">{{ form.country.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.timezone.id_for_label }}" class="form-label">
                Timezone
              </label>
              <select class="form-select {% if form.timezone.errors %}is-invalid{% endif %}"
                      id="{{ form.timezone.id_for_label }}"
                      name="{{ form.timezone.name }}">
                <option value="">Select timezone...</option>
                {% for value, label in form.timezone.field.choices %}
                  <option value="{{ value }}" {% if form.timezone.value == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
              {% if form.timezone.errors %}
                <div class="invalid-feedback">{{ form.timezone.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Capacity and Operations -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-warning">
            <i class="bi bi-diagram-3 me-2"></i>Capacity & Operations
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.total_capacity.id_for_label }}" class="form-label">
                Total Capacity (m²)
              </label>
              <input type="number" 
                     class="form-control {% if form.total_capacity.errors %}is-invalid{% endif %}" 
                     id="{{ form.total_capacity.id_for_label }}"
                     name="{{ form.total_capacity.name }}"
                     value="{{ form.total_capacity.value|default:'' }}"
                     step="0.01"
                     min="0"
                     placeholder="0.00">
              {% if form.total_capacity.errors %}
                <div class="invalid-feedback">{{ form.total_capacity.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Total storage area in square meters</div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.used_capacity.id_for_label }}" class="form-label">
                Used Capacity (m²)
              </label>
              <input type="number" 
                     class="form-control {% if form.used_capacity.errors %}is-invalid{% endif %}" 
                     id="{{ form.used_capacity.id_for_label }}"
                     name="{{ form.used_capacity.name }}"
                     value="{{ form.used_capacity.value|default:'' }}"
                     step="0.01"
                     min="0"
                     placeholder="0.00">
              {% if form.used_capacity.errors %}
                <div class="invalid-feedback">{{ form.used_capacity.errors.0 }}</div>
              {% endif %}
              <div class="form-text">Currently occupied storage area</div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.max_weight_capacity.id_for_label }}" class="form-label">
                Max Weight Capacity (kg)
              </label>
              <input type="number" 
                     class="form-control {% if form.max_weight_capacity.errors %}is-invalid{% endif %}" 
                     id="{{ form.max_weight_capacity.id_for_label }}"
                     name="{{ form.max_weight_capacity.name }}"
                     value="{{ form.max_weight_capacity.value|default:'' }}"
                     step="0.01"
                     min="0"
                     placeholder="0.00">
              {% if form.max_weight_capacity.errors %}
                <div class="invalid-feedback">{{ form.max_weight_capacity.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.current_weight.id_for_label }}" class="form-label">
                Current Weight (kg)
              </label>
              <input type="number" 
                     class="form-control {% if form.current_weight.errors %}is-invalid{% endif %}" 
                     id="{{ form.current_weight.id_for_label }}"
                     name="{{ form.current_weight.name }}"
                     value="{{ form.current_weight.value|default:'' }}"
                     step="0.01"
                     min="0"
                     placeholder="0.00">
              {% if form.current_weight.errors %}
                <div class="invalid-feedback">{{ form.current_weight.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <!-- Capacity Indicator -->
          <div class="mb-3" id="capacityIndicator" style="display: none;">
            <label class="form-label">Capacity Utilization</label>
            <div class="progress mb-2" style="height: 20px;">
              <div class="progress-bar" role="progressbar" id="capacityBar" style="width: 0%">
                <span id="capacityText">0%</span>
              </div>
            </div>
            <small class="text-muted" id="capacityDetails"></small>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-check mb-3">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="{{ form.has_loading_dock.id_for_label }}"
                       name="{{ form.has_loading_dock.name }}"
                       {% if form.has_loading_dock.value %}checked{% endif %}>
                <label class="form-check-label" for="{{ form.has_loading_dock.id_for_label }}">
                  <strong>Has Loading Dock</strong>
                </label>
                <div class="form-text">Facility for loading/unloading trucks</div>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="{{ form.climate_controlled.id_for_label }}"
                       name="{{ form.climate_controlled.name }}"
                       {% if form.climate_controlled.value %}checked{% endif %}>
                <label class="form-check-label" for="{{ form.climate_controlled.id_for_label }}">
                  <strong>Climate Controlled</strong>
                </label>
                <div class="form-text">Temperature and humidity controlled</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check mb-3">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="{{ form.security_system.id_for_label }}"
                       name="{{ form.security_system.name }}"
                       {% if form.security_system.value %}checked{% endif %}>
                <label class="form-check-label" for="{{ form.security_system.id_for_label }}">
                  <strong>Security System</strong>
                </label>
                <div class="form-text">Surveillance and access control</div>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="{{ form.requires_special_handling.id_for_label }}"
                       name="{{ form.requires_special_handling.name }}"
                       {% if form.requires_special_handling.value %}checked{% endif %}>
                <label class="form-check-label" for="{{ form.requires_special_handling.id_for_label }}">
                  <strong>Special Handling Required</strong>
                </label>
                <div class="form-text">Special procedures or equipment needed</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-info">
            <i class="bi bi-person-badge me-2"></i>Contact Information
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.manager_name.id_for_label }}" class="form-label">
                Manager Name
              </label>
              <input type="text" 
                     class="form-control {% if form.manager_name.errors %}is-invalid{% endif %}" 
                     id="{{ form.manager_name.id_for_label }}"
                     name="{{ form.manager_name.name }}"
                     value="{{ form.manager_name.value|default:'' }}"
                     placeholder="Location manager or supervisor">
              {% if form.manager_name.errors %}
                <div class="invalid-feedback">{{ form.manager_name.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                Phone Number
              </label>
              <input type="tel" 
                     class="form-control {% if form.phone_number.errors %}is-invalid{% endif %}" 
                     id="{{ form.phone_number.id_for_label }}"
                     name="{{ form.phone_number.name }}"
                     value="{{ form.phone_number.value|default:'' }}"
                     placeholder="+1 (555) 123-4567">
              {% if form.phone_number.errors %}
                <div class="invalid-feedback">{{ form.phone_number.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.email.id_for_label }}" class="form-label">
              Email Address
            </label>
            <input type="email" 
                   class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                   id="{{ form.email.id_for_label }}"
                   name="{{ form.email.name }}"
                   value="{{ form.email.value|default:'' }}"
                   placeholder="location@example.com">
            {% if form.email.errors %}
              <div class="invalid-feedback">{{ form.email.errors.0 }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check me-2"></i>
                {% if form.instance.pk %}Update Location{% else %}Create Location{% endif %}
              </button>
              <a href="{% url 'inventory:location_list' %}" class="btn btn-outline-secondary ms-2">
                <i class="bi bi-x me-2"></i>Cancel
              </a>
            </div>
            
            {% if form.instance.pk %}
            <div>
              <a href="{% url 'inventory:location_delete' form.instance.pk %}" 
                 class="btn btn-outline-danger"
                 onclick="return confirm('Are you sure you want to delete this location? This may affect inventory tracking.')">
                <i class="bi bi-trash me-2"></i>Delete Location
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      {% if form.instance.pk %}
      <!-- Location Statistics -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-info">
            <i class="bi bi-bar-chart me-2"></i>Location Statistics
          </h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <div class="h4 mb-0 text-primary">{{ form.instance.storage_bins.count|default:0 }}</div>
              <small class="text-muted">Storage Bins</small>
            </div>
            <div class="col-6 mb-3">
              <div class="h4 mb-0 text-success">{{ form.instance.stock_levels.count|default:0 }}</div>
              <small class="text-muted">Products</small>
            </div>
            <div class="col-12 mb-3">
              <div class="h4 mb-0 text-warning">{{ form.instance.stock_movements.count|default:0 }}</div>
              <small class="text-muted">Recent Movements</small>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Location Tips -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-secondary">
            <i class="bi bi-lightbulb me-2"></i>Location Management Tips
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Use descriptive location names
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Set realistic capacity limits
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Keep contact information updated
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Monitor capacity utilization
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Configure appropriate access controls
              </li>
              <li class="mb-2">
                <i class="bi bi-check-circle text-success me-2"></i>
                Set maintenance schedules
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Location Types Guide -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-info-circle me-2"></i>Location Types
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="bi bi-building text-primary me-2"></i>
                <strong>Warehouse:</strong> Large storage facility
              </li>
              <li class="mb-2">
                <i class="bi bi-shop text-success me-2"></i>
                <strong>Store:</strong> Retail or showroom location
              </li>
              <li class="mb-2">
                <i class="bi bi-truck text-warning me-2"></i>
                <strong>Distribution Center:</strong> Hub for order fulfillment
              </li>
              <li class="mb-2">
                <i class="bi bi-house text-info me-2"></i>
                <strong>Office:</strong> Administrative location with limited storage
              </li>
              <li class="mb-2">
                <i class="bi bi-geo-alt text-secondary me-2"></i>
                <strong>Other:</strong> Custom location type
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Required Fields -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-danger">
            <i class="bi bi-asterisk me-2"></i>Required Fields
          </h6>
        </div>
        <div class="card-body">
          <div class="small">
            <p class="mb-2">The following fields are required:</p>
            <ul class="list-unstyled">
              <li class="mb-1">
                <i class="bi bi-dot text-danger"></i>
                Location Name
              </li>
              <li class="mb-1">
                <i class="bi bi-dot text-danger"></i>
                Location Type
              </li>
            </ul>
            <p class="text-muted mb-0">
              All other fields are optional but recommended for complete location management.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus on location name field
    const nameField = document.getElementById('{{ form.name.id_for_label }}');
    if (nameField && !nameField.value) {
        nameField.focus();
    }
    
    // Auto-generate location code
    const codeField = document.getElementById('{{ form.location_code.id_for_label }}');
    const typeField = document.getElementById('{{ form.location_type.id_for_label }}');
    
    if (codeField && nameField && typeField && !codeField.value) {
        function generateCode() {
            if (nameField.value && typeField.value) {
                const nameCode = nameField.value
                    .toUpperCase()
                    .replace(/[^A-Z0-9]/g, '')
                    .substring(0, 4);
                
                const typeCode = typeField.options[typeField.selectedIndex].text
                    .toUpperCase()
                    .substring(0, 3);
                
                if (nameCode.length >= 2) {
                    codeField.value = typeCode + '-' + nameCode;
                }
            }
        }
        
        nameField.addEventListener('blur', generateCode);
        typeField.addEventListener('change', generateCode);
    }
    
    // Capacity calculation and visualization
    const totalCapacityField = document.getElementById('{{ form.total_capacity.id_for_label }}');
    const usedCapacityField = document.getElementById('{{ form.used_capacity.id_for_label }}');
    const capacityIndicator = document.getElementById('capacityIndicator');
    const capacityBar = document.getElementById('capacityBar');
    const capacityText = document.getElementById('capacityText');
    const capacityDetails = document.getElementById('capacityDetails');
    
    function updateCapacityVisualization() {
        const total = parseFloat(totalCapacityField.value) || 0;
        const used = parseFloat(usedCapacityField.value) || 0;
        
        if (total > 0) {
            capacityIndicator.style.display = 'block';
            
            const percentage = (used / total) * 100;
            const remaining = total - used;
            
            capacityBar.style.width = percentage + '%';
            capacityText.textContent = percentage.toFixed(1) + '%';
            capacityDetails.textContent = `${used.toFixed(1)}m² used of ${total.toFixed(1)}m² (${remaining.toFixed(1)}m² available)`;
            
            // Color coding
            capacityBar.className = 'progress-bar';
            if (percentage >= 90) {
                capacityBar.classList.add('bg-danger');
            } else if (percentage >= 75) {
                capacityBar.classList.add('bg-warning');
            } else {
                capacityBar.classList.add('bg-success');
            }
            
            // Validation
            if (used > total) {
                usedCapacityField.classList.add('is-invalid');
                if (!usedCapacityField.nextElementSibling || !usedCapacityField.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = 'Used capacity cannot exceed total capacity';
                    usedCapacityField.parentNode.appendChild(feedback);
                }
            } else {
                usedCapacityField.classList.remove('is-invalid');
                const feedback = usedCapacityField.parentNode.querySelector('.invalid-feedback');
                if (feedback && feedback.textContent === 'Used capacity cannot exceed total capacity') {
                    feedback.remove();
                }
            }
        } else {
            capacityIndicator.style.display = 'none';
        }
    }
    
    if (totalCapacityField && usedCapacityField) {
        totalCapacityField.addEventListener('input', updateCapacityVisualization);
        usedCapacityField.addEventListener('input', updateCapacityVisualization);
        updateCapacityVisualization(); // Initial calculation
    }
    
    // Phone number formatting
    const phoneField = document.getElementById('{{ form.phone_number.id_for_label }}');
    if (phoneField) {
        phoneField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 10) {
                value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
            } else if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{3})/, '($1) $2-');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{3})/, '($1) ');
            }
            e.target.value = value;
        });
    }
    
    // Email validation
    const emailField = document.getElementById('{{ form.email.id_for_label }}');
    if (emailField) {
        emailField.addEventListener('blur', function(e) {
            const email = e.target.value;
            if (email && !email.includes('@')) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        });
    }
    
    // Maintenance mode warning
    const maintenanceField = document.getElementById('{{ form.under_maintenance.id_for_label }}');
    const activeField = document.getElementById('{{ form.is_active.id_for_label }}');
    
    if (maintenanceField && activeField) {
        maintenanceField.addEventListener('change', function() {
            if (this.checked) {
                activeField.checked = false;
                if (!document.getElementById('maintenanceWarning')) {
                    const warning = document.createElement('div');
                    warning.id = 'maintenanceWarning';
                    warning.className = 'alert alert-warning mt-3';
                    warning.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Location under maintenance will not be available for stock operations.';
                    maintenanceField.closest('.card-body').appendChild(warning);
                }
            } else {
                const warning = document.getElementById('maintenanceWarning');
                if (warning) warning.remove();
            }
        });
    }
    
    // Form validation before submit
    document.querySelector('form').addEventListener('submit', function(e) {
        let isValid = true;
        
        // Check required fields
        if (!nameField.value.trim()) {
            nameField.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!typeField.value) {
            typeField.classList.add('is-invalid');
            isValid = false;
        }
        
        // Check capacity logic
        const total = parseFloat(totalCapacityField.value) || 0;
        const used = parseFloat(usedCapacityField.value) || 0;
        
        if (used > total && total > 0) {
            usedCapacityField.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            alert('Please fix the form errors before submitting.');
        }
    });
});
</script>
{% endblock %}