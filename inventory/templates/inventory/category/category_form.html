{% extends "inventory_base.html" %}
{% load static %}

{% block inventory_title %}
  {% if form.instance.pk %}Edit Category{% else %}Add Category{% endif %}
{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
  .form-container {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }
  
  .form-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
  }
  
  .form-body {
    padding: 2rem;
  }
  
  .form-section {
    background: #f8f9fc;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e3e6f0;
  }
  
  .section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .parent-category-display {
    background: #e7f3ff;
    border: 2px dashed #007bff;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    margin-bottom: 1rem;
  }
  
  .hierarchy-preview {
    background: #f8f9fc;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
    border: 1px solid #e3e6f0;
  }
  
  .hierarchy-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background: white;
    border-radius: 0.375rem;
    border: 1px solid #e3e6f0;
  }
  
  .hierarchy-item:last-child {
    margin-bottom: 0;
    border: 2px solid #28a745;
    background: #d4edda;
  }
  
  .hierarchy-level {
    font-size: 0.75rem;
    background: #6c757d;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin-right: 0.75rem;
    min-width: 60px;
    text-align: center;
  }
  
  .markup-calculator {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
  }
  
  .calculator-result {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-top: 0.5rem;
  }
  
  .form-help {
    background: #e7f3ff;
    border-left: 4px solid #007bff;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .slug-preview {
    font-family: monospace;
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 0.375rem;
    border: 1px solid #e3e6f0;
    margin-top: 0.5rem;
  }
  
  .validation-feedback {
    display: block;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }
  
  .validation-feedback.valid {
    color: #28a745;
  }
  
  .validation-feedback.invalid {
    color: #dc3545;
  }
  
  .input-group-addon {
    background: #f8f9fc;
    border: 1px solid #d1d3e2;
    border-radius: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    color: #6c757d;
  }
  
  .color-picker-container {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .color-option:hover,
  .color-option.selected {
    border-color: #2c3e50;
    transform: scale(1.1);
  }
  
  .preview-card {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    border: 1px solid #e3e6f0;
    margin-top: 1rem;
  }
  
  .icon-picker {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .icon-option {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #e3e6f0;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.25rem;
  }
  
  .icon-option:hover,
  .icon-option.selected {
    border-color: #667eea;
    background: #f8f9fc;
    color: #667eea;
  }
  
  @media (max-width: 768px) {
    .form-header,
    .form-body {
      padding: 1.5rem;
    }
    
    .form-section {
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .hierarchy-level {
      min-width: 50px;
      font-size: 0.7rem;
    }
    
    .color-picker-container {
      justify-content: center;
    }
    
    .icon-picker {
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    }
    
    .icon-option {
      width: 40px;
      height: 40px;
      font-size: 1rem;
    }
  }
</style>
{% endblock %}

{% block inventory_breadcrumbs %}
  <li class="breadcrumb-item"><a href="{% url 'inventory:category_list' %}">Categories</a></li>
  {% if form.instance.pk %}
    <li class="breadcrumb-item"><a href="{% url 'inventory:category_detail' form.instance.pk %}">{{ form.instance.name }}</a></li>
    <li class="breadcrumb-item active">Edit</li>
  {% else %}
    <li class="breadcrumb-item active">Add Category</li>
  {% endif %}
{% endblock %}

{% block inventory_actions %}
<div class="btn-group" role="group">
  <a href="{% url 'inventory:category_list' %}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left me-1"></i>Back to Categories
  </a>
  {% if form.instance.pk %}
    <a href="{% url 'inventory:category_detail' form.instance.pk %}" class="btn btn-outline-info btn-sm">
      <i class="bi bi-eye me-1"></i>View Category
    </a>
    {% if form.instance.product_count > 0 %}
      <a href="{% url 'inventory:category_products' form.instance.pk %}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-list me-1"></i>View Products ({{ form.instance.product_count }})
      </a>
    {% endif %}
  {% endif %}
</div>
{% endblock %}

{% block inventory_content %}
<div class="form-container">
  <!-- Form Header -->
  <div class="form-header">
    <h2 class="mb-2">
      {% if form.instance.pk %}
        <i class="bi bi-pencil me-2"></i>Edit Category
      {% else %}
        <i class="bi bi-plus-circle me-2"></i>Create New Category
      {% endif %}
    </h2>
    <p class="mb-0">
      {% if form.instance.pk %}
        Update category information and settings
      {% else %}
        Add a new category to organize your products
      {% endif %}
    </p>
  </div>

  <!-- Form Body -->
  <div class="form-body">
    <!-- Help Text -->
    <div class="form-help">
      <h6><i class="bi bi-info-circle me-2"></i>Category Guidelines</h6>
      <ul class="mb-0">
        <li>Choose descriptive names that clearly identify the product type</li>
        <li>Use parent categories to create logical hierarchies (e.g., Electronics > Audio > Speakers)</li>
        <li>Set appropriate default markup percentages for consistent pricing</li>
        <li>Configure reorder levels to match typical usage patterns</li>
      </ul>
    </div>

    <form method="post" id="categoryForm" novalidate>
      {% csrf_token %}
      
      <!-- Parent Category Section -->
      {% if request.GET.parent or form.instance.parent %}
        <div class="form-section">
          <div class="section-title">
            <i class="bi bi-diagram-3"></i>
            Parent Category
          </div>
          
          <div class="parent-category-display">
            <h5 class="mb-2">
              <i class="bi bi-folder me-2"></i>
              {% if request.GET.parent %}
                {{ parent_category.name }}
              {% else %}
                {{ form.instance.parent.name }}
              {% endif %}
            </h5>
            <p class="mb-0 text-muted">This category will be created as a subcategory</p>
            
            {% if request.GET.parent %}
              <input type="hidden" name="parent" value="{{ request.GET.parent }}">
            {% endif %}
          </div>
        </div>
      {% endif %}
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="bi bi-info-circle"></i>
          Basic Information
        </div>
        
        <div class="row">
          <div class="col-md-8">
            <div class="mb-3">
              <label for="{{ form.name.id_for_label }}" class="form-label required">
                <i class="bi bi-tag me-1"></i>Category Name
              </label>
              {{ form.name }}
              {% if form.name.errors %}
                <div class="validation-feedback invalid">
                  {{ form.name.errors.0 }}
                </div>
              {% endif %}
              <div class="form-text">
                Choose a clear, descriptive name for this category
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="mb-3">
              <label for="{{ form.display_order.id_for_label }}" class="form-label">
                <i class="bi bi-sort-numeric-up me-1"></i>Display Order
              </label>
              {{ form.display_order }}
              <div class="form-text">
                Lower numbers appear first
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="{{ form.slug.id_for_label }}" class="form-label">
            <i class="bi bi-link-45deg me-1"></i>URL Slug
          </label>
          {{ form.slug }}
          {% if form.slug.errors %}
            <div class="validation-feedback invalid">
              {{ form.slug.errors.0 }}
            </div>
          {% endif %}
          <div class="slug-preview" id="slugPreview">
            Category URL: <span id="slugUrl">/categories/{{ form.slug.value|default:"category-name" }}/</span>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="{{ form.description.id_for_label }}" class="form-label">
            <i class="bi bi-text-paragraph me-1"></i>Description
          </label>
          {{ form.description }}
          {% if form.description.errors %}
            <div class="validation-feedback invalid">
              {{ form.description.errors.0 }}
            </div>
          {% endif %}
          <div class="form-text">
            Briefly describe what products belong in this category
          </div>
        </div>

        <!-- Parent Category Selection (for edit mode) -->
        {% if not request.GET.parent and not form.instance.parent %}
          <div class="mb-3">
            <label for="{{ form.parent.id_for_label }}" class="form-label">
              <i class="bi bi-diagram-3 me-1"></i>Parent Category
            </label>
            {{ form.parent }}
            {% if form.parent.errors %}
              <div class="validation-feedback invalid">
                {{ form.parent.errors.0 }}
              </div>
            {% endif %}
            <div class="form-text">
              Leave empty to create a top-level category
            </div>
          </div>
        {% endif %}
      </div>

      <!-- Business Rules Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="bi bi-calculator"></i>
          Business Rules
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="{{ form.default_markup_percentage.id_for_label }}" class="form-label">
                <i class="bi bi-percent me-1"></i>Default Markup Percentage
              </label>
              <div class="input-group">
                {{ form.default_markup_percentage }}
                <span class="input-group-text">%</span>
              </div>
              {% if form.default_markup_percentage.errors %}
                <div class="validation-feedback invalid">
                  {{ form.default_markup_percentage.errors.0 }}
                </div>
              {% endif %}
              <div class="form-text">
                Default profit margin for products in this category
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="mb-3">
              <label for="{{ form.default_reorder_level.id_for_label }}" class="form-label">
                <i class="bi bi-arrow-repeat me-1"></i>Default Reorder Level
              </label>
              <div class="input-group">
                {{ form.default_reorder_level }}
                <span class="input-group-text">units</span>
              </div>
              {% if form.default_reorder_level.errors %}
                <div class="validation-feedback invalid">
                  {{ form.default_reorder_level.errors.0 }}
                </div>
              {% endif %}
              <div class="form-text">
                Default minimum stock level for products
              </div>
            </div>
          </div>
        </div>
        
        <!-- Markup Calculator -->
        <div class="markup-calculator">
          <h6><i class="bi bi-calculator me-2"></i>Pricing Calculator</h6>
          <div class="row">
            <div class="col-md-4">
              <label for="costPrice" class="form-label">Cost Price ($)</label>
              <input type="number" class="form-control" id="costPrice" step="0.01" placeholder="10.00">
            </div>
            <div class="col-md-4">
              <label for="markupPercent" class="form-label">Markup (%)</label>
              <input type="number" class="form-control" id="markupPercent" step="0.01" placeholder="30">
            </div>
            <div class="col-md-4">
              <div class="calculator-result" id="calculatorResult" style="display: none;">
                <strong>Selling Price: $<span id="sellingPrice">0.00</span></strong>
                <br>
                <small>Profit: $<span id="profitAmount">0.00</span></small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Display Settings Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="bi bi-palette"></i>
          Display Settings
        </div>
        
        <!-- Category Color -->
        <div class="mb-3">
          <label class="form-label">
            <i class="bi bi-palette me-1"></i>Category Color
          </label>
          <div class="color-picker-container">
            <div class="color-option" style="background: #667eea;" data-color="#667eea"></div>
            <div class="color-option" style="background: #f093fb;" data-color="#f093fb"></div>
            <div class="color-option" style="background: #4facfe;" data-color="#4facfe"></div>
            <div class="color-option" style="background: #43e97b;" data-color="#43e97b"></div>
            <div class="color-option" style="background: #fa709a;" data-color="#fa709a"></div>
            <div class="color-option" style="background: #fee140;" data-color="#fee140"></div>
            <div class="color-option" style="background: #96deda;" data-color="#96deda"></div>
            <div class="color-option" style="background: #ffecd2;" data-color="#ffecd2"></div>
          </div>
          <input type="hidden" name="category_color" id="categoryColor" value="#667eea">
          <div class="form-text">
            Choose a color to help identify this category
          </div>
        </div>
        
        <!-- Category Icon -->
        <div class="mb-3">
          <label class="form-label">
            <i class="bi bi-emoji-smile me-1"></i>Category Icon
          </label>
          <div class="icon-picker">
            <div class="icon-option" data-icon="box-seam"><i class="bi bi-box-seam"></i></div>
            <div class="icon-option" data-icon="laptop"><i class="bi bi-laptop"></i></div>
            <div class="icon-option" data-icon="phone"><i class="bi bi-phone"></i></div>
            <div class="icon-option" data-icon="headphones"><i class="bi bi-headphones"></i></div>
            <div class="icon-option" data-icon="camera"><i class="bi bi-camera"></i></div>
            <div class="icon-option" data-icon="tv"><i class="bi bi-tv"></i></div>
            <div class="icon-option" data-icon="watch"><i class="bi bi-watch"></i></div>
            <div class="icon-option" data-icon="keyboard"><i class="bi bi-keyboard"></i></div>
            <div class="icon-option" data-icon="mouse"><i class="bi bi-mouse"></i></div>
            <div class="icon-option" data-icon="speaker"><i class="bi bi-speaker"></i></div>
            <div class="icon-option" data-icon="printer"><i class="bi bi-printer"></i></div>
            <div class="icon-option" data-icon="router"><i class="bi bi-router"></i></div>
          </div>
          <input type="hidden" name="category_icon" id="categoryIcon" value="box-seam">
          <div class="form-text">
            Select an icon to represent this category
          </div>
        </div>
      </div>

      <!-- Status Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="bi bi-toggle-on"></i>
          Status & Activation
        </div>
        
        <div class="form-check form-switch">
          {{ form.is_active }}
          <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
            <strong>Active Category</strong>
            <div class="form-text">
              Only active categories can be assigned to products and appear in selection lists
            </div>
          </label>
        </div>
      </div>

      <!-- Category Hierarchy Preview -->
      {% if form.instance.pk or request.GET.parent %}
        <div class="form-section">
          <div class="section-title">
            <i class="bi bi-diagram-2"></i>
            Category Hierarchy Preview
          </div>
          
          <div class="hierarchy-preview">
            <div id="hierarchyDisplay">
              <!-- Hierarchy will be updated via JavaScript -->
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Category Preview -->
      <div class="preview-card">
        <h6><i class="bi bi-eye me-2"></i>Category Preview</h6>
        <div id="categoryPreview" class="d-flex align-items-center p-2 border rounded">
          <div id="previewIcon" class="me-3">
            <i class="bi bi-box-seam fs-4" style="color: #667eea;"></i>
          </div>
          <div>
            <div class="fw-bold" id="previewName">Category Name</div>
            <div class="text-muted small" id="previewDescription">Category description</div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'inventory:category_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-x-circle me-2"></i>Cancel
        </a>
        
        <div class="btn-group">
          {% if form.instance.pk %}
            <button type="submit" name="action" value="save" class="btn btn-primary">
              <i class="bi bi-check-circle me-2"></i>Update Category
            </button>
            <button type="submit" name="action" value="save_and_continue" class="btn btn-success">
              <i class="bi bi-check-circle me-2"></i>Update & Continue Editing
            </button>
          {% else %}
            <button type="submit" name="action" value="save" class="btn btn-primary">
              <i class="bi bi-plus-circle me-2"></i>Create Category
            </button>
            <button type="submit" name="action" value="save_and_add" class="btn btn-success">
              <i class="bi bi-plus-circle me-2"></i>Create & Add Another
            </button>
          {% endif %}
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize form enhancements
  setupSlugGeneration();
  setupMarkupCalculator();
  setupColorPicker();
  setupIconPicker();
  setupFormValidation();
  setupCategoryPreview();
  updateHierarchyDisplay();
  
  // Initialize form values
  updatePreview();
});

function setupSlugGeneration() {
  const nameField = document.getElementById('{{ form.name.id_for_label }}');
  const slugField = document.getElementById('{{ form.slug.id_for_label }}');
  
  if (nameField && slugField) {
    nameField.addEventListener('input', function() {
      if (!slugField.value || slugField.dataset.autoGenerated !== 'false') {
        const slug = generateSlug(this.value);
        slugField.value = slug;
        slugField.dataset.autoGenerated = 'true';
        updateSlugPreview(slug);
      }
    });
    
    slugField.addEventListener('input', function() {
      this.dataset.autoGenerated = 'false';
      updateSlugPreview(this.value);
    });
  }
}

function generateSlug(text) {
  return text.toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim('-');
}

function updateSlugPreview(slug) {
  const slugUrl = document.getElementById('slugUrl');
  if (slugUrl) {
    slugUrl.textContent = `/categories/${slug || 'category-name'}/`;
  }
}

function setupMarkupCalculator() {
  const costPrice = document.getElementById('costPrice');
  const markupPercent = document.getElementById('markupPercent');
  const defaultMarkup = document.getElementById('{{ form.default_markup_percentage.id_for_label }}');
  
  function calculatePricing() {
    const cost = parseFloat(costPrice.value) || 0;
    const markup = parseFloat(markupPercent.value) || parseFloat(defaultMarkup.value) || 0;
    
    if (cost > 0 && markup > 0) {
      const sellingPrice = cost * (1 + markup / 100);
      const profit = sellingPrice - cost;
      
      document.getElementById('sellingPrice').textContent = sellingPrice.toFixed(2);
      document.getElementById('profitAmount').textContent = profit.toFixed(2);
      document.getElementById('calculatorResult').style.display = 'block';
    } else {
      document.getElementById('calculatorResult').style.display = 'none';
    }
  }
  
  [costPrice, markupPercent, defaultMarkup].forEach(field => {
    if (field) {
      field.addEventListener('input', calculatePricing);
    }
  });
  
  // Sync markup percentage with default markup
  if (defaultMarkup) {
    defaultMarkup.addEventListener('input', function() {
      if (!markupPercent.value) {
        markupPercent.value = this.value;
        calculatePricing();
      }
    });
  }
}

function setupColorPicker() {
  const colorOptions = document.querySelectorAll('.color-option');
  const colorInput = document.getElementById('categoryColor');
  
  colorOptions.forEach(option => {
    option.addEventListener('click', function() {
      colorOptions.forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      
      const color = this.dataset.color;
      colorInput.value = color;
      updatePreview();
    });
  });
  
  // Set initial selection
  const initialColor = colorInput.value || '#667eea';
  const initialOption = document.querySelector(`[data-color="${initialColor}"]`);
  if (initialOption) {
    initialOption.classList.add('selected');
  }
}

function setupIconPicker() {
  const iconOptions = document.querySelectorAll('.icon-option');
  const iconInput = document.getElementById('categoryIcon');
  
  iconOptions.forEach(option => {
    option.addEventListener('click', function() {
      iconOptions.forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      
      const icon = this.dataset.icon;
      iconInput.value = icon;
      updatePreview();
    });
  });
  
  // Set initial selection
  const initialIcon = iconInput.value || 'box-seam';
  const initialOption = document.querySelector(`[data-icon="${initialIcon}"]`);
  if (initialOption) {
    initialOption.classList.add('selected');
  }
}

function setupFormValidation() {
  const form = document.getElementById('categoryForm');
  const nameField = document.getElementById('{{ form.name.id_for_label }}');
  
  // Real-time validation
  if (nameField) {
    nameField.addEventListener('input', function() {
      validateCategoryName(this.value);
    });
  }
  
  // Form submission validation
  form.addEventListener('submit', function(e) {
    if (!validateForm()) {
      e.preventDefault();
    }
  });
}

function validateCategoryName(name) {
  const feedback = document.querySelector('#{{ form.name.id_for_label }} + .validation-feedback');
  
  if (name.length < 2) {
    showValidationFeedback(feedback, 'Category name must be at least 2 characters long', false);
  } else if (name.length > 100) {
    showValidationFeedback(feedback, 'Category name must be less than 100 characters', false);
  } else {
    // Check for uniqueness (in a real implementation, this would be an AJAX call)
    showValidationFeedback(feedback, 'Category name looks good!', true);
  }
}

function showValidationFeedback(element, message, isValid) {
  if (!element) {
    element = document.createElement('div');
    element.className = 'validation-feedback';
    document.getElementById('{{ form.name.id_for_label }}').parentNode.appendChild(element);
  }
  
  element.textContent = message;
  element.className = `validation-feedback ${isValid ? 'valid' : 'invalid'}`;
}

function validateForm() {
  const nameField = document.getElementById('{{ form.name.id_for_label }}');
  
  if (!nameField.value.trim()) {
    nameField.focus();
    InventoryApp.showStockStatusUpdate('Category name is required', 'warning');
    return false;
  }
  
  return true;
}

function setupCategoryPreview() {
  const nameField = document.getElementById('{{ form.name.id_for_label }}');
  const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
  
  [nameField, descriptionField].forEach(field => {
    if (field) {
      field.addEventListener('input', updatePreview);
    }
  });
}

function updatePreview() {
  const name = document.getElementById('{{ form.name.id_for_label }}').value || 'Category Name';
  const description = document.getElementById('{{ form.description.id_for_label }}').value || 'Category description';
  const color = document.getElementById('categoryColor').value || '#667eea';
  const icon = document.getElementById('categoryIcon').value || 'box-seam';
  
  document.getElementById('previewName').textContent = name;
  document.getElementById('previewDescription').textContent = description;
  
  const iconElement = document.querySelector('#previewIcon i');
  iconElement.className = `bi bi-${icon} fs-4`;
  iconElement.style.color = color;
}

function updateHierarchyDisplay() {
  const hierarchyDisplay = document.getElementById('hierarchyDisplay');
  if (!hierarchyDisplay) return;
  
  const parentSelect = document.getElementById('{{ form.parent.id_for_label }}');
  const categoryName = document.getElementById('{{ form.name.id_for_label }}').value || 'New Category';
  
  let html = '';
  
  // Show current hierarchy
  {% if form.instance.parent %}
    html += createHierarchyItem('Level 0', '{{ form.instance.parent.parent.name|default:"Root" }}');
    html += createHierarchyItem('Level 1', '{{ form.instance.parent.name }}');
    html += createHierarchyItem('Level 2', categoryName, true);
  {% elif request.GET.parent %}
    html += createHierarchyItem('Level 0', '{{ parent_category.name }}');
    html += createHierarchyItem('Level 1', categoryName, true);
  {% else %}
    html += createHierarchyItem('Level 0', categoryName, true);
  {% endif %}
  
  hierarchyDisplay.innerHTML = html;
}

function createHierarchyItem(level, name, isCurrent = false) {
  const currentClass = isCurrent ? ' style="border: 2px solid #28a745; background: #d4edda;"' : '';
  return `
    <div class="hierarchy-item"${currentClass}>
      <span class="hierarchy-level">${level}</span>
      <i class="bi bi-folder me-2"></i>
      <span>${name}</span>
      ${isCurrent ? '<span class="badge bg-success ms-auto">Current</span>' : ''}
    </div>
  `;
}

// Auto-save draft functionality
let autoSaveTimeout;
function autoSave() {
  clearTimeout(autoSaveTimeout);
  autoSaveTimeout = setTimeout(() => {
    // Save form data to localStorage as draft
    const formData = new FormData(document.getElementById('categoryForm'));
    const draft = {};
    
    for (let [key, value] of formData.entries()) {
      draft[key] = value;
    }
    
    localStorage.setItem('categoryFormDraft', JSON.stringify(draft));
    console.log('Draft saved');
  }, 2000);
}

// Listen for form changes to trigger auto-save
document.getElementById('categoryForm').addEventListener('input', autoSave);

// Load draft on page load
function loadDraft() {
  const draft = localStorage.getItem('categoryFormDraft');
  if (draft && !document.getElementById('{{ form.name.id_for_label }}').value) {
    try {
      const data = JSON.parse(draft);
      
      for (let [key, value] of Object.entries(data)) {
        const field = document.getElementsByName(key)[0];
        if (field && field.type !== 'hidden') {
          field.value = value;
        }
      }
      
      updatePreview();
      InventoryApp.showStockStatusUpdate('Draft loaded', 'info');
    } catch (e) {
      console.error('Error loading draft:', e);
    }
  }
}

// Clear draft on successful submission
document.getElementById('categoryForm').addEventListener('submit', function() {
  localStorage.removeItem('categoryFormDraft');
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 's':
        e.preventDefault();
        document.getElementById('categoryForm').submit();
        break;
      case 'Escape':
        window.location.href = '{% url "inventory:category_list" %}';
        break;
    }
  }
});

// Load draft if available
loadDraft();
</script>
{% endblock %}
