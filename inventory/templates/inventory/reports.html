{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Inventory Reports{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
        <li class="breadcrumb-item active">Reports</li>
      </ol>
    </nav>
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-graph-up text-primary me-2"></i>Inventory Reports & Analytics
    </h1>
    <p class="text-muted mb-0">Comprehensive business intelligence and reporting dashboard</p>
  </div>
  
  <div class="btn-group" role="group">
    <button class="btn btn-outline-primary" onclick="scheduleReports()">
      <i class="bi bi-calendar me-2"></i>Schedule Reports
    </button>
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-gear me-2"></i>Settings
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="#" onclick="exportAllReports()">
        <i class="bi bi-download me-2"></i>Export All Reports
      </a></li>
      <li><a class="dropdown-item" href="#" onclick="customReport()">
        <i class="bi bi-plus-circle me-2"></i>Create Custom Report
      </a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="{% url 'inventory:configuration' %}">
        <i class="bi bi-arrow-left me-2"></i>Back to Configuration
      </a></li>
    </ul>
  </div>
</div>

<!-- Quick Metrics Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-primary text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Total Inventory Value
            </div>
            <div class="h5 mb-0 font-weight-bold">${{ total_inventory_value|floatformat:0|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-cash-stack fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-success text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Active Products
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ active_products|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-box fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-warning text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Low Stock Items
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ low_stock_count|default:0 }}</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-exclamation-triangle fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card bg-info text-white shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
              Avg Inventory Turnover
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ avg_turnover|floatformat:1|default:0 }}x</div>
          </div>
          <div class="col-auto">
            <i class="bi bi-arrow-repeat fa-2x text-white-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Report Categories -->
<div class="row">
  <!-- Stock Analysis Reports -->
  <div class="col-lg-4 col-md-6 mb-4">
    <div class="card shadow h-100">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="bi bi-graph-up me-2"></i>Stock Analysis
        </h6>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">Analyze stock levels, movements, and valuation across your inventory.</p>
        <div class="list-group list-group-flush">
          <a href="{% url 'inventory:stock_valuation_report' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Stock Valuation Report</div>
              <small class="text-muted">Current inventory values by location</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
          <a href="{% url 'inventory:abc_analysis' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">ABC Analysis</div>
              <small class="text-muted">Categorize products by value contribution</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
          <a href="{% url 'inventory:movement_history' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Movement History</div>
              <small class="text-muted">Track stock movements over time</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
          <a href="{% url 'inventory:dead_stock_report' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Dead Stock Analysis</div>
              <small class="text-muted">Identify slow-moving inventory</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Reports -->
  <div class="col-lg-4 col-md-6 mb-4">
    <div class="card shadow h-100">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-success">
          <i class="bi bi-speedometer me-2"></i>Performance Analysis
        </h6>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">Monitor supplier, category, and brand performance metrics.</p>
        <div class="list-group list-group-flush">
          <a href="{% url 'inventory:supplier_performance' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Supplier Performance</div>
              <small class="text-muted">Lead times, quality, and costs</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
          <a href="{% url 'inventory:category_performance' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Category Performance</div>
              <small class="text-muted">Sales and profitability by category</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
          <a href="{% url 'inventory:brand_performance' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Brand Performance</div>
              <small class="text-muted">Brand analysis and trends</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
          <a href="{% url 'inventory:turnover_analysis' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Turnover Analysis</div>
              <small class="text-muted">Inventory rotation metrics</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Executive Reports -->
  <div class="col-lg-4 col-md-12 mb-4">
    <div class="card shadow h-100">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-info">
          <i class="bi bi-clipboard-data me-2"></i>Executive Summary
        </h6>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">High-level reports for management and strategic decisions.</p>
        <div class="list-group list-group-flush">
          <a href="{% url 'inventory:executive_summary' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Executive Summary</div>
              <small class="text-muted">Key metrics and KPI dashboard</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
          <a href="{% url 'inventory:stock_movements_report' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <div class="font-weight-bold">Stock Movements</div>
              <small class="text-muted">Detailed movement analysis</small>
            </div>
            <i class="bi bi-arrow-right text-muted"></i>
          </a>
        </div>
        
        <!-- Quick Chart Preview -->
        <div class="mt-4">
          <canvas id="quickTrendChart" width="100" height="60"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Reports Activity -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-secondary">
      <i class="bi bi-clock-history me-2"></i>Recent Report Activity
    </h6>
  </div>
  <div class="card-body">
    {% if recent_reports %}
    <div class="table-responsive">
      <table class="table table-sm table-hover">
        <thead class="table-light">
          <tr>
            <th>Report Name</th>
            <th>Generated By</th>
            <th>Date</th>
            <th>Export Format</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for report in recent_reports|slice:":10" %}
          <tr>
            <td>
              <div class="font-weight-bold">{{ report.name }}</div>
              <small class="text-muted">{{ report.description|truncatechars:50 }}</small>
            </td>
            <td>{{ report.generated_by.get_full_name|default:report.generated_by.username }}</td>
            <td>{{ report.created_at|date:"M d, Y H:i" }}</td>
            <td>
              <span class="badge bg-secondary">{{ report.format|upper }}</span>
            </td>
            <td class="text-center">
              <a href="{{ report.file_url }}" class="btn btn-outline-primary btn-sm" title="Download">
                <i class="bi bi-download"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-4">
      <i class="bi bi-file-earmark-text text-muted" style="font-size: 2rem;"></i>
      <p class="text-muted mt-2 mb-0">No recent reports generated</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Quick Actions -->
<div class="row">
  <div class="col-lg-6 mb-4">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-warning">
          <i class="bi bi-lightning me-2"></i>Quick Actions
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-6 mb-3">
            <button class="btn btn-outline-primary w-100" onclick="generateDailyReport()">
              <i class="bi bi-calendar-day me-2"></i>
              Daily Report
            </button>
          </div>
          <div class="col-6 mb-3">
            <button class="btn btn-outline-success w-100" onclick="generateWeeklyReport()">
              <i class="bi bi-calendar-week me-2"></i>
              Weekly Report
            </button>
          </div>
          <div class="col-6 mb-3">
            <button class="btn btn-outline-info w-100" onclick="generateMonthlyReport()">
              <i class="bi bi-calendar-month me-2"></i>
              Monthly Report
            </button>
          </div>
          <div class="col-6 mb-3">
            <button class="btn btn-outline-warning w-100" onclick="customDateRange()">
              <i class="bi bi-calendar-range me-2"></i>
              Custom Range
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6 mb-4">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>Alerts & Notifications
        </h6>
      </div>
      <div class="card-body">
        {% if alerts %}
        <div class="list-group list-group-flush">
          {% for alert in alerts|slice:":5" %}
          <div class="list-group-item d-flex justify-content-between align-items-center px-0">
            <div>
              <div class="font-weight-bold text-{{ alert.severity }}">{{ alert.title }}</div>
              <small class="text-muted">{{ alert.description }}</small>
            </div>
            <span class="badge bg-{{ alert.severity }} rounded-pill">{{ alert.count }}</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-3">
          <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
          <p class="text-muted mt-2 mb-0">No active alerts</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Scheduled Reports -->
<div class="card shadow">
  <div class="card-header py-3 d-flex justify-content-between align-items-center">
    <h6 class="m-0 font-weight-bold text-secondary">
      <i class="bi bi-calendar-check me-2"></i>Scheduled Reports
    </h6>
    <button class="btn btn-sm btn-primary" onclick="addScheduledReport()">
      <i class="bi bi-plus-circle me-2"></i>Add Schedule
    </button>
  </div>
  <div class="card-body">
    {% if scheduled_reports %}
    <div class="table-responsive">
      <table class="table table-sm">
        <thead class="table-light">
          <tr>
            <th>Report</th>
            <th>Frequency</th>
            <th>Recipients</th>
            <th>Next Run</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for schedule in scheduled_reports %}
          <tr>
            <td>{{ schedule.report_name }}</td>
            <td>{{ schedule.get_frequency_display }}</td>
            <td>{{ schedule.recipients|truncatechars:30 }}</td>
            <td>{{ schedule.next_run|date:"M d, Y H:i" }}</td>
            <td>
              <span class="badge bg-{{ schedule.is_active|yesno:'success,secondary' }}">
                {{ schedule.is_active|yesno:'Active,Inactive' }}
              </span>
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-secondary" onclick="editSchedule({{ schedule.pk }})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteSchedule({{ schedule.pk }})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-4">
      <i class="bi bi-calendar-x text-muted" style="font-size: 2rem;"></i>
      <p class="text-muted mt-2 mb-3">No scheduled reports configured</p>
      <button class="btn btn-primary" onclick="addScheduledReport()">
        <i class="bi bi-plus-circle me-2"></i>Schedule Your First Report
      </button>
    </div>
    {% endif %}
  </div>
</div>

<script>
// Quick trend chart
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('quickTrendChart').getContext('2d');
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
      datasets: [{
        label: 'Inventory Value',
        data: {{ inventory_trend_data|default:"[0, 0, 0, 0, 0, 0]"|safe }},
        borderColor: '#4e73df',
        backgroundColor: 'rgba(78, 115, 223, 0.1)',
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { display: false },
        y: { display: false }
      },
      elements: {
        point: { radius: 2 }
      }
    }
  });
});

// Action functions
function scheduleReports() {
  alert('Report scheduling functionality would be implemented here');
}

function exportAllReports() {
  if (confirm('Export all available reports? This may take several minutes.')) {
    window.location.href = '/inventory/reports/export-all/';
  }
}

function customReport() {
  alert('Custom report builder would be implemented here');
}

function generateDailyReport() {
  window.location.href = '/inventory/reports/generate/daily/';
}

function generateWeeklyReport() {
  window.location.href = '/inventory/reports/generate/weekly/';
}

function generateMonthlyReport() {
  window.location.href = '/inventory/reports/generate/monthly/';
}

function customDateRange() {
  const startDate = prompt('Enter start date (YYYY-MM-DD):');
  const endDate = prompt('Enter end date (YYYY-MM-DD):');
  
  if (startDate && endDate) {
    window.location.href = `/inventory/reports/generate/custom/?start=${startDate}&end=${endDate}`;
  }
}

function addScheduledReport() {
  alert('Schedule report form would be implemented here');
}

function editSchedule(scheduleId) {
  alert(`Edit schedule ${scheduleId} functionality would be implemented here`);
}

function deleteSchedule(scheduleId) {
  if (confirm('Delete this scheduled report?')) {
    // Implementation would go here
    alert(`Delete schedule ${scheduleId} functionality would be implemented here`);
  }
}
</script>
{% endblock %}