{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Notifications{% endblock %}

{% block extra_dashboard_head %}
<style>
  .notification-item {
    transition: all 0.3s ease;
    border-radius: 12px;
    border: none;
    margin-bottom: 1px;
  }
  .notification-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  .notification-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  .notification-icon:hover {
    transform: scale(1.1);
  }
  .notification-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    border: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .notification-stats:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  .priority-high {
    border-left: 4px solid #dc3545;
    background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
  }
  .priority-medium {
    border-left: 4px solid #ffc107;
    background: linear-gradient(135deg, #fffbf0 0%, #fef3cd 100%);
  }
  .priority-low {
    border-left: 4px solid #28a745;
    background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
  }
  .notification-type-quote {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  .notification-type-system {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  }
  .notification-type-crm {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
  }
  .notification-type-inventory {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
  }
  .stats-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 12px;
  }
  .stats-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  .btn {
    border-radius: 8px;
    transition: all 0.2s ease;
  }
  .btn:hover {
    transform: translateY(-1px);
  }
  .card {
    border-radius: 12px;
    border: none;
  }
  .badge {
    border-radius: 10px;
    font-size: 0.8em;
    padding: 4px 8px;
  }
  .list-group-item {
    border-radius: 8px !important;
    border: none !important;
    margin-bottom: 2px;
  }
</style>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
  <button class="btn btn-outline-primary" onclick="markAllAsRead()">
    <i class="bi bi-check-all me-1"></i>Mark All Read
  </button>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-funnel me-1"></i>Filter
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="?">
        <i class="bi bi-list me-2"></i>All Notifications
      </a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="?type=quote">
        <i class="bi bi-file-earmark-text me-2 text-primary"></i>Quote Notifications
      </a></li>
      <li><a class="dropdown-item" href="?type=crm">
        <i class="bi bi-people me-2 text-success"></i>CRM Notifications
      </a></li>
      <li><a class="dropdown-item" href="?type=system">
        <i class="bi bi-gear me-2 text-info"></i>System Notifications
      </a></li>
      <li><a class="dropdown-item" href="?type=inventory">
        <i class="bi bi-box-seam me-2 text-warning"></i>Inventory Notifications
      </a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="?status=unread">
        <i class="bi bi-circle me-2 text-danger"></i>Unread Only
      </a></li>
      <li><a class="dropdown-item" href="?priority=high">
        <i class="bi bi-exclamation-triangle me-2 text-danger"></i>High Priority
      </a></li>
    </ul>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-bell me-1"></i>Settings
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="{% url 'core:notification_settings' %}">
        <i class="bi bi-gear me-2"></i>Notification Preferences
      </a></li>
      <li><a class="dropdown-item" href="#" onclick="toggleNotifications()">
        <i class="bi bi-bell-slash me-2"></i>Pause Notifications
      </a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="{% url 'core:export_notifications' %}">
        <i class="bi bi-download me-2"></i>Export Notifications
      </a></li>
    </ul>
  </div>
</div>
{% endblock %}

{% block dashboard_content %}
<!-- Enhanced Notification Statistics -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card notification-stats h-100 text-white shadow-sm">
      <div class="card-body text-center">
        <i class="bi bi-bell fa-2x mb-3 opacity-75"></i>
        <h3 class="mb-1">{{ total_notifications|default:0 }}</h3>
        <p class="mb-0 text-white-75">Total Notifications</p>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stats-card h-100 border-danger shadow-sm">
      <div class="card-body text-center">
        <i class="bi bi-circle fa-2x text-danger mb-3"></i>
        <h3 class="text-danger mb-1">{{ unread_count|default:0 }}</h3>
        <p class="text-muted mb-0">Unread</p>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stats-card h-100 border-warning shadow-sm">
      <div class="card-body text-center">
        <i class="bi bi-exclamation-triangle fa-2x text-warning mb-3"></i>
        <h3 class="text-warning mb-1">{{ high_priority_count|default:0 }}</h3>
        <p class="text-muted mb-0">High Priority</p>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stats-card h-100 border-success shadow-sm">
      <div class="card-body text-center">
        <i class="bi bi-clock fa-2x text-success mb-3"></i>
        <h3 class="text-success mb-1">{{ today_count|default:0 }}</h3>
        <p class="text-muted mb-0">Today</p>
      </div>
    </div>
  </div>
</div>

<!-- Notification Type Breakdown -->
{% if type_stats %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h6 class="mb-0">
          <i class="bi bi-pie-chart me-2"></i>Notifications by Type
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          {% for stat in type_stats %}
          <div class="col-lg-2 col-md-4 col-6 mb-3">
            <div class="card notification-type-{{ stat.type }} text-white text-center shadow-sm h-100" style="transition: transform 0.2s ease;">
              <div class="card-body py-3" style="min-height: 80px; display: flex; flex-direction: column; justify-content: center;">
                <div class="fw-bold h4 mb-1">{{ stat.count }}</div>
                <small class="text-white-75">{{ stat.type|title }}</small>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Enhanced Notifications List -->
<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center bg-white">
    <h5 class="mb-0">
      <i class="bi bi-list me-2"></i>All Notifications
      {% if current_filter %}
      <span class="badge bg-primary ms-2">{{ current_filter|title }} Filter Active</span>
      {% endif %}
    </h5>
    <div class="d-flex align-items-center gap-2">
      <small class="text-muted">{{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}</small>
    </div>
  </div>
  <div class="card-body p-0">
    {% if page_obj %}
    <div class="list-group list-group-flush p-3">
      {% for notification in page_obj %}
      <div class="list-group-item notification-item 
           {% if not notification.is_read %}bg-light{% endif %}
           {% if notification.priority == 'high' %}priority-high
           {% elif notification.priority == 'medium' %}priority-medium
           {% elif notification.priority == 'low' %}priority-low{% endif %}"
           data-notification-id="{{ notification.id }}">
        <div class="d-flex align-items-start">
          <div class="flex-shrink-0 me-3">
            <!-- Enhanced notification icon based on type and priority -->
            <div class="notification-icon
                {% if notification.notification_type == 'quote' %}bg-primary text-white
                {% elif notification.notification_type == 'crm' %}bg-success text-white
                {% elif notification.notification_type == 'system' %}bg-info text-white
                {% elif notification.notification_type == 'inventory' %}bg-warning text-dark
                {% elif notification.notification_type == 'error' %}bg-danger text-white
                {% else %}bg-secondary text-white{% endif %} shadow-sm">
              {% if notification.notification_type == 'quote' %}
                <i class="bi bi-file-earmark-text"></i>
              {% elif notification.notification_type == 'crm' %}
                <i class="bi bi-people"></i>
              {% elif notification.notification_type == 'system' %}
                  <i class="bi bi-gear"></i>
              {% elif notification.notification_type == 'inventory' %}
                  <i class="bi bi-box-seam"></i>
              {% elif notification.notification_type == 'error' %}
                  <i class="bi bi-x-circle"></i>
              {% elif notification.notification_type == 'success' %}
                  <i class="bi bi-check-circle"></i>
              {% elif notification.notification_type == 'warning' %}
                  <i class="bi bi-exclamation-triangle"></i>
              {% else %}
                  <i class="bi bi-info-circle"></i>
              {% endif %}
            </div>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0 {% if not notification.is_read %}fw-bold{% endif %}">
                {{ notification.title }}
                {% if notification.priority == 'high' %}
                <span class="badge bg-danger ms-2">High Priority</span>
                {% elif notification.priority == 'medium' %}
                <span class="badge bg-warning text-dark ms-2">Medium</span>
                {% endif %}
              </h6>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                {% if not notification.is_read %}
                <span class="badge bg-primary">New</span>
                {% endif %}
              </div>
            </div>
            
            <p class="mb-3 text-muted">{{ notification.message }}</p>
            
            <!-- Enhanced metadata for different notification types -->
            {% if notification.notification_type == 'quote' and notification.related_quote %}
            <div class="mb-3">
              <small class="text-info d-flex align-items-center">
                <i class="bi bi-link-45deg me-1"></i>
                Related Quote: <a href="{% url 'quotes:quote_detail' notification.related_quote.id %}" class="text-decoration-none ms-1">
                  {{ notification.related_quote.quote_number }}
                </a>
                <span class="ms-2 text-muted">{{ notification.related_quote.client.name }}</span>
              </small>
            </div>
            {% elif notification.notification_type == 'crm' and notification.related_client %}
            <div class="mb-3">
              <small class="text-success d-flex align-items-center">
                <i class="bi bi-link-45deg me-1"></i>
                Related Client: <a href="{% url 'crm:client_detail' notification.related_client.id %}" class="text-decoration-none ms-1">
                  {{ notification.related_client.name }}
                </a>
              </small>
            </div>
            {% endif %}
            
            <!-- Action Button and Status -->
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span class="badge 
                    {% if notification.notification_type == 'quote' %}bg-primary
                    {% elif notification.notification_type == 'crm' %}bg-success
                    {% elif notification.notification_type == 'system' %}bg-info
                    {% elif notification.notification_type == 'inventory' %}bg-warning text-dark
                    {% elif notification.notification_type == 'error' %}bg-danger
                    {% elif notification.notification_type == 'success' %}bg-success
                    {% elif notification.notification_type == 'warning' %}bg-warning text-dark
                    {% else %}bg-secondary{% endif %}">
                    {{ notification.get_type_display }}
                </span>
                {% if notification.source %}
                <small class="text-muted ms-2">From: {{ notification.source }}</small>
                {% endif %}
              </div>
              <div class="d-flex gap-2">
                {% if notification.action_url and notification.action_text %}
                <a href="{{ notification.action_url }}" class="btn btn-sm btn-primary">
                  {{ notification.action_text }}
                </a>
                {% endif %}
                {% if not notification.is_read %}
                <button class="btn btn-sm btn-outline-secondary mark-read-btn" 
                        data-notification-id="{{ notification.id }}"
                        title="Mark as read">
                  <i class="bi bi-check"></i>
                </button>
                {% endif %}
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><button class="dropdown-item" onclick="viewNotificationDetails('{{ notification.id }}')">
                      <i class="bi bi-eye me-2"></i>View Details
                    </button></li>
                    {% if not notification.is_read %}
                    <li><button class="dropdown-item mark-read-btn" data-notification-id="{{ notification.id }}">
                      <i class="bi bi-check me-2"></i>Mark as Read
                    </button></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item text-danger" onclick="archiveNotification('{{ notification.id }}')">
                      <i class="bi bi-archive me-2"></i>Archive
                    </button></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Enhanced Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="card-footer bg-white">
      <nav aria-label="Notifications pagination">
        <ul class="pagination justify-content-center mb-0">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
              &laquo; First
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
              Previous
            </a>
          </li>
          {% endif %}
          
          {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
              {{ num }}
            </a>
          </li>
          {% endif %}
          {% endfor %}
          
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
              Next
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
              Last &raquo;
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
    {% else %}
    <div class="text-center py-5">
      <i class="bi bi-bell-slash fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">No notifications found</h4>
      <p class="text-muted">
        {% if current_filter %}
        No notifications match your current filter. 
        <a href="{% url 'core:notifications' %}" class="text-decoration-none">View all notifications</a>
        {% else %}
        You're all caught up! We'll notify you when something important happens.
        {% endif %}
      </p>
      {% if not current_filter %}
      <div class="mt-4">
        <a href="{% url 'core:dashboard' %}" class="btn btn-primary">
          <i class="bi bi-house me-1"></i>Back to Dashboard
        </a>
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Notification Details Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="notificationModalBody">
        <!-- Content loaded dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="notificationActionBtn" style="display: none;">
          <!-- Action button loaded dynamically -->
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_dashboard_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle individual notification mark as read
  document.querySelectorAll('.mark-read-btn').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const notificationId = this.getAttribute('data-notification-id');
      markNotificationAsRead(notificationId, this);
    });
  });
  
  // Auto-mark notifications as read when action buttons are clicked
  document.querySelectorAll('.notification-item a[href]').forEach(link => {
    link.addEventListener('click', function() {
      const notificationItem = this.closest('.notification-item');
      const notificationId = notificationItem.getAttribute('data-notification-id');
      if (notificationItem.classList.contains('bg-light')) {
        markNotificationAsRead(notificationId);
      }
    });
  });
  
  // Add hover effects to notification type cards
  document.querySelectorAll('.notification-type-quote, .notification-type-system, .notification-type-crm, .notification-type-inventory').forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-3px)';
    });
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
});

function markNotificationAsRead(notificationId, buttonElement = null) {
  fetch(`{% url "core:mark_notification_read" 0 %}`.replace('0', notificationId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
      if (notificationItem) {
        notificationItem.classList.remove('bg-light');
        const newBadge = notificationItem.querySelector('.badge.bg-primary');
        if (newBadge && newBadge.textContent === 'New') {
          newBadge.remove();
        }
        if (buttonElement) {
          buttonElement.remove();
        } else {
          const markReadBtn = notificationItem.querySelector('.mark-read-btn');
          if (markReadBtn) {
            markReadBtn.remove();
          }
        }
        updateNotificationCounts();
      }
    }
  })
  .catch(error => console.error('Error marking notification as read:', error));
}

function markAllAsRead() {
  if (confirm('Mark all notifications as read?')) {
    fetch('{% url "core:mark_all_notifications_read" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error marking notifications as read: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error marking all notifications as read:', error);
      alert('An error occurred. Please try again.');
    });
  }
}

function viewNotificationDetails(notificationId) {
  fetch(`{% url "core:get_notification_details" 0 %}`.replace('0', notificationId))
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('notificationModalTitle').textContent = data.notification.title;
        document.getElementById('notificationModalBody').innerHTML = `
          <div class="mb-3">
            <span class="badge bg-${data.notification.notification_type === 'quote' ? 'primary' : 
                                  data.notification.notification_type === 'crm' ? 'success' : 
                                  data.notification.notification_type === 'system' ? 'info' : 'secondary'}">
              ${data.notification.notification_type.charAt(0).toUpperCase() + data.notification.notification_type.slice(1)}
            </span>
            <small class="text-muted ms-2">${data.notification.created_at}</small>
            ${data.notification.priority === 'high' ? '<span class="badge bg-danger ms-2">High Priority</span>' : ''}
          </div>
          <div class="mb-3">
            <p>${data.notification.message}</p>
          </div>
          ${data.notification.details ? `<div class="mb-3"><h6>Details:</h6><div class="bg-light p-3 rounded">${data.notification.details}</div></div>` : ''}
          ${data.notification.related_object ? `<div class="mb-3"><h6>Related:</h6><p class="text-info">${data.notification.related_object}</p></div>` : ''}
        `;
        
        const actionBtn = document.getElementById('notificationActionBtn');
        if (data.notification.action_url && data.notification.action_text) {
          actionBtn.style.display = 'inline-block';
          actionBtn.textContent = data.notification.action_text;
          actionBtn.onclick = () => window.location.href = data.notification.action_url;
        } else {
          actionBtn.style.display = 'none';
        }
        
        const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
        modal.show();
      }
    })
    .catch(error => console.error('Error loading notification details:', error));
}

function archiveNotification(notificationId) {
  if (confirm('Archive this notification? It will be moved to your archived notifications.')) {
    fetch(`{% url "core:archive_notification" 0 %}`.replace('0', notificationId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (notificationItem) {
          notificationItem.style.transition = 'opacity 0.3s ease';
          notificationItem.style.opacity = '0';
          setTimeout(() => {
            notificationItem.remove();
          }, 300);
        }
      } else {
        alert('Error archiving notification: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error archiving notification:', error);
      alert('An error occurred. Please try again.');
    });
  }
}

function toggleNotifications() {
  alert('Notification preferences can be managed in Settings');
}

function updateNotificationCounts() {
  // Update the header notification counts
  const unreadCountElements = document.querySelectorAll('.notification-stats h3');
  if (unreadCountElements.length > 1) {
    const currentUnread = parseInt(unreadCountElements[1].textContent) - 1;
    unreadCountElements[1].textContent = Math.max(0, currentUnread);
  }
}
</script>
{% endblock %}