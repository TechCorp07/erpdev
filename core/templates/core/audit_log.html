{% extends "dashboard_base.html" %}
{% block page_title %}Audit Log{% endblock %}
{% block dashboard_content %}
<h3>Audit Log</h3>
<form class="row row-cols-auto g-2 mb-3" method="get">
    <input type="text" name="q" value="{{ current_filter.q }}" placeholder="Search" class="form-control me-2"/>
    <select name="action" class="form-select me-2">
        <option value="">Any Action</option>
        {% for val, label in actions %}
        <option value="{{ val }}" {% if val == current_filter.action %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
    <select name="object_type" class="form-select me-2">
        <option value="">Any Object</option>
        {% for ot in object_types %}
        <option value="{{ ot }}" {% if ot == current_filter.object_type %}selected{% endif %}>{{ ot }}</option>
        {% endfor %}
    </select>
    <select name="user" class="form-select me-2">
        <option value="">Any User</option>
        {% for u in users %}
        <option value="{{ u.user__id }}" {% if u.user__id|stringformat:"s" == current_filter.user_id %}selected{% endif %}>{{ u.user__username }}</option>
        {% endfor %}
    </select>
    <input type="date" name="from" value="{{ current_filter.from }}" class="form-control me-2"/>
    <input type="date" name="to" value="{{ current_filter.to }}" class="form-control me-2"/>
    <button type="submit" class="btn btn-primary">Filter</button>
    <a href="?export=csv" class="btn btn-secondary ms-2">Export CSV</a>
</form>
<div class="table-responsive">
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th>Date/Time</th>
        <th>User</th>
        <th>Action</th>
        <th>Object Type</th>
        <th>Object ID</th>
        <th>Description</th>
        <th>IP</th>
        <th>User Agent</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td>{{ log.timestamp|date:"Y-m-d H:i:s" }}</td>
        <td>{% if log.user %}{{ log.user.username }}{% else %}Anonymous{% endif %}</td>
        <td>{{ log.get_action_display }}</td>
        <td>{{ log.object_type }}</td>
        <td>{{ log.object_id }}</td>
        <td>{{ log.description }}</td>
        <td>{{ log.ip_address }}</td>
        <td title="{{ log.user_agent }}">{{ log.user_agent|truncatechars:32 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-center text-muted">No logs found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<nav>
  <ul class="pagination">
    {% if logs.has_previous %}
      <li class="page-item"><a class="page-link" href="?{% if current_filter %}{{ current_filter|urlencode }}&{% endif %}page={{ logs.previous_page_number }}">Previous</a></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Page {{ logs.number }} of {{ logs.paginator.num_pages }}</span></li>
    {% if logs.has_next %}
      <li class="page-item"><a class="page-link" href="?{% if current_filter %}{{ current_filter|urlencode }}&{% endif %}page={{ logs.next_page_number }}">Next</a></li>
    {% endif %}
  </ul>
</nav>
{% endblock %}
