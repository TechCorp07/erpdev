{% extends "universal_base.html" %}
{% load static %}

{% block extra_head %}
<!-- Dashboard specific CSS -->
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
  .nav-link.active {
    background-color: rgba(255, 255, 255, 0.1) !important;
    border-radius: 6px;
  }
  .quote-badge {
    font-size: 0.75em;
    position: relative;
    top: -2px;
  }
  .sidebar {
    background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
    height: 100vh;
    max-height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    transition: all 0.3s ease;
    overflow-y: auto;
    overflow-x: hidden;
    width: 250px;
  }
  .sidebar.collapsed {
    margin-left: -250px;
  }
  
  /* Custom scrollbar for sidebar */
  .sidebar::-webkit-scrollbar {
    width: 6px;
  }
  .sidebar::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
  }
  .sidebar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
  }
  .sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }
  
  .nav-link {
    color: rgba(255, 255, 255, 0.8) !important;
    transition: all 0.3s ease;
    margin-bottom: 1px;
    border-radius: 6px;
    padding: 6px 16px;
    font-size: 0.9rem;
  }
  .nav-link:hover {
    color: white !important;
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
  }
  .nav-link i {
    width: 18px;
    text-align: center;
    font-size: 0.85rem;
  }
  .submenu {
    background-color: rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    margin-top: 2px;
    padding: 2px 0;
  }
  .submenu .nav-link {
    padding: 4px 12px 4px 36px;
    font-size: 0.8rem;
    margin-bottom: 1px;
  }
  .main-content {
    margin-left: 250px;
    transition: all 0.3s ease;
    min-height: 100vh;
  }
  .main-content.expanded {
    margin-left: 0;
  }
  .sidebar-toggle {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 1001;
    background: rgba(44, 62, 80, 0.9);
    border: none;
    color: white;
    border-radius: 4px;
    padding: 8px 12px;
    transition: all 0.3s ease;
  }
  .sidebar-toggle:hover {
    background: rgba(44, 62, 80, 1);
    color: white;
  }
  .user-profile-section {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    margin: 12px 12px 8px 12px;
    padding: 10px;
  }
  .quick-stats {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    margin: 12px 12px 8px 12px;
    padding: 10px;
  }
  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-size: 0.85rem;
  }
  .stat-item:last-child {
    margin-bottom: 0;
  }
  
  /* Brand section optimization */
  .sidebar-brand {
    text-align: center;
    padding: 1rem 1rem 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 0.5rem;
  }
  .sidebar-brand img {
    max-width: 140px;
    height: auto;
  }
  .sidebar-brand h5 {
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
  }
  .sidebar-brand small {
    font-size: 0.8rem;
  }
  
  /* Navigation section */
  .sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: 0 12px;
  }
  
  /* Sidebar container optimization */
  .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  
  /* Bottom section styling */
  .sidebar-bottom {
    margin-top: auto;
    padding-bottom: 8px;
  }
  
  .notification-indicator {
    animation: pulse 2s infinite;
  }
  .header-user-dropdown {
    min-width: 250px;
  }
  .header-user-dropdown .dropdown-header {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  @media (max-width: 768px) {
    .sidebar {
      margin-left: -250px;
    }
    .sidebar.show {
      margin-left: 0;
    }
    .main-content {
      margin-left: 0;
    }
    .sidebar-toggle {
      display: block;
    }
    .sidebar-brand h5 {
      font-size: 1rem;
    }
    .sidebar-brand img {
      max-width: 120px;
    }
  }
  
  /* Height-specific optimizations */
  @media (max-height: 700px) {
    .sidebar-brand {
      padding: 0.75rem 1rem 0.5rem;
    }
    .sidebar-brand h5 {
      font-size: 1rem;
      margin-bottom: 0.125rem;
    }
    .sidebar-brand small {
      font-size: 0.75rem;
    }
    .nav-link {
      padding: 5px 16px;
      font-size: 0.85rem;
    }
    .submenu .nav-link {
      padding: 3px 12px 3px 32px;
      font-size: 0.75rem;
    }
    .quick-stats, .user-profile-section {
      margin: 8px 12px 6px 12px;
      padding: 8px;
    }
    .stat-item {
      margin-bottom: 4px;
      font-size: 0.8rem;
    }
  }
  
  /* Very small height screens */
  @media (max-height: 600px) {
    .sidebar-brand {
      padding: 0.5rem 1rem 0.25rem;
    }
    .sidebar-brand h5 {
      font-size: 0.9rem;
      margin-bottom: 0;
    }
    .sidebar-brand small {
      font-size: 0.7rem;
    }
    .nav-link {
      padding: 4px 16px;
      font-size: 0.8rem;
    }
    .nav-link i {
      font-size: 0.75rem;
    }
    .quick-stats {
      display: none; /* Hide stats on very small screens */
    }
  }
  
  @media (min-width: 769px) {
    .sidebar-toggle {
      display: none;
    }
  }
  /* Sidebar dividers and section titles */
.sidebar-divider {
  border-color: rgba(255, 255, 255, 0.2);
  margin: 0.5rem 0;
}

.nav-section-title {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 0 16px;
  display: block;
  margin-bottom: 0.5rem;
}

/* Permission level badges */
.nav-link .badge {
  font-size: 0.6rem;
  padding: 0.2em 0.5em;
}

/* External link indicator */
.nav-link .bi-box-arrow-up-right {
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

.nav-link:hover .bi-box-arrow-up-right {
  opacity: 1;
}

/* Better spacing for management/admin sections */
.nav-item.mt-3 {
  margin-top: 1rem !important;
}

/* Improved dropdown in sidebar */
.user-profile-section .dropdown-menu {
  transform: translateY(-10px);
}

/* Make the sidebar more compact on smaller heights */
@media (max-height: 700px) {
  .nav-section-title {
    font-size: 0.7rem;
    margin-bottom: 0.25rem;
  }
  
  .sidebar-divider {
    margin: 0.25rem 0;
  }
  
  .nav-item.mt-3 {
    margin-top: 0.5rem !important;
  }
}

/* Hide quick stats on very small screens to save space */
@media (max-height: 600px) {
  .quick-stats {
    display: none;
  }
}
</style>
{% block extra_dashboard_head %}{% endblock %}
{% endblock %}

{% block body_class %}bg-light{% endblock %}

{% block content %}
<!-- Mobile/Desktop Sidebar Toggle -->
<button class="sidebar-toggle d-lg-none" type="button" onclick="toggleSidebar()">
  <i class="bi bi-list"></i>
</button>

<div class="container-fluid p-0">
  <div class="d-flex">
    <!-- Enhanced Unified Sidebar -->
    <nav id="sidebar" class="sidebar">
      <div class="sidebar-container">
        <!-- Brand Section -->
        <div class="sidebar-brand">
          <img src="{% static 'core/img/blitz-logo.png' %}" alt="BlitzHub Logo" class="mb-2">
          <h5 class="text-white mb-1">BlitzHub</h5>
          <small class="text-white-50">{{ user.first_name|default:user.username }}</small>
        </div>
        
        <!-- Main Navigation -->
        <div class="sidebar-nav">
          <ul class="nav flex-column">
            <!-- Dashboard -->
            <li class="nav-item">
              <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'core:dashboard' %}">
                <i class="bi bi-speedometer2 me-2"></i>
                Dashboard
              </a>
            </li>
            
            <!-- CRM Section - FIXED PERMISSION CHECK -->
            {% if app_permissions.crm or is_admin %}
            <li class="nav-item">
              <a class="nav-link {% if 'crm:' in request.resolver_match.namespace %}active{% endif %}" href="{% url 'crm:dashboard' %}">
                <i class="bi bi-people me-2"></i>
                CRM
                {% if app_permissions.crm == 'admin' %}
                <span class="badge bg-success rounded-pill ms-auto">Admin</span>
                {% elif app_permissions.crm == 'edit' %}
                <span class="badge bg-primary rounded-pill ms-auto">Edit</span>
                {% elif app_permissions.crm == 'view' %}
                <span class="badge bg-secondary rounded-pill ms-auto">View</span>
                {% endif %}
              </a>
            </li>
            {% endif %}
            
            <!-- Quote System - FIXED PERMISSION CHECK -->
            {% if app_permissions.quotes or is_admin %}
            <li class="nav-item">
              <a class="nav-link {% if 'quotes:' in request.resolver_match.namespace %}active{% endif %}" href="{% url 'quotes:dashboard' %}">
                <i class="bi bi-file-earmark-text me-2"></i>
                Quotes
                {% if pending_quotes_count %}
                <span class="badge bg-warning rounded-pill ms-auto quote-badge notification-indicator">{{ pending_quotes_count }}</span>
                {% endif %}
              </a>
              
              <!-- Enhanced Quote Submenu - Only show if user has quote access -->
              {% if 'quotes:' in request.resolver_match.namespace %}
              <ul class="nav flex-column submenu">
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'quotes:quote_list' %}">
                    <i class="bi bi-list me-2"></i>All Quotes
                  </a>
                </li>
                {% if app_permissions.quotes == 'edit' or app_permissions.quotes == 'admin' or is_admin %}
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'quotes:quote_create' %}">
                    <i class="bi bi-plus-circle me-2"></i>New Quote
                  </a>
                </li>
                {% endif %}
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'quotes:analytics' %}">
                    <i class="bi bi-graph-up me-2"></i>Analytics
                  </a>
                </li>
                {% if app_permissions.quotes == 'admin' or is_admin %}
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'quotes:settings' %}">
                    <i class="bi bi-gear me-2"></i>Quote Settings
                  </a>
                </li>
                {% endif %}
              </ul>
              {% endif %}
            </li>
            {% endif %}
            
            <!-- Inventory Section - FIXED PERMISSION CHECK -->
            {% if app_permissions.inventory or is_admin %}
            <li class="nav-item">
              <a class="nav-link {% if 'inventory:' in request.resolver_match.namespace %}active{% endif %}" href="{% url 'inventory:dashboard' %}">
                <i class="bi bi-boxes me-2"></i>
                Inventory
              </a>
            </li>
            {% endif %}
            
            <!-- Reports Section - FIXED PERMISSION CHECK -->
            {% if app_permissions.reports or is_admin %}
            <li class="nav-item">
              <a class="nav-link {% if 'reports:' in request.resolver_match.namespace %}active{% endif %}" href="{% url 'reports:dashboard' %}">
                <i class="bi bi-graph-up me-2"></i>
                Reports
              </a>
            </li>
            {% endif %}
            
            <!-- Financial Section - FIXED PERMISSION CHECK -->
            {% if app_permissions.financial or is_admin %}
            <li class="nav-item">
              <a class="nav-link {% if 'financial:' in request.resolver_match.namespace %}active{% endif %}" href="{% url 'financial:dashboard' %}">
                <i class="bi bi-currency-dollar me-2"></i>
                Financial
              </a>
            </li>
            {% endif %}
            
            <!-- Divider for Management Section -->
            {% if is_manager or is_admin %}
            <li class="nav-item mt-3">
              <hr class="sidebar-divider">
              <span class="nav-section-title">Management</span>
            </li>
            
            <!-- Employee Management -->
            <li class="nav-item">
              <a class="nav-link" href="{% url 'core:employee_list' %}">
                <i class="bi bi-people-fill me-2"></i>
                Employees
              </a>
            </li>
            
            <!-- User Management -->
            <li class="nav-item">
              <a class="nav-link" href="{% url 'core:user_management' %}">
                <i class="bi bi-person-gear me-2"></i>
                User Management
              </a>
            </li>
            {% endif %}
            
            <!-- Admin Section -->
            {% if is_admin %}
            <li class="nav-item mt-3">
              <hr class="sidebar-divider">
              <span class="nav-section-title">Administration</span>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="{% url 'core:system_settings' %}">
                <i class="bi bi-gear-fill me-2"></i>
                System Settings
              </a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="{% url 'core:audit_logs' %}">
                <i class="bi bi-clipboard-data me-2"></i>
                Audit Logs
              </a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="{% url 'admin:index' %}" target="_blank">
                <i class="bi bi-shield-lock me-2"></i>
                Django Admin
                <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.75em;"></i>
              </a>
            </li>
            {% endif %}
          </ul>
        </div>
        
        <!-- Quick Stats Section (Only for users with relevant permissions) -->
        {% if app_permissions.quotes or app_permissions.crm %}
        <div class="quick-stats">
          <h6 class="text-white-50 mb-2">
            <i class="bi bi-speedometer2 me-2"></i>Quick Stats
          </h6>
          
          {% if app_permissions.quotes %}
          <div class="stat-item">
            <span class="text-white-50">Active Quotes:</span>
            <span class="text-white" data-stat="active-quotes">{{ quote_stats.active_quotes|default:0 }}</span>
          </div>
          <div class="stat-item">
            <span class="text-white-50">Month Value:</span>
            <span class="text-white" data-stat="month-value">${{ quote_stats.month_value|default:0|floatformat:0 }}</span>
          </div>
          <div class="stat-item">
            <span class="text-white-50">Conversion:</span>
            <span class="text-white" data-stat="conversion-rate">{{ quote_stats.conversion_rate|default:0 }}%</span>
          </div>
          {% endif %}
          
          {% if app_permissions.crm %}
          <div class="stat-item">
            <span class="text-white-50">Total Customers:</span>
            <span class="text-white">{{ crm_stats.total_customers|default:0 }}</span>
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        <!-- Bottom Section -->
        <div class="sidebar-bottom">
          <!-- User Profile Section -->
          <div class="user-profile-section">
            <div class="d-flex align-items-center">
              {% if user.profile.profile_image %}
              <img src="{{ user.profile.profile_image.url }}" alt="{{ user.username }}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
              {% else %}
              <div class="rounded-circle bg-secondary me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                <span class="text-white small">{{ user.first_name|first|default:user.username|first }}</span>
              </div>
              {% endif %}
              <div class="flex-grow-1">
                <div class="text-white small">{{ user.get_full_name|default:user.username }}</div>
                <div class="text-white-50" style="font-size: 0.75rem;">{{ user.profile.get_user_type_display }}</div>
              </div>
              
              <!-- User dropdown in sidebar -->
              <div class="dropdown">
                <button class="btn btn-link text-white-50 p-1" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUser1">
                  <li><a class="dropdown-item" href="{% url 'core:profile' %}">
                    <i class="bi bi-person me-2"></i>Profile
                  </a></li>
                  <li><a class="dropdown-item" href="{% url 'core:notifications' %}">
                    <i class="bi bi-bell me-2"></i>Notifications
                    {% if unread_notification_count > 0 %}
                    <span class="badge bg-danger ms-1">{{ unread_notification_count }}</span>
                    {% endif %}
                  </a></li>
                  <li><a class="dropdown-item" href="{% url 'core:password_change' %}">
                    <i class="bi bi-shield-lock me-2"></i>Change Password
                  </a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{% url 'website:home' %}">
                    <i class="bi bi-house me-2"></i>Visit Website
                  </a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{% url 'core:logout' %}">
                    <i class="bi bi-box-arrow-right me-2"></i>Sign out
                  </a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    
    <!-- Main Content Area -->
    <main class="main-content">
      <div class="container-fluid px-4">
        <!-- Enhanced Header with Breadcrumbs and User Dropdown -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <div>
            <h1 class="h2 mb-1">{% block page_title %}Dashboard{% endblock %}</h1>
            {% if breadcrumbs %}
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                {% for crumb in breadcrumbs %}
                <li class="breadcrumb-item {% if forloop.last %}active{% endif %}">
                  {% if crumb.url and not forloop.last %}
                  <a href="{{ crumb.url }}">{{ crumb.title }}</a>
                  {% else %}
                  {{ crumb.title }}
                  {% endif %}
                </li>
                {% endfor %}
              </ol>
            </nav>
            {% endif %}
          </div>
          
          <!-- Header Actions and User Dropdown -->
          <div class="d-flex align-items-center gap-3 mb-2 mb-md-0">
            <!-- Page Actions -->
            <div class="btn-toolbar">
            </div>
            
            <!-- Header User Dropdown -->
            <div class="dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="headerUserDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                {% if user.profile.profile_image %}
                  <img src="{{ user.profile.profile_image.url }}" alt="{{ user.username }}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                {% else %}
                  <div class="rounded-circle bg-secondary me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <span class="text-white small">{{ user.first_name|first|default:user.username|first }}</span>
                  </div>
                {% endif %}
                <span class="d-none d-sm-inline">{{ user.first_name|default:user.username }}</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end shadow header-user-dropdown" aria-labelledby="headerUserDropdown">
                <li>
                  <h6 class="dropdown-header">
                    {{ user.get_full_name|default:user.username }}
                    {% if user.profile %}
                      <small class="d-block text-muted">{{ user.profile.get_user_type_display }}</small>
                    {% endif %}
                  </h6>
                </li>
                <li><hr class="dropdown-divider"></li>
                
                <!-- Dashboard Access -->
                {% if user.profile.user_type != 'customer' %}
                <li>
                  <a class="dropdown-item" href="{% url 'core:dashboard' %}">
                    <i class="bi bi-speedometer2 me-2"></i> Go to Dashboard
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                {% endif %}
                
                <!-- Profile Management -->
                <li>
                  <a class="dropdown-item" href="{% url 'core:profile' %}">
                    <i class="bi bi-person me-2"></i> My Profile
                  </a>
                </li>
                
                <!-- Notifications -->
                <li>
                  <a class="dropdown-item" href="{% url 'core:notifications' %}">
                    <i class="bi bi-bell me-2"></i> Notifications
                    {% if unread_notification_count > 0 %}
                    <span class="badge bg-danger ms-1">{{ unread_notification_count }}</span>
                    {% endif %}
                  </a>
                </li>
                
                <!-- Settings -->
                <li>
                  <a class="dropdown-item" href="{% url 'core:password_change' %}">
                    <i class="bi bi-gear me-2"></i> Settings
                  </a>
                </li>
                
                <li><hr class="dropdown-divider"></li>
                
                <!-- Logout -->
                <li>
                  <a class="dropdown-item text-danger" href="{% url 'core:logout' %}">
                    <i class="bi bi-box-arrow-right me-2"></i> Logout
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Notifications with Context -->
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {% if message.tags == 'quote_success' %}
              <i class="bi bi-check-circle me-2"></i>
              {% elif message.tags == 'quote_warning' %}
              <i class="bi bi-exclamation-triangle me-2"></i>
              {% elif message.tags == 'quote_error' %}
              <i class="bi bi-x-circle me-2"></i>
              {% elif message.tags == 'success' %}
              <i class="bi bi-check-circle me-2"></i>
              {% elif message.tags == 'warning' %}
              <i class="bi bi-exclamation-triangle me-2"></i>
              {% elif message.tags == 'error' %}
              <i class="bi bi-x-circle me-2"></i>
              {% endif %}
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
        
        <!-- Main Dashboard Content Area -->
        {% block dashboard_content %}
        <!-- Content goes here -->
        {% endblock %}
      </div>
    </main>
  </div>
</div>

<!-- Enhanced Reports Menu Modal -->
{% if is_manager or is_admin %}
<div class="modal fade" id="reportsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-graph-up me-2"></i>Reports & Analytics
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          {% if app_permissions.quotes %}
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-file-earmark-text me-2 text-primary"></i>Quote Reports
                </h6>
                <div class="list-group list-group-flush">
                  <a href="{% url 'quotes:quote_analytics' %}" class="list-group-item list-group-item-action border-0">
                    <i class="bi bi-graph-up me-2"></i>Quote Analytics
                    <small class="text-muted d-block">Performance metrics and trends</small>
                  </a>
                  <a href="{% url 'quotes:sales_report' %}" class="list-group-item list-group-item-action border-0">
                    <i class="bi bi-currency-dollar me-2"></i>Sales Report
                    <small class="text-muted d-block">Revenue and conversion analysis</small>
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          {% if app_permissions.crm %}
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-people me-2 text-success"></i>CRM Reports
                </h6>
                <div class="list-group list-group-flush">
                  <a href="{% url 'crm:analytics' %}" class="list-group-item list-group-item-action border-0">
                    <i class="bi bi-people me-2"></i>CRM Analytics
                    <small class="text-muted d-block">Customer insights and pipeline</small>
                  </a>
                  <a href="{% url 'crm:performance_report' %}" class="list-group-item list-group-item-action border-0">
                    <i class="bi bi-trophy me-2"></i>Team Performance
                    <small class="text-muted d-block">Sales team performance metrics</small>
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          {% if app_permissions.inventory %}
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-box-seam me-2 text-warning"></i>Inventory Reports
                </h6>
                <div class="list-group list-group-flush">
                  <a href="{% url 'inventory:reports_dashboard' %}" class="list-group-item list-group-item-action border-0">
                    <i class="bi bi-box-seam me-2"></i>Inventory Reports
                    <small class="text-muted d-block">Stock levels and movements</small>
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-gear me-2 text-info"></i>System Reports
                </h6>
                <div class="list-group list-group-flush">
                  <a href="{% url 'core:system_reports' %}" class="list-group-item list-group-item-action border-0">
                    <i class="bi bi-gear me-2"></i>System Reports
                    <small class="text-muted d-block">User activity and performance</small>
                  </a>
                  <a href="{% url 'core:audit_log' %}" class="list-group-item list-group-item-action border-0">
                    <i class="bi bi-shield-check me-2"></i>Audit Log
                    <small class="text-muted d-block">System security and access logs</small>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Overlay for mobile -->
<div class="sidebar-overlay d-lg-none" onclick="toggleSidebar()" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>
{% endblock %}

{% block extra_js %}
<!-- Enhanced Dashboard JavaScript -->
<script src="{% static 'core/js/dashboard.js' %}"></script>

<script>
// Enhanced dashboard functionality
document.addEventListener('DOMContentLoaded', function() {
  // Initialize sidebar with responsive behavior
  initializeSidebar();
  
  // Restore previous sidebar state
  restoreSidebarState();
  
  // Auto-refresh notification counts
  setInterval(updateNotificationCounts, 300000); // Every 5 minutes
  
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Initialize collapsible submenus
  initializeSubmenus();
  
  // Handle window focus/blur for better performance
  let isWindowFocused = true;
  
  window.addEventListener('focus', function() {
    isWindowFocused = true;
    updateNotificationCounts(); // Refresh when window gains focus
  });
  
  window.addEventListener('blur', function() {
    isWindowFocused = false;
  });
  
  // Optimize sidebar scroll behavior
  const sidebarNav = document.querySelector('.sidebar-nav');
  if (sidebarNav) {
    // Smooth scrolling
    sidebarNav.style.scrollBehavior = 'smooth';
    
    // Remember scroll position
    const savedScrollPosition = sessionStorage.getItem('sidebar-scroll');
    if (savedScrollPosition) {
      sidebarNav.scrollTop = parseInt(savedScrollPosition);
    }
    
    // Save scroll position
    sidebarNav.addEventListener('scroll', function() {
      sessionStorage.setItem('sidebar-scroll', this.scrollTop);
    });
  }
});

function initializeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.querySelector('.main-content');
  
  // Handle responsive behavior
  function handleResize() {
    if (window.innerWidth < 769) {
      sidebar.classList.add('collapsed');
      mainContent.classList.add('expanded');
    } else {
      sidebar.classList.remove('collapsed');
      mainContent.classList.remove('expanded');
    }
    
    // Handle very small height screens
    if (window.innerHeight < 600) {
      sidebar.classList.add('compact');
    } else {
      sidebar.classList.remove('compact');
    }
    
    // Optimize sidebar content for screen height
    optimizeSidebarForHeight();
  }
  
  function optimizeSidebarForHeight() {
    const sidebarHeight = window.innerHeight;
    const brandHeight = document.querySelector('.sidebar-brand')?.offsetHeight || 0;
    const bottomHeight = document.querySelector('.sidebar-bottom')?.offsetHeight || 0;
    const availableHeight = sidebarHeight - brandHeight - bottomHeight - 40; // 40px buffer
    
    const navContainer = document.querySelector('.sidebar-nav');
    if (navContainer) {
      navContainer.style.maxHeight = `${availableHeight}px`;
      navContainer.style.overflowY = 'auto';
    }
  }
  
  window.addEventListener('resize', handleResize);
  window.addEventListener('orientationchange', () => {
    setTimeout(handleResize, 100); // Delay for orientation change
  });
  
  handleResize(); // Initial call
  
  // Smooth scrolling for sidebar navigation
  const navLinks = sidebar.querySelectorAll('.nav-link');
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      // Remove active class from all links
      navLinks.forEach(l => l.classList.remove('active'));
      // Add active class to clicked link
      this.classList.add('active');
    });
  });
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.querySelector('.main-content');
  const overlay = document.querySelector('.sidebar-overlay');
  
  if (window.innerWidth < 769) {
    // Mobile behavior
    sidebar.classList.toggle('show');
    if (overlay) {
      overlay.style.display = sidebar.classList.contains('show') ? 'block' : 'none';
    }
  } else {
    // Desktop behavior
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
    
    // Save preference in localStorage
    const isCollapsed = sidebar.classList.contains('collapsed');
    localStorage.setItem('sidebar-collapsed', isCollapsed);
  }
}

// Restore sidebar state on page load
function restoreSidebarState() {
  const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.querySelector('.main-content');
  
  if (isCollapsed && window.innerWidth >= 769) {
    sidebar.classList.add('collapsed');
    mainContent.classList.add('expanded');
  }
}

function initializeSubmenus() {
  // Auto-expand submenus for active sections
  const activeLinks = document.querySelectorAll('.nav-link.active');
  activeLinks.forEach(link => {
    const submenu = link.nextElementSibling;
    if (submenu && submenu.classList.contains('submenu')) {
      submenu.style.display = 'block';
    }
  });
}

function showReportsMenu() {
  {% if is_manager or is_admin %}
  const modal = new bootstrap.Modal(document.getElementById('reportsModal'));
  modal.show();
  {% endif %}
}

function updateNotificationCounts() {
  fetch('{% url "core:get_notification_count" %}')
    .then(response => response.json())
    .then(data => {
      // Update notification badges
      updateBadgeCount('.nav-link[href*="notifications"] .badge', data.unread_count);
      
      // Update quote badges if applicable
      if (data.quote_stats) {
        updateBadgeCount('.quote-badge', data.quote_stats.pending_count);
      }
      
      // Update task badges if applicable
      if (data.task_stats) {
        updateBadgeCount('.nav-link[href*="task"] .badge', data.task_stats.overdue_count || data.task_stats.due_today);
      }
    })
    .catch(error => console.log('Error updating counts:', error));
}

function updateBadgeCount(selector, count) {
  const badges = document.querySelectorAll(selector);
  badges.forEach(badge => {
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'inline';
      if (count > 0) {
        badge.classList.add('notification-indicator');
      }
    } else {
      badge.style.display = 'none';
      badge.classList.remove('notification-indicator');
    }
  });
}

// Real-time quote status updates
{% if app_permissions.quotes %}
function initializeQuoteUpdates() {
  setInterval(function() {
    if (window.location.pathname.includes('/quotes/') || 
        window.location.pathname === '{% url "core:dashboard" %}') {
      fetch('{% url "quotes:get_dashboard_stats" %}')
        .then(response => response.json())
        .then(data => {
          if (data.stats) {
            updateQuoteStats(data.stats);
          }
        })
        .catch(error => console.log('Quote update error:', error));
    }
  }, 60000); // Every minute
}

function updateQuoteStats(stats) {
  // Update sidebar quick stats
  const activeQuotesEl = document.querySelector('[data-stat="active-quotes"]');
  if (activeQuotesEl) {
    activeQuotesEl.textContent = stats.active_quotes;
  }
  
  const monthValueEl = document.querySelector('[data-stat="month-value"]');
  if (monthValueEl) {
    monthValueEl.textContent = '$' + stats.month_value.toLocaleString();
  }
  
  const conversionEl = document.querySelector('[data-stat="conversion-rate"]');
  if (conversionEl) {
    conversionEl.textContent = stats.conversion_rate.toFixed(1) + '%';
  }
}

// Initialize quote updates
initializeQuoteUpdates();
{% endif %}

// Enhanced keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + B to toggle sidebar
  if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
    e.preventDefault();
    toggleSidebar();
  }
  
  // Ctrl/Cmd + N for new quote (if available)
  {% if app_permissions.quotes == 'edit' or app_permissions.quotes == 'admin' %}
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    window.location.href = '{% url "quotes:quote_create" %}';
  }
  {% endif %}
});

// Auto-collapse sidebar on mobile when clicking main content
document.addEventListener('click', function(e) {
  if (window.innerWidth < 769) {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    const overlay = document.querySelector('.sidebar-overlay');
    
    if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
      sidebar.classList.remove('show');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }
  }
});
</script>

{% block extra_dashboard_js %}{% endblock %}
{% endblock %}