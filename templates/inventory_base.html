{% extends "dashboard_base.html" %}
{% load static %}

{% block extra_dashboard_head %}
{{ block.super }}
<!-- Inventory-specific CSS -->
<link rel="stylesheet" href="{% static 'inventory/css/inventory.css' %}">
<link rel="stylesheet" href="{% static 'inventory/css/dashboard.css' %}">

<!-- Additional Bootstrap icons for inventory -->
<style>
  /* Inventory-specific enhancements */
  .inventory-card {
    transition: all 0.3s ease;
    border: 1px solid #e3e6f0;
    border-radius: 0.5rem;
  }
  
  .inventory-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
  }
  
  .stock-status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-weight: 500;
  }
  
  .stock-in { 
    color: #28a745; 
    background-color: #d4edda;
  }
  .stock-low { 
    color: #856404; 
    background-color: #fff3cd;
  }
  .stock-out { 
    color: #721c24; 
    background-color: #f8d7da;
  }
  .stock-critical { 
    color: #dc3545; 
    background-color: #f8d7da;
    animation: pulse 2s infinite;
  }
  
  .quick-action-btn {
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .quick-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .inventory-metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: transform 0.3s ease;
  }
  
  .inventory-metric-card:hover {
    transform: translateY(-3px);
  }
  
  .inventory-metric-card.success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
  }
  
  .inventory-metric-card.warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }
  
  .inventory-metric-card.info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }
  
  .inventory-metric-card.danger {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
  }
  
  .search-box {
    border-radius: 0.5rem;
    border: 1px solid #d1d3e2;
    padding: 0.5rem 1rem;
    transition: all 0.2s ease;
  }
  
  .search-box:focus {
    border-color: #5a5c69;
    box-shadow: 0 0 0 0.2rem rgba(90, 92, 105, 0.25);
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }
  
  .inventory-breadcrumb {
    background-color: transparent;
    padding: 0.5rem 0;
    margin-bottom: 1rem;
  }
  
  .inventory-breadcrumb .breadcrumb-item {
    color: #6c757d;
  }
  
  .inventory-breadcrumb .breadcrumb-item.active {
    color: #495057;
    font-weight: 500;
  }
  
  .inventory-breadcrumb .breadcrumb-item + .breadcrumb-item::before {
    content: ">";
    color: #6c757d;
  }
  
  /* Inventory-specific alerts */
  .inventory-alert {
    border-radius: 0.5rem;
    border-left: 4px solid;
    margin-bottom: 1rem;
  }
  
  .inventory-alert.alert-warning {
    border-left-color: #ffc107;
    background-color: #fff3cd;
  }
  
  .inventory-alert.alert-danger {
    border-left-color: #dc3545;
    background-color: #f8d7da;
  }
  
  .inventory-alert.alert-info {
    border-left-color: #17a2b8;
    background-color: #d1ecf1;
  }
  
  /* Product status indicators */
  .product-status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
  }
  
  .status-active { background-color: #28a745; }
  .status-inactive { background-color: #6c757d; }
  .status-discontinued { background-color: #dc3545; }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .inventory-metric-card {
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .quick-action-btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .btn-group {
      flex-direction: column;
      width: 100%;
    }
    
    .btn-group .btn {
      border-radius: 0.375rem !important;
      margin-bottom: 0.25rem;
    }
  }
  
  /* Custom scrollbar for inventory tables */
  .inventory-table-container {
    max-height: 600px;
    overflow-y: auto;
    border-radius: 0.5rem;
  }
  
  .inventory-table-container::-webkit-scrollbar {
    width: 8px;
  }
  
  .inventory-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .inventory-table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  .inventory-table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  
  /* Loading states */
  .inventory-loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
  
  /* Search modal enhancements */
  .search-result-item {
    transition: all 0.2s ease;
    border-radius: 0.375rem;
    margin-bottom: 0.25rem;
  }
  
  .search-result-item:hover {
    background-color: rgba(0, 123, 255, 0.1);
    transform: translateX(5px);
  }
  
  .search-highlight {
    background-color: #fff3cd;
    padding: 0.1rem 0.2rem;
    border-radius: 0.2rem;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block page_title %}
  {% block inventory_title %}Inventory Management{% endblock %}
{% endblock %}

{% block page_actions %}
  {% block inventory_actions %}
    <!-- Quick inventory actions -->
    <div class="btn-group me-2" role="group">
      {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
        <a href="{% url 'inventory:product_create' %}" class="btn btn-success btn-sm quick-action-btn">
          <i class="bi bi-plus-circle me-1"></i>Add Product
        </a>
        <a href="{% url 'inventory:stock_adjust' %}" class="btn btn-warning btn-sm quick-action-btn">
          <i class="bi bi-arrows-move me-1"></i>Adjust Stock
        </a>
        <a href="{% url 'inventory:bulk_import' %}" class="btn btn-info btn-sm quick-action-btn">
          <i class="bi bi-upload me-1"></i>Import
        </a>
      {% endif %}
    </div>
    
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-primary btn-sm quick-action-btn" onclick="openQuickSearch()">
        <i class="bi bi-search me-1"></i>Search
      </button>
      {% if app_permissions.inventory %}
        <a href="{% url 'inventory:reports_dashboard' %}" class="btn btn-outline-info btn-sm quick-action-btn">
          <i class="bi bi-graph-up me-1"></i>Reports
        </a>
        <a href="{% url 'inventory:export_data' %}" class="btn btn-outline-secondary btn-sm quick-action-btn">
          <i class="bi bi-download me-1"></i>Export
        </a>
      {% endif %}
    </div>
  {% endblock %}
{% endblock %}

{% block dashboard_content %}
  <!-- Inventory-specific breadcrumbs -->
  {% if inventory_breadcrumbs %}
    <nav aria-label="inventory-breadcrumb" class="mb-3">
      <ol class="breadcrumb inventory-breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'inventory:dashboard' %}" class="text-decoration-none">
            <i class="bi bi-house me-1"></i>Inventory
          </a>
        </li>
        {% for crumb in inventory_breadcrumbs %}
          <li class="breadcrumb-item {% if forloop.last %}active{% endif %}">
            {% if crumb.url and not forloop.last %}
              <a href="{{ crumb.url }}" class="text-decoration-none">{{ crumb.title }}</a>
            {% else %}
              {{ crumb.title }}
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </nav>
  {% endif %}

  <!-- Inventory alerts -->
  {% if inventory_alerts %}
    <div class="row mb-3">
      <div class="col-12">
        {% for alert in inventory_alerts %}
          <div class="alert alert-{{ alert.type }} inventory-alert alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
              <i class="bi bi-{{ alert.icon|default:'info-circle' }} me-2"></i>
              <div class="flex-grow-1">
                <strong>{{ alert.title }}</strong> {{ alert.message }}
                {% if alert.action_url %}
                  <a href="{{ alert.action_url }}" class="alert-link ms-2">{{ alert.action_text|default:"View Details" }}</a>
                {% endif %}
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- Quick stats row for inventory -->
  {% if show_quick_stats %}
    <div class="row mb-4">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="inventory-metric-card success">
          <div class="d-flex align-items-center">
            <i class="bi bi-box-seam fs-1 me-3 opacity-75"></i>
            <div>
              <div class="fs-4 fw-bold" data-metric="total_products">{{ total_products|default:0 }}</div>
              <div class="small text-white-75">Total Products</div>
            </div>
          </div>
          <div class="mt-2">
            <a href="{% url 'inventory:product_list' %}" class="text-white text-decoration-none small">
              <i class="bi bi-arrow-right me-1"></i>View Products
            </a>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="inventory-metric-card info">
          <div class="d-flex align-items-center">
            <i class="bi bi-currency-dollar fs-1 me-3 opacity-75"></i>
            <div>
              <div class="fs-4 fw-bold" data-metric="total_stock_value">${{ total_stock_value|floatformat:0|default:0 }}</div>
              <div class="small text-white-75">Stock Value</div>
            </div>
          </div>
          <div class="mt-2">
            <a href="{% url 'inventory:valuation_report' %}" class="text-white text-decoration-none small">
              <i class="bi bi-arrow-right me-1"></i>View Report
            </a>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="inventory-metric-card warning">
          <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle fs-1 me-3 opacity-75"></i>
            <div>
              <div class="fs-4 fw-bold" data-metric="low_stock_count">{{ low_stock_count|default:0 }}</div>
              <div class="small text-white-75">Low Stock Items</div>
            </div>
          </div>
          <div class="mt-2">
            <a href="{% url 'inventory:low_stock_report' %}" class="text-white text-decoration-none small">
              <i class="bi bi-arrow-right me-1"></i>View Low Stock
            </a>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="inventory-metric-card {% if active_alerts_count > 0 %}danger{% endif %}">
          <div class="d-flex align-items-center">
            <i class="bi bi-bell fs-1 me-3 opacity-75"></i>
            <div>
              <div class="fs-4 fw-bold" data-metric="active_alerts_count">{{ active_alerts_count|default:0 }}</div>
              <div class="small text-white-75">Active Alerts</div>
            </div>
          </div>
          <div class="mt-2">
            <a href="{% url 'inventory:alerts_dashboard' %}" class="text-white text-decoration-none small">
              <i class="bi bi-arrow-right me-1"></i>Manage Alerts
            </a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Main inventory content -->
  {% block inventory_content %}
    <!-- This block will be overridden by specific inventory pages -->
    <div class="row">
      <div class="col-12">
        <div class="card inventory-card">
          <div class="card-header d-flex justify-content-between align-items-center bg-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-grid-3x3-gap me-2 text-primary"></i>Inventory Overview
            </h5>
            <div class="text-muted small">
              <i class="bi bi-clock me-1"></i>
              Last updated: {{ last_updated|default:"Just now" }}
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <p class="text-muted mb-3">
                  Welcome to the inventory management system. Use the navigation and tools above to manage products, track stock levels, and generate comprehensive reports.
                </p>
                <div class="d-flex gap-2 flex-wrap">
                  {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}
                  <a href="{% url 'inventory:product_create' %}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle me-1"></i>Add First Product
                  </a>
                  {% endif %}
                  <a href="{% url 'inventory:product_list' %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-list me-1"></i>Browse Products
                  </a>
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openQuickSearch()">
                    <i class="bi bi-search me-1"></i>Quick Search
                  </button>
                </div>
              </div>
              <div class="col-md-4 text-center">
                <i class="bi bi-box-seam text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endblock %}

  <!-- Enhanced Quick search modal -->
  <div class="modal fade" id="quickSearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-search me-2"></i>Quick Product Search
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" 
                     class="form-control search-box" 
                     id="quickSearchInput" 
                     placeholder="Search by product name, SKU, barcode, or category..."
                     autocomplete="off">
              <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                <i class="bi bi-x"></i>
              </button>
            </div>
            <small class="text-muted">
              <i class="bi bi-lightbulb me-1"></i>
              Pro tip: Use "sku:", "cat:", or "name:" prefixes for specific searches
            </small>
          </div>
          <div id="searchResults" class="list-group">
            <div class="text-muted p-3 text-center">
              <i class="bi bi-search me-2"></i>
              Type at least 2 characters to search...
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a href="{% url 'inventory:product_search' %}" class="btn btn-primary">
            <i class="bi bi-search me-1"></i>Advanced Search
          </a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_dashboard_js %}
{{ block.super }}
<!-- Inventory-specific JavaScript -->
<script src="{% static 'inventory/js/inventory.js' %}"></script>
<script src="{% static 'inventory/js/stock-manager.js' %}"></script>
<script src="{% static 'inventory/js/bulk-operations.js' %}"></script>
<script src="{% static 'inventory/js/barcode-scanner.js' %}"></script>

<script>
// Initialize inventory functionality
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips for inventory elements
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Initialize quick search functionality
  initializeQuickSearch();
  
  // Auto-refresh inventory stats every 5 minutes
  if (typeof updateInventoryStats !== 'undefined') {
    setInterval(updateInventoryStats, 300000);
  }
  
  // Initialize barcode scanner if available
  if (typeof initBarcodeScanner !== 'undefined') {
    initBarcodeScanner();
  }
  
  // Initialize any inventory-specific features
  initializeInventoryFeatures();
});

function initializeQuickSearch() {
  const quickSearchInput = document.getElementById('quickSearchInput');
  const searchResults = document.getElementById('searchResults');
  
  if (quickSearchInput) {
    let searchTimeout;
    
    quickSearchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      
      if (query.length < 2) {
        searchResults.innerHTML = `
          <div class="text-muted p-3 text-center">
            <i class="bi bi-search me-2"></i>
            Type at least 2 characters to search...
          </div>
        `;
        return;
      }
      
      searchTimeout = setTimeout(() => {
        performQuickSearch(query);
      }, 300);
    });
    
    // Handle Enter key
    quickSearchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const firstResult = searchResults.querySelector('.list-group-item-action');
        if (firstResult) {
          firstResult.click();
        }
      }
    });
  }
}

function openQuickSearch() {
  const searchModal = new bootstrap.Modal(document.getElementById('quickSearchModal'));
  searchModal.show();
  
  // Focus on input after modal is shown
  document.getElementById('quickSearchModal').addEventListener('shown.bs.modal', function() {
    document.getElementById('quickSearchInput').focus();
  });
}

function clearSearch() {
  const searchInput = document.getElementById('quickSearchInput');
  const searchResults = document.getElementById('searchResults');
  
  searchInput.value = '';
  searchInput.focus();
  searchResults.innerHTML = `
    <div class="text-muted p-3 text-center">
      <i class="bi bi-search me-2"></i>
      Type at least 2 characters to search...
    </div>
  `;
}

function performQuickSearch(query) {
  const searchResults = document.getElementById('searchResults');
  searchResults.innerHTML = `
    <div class="text-center p-3">
      <div class="inventory-loading me-2"></div>
      Searching...
    </div>
  `;
  
  fetch(`{% url 'inventory:product_search_api' %}?q=${encodeURIComponent(query)}&limit=10`)
    .then(response => response.json())
    .then(data => {
      if (data.success && data.results.length > 0) {
        let html = '';
        data.results.forEach(product => {
          const stockClass = getStockStatusClass(product.stock_status);
          const statusIndicator = getStatusIndicator(product.status);
          
          html += `
            <a href="/inventory/products/${product.id}/" class="list-group-item list-group-item-action search-result-item">
              <div class="d-flex w-100 justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="mb-1">
                    <span class="product-status-indicator ${statusIndicator}"></span>
                    ${highlightSearchTerm(product.name, query)}
                  </h6>
                  <p class="mb-1 small text-muted">
                    SKU: ${highlightSearchTerm(product.sku, query)} | 
                    Category: ${product.category} | 
                    Stock: ${product.current_stock}
                  </p>
                  <small class="text-muted">Price: $${product.selling_price}</small>
                </div>
                <div class="text-end">
                  <span class="stock-status-badge ${stockClass}">${product.stock_status.replace('_', ' ')}</span>
                </div>
              </div>
            </a>
          `;
        });
        searchResults.innerHTML = html;
      } else {
        searchResults.innerHTML = `
          <div class="text-muted p-3 text-center">
            <i class="bi bi-inbox me-2"></i>
            No products found matching "${query}".
            <br>
            <small>Try a different search term or <a href="{% url 'inventory:product_search' %}">use advanced search</a></small>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Search error:', error);
      searchResults.innerHTML = `
        <div class="text-danger p-3 text-center">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Search failed. Please try again.
        </div>
      `;
    });
}

function highlightSearchTerm(text, term) {
  if (!term || term.length < 2) return text;
  
  const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
  return text.replace(regex, '<span class="search-highlight">$1</span>');
}

function getStockStatusClass(status) {
  switch(status) {
    case 'in_stock': return 'stock-in';
    case 'low_stock': return 'stock-low';
    case 'out_of_stock': return 'stock-out';
    case 'critical': return 'stock-critical';
    default: return '';
  }
}

function getStatusIndicator(status) {
  switch(status) {
    case 'active': return 'status-active';
    case 'inactive': return 'status-inactive';
    case 'discontinued': return 'status-discontinued';
    default: return 'status-active';
  }
}

function updateInventoryStats() {
  fetch('{% url "inventory:quick_stats" %}')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update metric cards if they exist
        updateMetricIfExists('total_products', data.stats.total_products);
        updateMetricIfExists('total_stock_value', '$' + data.stats.total_stock_value.toLocaleString());
        updateMetricIfExists('low_stock_count', data.stats.low_stock_count);
        updateMetricIfExists('active_alerts_count', data.stats.active_alerts);
        
        // Update sidebar inventory badge if it exists
        const inventoryBadge = document.querySelector('.nav-link[href*="inventory"] .badge');
        if (inventoryBadge && data.stats.urgent_alerts > 0) {
          inventoryBadge.textContent = data.stats.urgent_alerts;
          inventoryBadge.style.display = 'inline';
          inventoryBadge.classList.add('notification-indicator');
        } else if (inventoryBadge) {
          inventoryBadge.style.display = 'none';
          inventoryBadge.classList.remove('notification-indicator');
        }
      }
    })
    .catch(error => console.log('Stats update error:', error));
}

function updateMetricIfExists(metricName, value) {
  const element = document.querySelector(`[data-metric="${metricName}"]`);
  if (element) {
    element.textContent = value;
  }
}

function initializeInventoryFeatures() {
  // Initialize any additional inventory-specific features
  
  // Auto-save form data in localStorage for new/edit forms
  const forms = document.querySelectorAll('form[data-auto-save]');
  forms.forEach(form => {
    const inputs = form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
      // Load saved data
      const savedValue = localStorage.getItem(`inventory_form_${input.name}`);
      if (savedValue && !input.value) {
        input.value = savedValue;
      }
      
      // Save on change
      input.addEventListener('input', function() {
        localStorage.setItem(`inventory_form_${this.name}`, this.value);
      });
    });
    
    // Clear saved data on successful submit
    form.addEventListener('submit', function() {
      if (this.checkValidity()) {
        inputs.forEach(input => {
          localStorage.removeItem(`inventory_form_${input.name}`);
        });
      }
    });
  });
}

// Enhanced keyboard shortcuts for inventory
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + K for quick search
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    openQuickSearch();
  }
  
  // Ctrl/Cmd + N for new product
  if ((e.ctrlKey || e.metaKey) && e.key === 'n' && {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}true{% else %}false{% endif %}) {
    e.preventDefault();
    window.location.href = '{% url "inventory:product_create" %}';
  }
  
  // Ctrl/Cmd + Shift + S for stock adjustment
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S' && {% if app_permissions.inventory == 'edit' or app_permissions.inventory == 'admin' %}true{% else %}false{% endif %}) {
    e.preventDefault();
    window.location.href = '{% url "inventory:stock_adjust" %}';
  }
  
  // ESC to close modals
  if (e.key === 'Escape') {
    const openModal = document.querySelector('.modal.show');
    if (openModal) {
      const modal = bootstrap.Modal.getInstance(openModal);
      if (modal) modal.hide();
    }
  }
});

// Stock status update notifications
function showStockStatusUpdate(message, type = 'info') {
  const alertContainer = document.createElement('div');
  alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  alertContainer.style.cssText = 'top: 80px; right: 20px; z-index: 1060; min-width: 300px; max-width: 400px;';
  alertContainer.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
      <div class="flex-grow-1">${message}</div>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
  
  document.body.appendChild(alertContainer);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (alertContainer.parentNode) {
      const alert = bootstrap.Alert.getInstance(alertContainer);
      if (alert) alert.close();
      else alertContainer.remove();
    }
  }, 5000);
}

// Enhanced bulk operations feedback
function showBulkOperationProgress(current, total, operation) {
  const progressContainer = document.getElementById('bulkProgressContainer');
  if (progressContainer) {
    const percentage = Math.round((current / total) * 100);
    progressContainer.innerHTML = `
      <div class="progress mb-3">
        <div class="progress-bar" role="progressbar" style="width: ${percentage}%" 
             aria-valuenow="${current}" aria-valuemin="0" aria-valuemax="${total}">
          ${percentage}%
        </div>
      </div>
      <p class="text-muted">${operation}: ${current} of ${total} items processed</p>
    `;
  }
}

// Export functions for other inventory scripts
window.InventoryApp = {
  performQuickSearch,
  updateInventoryStats,
  showStockStatusUpdate,
  getStockStatusClass,
  getStatusIndicator,
  highlightSearchTerm,
  openQuickSearch,
  clearSearch,
  showBulkOperationProgress
};

console.log('Inventory management system initialized successfully');
</script>
{% endblock %}