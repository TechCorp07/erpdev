{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}{{ client.name }}{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
  <a href="{% url 'crm:client_update' client.id %}" class="btn btn-warning">
    <i class="bi bi-pencil me-1"></i> Edit Client
  </a>
  <a href="{% url 'crm:add_interaction' client.id %}" class="btn btn-success">
    <i class="bi bi-chat-left-text me-1"></i> Add Interaction
  </a>
  <div class="btn-group" role="group">
    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-three-dots me-1"></i> More Actions
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="mailto:{{ client.email }}"><i class="bi bi-envelope me-1"></i> Send Email</a></li>
      {% if client.phone %}
      <li><a class="dropdown-item" href="tel:{{ client.phone }}"><i class="bi bi-telephone me-1"></i> Call Client</a></li>
      {% endif %}
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="#" onclick="generateQuote()"><i class="bi bi-file-earmark-text me-1"></i> Generate Quote</a></li>
      <li><a class="dropdown-item" href="#" onclick="createDeal()"><i class="bi bi-briefcase me-1"></i> Create Deal</a></li>
      <li><hr class="dropdown-divider"></li>
      {% if is_admin %}
      <li><a class="dropdown-item text-danger" href="{% url 'crm:client_delete' client.id %}"><i class="bi bi-trash me-1"></i> Delete Client</a></li>
      {% endif %}
    </ul>
  </div>
  <a href="{% url 'crm:client_list' %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> Back to List
  </a>
</div>
{% endblock %}

{% block dashboard_content %}
<!-- Client Header -->
<div class="row mb-4">
  <div class="col-md-8">
    <div class="d-flex align-items-center">
      <div class="flex-shrink-0 me-3">
        {% if client.priority == 'vip' %}
        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
          <i class="bi bi-star-fill text-white fs-3"></i>
        </div>
        {% elif client.priority == 'high' %}
        <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
          <i class="bi bi-exclamation-triangle-fill text-white fs-3"></i>
        </div>
        {% else %}
        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
          <span class="text-white fs-4">{{ client.name|first }}</span>
        </div>
        {% endif %}
      </div>
      <div>
        <h2 class="mb-1">{{ client.name }}</h2>
        {% if client.company %}
        <p class="text-muted mb-1 fs-5">{{ client.company }}</p>
        {% endif %}
        <div class="d-flex align-items-center gap-3">
          <span class="badge bg-{% if client.status == 'client' %}success{% elif client.status == 'prospect' %}warning{% elif client.status == 'lead' %}info{% elif client.status == 'inactive' %}secondary{% else %}danger{% endif %} fs-6">
            {{ client.get_status_display }}
          </span>
          <span class="badge bg-light text-dark">{{ client.get_customer_type_display }}</span>
          {% if client.priority != 'medium' %}
          <span class="badge bg-{% if client.priority == 'vip' %}warning{% elif client.priority == 'high' %}danger{% else %}info{% endif %}">
            {{ client.get_priority_display }}
          </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4 text-md-end">
    <div class="text-muted small">
      <div>Client ID: {{ client.client_id }}</div>
      <div>Created: {{ client.created_at|date:"M d, Y" }}</div>
      {% if client.created_by %}
      <div>By: {{ client.created_by.get_full_name|default:client.created_by.username }}</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Alert for overdue follow-ups -->
{% if client.is_overdue_followup %}
<div class="alert alert-warning mb-4" role="alert">
  <i class="bi bi-exclamation-triangle me-2"></i>
  <strong>Follow-up Overdue!</strong> This client has an overdue follow-up scheduled for {{ client.followup_date|date:"M d, Y H:i" }}.
  <a href="{% url 'crm:add_interaction' client.id %}" class="alert-link">Add interaction now</a>
</div>
{% endif %}

<!-- Key Metrics Row -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card text-center h-100">
      <div class="card-body">
        <i class="bi bi-chat-left-text text-primary fs-1 mb-2"></i>
        <h5 class="card-title">{{ total_interactions|default:0 }}</h5>
        <p class="card-text text-muted small">Total Interactions</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card text-center h-100">
      <div class="card-body">
        <i class="bi bi-calendar-event text-success fs-1 mb-2"></i>
        <h5 class="card-title">
          {% if client.days_since_last_contact %}
          {{ client.days_since_last_contact }}
          {% else %}
          Never
          {% endif %}
        </h5>
        <p class="card-text text-muted small">Days Since Last Contact</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card text-center h-100">
      <div class="card-body">
        <i class="bi bi-currency-dollar text-warning fs-1 mb-2"></i>
        <h5 class="card-title">${{ client.total_value|floatformat:0|default:0 }}</h5>
        <p class="card-text text-muted small">Total Value</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card text-center h-100">
      <div class="card-body">
        <i class="bi bi-graph-up text-info fs-1 mb-2"></i>
        <h5 class="card-title">{{ client.lead_score|default:0 }}%</h5>
        <p class="card-text text-muted small">Lead Score</p>
      </div>
    </div>
  </div>
</div>

<!-- Main Content Tabs -->
<div class="card">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" id="clientTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
          <i class="bi bi-person me-1"></i> Overview
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="interactions-tab" data-bs-toggle="tab" data-bs-target="#interactions" type="button" role="tab">
          <i class="bi bi-chat-left-text me-1"></i> Interactions
          {% if total_interactions %}
          <span class="badge bg-secondary rounded-pill ms-1">{{ total_interactions }}</span>
          {% endif %}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="followups-tab" data-bs-toggle="tab" data-bs-target="#followups" type="button" role="tab">
          <i class="bi bi-calendar-check me-1"></i> Follow-ups
          {% if upcoming_followups|length or overdue_followups|length %}
          <span class="badge bg-{% if overdue_followups|length %}danger{% else %}warning{% endif %} rounded-pill ms-1">
            {{ upcoming_followups|length|add:overdue_followups|length }}
          </span>
          {% endif %}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
          <i class="bi bi-graph-up me-1"></i> Analytics
        </button>
      </li>
    </ul>
  </div>
  
  <div class="card-body">
    <div class="tab-content" id="clientTabsContent">
      <!-- Overview Tab -->
      <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row">
          <!-- Contact Information -->
          <div class="col-lg-6 mb-4">
            <h5 class="mb-3">Contact Information</h5>
            <table class="table table-borderless">
              <tr>
                <td class="text-muted" style="width: 30%;"><i class="bi bi-envelope me-2"></i>Email:</td>
                <td><a href="mailto:{{ client.email }}">{{ client.email }}</a></td>
              </tr>
              {% if client.phone %}
              <tr>
                <td class="text-muted"><i class="bi bi-telephone me-2"></i>Phone:</td>
                <td><a href="tel:{{ client.phone }}">{{ client.phone }}</a></td>
              </tr>
              {% endif %}
              {% if client.website %}
              <tr>
                <td class="text-muted"><i class="bi bi-globe me-2"></i>Website:</td>
                <td><a href="{{ client.website }}" target="_blank">{{ client.website }}</a></td>
              </tr>
              {% endif %}
              {% if client.full_address %}
              <tr>
                <td class="text-muted"><i class="bi bi-geo-alt me-2"></i>Address:</td>
                <td>{{ client.full_address }}</td>
              </tr>
              {% endif %}
            </table>
          </div>
          
          <!-- Business Information -->
          <div class="col-lg-6 mb-4">
            <h5 class="mb-3">Business Information</h5>
            <table class="table table-borderless">
              <tr>
                <td class="text-muted" style="width: 30%;">Industry:</td>
                <td>{{ client.industry|default:"Not specified" }}</td>
              </tr>
              {% if client.company_size %}
              <tr>
                <td class="text-muted">Company Size:</td>
                <td>{{ client.company_size }} employees</td>
              </tr>
              {% endif %}
              {% if client.tax_number %}
              <tr>
                <td class="text-muted">Tax Number:</td>
                <td>{{ client.tax_number }}</td>
              </tr>
              {% endif %}
              <tr>
                <td class="text-muted">Payment Terms:</td>
                <td>{{ client.payment_terms }} days</td>
              </tr>
              <tr>
                <td class="text-muted">Credit Limit:</td>
                <td>${{ client.credit_limit|floatformat:2 }} {{ client.currency_preference }}</td>
              </tr>
            </table>
          </div>
        </div>
        
        <!-- Assignment and Source -->
        <div class="row">
          <div class="col-lg-6 mb-4">
            <h5 class="mb-3">Team Assignment</h5>
            <table class="table table-borderless">
              <tr>
                <td class="text-muted" style="width: 30%;">Assigned To:</td>
                <td>
                  {% if client.assigned_to %}
                  {{ client.assigned_to.get_full_name|default:client.assigned_to.username }}
                  {% else %}
                  <span class="text-muted">Not assigned</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="text-muted">Account Manager:</td>
                <td>
                  {% if client.account_manager %}
                  {{ client.account_manager.get_full_name|default:client.account_manager.username }}
                  {% else %}
                  <span class="text-muted">Not assigned</span>
                  {% endif %}
                </td>
              </tr>
            </table>
          </div>
          
          <div class="col-lg-6 mb-4">
            <h5 class="mb-3">Source & Attribution</h5>
            <table class="table table-borderless">
              <tr>
                <td class="text-muted" style="width: 30%;">Source:</td>
                <td>{{ client.source|default:"Not specified" }}</td>
              </tr>
              {% if client.referral_source %}
              <tr>
                <td class="text-muted">Referral:</td>
                <td>{{ client.referral_source }}</td>
              </tr>
              {% endif %}
              {% if client.marketing_campaign %}
              <tr>
                <td class="text-muted">Campaign:</td>
                <td>{{ client.marketing_campaign }}</td>
              </tr>
              {% endif %}
            </table>
          </div>
        </div>
        
        <!-- Notes and Tags -->
        {% if client.notes or client.tag_list %}
        <div class="row">
          {% if client.notes %}
          <div class="col-lg-6 mb-4">
            <h5 class="mb-3">Notes</h5>
            <div class="bg-light p-3 rounded">
              {{ client.notes|linebreaks }}
            </div>
          </div>
          {% endif %}
          
          {% if client.tag_list %}
          <div class="col-lg-6 mb-4">
            <h5 class="mb-3">Tags</h5>
            <div>
              {% for tag in client.tag_list %}
              <span class="badge bg-secondary me-1 mb-1">{{ tag }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
      
      <!-- Interactions Tab -->
      <div class="tab-pane fade" id="interactions" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Interaction History</h5>
          <a href="{% url 'crm:add_interaction' client.id %}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus me-1"></i> Add Interaction
          </a>
        </div>
        
        {% if interactions %}
        <div class="timeline">
          {% for interaction in interactions %}
          <div class="timeline-item mb-4">
            <div class="d-flex">
              <div class="flex-shrink-0 me-3">
                <div class="timeline-marker bg-{% if interaction.outcome == 'positive' %}success{% elif interaction.outcome == 'negative' %}danger{% else %}secondary{% endif %}">
                  <i class="bi bi-{% if interaction.interaction_type == 'call' %}telephone{% elif interaction.interaction_type == 'email' %}envelope{% elif interaction.interaction_type == 'meeting' %}people{% elif interaction.interaction_type == 'visit' %}geo-alt{% else %}chat-left-text{% endif %} text-white"></i>
                </div>
              </div>
              <div class="flex-grow-1">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="card-title mb-0">{{ interaction.get_interaction_type_display }}</h6>
                      <small class="text-muted">{{ interaction.created_at|date:"M d, Y H:i" }}</small>
                    </div>
                    
                    {% if interaction.subject %}
                    <p class="fw-bold mb-1">{{ interaction.subject }}</p>
                    {% endif %}
                    
                    <p class="card-text">{{ interaction.notes|truncatewords:50 }}</p>
                    
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        {% if interaction.outcome %}
                        <span class="badge bg-{% if interaction.outcome == 'positive' %}success{% elif interaction.outcome == 'negative' %}danger{% else %}secondary{% endif %}">
                          {{ interaction.get_outcome_display }}
                        </span>
                        {% endif %}
                        {% if interaction.duration_minutes %}
                        <span class="badge bg-light text-dark">{{ interaction.duration_minutes }}min</span>
                        {% endif %}
                      </div>
                      <small class="text-muted">by {{ interaction.created_by.get_full_name|default:interaction.created_by.username }}</small>
                    </div>
                    
                    {% if interaction.next_followup %}
                    <div class="mt-2 p-2 bg-light rounded">
                      <small class="text-muted">
                        <i class="bi bi-calendar-event me-1"></i>
                        Follow-up scheduled: {{ interaction.next_followup|date:"M d, Y H:i" }}
                        {% if interaction.is_followup_overdue %}
                        <span class="text-danger">(Overdue)</span>
                        {% endif %}
                      </small>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        
        {% if total_interactions > 10 %}
        <div class="text-center">
          <a href="{% url 'crm:client_interactions' client.id %}" class="btn btn-outline-primary">
            View All {{ total_interactions }} Interactions
          </a>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5 text-muted">
          <i class="bi bi-chat-left-text fs-1 mb-3"></i>
          <h5>No interactions yet</h5>
          <p>Start building a relationship by recording your first interaction.</p>
          <a href="{% url 'crm:add_interaction' client.id %}" class="btn btn-primary">
            <i class="bi bi-plus me-1"></i> Add First Interaction
          </a>
        </div>
        {% endif %}
      </div>
      
      <!-- Follow-ups Tab -->
      <div class="tab-pane fade" id="followups" role="tabpanel">
        <h5 class="mb-3">Follow-up Schedule</h5>
        
        <!-- Overdue Follow-ups -->
        {% if overdue_followups %}
        <div class="alert alert-danger">
          <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-1"></i> Overdue Follow-ups</h6>
          {% for interaction in overdue_followups %}
          <div class="d-flex justify-content-between align-items-center {% if not forloop.last %}mb-2{% endif %}">
            <div>
              <strong>{{ interaction.get_interaction_type_display }}</strong>
              <small class="text-muted">- Due {{ interaction.next_followup|date:"M d, Y H:i" }}</small>
            </div>
            <button class="btn btn-sm btn-success" onclick="markFollowupComplete({{ interaction.id }})">
              Complete
            </button>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        
        <!-- Upcoming Follow-ups -->
        {% if upcoming_followups %}
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Upcoming Follow-ups</h6>
          </div>
          <div class="card-body">
            {% for interaction in upcoming_followups %}
            <div class="d-flex justify-content-between align-items-center {% if not forloop.last %}border-bottom pb-2 mb-2{% endif %}">
              <div>
                <h6 class="mb-1">{{ interaction.get_interaction_type_display }}</h6>
                <small class="text-muted">{{ interaction.next_followup|date:"M d, Y H:i" }}</small>
                {% if interaction.followup_notes %}
                <br><small>{{ interaction.followup_notes|truncatewords:10 }}</small>
                {% endif %}
              </div>
              <button class="btn btn-sm btn-outline-success" onclick="markFollowupComplete({{ interaction.id }})">
                Complete
              </button>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {% if not overdue_followups and not upcoming_followups %}
        <div class="text-center py-5 text-muted">
          <i class="bi bi-calendar-check fs-1 mb-3"></i>
          <h5>No follow-ups scheduled</h5>
          <p>Add an interaction with a follow-up date to schedule future contact.</p>
          <a href="{% url 'crm:add_interaction' client.id %}" class="btn btn-primary">
            <i class="bi bi-plus me-1"></i> Add Interaction
          </a>
        </div>
        {% endif %}
      </div>
      
      <!-- Analytics Tab -->
      <div class="tab-pane fade" id="analytics" role="tabpanel">
        <div class="row">
          <div class="col-md-6 mb-4">
            <h5 class="mb-3">Interaction Analytics</h5>
            {% if interaction_stats %}
            <canvas id="interactionChart" width="400" height="200"></canvas>
            {% else %}
            <div class="text-center py-4 text-muted">
              <i class="bi bi-graph-up fs-1 mb-3"></i>
              <p>No interaction data available yet.</p>
            </div>
            {% endif %}
          </div>
          
          <div class="col-md-6 mb-4">
            <h5 class="mb-3">Client Metrics</h5>
            <table class="table">
              <tr>
                <td>Lead Score:</td>
                <td><strong>{{ client.lead_score }}%</strong></td>
              </tr>
              <tr>
                <td>Conversion Probability:</td>
                <td><strong>{{ client.conversion_probability }}%</strong></td>
              </tr>
              <tr>
                <td>Total Orders:</td>
                <td><strong>{{ client.total_orders }}</strong></td>
              </tr>
              <tr>
                <td>Average Order Value:</td>
                <td><strong>${{ client.average_order_value|floatformat:2 }}</strong></td>
              </tr>
              <tr>
                <td>Lifetime Value:</td>
                <td><strong>${{ client.lifetime_value|floatformat:2 }}</strong></td>
              </tr>
              {% if client.profit_margin %}
              <tr>
                <td>Profit Margin:</td>
                <td><strong>{{ client.profit_margin }}%</strong></td>
              </tr>
              {% endif %}
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Mark follow-up as complete
function markFollowupComplete(interactionId) {
    if (confirm('Mark this follow-up as complete?')) {
        fetch(`/crm/interactions/${interactionId}/complete-followup/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error completing follow-up. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error completing follow-up. Please try again.');
        });
    }
}

// Generate Quote (placeholder)
function generateQuote() {
    alert('Quote generation will be available in Phase 2 of the CRM enhancement.');
}

// Create Deal (placeholder)
function createDeal() {
    alert('Deal management will be available in Phase 2 of the CRM enhancement.');
}

// Interaction Analytics Chart
{% if interaction_stats %}
const ctx = document.getElementById('interactionChart').getContext('2d');
const interactionChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: [
            {% for stat in interaction_stats %}
            '{{ stat.interaction_type|capfirst }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for stat in interaction_stats %}
                {{ stat.count }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Auto-calculate lead score (placeholder for future implementation)
function calculateLeadScore() {
    fetch(`/crm/ajax/client/{{ client.id }}/calculate-score/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>

<style>
.timeline-marker {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 19px;
    top: 40px;
    width: 2px;
    height: calc(100% - 40px);
    background-color: #dee2e6;
    z-index: -1;
}

.timeline {
    position: relative;
}
</style>
{% endblock %}
