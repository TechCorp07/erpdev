{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Delete Task - {{ task.title }}{% endblock %}

{% block dashboard_content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <!-- Warning Card -->
    <div class="card border-danger">
      <div class="card-header bg-danger text-white">
        <h5 class="card-title mb-0">
          <i class="bi bi-exclamation-triangle me-2"></i>Confirm Task Deletion
        </h5>
      </div>
      <div class="card-body">
        <!-- Task Information -->
        <div class="alert alert-warning">
          <h6 class="alert-heading">
            <i class="bi bi-exclamation-triangle me-1"></i>
            You are about to permanently delete this task
          </h6>
          <p class="mb-0">This action cannot be undone. The task will be permanently removed from the system.</p>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-6">
            <h6>Task Details:</h6>
            <ul class="list-unstyled">
              <li><strong>Title:</strong> {{ task.title }}</li>
              <li><strong>Status:</strong> {{ task.get_status_display }}</li>
              <li><strong>Priority:</strong> {{ task.get_priority_display }}</li>
              <li><strong>Assigned To:</strong> {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}</li>
              <li><strong>Created:</strong> {{ task.created_at|date:"M d, Y" }}</li>
              {% if task.due_date %}
              <li><strong>Due Date:</strong> {{ task.due_date|date:"M d, Y H:i" }}</li>
              {% endif %}
            </ul>
          </div>
          <div class="col-md-6">
            <h6>Related Information:</h6>
            <ul class="list-unstyled">
              {% if task.client %}
              <li><i class="bi bi-person text-primary me-1"></i> <strong>Client:</strong> {{ task.client.name }}</li>
              {% endif %}
              {% if task.deal %}
              <li><i class="bi bi-briefcase text-success me-1"></i> <strong>Deal:</strong> {{ task.deal.title }}</li>
              {% endif %}
              {% if not task.client and not task.deal %}
              <li><i class="bi bi-info-circle text-muted me-1"></i> General task (no client/deal relationships)</li>
              {% endif %}
              <li><i class="bi bi-person-badge text-info me-1"></i> <strong>Created By:</strong> {{ task.created_by.get_full_name|default:task.created_by.username }}</li>
            </ul>
          </div>
        </div>
        
        <!-- Impact Assessment -->
        <div class="alert alert-info">
          <h6 class="alert-heading">
            <i class="bi bi-info-circle me-1"></i>What happens when you delete this task?
          </h6>
          <ul class="mb-0">
            <li><i class="bi bi-check-circle text-success me-1"></i> Client and deal records will remain intact</li>
            <li><i class="bi bi-plus-circle text-primary me-1"></i> An audit trail will be maintained in client interactions</li>
            <li><i class="bi bi-x-circle text-danger me-1"></i> Task data and history will be permanently deleted</li>
            <li><i class="bi bi-graph-down text-warning me-1"></i> This may affect productivity reporting and analytics</li>
          </ul>
        </div>
        
        <!-- Task Description Preview -->
        {% if task.description %}
        <div class="card mt-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">Task Description</h6>
          </div>
          <div class="card-body">
            <p class="mb-0">{{ task.description|truncatewords:50 }}</p>
            {% if task.description|length > 200 %}
            <small class="text-muted">... (description truncated)</small>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        <!-- Confirmation Form -->
        <form method="post" id="deleteForm" class="mt-4">
          {% csrf_token %}
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmDelete" required>
            <label class="form-check-label" for="confirmDelete">
              I understand that this action is permanent and cannot be undone
            </label>
          </div>
          
          <div class="mb-3">
            <label for="deleteReason" class="form-label">Reason for Deletion (Optional)</label>
            <textarea class="form-control" id="deleteReason" name="delete_reason" rows="3" 
                      placeholder="Why is this task being deleted? (This will be recorded in the audit log)"></textarea>
          </div>
          
          <div class="d-flex justify-content-between">
            <a href="{% url 'crm:task_detail' task.id %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i> Cancel - Keep Task
            </a>
            
            <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>
              <i class="bi bi-trash me-1"></i> Permanently Delete Task
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Alternative Actions -->
    <div class="card mt-3">
      <div class="card-body">
        <h6 class="card-title">
          <i class="bi bi-lightbulb me-1"></i> Alternative Actions
        </h6>
        <p class="card-text small text-muted">
          Instead of deleting, consider marking the task as "Cancelled" to maintain historical data 
          while removing it from active task views.
        </p>
        <div class="d-flex gap-2">
          <a href="{% url 'crm:task_update' task.id %}" class="btn btn-outline-warning btn-sm">
            <i class="bi bi-pencil me-1"></i> Edit Task Instead
          </a>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="markAsCancelled()">
            <i class="bi bi-x-circle me-1"></i> Mark as Cancelled
          </button>
        </div>
      </div>
    </div>
    
    <!-- Productivity Impact Warning -->
    {% if task.status == 'completed' %}
    <div class="card mt-3 border-warning">
      <div class="card-body">
        <h6 class="card-title text-warning">
          <i class="bi bi-exclamation-triangle me-1"></i> Productivity Impact Warning
        </h6>
        <p class="card-text small">
          This is a completed task. Deleting it will affect your productivity statistics and completion records.
          Consider keeping it for historical tracking and performance analysis.
        </p>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmCheckbox = document.getElementById('confirmDelete');
    const deleteButton = document.getElementById('confirmDeleteBtn');
    const deleteForm = document.getElementById('deleteForm');
    
    // Enable/disable delete button based on confirmation
    confirmCheckbox.addEventListener('change', function() {
        deleteButton.disabled = !this.checked;
        
        if (this.checked) {
            deleteButton.classList.remove('btn-secondary');
            deleteButton.classList.add('btn-danger');
        } else {
            deleteButton.classList.remove('btn-danger');
            deleteButton.classList.add('btn-secondary');
        }
    });
    
    // Final confirmation on form submit
    deleteForm.addEventListener('submit', function(e) {
        const taskTitle = "{{ task.title|escapejs }}";
        const confirmed = confirm(
            `Are you absolutely sure you want to delete the task "${taskTitle}"?\n\n` +
            `This action is PERMANENT and cannot be undone.`
        );
        
        if (!confirmed) {
            e.preventDefault();
            return false;
        }
        
        // Show loading state
        deleteButton.disabled = true;
        deleteButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Deleting...';
    });
    
    // Escape key to cancel
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            window.location.href = "{% url 'crm:task_detail' task.id %}";
        }
    });
});

// Mark as cancelled instead of deleting
function markAsCancelled() {
    if (confirm('Mark this task as cancelled instead of deleting it?')) {
        // Create a form to update the task status
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'crm:task_update' task.id %}";
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // Add status field
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = 'cancelled';
        form.appendChild(statusInput);
        
        // Copy all other current values (simplified approach)
        const hiddenFields = [
            { name: 'title', value: "{{ task.title|escapejs }}" },
            { name: 'description', value: "{{ task.description|escapejs }}" },
            { name: 'priority', value: "{{ task.priority }}" },
            { name: 'assigned_to', value: "{{ task.assigned_to.id }}" },
            {% if task.client %}
            { name: 'client', value: "{{ task.client.id }}" },
            {% endif %}
            {% if task.deal %}
            { name: 'deal', value: "{{ task.deal.id }}" },
            {% endif %}
            {% if task.due_date %}
            { name: 'due_date', value: "{{ task.due_date|date:'Y-m-d\\TH:i' }}" },
            {% endif %}
        ];
        
        hiddenFields.forEach(field => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = field.name;
            input.value = field.value;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
