{% extends "dashboard_base.html" %}
{% load static %}

{% block page_title %}Sales Pipeline{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
  <a href="{% url 'crm:deal_create' %}" class="btn btn-primary">
    <i class="bi bi-briefcase-plus me-1"></i> New Deal
  </a>
  <a href="{% url 'crm:dashboard' %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> Back to CRM
  </a>
  <div class="btn-group" role="group">
    <button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-download me-1"></i> Export
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="#" onclick="exportDeals('csv')"><i class="bi bi-file-earmark-spreadsheet me-1"></i> Export CSV</a></li>
      <li><a class="dropdown-item" href="#" onclick="exportDeals('pipeline')"><i class="bi bi-diagram-2 me-1"></i> Pipeline Report</a></li>
    </ul>
  </div>
</div>
{% endblock %}

{% block dashboard_content %}
<!-- Pipeline Statistics Row -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-primary text-white h-100">
      <div class="card-body text-center">
        <i class="bi bi-briefcase fs-1 mb-2"></i>
        <h4>{{ pipeline_stats.total_deals|default:0 }}</h4>
        <p class="mb-0">Total Deals</p>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-success text-white h-100">
      <div class="card-body text-center">
        <i class="bi bi-currency-dollar fs-1 mb-2"></i>
        <h4>${{ pipeline_stats.total_value|floatformat:0|default:0 }}</h4>
        <p class="mb-0">Pipeline Value</p>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-warning text-dark h-100">
      <div class="card-body text-center">
        <i class="bi bi-graph-up fs-1 mb-2"></i>
        <h4>${{ pipeline_stats.weighted_value|floatformat:0|default:0 }}</h4>
        <p class="mb-0">Weighted Value</p>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-info text-white h-100">
      <div class="card-body text-center">
        <i class="bi bi-calculator fs-1 mb-2"></i>
        <h4>${{ pipeline_stats.avg_deal_size|floatformat:0|default:0 }}</h4>
        <p class="mb-0">Avg Deal Size</p>
      </div>
    </div>
  </div>
</div>

<!-- Pipeline Stage Breakdown -->
{% if stage_breakdown %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bi bi-diagram-2 me-2"></i>Pipeline Breakdown
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          {% for stage in stage_breakdown %}
          <div class="col-md-2 mb-3">
            <div class="text-center">
              <div class="border rounded p-3 h-100">
                <h6 class="text-muted">{{ stage.stage|title }}</h6>
                <h4 class="text-primary">{{ stage.count }}</h4>
                <small class="text-success">${{ stage.total_value|floatformat:0 }}</small>
                <br><small class="text-warning">${{ stage.weighted_value|floatformat:0 }} weighted</small>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Search and Filter Section -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Filter Deals</h5>
  </div>
  <div class="card-body">
    <form method="get" class="row g-3">
      <!-- Search -->
      <div class="col-md-3">
        <label for="search" class="form-label">Search</label>
        <input type="text" class="form-control" name="search" id="search" 
               value="{{ search_query }}" placeholder="Deal title, client name...">
      </div>
      
      <!-- Stage Filter -->
      <div class="col-md-2">
        <label for="stage" class="form-label">Stage</label>
        <select class="form-control" name="stage" id="stage">
          <option value="">All Stages</option>
          {% for value, label in available_stages %}
          <option value="{{ value }}" {% if value == stage_filter %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Priority Filter -->
      <div class="col-md-2">
        <label for="priority" class="form-label">Priority</label>
        <select class="form-control" name="priority" id="priority">
          <option value="">All Priorities</option>
          {% for value, label in available_priorities %}
          <option value="{{ value }}" {% if value == priority_filter %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Value Range -->
      <div class="col-md-2">
        <label for="min_value" class="form-label">Min Value</label>
        <input type="number" class="form-control" name="min_value" id="min_value" 
               value="{{ min_value }}" placeholder="0" step="100">
      </div>
      
      <div class="col-md-2">
        <label for="max_value" class="form-label">Max Value</label>
        <input type="number" class="form-control" name="max_value" id="max_value" 
               value="{{ max_value }}" placeholder="Any" step="100">
      </div>
      
      <!-- Assigned Filter -->
      {% if team_members %}
      <div class="col-md-2">
        <label for="assigned" class="form-label">Assigned To</label>
        <select class="form-control" name="assigned" id="assigned">
          <option value="">All Team</option>
          {% for member in team_members %}
          <option value="{{ member.id }}" {% if member.id|stringformat:"s" == assigned_filter %}selected{% endif %}>
            {{ member.get_full_name|default:member.username }}
          </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      
      <!-- Close Date Filter -->
      <div class="col-md-2">
        <label for="close_date" class="form-label">Close Date</label>
        <select class="form-control" name="close_date" id="close_date">
          <option value="">Any Date</option>
          <option value="overdue" {% if close_date_filter == 'overdue' %}selected{% endif %}>Overdue</option>
          <option value="this_month" {% if close_date_filter == 'this_month' %}selected{% endif %}>This Month</option>
          <option value="this_quarter" {% if close_date_filter == 'this_quarter' %}selected{% endif %}>This Quarter</option>
        </select>
      </div>
      
      <!-- Sort -->
      <div class="col-md-2">
        <label for="sort" class="form-label">Sort By</label>
        <select class="form-control" name="sort" id="sort">
          <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Newest First</option>
          <option value="expected_close_date" {% if sort_by == 'expected_close_date' %}selected{% endif %}>Close Date</option>
          <option value="-value" {% if sort_by == '-value' %}selected{% endif %}>Highest Value</option>
          <option value="value" {% if sort_by == 'value' %}selected{% endif %}>Lowest Value</option>
          <option value="stage" {% if sort_by == 'stage' %}selected{% endif %}>Stage</option>
        </select>
      </div>
      
      <!-- Filter Buttons -->
      <div class="col-12">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-funnel me-1"></i> Apply Filters
        </button>
        <a href="{% url 'crm:deal_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-x me-1"></i> Clear
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Results Summary -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h6 class="mb-0">
      {% if page_obj.paginator.count %}
        Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} deal{{ page_obj.paginator.count|pluralize }}
      {% else %}
        No deals found
      {% endif %}
    </h6>
  </div>
  <div>
    {% if search_query or stage_filter or priority_filter %}
    <small class="text-muted">
      <i class="bi bi-funnel me-1"></i> Filters applied
    </small>
    {% endif %}
  </div>
</div>

<!-- Deals Table -->
<div class="card">
  <div class="card-body p-0">
    {% if page_obj %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th>Deal</th>
            <th>Client</th>
            <th>Stage</th>
            <th>Value</th>
            <th>Probability</th>
            <th>Close Date</th>
            <th>Assigned To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for deal in page_obj %}
          <tr class="{% if deal.is_overdue %}table-warning{% endif %}">
            <td>
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  {% if deal.priority == 'critical' %}
                  <i class="bi bi-exclamation-triangle-fill text-danger" title="Critical Priority"></i>
                  {% elif deal.priority == 'high' %}
                  <i class="bi bi-exclamation-circle-fill text-warning" title="High Priority"></i>
                  {% else %}
                  <i class="bi bi-briefcase text-muted"></i>
                  {% endif %}
                </div>
                <div>
                  <h6 class="mb-0">
                    <a href="{% url 'crm:deal_detail' deal.id %}" class="text-decoration-none">
                      {{ deal.title }}
                    </a>
                  </h6>
                  {% if deal.description %}
                  <small class="text-muted">{{ deal.description|truncatewords:8 }}</small>
                  {% endif %}
                </div>
              </div>
            </td>
            <td>
              <a href="{% url 'crm:client_detail' deal.client.id %}" class="text-decoration-none">
                {{ deal.client.name }}
              </a>
              {% if deal.client.company %}
              <br><small class="text-muted">{{ deal.client.company }}</small>
              {% endif %}
            </td>
            <td>
              <span class="badge bg-{% if deal.stage == 'prospecting' %}secondary{% elif deal.stage == 'qualification' %}info{% elif deal.stage == 'proposal' %}warning{% elif deal.stage == 'negotiation' %}primary{% elif deal.stage == 'closed_won' %}success{% else %}danger{% endif %}">
                {{ deal.get_stage_display }}
              </span>
            </td>
            <td>
              <div>
                <span class="fw-bold">${{ deal.value|floatformat:0 }}</span>
                <br><small class="text-muted">{{ deal.currency }}</small>
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="progress me-2" style="width: 60px; height: 8px;">
                  <div class="progress-bar bg-{% if deal.probability >= 75 %}success{% elif deal.probability >= 50 %}warning{% else %}danger{% endif %}" 
                       style="width: {{ deal.probability }}%"></div>
                </div>
                <small>{{ deal.probability }}%</small>
              </div>
            </td>
            <td>
              {% if deal.expected_close_date %}
              <span class="{% if deal.is_overdue %}text-danger fw-bold{% endif %}">
                {{ deal.expected_close_date|date:"M d, Y" }}
              </span>
              {% if deal.is_overdue %}
              <br><small class="text-danger">
                <i class="bi bi-exclamation-triangle me-1"></i>Overdue
              </small>
              {% endif %}
              {% else %}
              <span class="text-muted">Not set</span>
              {% endif %}
            </td>
            <td>
              {% if deal.assigned_to %}
              {{ deal.assigned_to.get_full_name|default:deal.assigned_to.username }}
              {% else %}
              <span class="text-muted">Unassigned</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'crm:deal_detail' deal.id %}" class="btn btn-outline-primary" title="View Details">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="{% url 'crm:deal_update' deal.id %}" class="btn btn-outline-warning" title="Edit">
                  <i class="bi bi-pencil"></i>
                </a>
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="More Actions">
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'crm:task_create' %}?deal_id={{ deal.id }}"><i class="bi bi-plus-circle me-1"></i> Add Task</a></li>
                    <li><a class="dropdown-item" href="#" onclick="createQuote({{ deal.id }})"><i class="bi bi-file-earmark-text me-1"></i> Generate Quote</a></li>
                    <li><hr class="dropdown-divider"></li>
                    {% if is_admin %}
                    <li><a class="dropdown-item text-danger" href="{% url 'crm:deal_delete' deal.id %}"><i class="bi bi-trash me-1"></i> Delete</a></li>
                    {% endif %}
                  </ul>
                </div>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-5">
              <div class="text-muted">
                <i class="bi bi-briefcase-x fs-1 mb-3"></i>
                <h5>No deals found</h5>
                <p>
                  {% if search_query or stage_filter or priority_filter %}
                    Try adjusting your search criteria or <a href="{% url 'crm:deal_list' %}">clear filters</a>.
                  {% else %}
                    Start building your sales pipeline by <a href="{% url 'crm:deal_create' %}">creating your first deal</a>!
                  {% endif %}
                </p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Deals pagination" class="p-3">
      <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if stage_filter %}&stage={{ stage_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">First</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if stage_filter %}&stage={{ stage_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Previous</a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active">
          <span class="page-link">{{ num }}</span>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
          <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if stage_filter %}&stage={{ stage_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if stage_filter %}&stage={{ stage_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Next</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if stage_filter %}&stage={{ stage_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Last</a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <div class="text-center py-5">
      <div class="text-muted">
        <i class="bi bi-briefcase-plus fs-1 mb-3"></i>
        <h5>No deals yet</h5>
        <p>Start building your sales pipeline by creating your first deal.</p>
        <a href="{% url 'crm:deal_create' %}" class="btn btn-primary">
          <i class="bi bi-briefcase-plus me-1"></i> Create First Deal
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit filters on change
document.getElementById('sort').addEventListener('change', function() {
    this.form.submit();
});

// Export functions
function exportDeals(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('export', format);
    window.location.href = window.location.pathname + '?' + params.toString();
}

// Create quote from deal
function createQuote(dealId) {
    window.location.href = `/quotes/create/?deal_id=${dealId}`;
}

// Real-time search (debounced)
let searchTimeout;
document.getElementById('search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        // Could auto-submit after typing stops
        // this.form.submit();
    }, 500);
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + N to add new deal
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        window.location.href = "{% url 'crm:deal_create' %}";
    }
    
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('search').focus();
    }
});

// Pipeline stage progress indicators
document.querySelectorAll('.progress-bar').forEach(bar => {
    const width = parseInt(bar.style.width);
    bar.addEventListener('mouseenter', function() {
        this.setAttribute('title', `${width}% probability`);
    });
});
</script>
{% endblock %}
